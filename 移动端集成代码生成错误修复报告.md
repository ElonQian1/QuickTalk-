# ç§»åŠ¨ç«¯é›†æˆä»£ç ç”Ÿæˆé”™è¯¯ä¿®å¤æŠ¥å‘Š

## ğŸš¨ é—®é¢˜æè¿°
ç§»åŠ¨ç«¯ç®¡ç†é¡µé¢ç‚¹å‡»"ğŸ“‹ ä»£ç "æŒ‰é’®æ—¶å‡ºç°ä¸¤ä¸ªé”™è¯¯ï¼š
1. **JSONè§£æé”™è¯¯**ï¼š`SyntaxError: Unexpected token '<', "<!DOCTYPE "... is not valid JSON`
2. **å‡½æ•°æœªå®šä¹‰é”™è¯¯**ï¼š`ReferenceError: showToast is not defined`

## ğŸ” é—®é¢˜æ ¹å› åˆ†æ

### 1. JSONè§£æé”™è¯¯
- **åŸå› **ï¼šAPIç«¯ç‚¹ `/api/shops/:shopId/integration-code` ä¸å­˜åœ¨
- **ç»“æœ**ï¼šæœåŠ¡å™¨è¿”å›404é¡µé¢çš„HTMLå†…å®¹ï¼Œè€Œä¸æ˜¯JSONå“åº”
- **è¡¨ç°**ï¼šå‰ç«¯å°è¯•è§£æHTMLä¸ºJSONæ—¶å¤±è´¥

### 2. showToastå‡½æ•°æœªå®šä¹‰
- **åŸå› **ï¼šç§»åŠ¨ç«¯ç®¡ç†é¡µé¢ç¼ºå°‘ `showToast` å‡½æ•°å®šä¹‰
- **ç»“æœ**ï¼šé”™è¯¯å¤„ç†ä»£ç è°ƒç”¨æœªå®šä¹‰å‡½æ•°å¯¼è‡´å´©æºƒ
- **è¡¨ç°**ï¼š`ReferenceError: showToast is not defined`

## âœ… è§£å†³æ–¹æ¡ˆ

### 1. æ·»åŠ showToastå‡½æ•°
åœ¨ `static/admin-mobile.html` çš„JavaScriptä»£ç å¼€å§‹å¤„æ·»åŠ äº†å®Œæ•´çš„Toastæç¤ºåŠŸèƒ½ï¼š

```javascript
// Toast æç¤ºå‡½æ•°
function showToast(message, type = 'info') {
    // åˆ›å»º toast å…ƒç´ 
    const toast = document.createElement('div');
    toast.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        background: ${type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#2196f3'};
        color: white;
        padding: 12px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        z-index: 10000;
        max-width: 300px;
        word-wrap: break-word;
        transform: translateX(100%);
        transition: transform 0.3s ease;
    `;
    toast.textContent = message;
    
    // æ·»åŠ åˆ°é¡µé¢
    document.body.appendChild(toast);
    
    // åŠ¨ç”»æ˜¾ç¤º
    setTimeout(() => {
        toast.style.transform = 'translateX(0)';
    }, 10);
    
    // 3ç§’åè‡ªåŠ¨ç§»é™¤
    setTimeout(() => {
        toast.style.transform = 'translateX(100%)';
        setTimeout(() => {
            if (toast.parentNode) {
                toast.parentNode.removeChild(toast);
            }
        }, 300);
    }, 3000);
}
```

**ç‰¹æ€§**ï¼š
- æ”¯æŒä¸åŒç±»å‹æç¤ºï¼ˆinfoã€successã€errorï¼‰
- è‡ªåŠ¨å®šä½åˆ°å³ä¸Šè§’
- æ»‘åŠ¨åŠ¨ç”»æ•ˆæœ
- 3ç§’åè‡ªåŠ¨æ¶ˆå¤±
- å“åº”å¼è®¾è®¡

### 2. æ·»åŠ é›†æˆä»£ç API
åœ¨ `auth-routes.js` ä¸­æ·»åŠ äº†å®Œæ•´çš„é›†æˆä»£ç ç”ŸæˆAPIï¼š

```javascript
// ç”Ÿæˆåº—é“ºé›†æˆä»£ç 
app.post('/api/shops/:shopId/integration-code', requireAuth, requireShopOwner, async (req, res) => {
    try {
        const shopId = req.params.shopId;
        const { serverUrl } = req.body;
        
        console.log('ğŸ“‹ ç”Ÿæˆé›†æˆä»£ç è¯·æ±‚:', { shopId, serverUrl });
        
        // æ£€æŸ¥åº—é“ºæ˜¯å¦å­˜åœ¨
        const shop = await database.getShopById(shopId);
        if (!shop) {
            return res.status(404).json({ error: 'åº—é“ºä¸å­˜åœ¨' });
        }
        
        // ä½¿ç”¨é›†æˆä»£ç ç”Ÿæˆå™¨ç”Ÿæˆä»£ç 
        const IntegrationCodeGenerator = require('./integration-code-generator');
        const codeGenerator = new IntegrationCodeGenerator(database);
        
        const integrationCode = await codeGenerator.generateIntegrationCode(shopId, {
            serverUrl: serverUrl || `${req.protocol}://${req.get('host')}`
        });
        
        console.log('âœ… é›†æˆä»£ç ç”ŸæˆæˆåŠŸ');
        
        res.json({
            success: true,
            shop: {
                id: shop.id,
                name: shop.name,
                domain: shop.domain
            },
            integrationCode: integrationCode
        });
        
    } catch (error) {
        console.error('ç”Ÿæˆé›†æˆä»£ç å¤±è´¥:', error.message);
        res.status(500).json({ error: 'ç”Ÿæˆé›†æˆä»£ç å¤±è´¥: ' + error.message });
    }
});
```

**åŠŸèƒ½ç‰¹æ€§**ï¼š
- ä½¿ç”¨ç°æœ‰çš„æƒé™ä¸­é—´ä»¶ä¿æŠ¤API
- æ”¯æŒåº—é“ºæ‰€æœ‰è€…æƒé™æ£€æŸ¥
- è‡ªåŠ¨ç”ŸæˆAPIå¯†é’¥ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
- è¿”å›å®Œæ•´çš„JavaScripté›†æˆä»£ç 
- æ”¯æŒè‡ªå®šä¹‰æœåŠ¡å™¨URL

## ğŸ”§ ä¿®æ”¹æ–‡ä»¶åˆ—è¡¨

### 1. static/admin-mobile.html
- **æ–°å¢**ï¼š`showToast` å‡½æ•°å®šä¹‰
- **ä½ç½®**ï¼šJavaScriptä»£ç å¼€å§‹å¤„ï¼ˆç¬¬3240è¡Œé™„è¿‘ï¼‰
- **åŠŸèƒ½**ï¼šæä¾›å®Œæ•´çš„Toastæç¤ºåŠŸèƒ½

### 2. auth-routes.js
- **æ–°å¢**ï¼š`POST /api/shops/:shopId/integration-code` APIç«¯ç‚¹
- **ä½ç½®**ï¼šæ–‡ä»¶æœ«å°¾ï¼ˆç¬¬1173è¡Œé™„è¿‘ï¼‰
- **åŠŸèƒ½**ï¼šç”Ÿæˆåº—é“ºé›†æˆä»£ç 

## ğŸ§ª æµ‹è¯•éªŒè¯

### APIæµ‹è¯•
```bash
# ç™»å½•è·å–sessionIdåæµ‹è¯•
curl -X POST "http://localhost:3030/api/shops/{shopId}/integration-code" \
  -H "Content-Type: application/json" \
  -H "X-Session-Id: {sessionId}" \
  -d '{"serverUrl": "http://localhost:3030"}'
```

### é¢„æœŸå“åº”
```json
{
  "success": true,
  "shop": {
    "id": "shop_xxx",
    "name": "åº—é“ºåç§°",
    "domain": "åº—é“ºåŸŸå"
  },
  "integrationCode": "<!-- å®Œæ•´çš„JavaScripté›†æˆä»£ç  -->"
}
```

## ğŸ¯ ä¿®å¤æ•ˆæœ

### ä¿®å¤å‰
- âŒ ç‚¹å‡»"ğŸ“‹ ä»£ç "æŒ‰é’®æŠ¥é”™
- âŒ JSONè§£æå¤±è´¥
- âŒ showToastå‡½æ•°æœªå®šä¹‰

### ä¿®å¤å
- âœ… ç‚¹å‡»"ğŸ“‹ ä»£ç "æŒ‰é’®æ­£å¸¸å·¥ä½œ
- âœ… APIè¿”å›æ­£ç¡®çš„JSONå“åº”
- âœ… é”™è¯¯ä¿¡æ¯æ­£ç¡®æ˜¾ç¤ºToastæç¤º
- âœ… é›†æˆä»£ç ç”ŸæˆæˆåŠŸ

## ğŸš€ åŠŸèƒ½å¢å¼º

### Toastæç¤ºç³»ç»Ÿ
- æ”¯æŒå¤šç§ç±»å‹ï¼ˆinfoã€successã€errorï¼‰
- ç¾è§‚çš„UIè®¾è®¡å’ŒåŠ¨ç”»æ•ˆæœ
- è‡ªåŠ¨æ¶ˆå¤±æœºåˆ¶
- ç§»åŠ¨ç«¯å‹å¥½

### é›†æˆä»£ç ç”Ÿæˆ
- è‡ªåŠ¨ç”ŸæˆAPIå¯†é’¥
- å®Œæ•´çš„JavaScriptå®¢æœä»£ç 
- æ”¯æŒè‡ªå®šä¹‰é…ç½®
- æƒé™ä¿æŠ¤

---

**ä¿®å¤å®Œæˆæ—¶é—´**ï¼š2025å¹´9æœˆ13æ—¥ 16:06  
**ä¿®å¤çŠ¶æ€**ï¼šâœ… å·²å®Œæˆå¹¶æµ‹è¯•éªŒè¯  
**æœåŠ¡å™¨çŠ¶æ€**ï¼šâœ… å·²é‡å¯ï¼Œæ‰€æœ‰ä¿®æ”¹ç”Ÿæ•ˆ
