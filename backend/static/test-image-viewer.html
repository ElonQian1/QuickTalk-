<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ImageViewer功能测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-info {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
        .sdk-container {
            border: 2px dashed #ccc;
            padding: 20px;
            min-height: 400px;
            position: relative;
        }
        .console-output {
            background: #1e1e1e;
            color: #00ff00;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 200px;
            overflow-y: auto;
            margin-top: 20px;
            border-radius: 5px;
        }
        .test-button {
            background: #2196F3;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-button:hover {
            background: #1976D2;
        }
    </style>
</head>
<body>
    <div class="test-container">
        <h1>🖼️ ImageViewer功能测试</h1>
        
        <div class="test-info">
            <h3>📋 测试说明</h3>
            <p>此页面测试WebSocket SDK的ImageViewer功能：</p>
            <ul>
                <li>✅ ImageViewer模块正确初始化</li>
                <li>✅ 图片消息点击预览</li>
                <li>✅ 全屏模态框显示</li>
                <li>✅ 下载功能正常工作</li>
                <li>✅ 关闭和键盘事件</li>
            </ul>
        </div>

        <div class="test-controls">
            <button class="test-button" onclick="simulateImageMessage()">📸 模拟图片消息</button>
            <button class="test-button" onclick="testImageViewer()">🔍 测试ImageViewer</button>
            <button class="test-button" onclick="clearConsole()">🧹 清空控制台</button>
        </div>

        <div class="sdk-container" id="chat-widget"></div>

        <div class="console-output" id="console-output">
            <div>🚀 准备加载WebSocket SDK...</div>
        </div>
    </div>

    <!-- 加载WebSocket SDK -->
    <script src="./embed/service-standalone.js"></script>
    
    <script>
        // 控制台输出记录
        const consoleOutput = document.getElementById('console-output');
        
        function logToConsole(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const color = {
                'info': '#00ff00',
                'error': '#ff6b6b',
                'warn': '#ffd93d',
                'success': '#6bcf7f'
            }[type] || '#00ff00';
            
            const div = document.createElement('div');
            div.style.color = color;
            div.innerHTML = `[${timestamp}] ${message}`;
            consoleOutput.appendChild(div);
            consoleOutput.scrollTop = consoleOutput.scrollHeight;
        }

        // 重写console方法以捕获SDK输出
        const originalConsole = {
            log: console.log,
            error: console.error,
            warn: console.warn
        };
        
        console.log = (...args) => {
            originalConsole.log(...args);
            logToConsole(args.join(' '), 'info');
        };
        
        console.error = (...args) => {
            originalConsole.error(...args);
            logToConsole('❌ ERROR: ' + args.join(' '), 'error');
        };
        
        console.warn = (...args) => {
            originalConsole.warn(...args);
            logToConsole('⚠️ WARN: ' + args.join(' '), 'warn');
        };

        let sdk = null;

        // 初始化SDK
        function initSDK() {
            try {
                logToConsole('🔧 开始初始化WebSocket SDK...', 'info');
                
                if (typeof QuickTalkSDK === 'undefined') {
                    logToConsole('❌ QuickTalkSDK未定义！检查service-standalone.js是否加载', 'error');
                    return;
                }
                
                sdk = new QuickTalkSDK({
                    shopId: 'test-shop-123',
                    customerId: 'test-customer-456',
                    wsUrl: 'ws://localhost:8080',
                    apiUrl: 'http://localhost:8080',
                    containerId: 'chat-widget'
                });
                
                logToConsole('✅ SDK实例创建成功', 'success');
                
                // 初始化SDK
                sdk.init().then(() => {
                    logToConsole('✅ SDK初始化完成', 'success');
                    logToConsole('🔍 检查ImageViewer是否已初始化...', 'info');
                    
                    // 检查ImageViewer
                    setTimeout(() => {
                        if (sdk.uiManager && sdk.uiManager.getImageViewer) {
                            const imageViewer = sdk.uiManager.getImageViewer();
                            if (imageViewer) {
                                logToConsole('✅ ImageViewer已成功初始化！', 'success');
                            } else {
                                logToConsole('⚠️ ImageViewer为null或undefined', 'warn');
                            }
                        } else {
                            logToConsole('❌ UIManager或getImageViewer方法不存在', 'error');
                        }
                    }, 1000);
                    
                }).catch(error => {
                    logToConsole('❌ SDK初始化失败: ' + error.message, 'error');
                });
                
            } catch (error) {
                logToConsole('❌ 初始化过程出错: ' + error.message, 'error');
            }
        }

        // 模拟图片消息
        function simulateImageMessage() {
            if (!sdk || !sdk.uiManager) {
                logToConsole('❌ SDK未初始化，无法模拟消息', 'error');
                return;
            }
            
            logToConsole('📸 添加模拟图片消息...', 'info');
            
            const imageMessage = {
                id: 'test-msg-' + Date.now(),
                type: 'image',
                content: '图片消息',
                fileUrl: 'https://via.placeholder.com/300x200/4CAF50/white?text=Test+Image',
                fileName: 'test-image.jpg',
                senderId: 'system',
                timestamp: new Date().toISOString(),
                senderType: 'customer'
            };
            
            try {
                sdk.uiManager.addMessage(imageMessage);
                logToConsole('✅ 图片消息已添加，点击图片测试预览功能', 'success');
            } catch (error) {
                logToConsole('❌ 添加图片消息失败: ' + error.message, 'error');
            }
        }

        // 测试ImageViewer
        function testImageViewer() {
            if (!sdk || !sdk.uiManager) {
                logToConsole('❌ SDK未初始化', 'error');
                return;
            }
            
            logToConsole('🔍 测试ImageViewer功能...', 'info');
            
            try {
                const imageViewer = sdk.uiManager.getImageViewer();
                logToConsole('✅ ImageViewer获取成功！', 'success');
                logToConsole(`🔍 ImageViewer类型: ${typeof imageViewer}`, 'info');
                logToConsole(`🔍 ImageViewer方法: ${Object.getOwnPropertyNames(Object.getPrototypeOf(imageViewer))}`, 'info');
                
                if (imageViewer && imageViewer.show) {
                    logToConsole('✅ show方法可用，显示测试图片...', 'success');
                    imageViewer.show({
                        src: 'https://via.placeholder.com/800x600/2196F3/white?text=ImageViewer+Test',
                        alt: 'test-viewer-image.jpg',
                        title: 'ImageViewer测试图片'
                    });
                } else {
                    logToConsole('❌ ImageViewer或show方法不可用', 'error');
                    logToConsole(`📋 ImageViewer详情: ${JSON.stringify(imageViewer, null, 2)}`, 'warn');
                }
            } catch (error) {
                logToConsole('❌ ImageViewer测试失败: ' + error.message, 'error');
                logToConsole('📋 错误堆栈: ' + error.stack, 'error');
            }
        }

        // 清空控制台
        function clearConsole() {
            consoleOutput.innerHTML = '<div style="color: #6bcf7f;">🧹 控制台已清空</div>';
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            logToConsole('📄 页面DOM加载完成', 'success');
            
            // 延迟一下确保SDK脚本加载完成
            setTimeout(() => {
                initSDK();
            }, 500);
        });
    </script>
</body>
</html>