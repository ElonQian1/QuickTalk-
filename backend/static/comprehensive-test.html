<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket SDK 完整功能测试</title>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            margin: 0;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 30px;
            text-align: center;
        }
        .header h1 {
            margin: 0;
            font-size: 2.5em;
        }
        .content {
            padding: 30px;
        }
        .status-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
        }
        .status {
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        .success { background: #d4edda; color: #155724; border-left: 5px solid #28a745; }
        .error { background: #f8d7da; color: #721c24; border-left: 5px solid #dc3545; }
        .info { background: #d1ecf1; color: #0c5460; border-left: 5px solid #17a2b8; }
        .warning { background: #fff3cd; color: #856404; border-left: 5px solid #ffc107; }
        
        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .test-card {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border: 2px solid #e9ecef;
            transition: all 0.3s ease;
        }
        .test-card:hover {
            border-color: #007bff;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        .test-card h3 {
            margin-top: 0;
            color: #495057;
        }
        
        button {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            min-width: 120px;
        }
        button:hover:not(:disabled) { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(0,123,255,0.3);
        }
        button:disabled {
            background: #6c757d;
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .demo-btn { background: linear-gradient(135deg, #28a745, #20c997); }
        .test-btn { background: linear-gradient(135deg, #ffc107, #fd7e14); }
        .danger-btn { background: linear-gradient(135deg, #dc3545, #c82333); }
        
        #chat-widget {
            border: 2px dashed #dee2e6;
            min-height: 200px;
            padding: 20px;
            margin: 20px 0;
            border-radius: 10px;
            background: #f8f9fa;
            position: relative;
        }
        #chat-widget:empty::before {
            content: "🤖 客服窗口将在这里显示";
            color: #6c757d;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 18px;
        }
        
        .feature-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        .feature-item {
            display: flex;
            align-items: center;
            padding: 10px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        .feature-item .icon {
            font-size: 24px;
            margin-right: 10px;
        }
        
        @media (max-width: 768px) {
            .header h1 { font-size: 2em; }
            .test-grid { grid-template-columns: 1fr; }
            button { min-width: 100px; font-size: 12px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🚀 WebSocket SDK 完整测试</h1>
            <p>验证响应式设计、图片预览、文件处理等核心功能</p>
        </div>
        
        <div class="content">
            <div class="status-section">
                <h2>📊 系统状态</h2>
                <div id="status" class="status info">⏳ 正在初始化SDK...</div>
            </div>

            <div class="feature-list">
                <div class="feature-item">
                    <div class="icon">📱</div>
                    <div>响应式面板设计</div>
                </div>
                <div class="feature-item">
                    <div class="icon">🖼️</div>
                    <div>图片点击预览</div>
                </div>
                <div class="feature-item">
                    <div class="icon">📁</div>
                    <div>文件下载支持</div>
                </div>
                <div class="feature-item">
                    <div class="icon">🎯</div>
                    <div>模块化架构</div>
                </div>
                <div class="feature-item">
                    <div class="icon">⚡</div>
                    <div>WebSocket实时通信</div>
                </div>
                <div class="feature-item">
                    <div class="icon">🛡️</div>
                    <div>错误处理机制</div>
                </div>
            </div>

            <div class="test-grid">
                <div class="test-card">
                    <h3>🔧 基础功能测试</h3>
                    <p>验证SDK初始化和核心组件</p>
                    <button onclick="testBasicFunctions()" id="basicBtn" disabled class="test-btn">运行基础测试</button>
                </div>

                <div class="test-card">
                    <h3>🖼️ ImageViewer测试</h3>
                    <p>测试图片预览和下载功能</p>
                    <button onclick="testImageViewer()" id="testBtn" disabled class="test-btn">测试图片查看器</button>
                    <button onclick="showDemoImage()" id="demoBtn" disabled class="demo-btn">显示演示图片</button>
                </div>

                <div class="test-card">
                    <h3>📱 响应式测试</h3>
                    <p>测试不同屏幕尺寸的适配</p>
                    <button onclick="testResponsive()" id="responsiveBtn" disabled class="test-btn">测试响应式</button>
                    <button onclick="simulateMobile()" id="mobileBtn" disabled class="demo-btn">模拟移动端</button>
                </div>

                <div class="test-card">
                    <h3>💬 消息功能测试</h3>
                    <p>测试不同类型消息的显示</p>
                    <button onclick="addTestMessages()" id="messageBtn" disabled class="demo-btn">添加测试消息</button>
                    <button onclick="clearMessages()" id="clearBtn" disabled class="danger-btn">清空消息</button>
                </div>
            </div>

            <div id="chat-widget"></div>
        </div>
    </div>

    <script src="./embed/service-standalone.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const buttons = {
            basic: document.getElementById('basicBtn'),
            test: document.getElementById('testBtn'),
            demo: document.getElementById('demoBtn'),
            responsive: document.getElementById('responsiveBtn'),
            mobile: document.getElementById('mobileBtn'),
            message: document.getElementById('messageBtn'),
            clear: document.getElementById('clearBtn')
        };
        
        let sdk = null;

        function updateStatus(message, type = 'info') {
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
        }

        function enableAllButtons() {
            Object.values(buttons).forEach(btn => btn.disabled = false);
        }

        function testBasicFunctions() {
            if (!sdk) {
                updateStatus('❌ SDK未初始化', 'error');
                return;
            }
            
            try {
                const tests = [
                    () => sdk.getConnectionState(),
                    () => sdk.getDeviceInfo(),
                    () => sdk.getUIManager(),
                    () => sdk.getUIManager().getImageViewer()
                ];
                
                let results = [];
                tests.forEach((test, index) => {
                    try {
                        const result = test();
                        results.push(`测试${index + 1}: ✅ 通过`);
                    } catch (error) {
                        results.push(`测试${index + 1}: ❌ 失败 - ${error.message}`);
                    }
                });
                
                updateStatus(`基础功能测试完成 - ${results.join(', ')}`, 'success');
                console.log('基础功能测试结果:', results);
            } catch (error) {
                updateStatus('❌ 基础功能测试失败: ' + error.message, 'error');
            }
        }

        function testImageViewer() {
            if (!sdk) {
                updateStatus('❌ SDK未初始化', 'error');
                return;
            }
            
            try {
                const uiManager = sdk.getUIManager();
                const imageViewer = uiManager.getImageViewer();
                updateStatus('✅ ImageViewer测试通过！功能可用', 'success');
                console.log('ImageViewer实例:', imageViewer);
                console.log('ImageViewer方法:', Object.getOwnPropertyNames(Object.getPrototypeOf(imageViewer)));
            } catch (error) {
                updateStatus('❌ ImageViewer测试失败: ' + error.message, 'error');
                console.error('错误详情:', error);
            }
        }

        function showDemoImage() {
            if (!sdk) {
                updateStatus('❌ SDK未初始化', 'error');
                return;
            }
            
            try {
                const uiManager = sdk.getUIManager();
                const imageViewer = uiManager.getImageViewer();
                imageViewer.show({
                    src: 'https://via.placeholder.com/800x600/4CAF50/white?text=WebSocket+SDK+Demo',
                    alt: 'SDK演示图片',
                    title: 'WebSocket SDK 图片预览演示'
                });
                updateStatus('✅ 演示图片已打开，测试点击、下载、关闭功能', 'success');
            } catch (error) {
                updateStatus('❌ 图片预览失败: ' + error.message, 'error');
                console.error('错误详情:', error);
            }
        }

        function testResponsive() {
            if (!sdk) {
                updateStatus('❌ SDK未初始化', 'error');
                return;
            }
            
            try {
                const deviceInfo = sdk.getDeviceInfo();
                updateStatus(`✅ 响应式信息: ${deviceInfo}`, 'info');
                console.log('设备信息详情:', deviceInfo);
                
                // 触发窗口resize事件测试响应式
                window.dispatchEvent(new Event('resize'));
                
                setTimeout(() => {
                    updateStatus('✅ 响应式测试完成，已触发resize事件', 'success');
                }, 1000);
            } catch (error) {
                updateStatus('❌ 响应式测试失败: ' + error.message, 'error');
            }
        }

        function simulateMobile() {
            // 通过修改viewport meta标签模拟移动端
            let viewport = document.querySelector('meta[name="viewport"]');
            if (!viewport) {
                viewport = document.createElement('meta');
                viewport.name = 'viewport';
                document.head.appendChild(viewport);
            }
            viewport.content = 'width=375, initial-scale=1.0';
            
            // 触发resize事件
            window.dispatchEvent(new Event('resize'));
            
            updateStatus('✅ 已切换到移动端模拟模式 (375px宽度)', 'info');
            
            setTimeout(() => {
                viewport.content = 'width=device-width, initial-scale=1.0';
                window.dispatchEvent(new Event('resize'));
                updateStatus('✅ 已恢复到响应式模式', 'success');
            }, 3000);
        }

        function addTestMessages() {
            if (!sdk) {
                updateStatus('❌ SDK未初始化', 'error');
                return;
            }
            
            try {
                const uiManager = sdk.getUIManager();
                
                // 添加文本消息
                uiManager.addMessage({
                    id: 'test-1',
                    type: 'text',
                    content: '欢迎使用WebSocket SDK! 🎉',
                    senderId: 'system',
                    timestamp: new Date().toISOString(),
                    senderType: 'staff'
                });

                // 添加图片消息
                uiManager.addMessage({
                    id: 'test-2',
                    type: 'image',
                    content: '这是一张测试图片',
                    fileUrl: 'https://via.placeholder.com/300x200/FF6B6B/white?text=Test+Image',
                    fileName: 'test-image.jpg',
                    senderId: 'customer',
                    timestamp: new Date().toISOString(),
                    senderType: 'customer'
                });

                // 添加文件消息
                uiManager.addMessage({
                    id: 'test-3',
                    type: 'file',
                    content: '文档文件',
                    fileUrl: 'https://example.com/document.pdf',
                    fileName: 'document.pdf',
                    senderId: 'staff',
                    timestamp: new Date().toISOString(),
                    senderType: 'staff'
                });

                updateStatus('✅ 测试消息已添加，点击图片可预览', 'success');
            } catch (error) {
                updateStatus('❌ 添加测试消息失败: ' + error.message, 'error');
            }
        }

        function clearMessages() {
            // 这个功能需要在UIManager中实现
            updateStatus('⚠️ 清空消息功能需要在UIManager中实现', 'warning');
        }

        // 初始化SDK
        if (typeof QuickTalkSDK !== 'undefined') {
            try {
                updateStatus('🔧 创建SDK实例...', 'info');
                
                sdk = new QuickTalkSDK({
                    shopId: 'test-shop-demo',
                    customerId: 'test-customer-demo',
                    wsUrl: 'ws://localhost:8080',
                    apiUrl: 'http://localhost:8080',
                    containerId: 'chat-widget',
                    debugMode: true
                });
                
                updateStatus('⏳ 正在初始化SDK...', 'info');
                
                sdk.init().then(() => {
                    updateStatus('✅ SDK初始化成功！所有功能已就绪', 'success');
                    enableAllButtons();
                    
                    // 自动运行基础测试
                    setTimeout(() => {
                        testBasicFunctions();
                    }, 1000);
                    
                }).catch(error => {
                    updateStatus('❌ SDK初始化失败: ' + error.message, 'error');
                    console.error('初始化错误:', error);
                });
                
            } catch (error) {
                updateStatus('❌ SDK创建失败: ' + error.message, 'error');
                console.error('创建错误:', error);
            }
        } else {
            updateStatus('❌ QuickTalkSDK未定义，请检查service-standalone.js是否加载', 'error');
        }

        // 监听窗口resize事件
        window.addEventListener('resize', () => {
            if (sdk) {
                console.log('📱 窗口大小变化:', {
                    width: window.innerWidth,
                    height: window.innerHeight,
                    deviceInfo: sdk.getDeviceInfo()
                });
            }
        });
    </script>
</body>
</html>