<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é‡æ„åç³»ç»ŸåŠŸèƒ½éªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 15px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow-x: auto; }
        button { padding: 8px 16px; margin: 5px; border: none; border-radius: 4px; cursor: pointer; }
        .btn-primary { background: #007bff; color: white; }
        .btn-success { background: #28a745; color: white; }
        .btn-warning { background: #ffc107; color: #212529; }
    </style>
</head>
<body>
    <h1>ğŸ”§ QuickTalk é‡æ„åç³»ç»ŸåŠŸèƒ½éªŒè¯</h1>
    
    <div class="test-section">
        <h3>ğŸ“‹ éªŒè¯æ¸…å•</h3>
        <div id="checklistResults"></div>
        <button class="btn-primary" onclick="runAllTests()">ğŸš€ è¿è¡Œæ‰€æœ‰éªŒè¯</button>
        <button class="btn-success" onclick="runModuleTests()">ğŸ“¦ éªŒè¯æ¨¡å—åŠ è½½</button>
        <button class="btn-warning" onclick="runCoordinatorTests()">ğŸ¯ éªŒè¯åè°ƒå™¨</button>
    </div>

    <div class="test-section">
        <h3>ğŸ“Š æµ‹è¯•ç»“æœ</h3>
        <div id="testResults"></div>
    </div>

    <div class="test-section">
        <h3>ğŸ” è¯¦ç»†æ—¥å¿—</h3>
        <pre id="detailedLog"></pre>
    </div>

    <!-- æ ¸å¿ƒä¾èµ– -->
    <script src="/static/js/utils/qt-log.js"></script>
    <script src="/static/js/telemetry/event-bus.js"></script>
    <script src="/static/js/state/message-state-store.js"></script>
    
    <!-- ä¸šåŠ¡ç®¡ç†å™¨ -->
    <script src="/static/js/usecases/shops-manager-clean.js"></script>
    <script src="/static/js/usecases/conversations-manager-clean.js"></script>
    <script src="/static/js/usecases/messages-manager-clean.js"></script>
    
    <!-- æ ¸å¿ƒåè°ƒå™¨ -->
    <script src="/static/js/core/message-coordinator.js"></script>
    
    <!-- é›†æˆå’ŒéªŒè¯å·¥å…· -->
    <script src="/static/js/integrator/message-module-integrator.js"></script>
    <script src="/static/js/utils/message-functionality-checker.js"></script>

    <script>
        let testLog = [];
        
        function log(level, message, data = null) {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${level.toUpperCase()}: ${message}`;
            testLog.push(logEntry);
            
            if (data) {
                testLog.push(JSON.stringify(data, null, 2));
            }
            
            // å®æ—¶æ›´æ–°è¯¦ç»†æ—¥å¿—
            document.getElementById('detailedLog').textContent = testLog.join('\n');
            
            console[level] || console.log(logEntry, data);
        }

        function updateResults(section, content, className = '') {
            const element = document.getElementById(section);
            const div = document.createElement('div');
            div.innerHTML = content;
            if (className) div.className = className;
            element.appendChild(div);
        }

        async function runModuleTests() {
            log('info', 'å¼€å§‹éªŒè¯æ¨¡å—åŠ è½½...');
            const results = [];
            
            // æ£€æŸ¥æ ¸å¿ƒç±»
            const coreModules = {
                'MessageCoordinator': window.MessageCoordinator,
                'MessageModuleIntegrator': window.MessageModuleIntegrator,
                'MessageFunctionalityChecker': window.MessageFunctionalityChecker,
                'QT_LOG': window.QT_LOG,
                'MessageEventBus': window.MessageEventBus,
                'MessageStateStore': window.MessageStateStore
            };
            
            for (const [name, module] of Object.entries(coreModules)) {
                if (module) {
                    results.push(`âœ… ${name} å·²åŠ è½½`);
                    log('info', `æ¨¡å— ${name} åŠ è½½æˆåŠŸ`);
                } else {
                    results.push(`âŒ ${name} æœªåŠ è½½`);
                    log('error', `æ¨¡å— ${name} åŠ è½½å¤±è´¥`);
                }
            }
            
            updateResults('testResults', 
                `<h4>ğŸ“¦ æ¨¡å—åŠ è½½éªŒè¯ç»“æœ:</h4><ul><li>${results.join('</li><li>')}</li></ul>`
            );
        }

        async function runCoordinatorTests() {
            log('info', 'å¼€å§‹éªŒè¯åè°ƒå™¨åŠŸèƒ½...');
            
            try {
                // æµ‹è¯•åè°ƒå™¨åˆ›å»º
                if (!window.MessageCoordinator) {
                    throw new Error('MessageCoordinator ç±»ä¸å¯ç”¨');
                }
                
                const coordinator = new window.MessageCoordinator({
                    debug: true,
                    autoInit: false
                });
                
                log('info', 'åè°ƒå™¨åˆ›å»ºæˆåŠŸ', {
                    state: coordinator.state,
                    managersCount: Object.keys(coordinator.managers).length
                });
                
                // æµ‹è¯•åˆå§‹åŒ–
                coordinator.init();
                
                if (coordinator.state.initialized) {
                    updateResults('testResults', 
                        `<div class="success">âœ… åè°ƒå™¨åˆå§‹åŒ–æˆåŠŸ</div>`
                    );
                } else {
                    updateResults('testResults', 
                        `<div class="error">âŒ åè°ƒå™¨åˆå§‹åŒ–å¤±è´¥</div>`
                    );
                }
                
                // æµ‹è¯•é›†æˆå™¨
                if (window.MessageModuleIntegrator) {
                    const integrator = new window.MessageModuleIntegrator({
                        debug: true
                    });
                    
                    log('info', 'é›†æˆå™¨æµ‹è¯•æˆåŠŸ');
                    updateResults('testResults', 
                        `<div class="success">âœ… é›†æˆå™¨åˆ›å»ºå’Œåˆå§‹åŒ–æˆåŠŸ</div>`
                    );
                }
                
            } catch (error) {
                log('error', 'åè°ƒå™¨æµ‹è¯•å¤±è´¥', error);
                updateResults('testResults', 
                    `<div class="error">âŒ åè°ƒå™¨æµ‹è¯•å¤±è´¥: ${error.message}</div>`
                );
            }
        }

        async function runFunctionalityTests() {
            log('info', 'å¼€å§‹åŠŸèƒ½å®Œæ•´æ€§éªŒè¯...');
            
            if (window.MessageFunctionalityChecker) {
                try {
                    const checker = window.MessageFunctionalityChecker;
                    const report = await checker.generateReport();
                    
                    log('info', 'åŠŸèƒ½éªŒè¯å®Œæˆ', report);
                    
                    const moduleResults = Object.entries(report.modules)
                        .map(([name, status]) => `${status ? 'âœ…' : 'âŒ'} ${name}`)
                        .join('<br>');
                    
                    updateResults('testResults', 
                        `<h4>ğŸ” åŠŸèƒ½å®Œæ•´æ€§éªŒè¯:</h4>
                         <div>æ€»ä½“çŠ¶æ€: ${report.overall ? 'âœ… å¥åº·' : 'âŒ å¼‚å¸¸'}</div>
                         <div>æ¨¡å—çŠ¶æ€:<br>${moduleResults}</div>`
                    );
                    
                } catch (error) {
                    log('error', 'åŠŸèƒ½éªŒè¯å¤±è´¥', error);
                    updateResults('testResults', 
                        `<div class="error">âŒ åŠŸèƒ½éªŒè¯å¤±è´¥: ${error.message}</div>`
                    );
                }
            } else {
                updateResults('testResults', 
                    `<div class="warning">âš ï¸ MessageFunctionalityChecker ä¸å¯ç”¨</div>`
                );
            }
        }

        async function runAllTests() {
            // æ¸…ç©ºä¹‹å‰çš„ç»“æœ
            document.getElementById('testResults').innerHTML = '<h3>ğŸ”„ æ­£åœ¨è¿è¡ŒéªŒè¯...</h3>';
            document.getElementById('detailedLog').textContent = '';
            testLog = [];
            
            log('info', '=== å¼€å§‹å®Œæ•´ç³»ç»ŸéªŒè¯ ===');
            
            try {
                await runModuleTests();
                await new Promise(resolve => setTimeout(resolve, 500)); // çŸ­æš‚å»¶è¿Ÿ
                
                await runCoordinatorTests();
                await new Promise(resolve => setTimeout(resolve, 500));
                
                await runFunctionalityTests();
                
                log('info', '=== ç³»ç»ŸéªŒè¯å®Œæˆ ===');
                updateResults('testResults', 
                    `<div class="info">ğŸ“‹ æ‰€æœ‰éªŒè¯é¡¹ç›®å·²å®Œæˆï¼Œè¯·æŸ¥çœ‹ä¸Šè¿°ç»“æœå’Œè¯¦ç»†æ—¥å¿—</div>`
                );
                
            } catch (error) {
                log('error', 'éªŒè¯è¿‡ç¨‹å‡ºé”™', error);
                updateResults('testResults', 
                    `<div class="error">ğŸ’¥ éªŒè¯è¿‡ç¨‹å‡ºé”™: ${error.message}</div>`
                );
            }
        }

        // æ˜¾ç¤ºéªŒè¯æ¸…å•
        function showChecklist() {
            const checklist = [
                'ğŸ—‘ï¸ åˆ é™¤å†—ä½™åè°ƒå™¨æ–‡ä»¶ (message-module.js, message-module-refactored.js, message-core-coordinator.js)',
                'ğŸ”„ æ›´æ–°HTMLæ–‡ä»¶å¼•ç”¨ (mobile-dashboard-*.html)',
                'ğŸ”— æ›´æ–°JSæ¨¡å—å¼•ç”¨ (integrator, compat-layer, functionality-checker)',
                'ğŸ—ï¸ ä¿ç•™ç”¨æˆ·ç¼–è¾‘çš„ message-coordinator.js',
                'ğŸ¯ ç»Ÿä¸€åè°ƒå™¨ç±»åä¸º MessageCoordinator',
                'ğŸ“¦ éªŒè¯æ¨¡å—åŠ è½½å’Œé›†æˆ',
                'âš™ï¸ æµ‹è¯•æ ¸å¿ƒåŠŸèƒ½å®Œæ•´æ€§'
            ];
            
            const checklistHtml = checklist.map(item => `<div>âœ… ${item}</div>`).join('');
            document.getElementById('checklistResults').innerHTML = checklistHtml;
        }

        // é¡µé¢åŠ è½½æ—¶æ˜¾ç¤ºæ¸…å•
        document.addEventListener('DOMContentLoaded', function() {
            showChecklist();
            log('info', 'é‡æ„åç³»ç»ŸéªŒè¯é¡µé¢å·²å°±ç»ª');
        });
    </script>
</body>
</html>