<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç»Ÿä¸€å·²è¯»ç®¡ç†å™¨æµ‹è¯•</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ddd; border-radius: 8px; }
        .test-button { padding: 8px 16px; margin: 5px; background: #007aff; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #005bb5; }
        .log-area { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 4px; font-family: monospace; font-size: 12px; height: 200px; overflow-y: auto; }
        .status { padding: 5px 10px; margin: 5px 0; border-radius: 4px; }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>ğŸ§ª ç»Ÿä¸€å·²è¯»ç®¡ç†å™¨æµ‹è¯•é¡µé¢</h1>
    
    <div class="test-section">
        <h2>ğŸ“‹ ç³»ç»ŸçŠ¶æ€</h2>
        <div id="systemStatus"></div>
        <button class="test-button" onclick="checkSystemStatus()">æ£€æŸ¥ç³»ç»ŸçŠ¶æ€</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”§ åŸºç¡€åŠŸèƒ½æµ‹è¯•</h2>
        <button class="test-button" onclick="testMarkSingle()">æµ‹è¯•å•ä¸ªå¯¹è¯æ ‡è®°</button>
        <button class="test-button" onclick="testMarkMultiple()">æµ‹è¯•æ‰¹é‡æ ‡è®°</button>
        <button class="test-button" onclick="testAutoMark()">æµ‹è¯•è‡ªåŠ¨æ ‡è®°</button>
        <button class="test-button" onclick="enableDebug()">å¯ç”¨è°ƒè¯•æ¨¡å¼</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“¡ APIè¿æ¥æµ‹è¯•</h2>
        <button class="test-button" onclick="testApiConnection()">æµ‹è¯•APIè¿æ¥</button>
        <button class="test-button" onclick="testSessionId()">æµ‹è¯•ä¼šè¯ID</button>
    </div>

    <div class="test-section">
        <h2>ğŸ“ æµ‹è¯•æ—¥å¿—</h2>
        <button class="test-button" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="logArea" class="log-area"></div>
    </div>

    <script src="/js/core/unified-read-manager.js"></script>
    <script>
        function log(message, type = 'info') {
            const logArea = document.getElementById('logArea');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `status ${type}`;
            logEntry.innerHTML = `[${timestamp}] ${message}`;
            logArea.appendChild(logEntry);
            logArea.scrollTop = logArea.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        function checkSystemStatus() {
            const statusDiv = document.getElementById('systemStatus');
            let html = '';

            // æ£€æŸ¥ç»Ÿä¸€ç®¡ç†å™¨
            if (window.UnifiedReadManager) {
                html += '<div class="status success">âœ… UnifiedReadManager å·²åŠ è½½</div>';
                html += `<div class="status info">ğŸ“ APIç«¯ç‚¹: ${window.UnifiedReadManager.apiEndpoint}</div>`;
            } else {
                html += '<div class="status error">âŒ UnifiedReadManager æœªåŠ è½½</div>';
            }

            // æ£€æŸ¥å¿«æ·æ–¹æ³•
            if (window.markConversationAsRead) {
                html += '<div class="status success">âœ… å…¨å±€å¿«æ·æ–¹æ³•å¯ç”¨</div>';
            } else {
                html += '<div class="status error">âŒ å…¨å±€å¿«æ·æ–¹æ³•ä¸å¯ç”¨</div>';
            }

            // æ£€æŸ¥ä¼šè¯ID
            const sessionId = localStorage.getItem('sessionId') || sessionStorage.getItem('sessionId');
            if (sessionId) {
                html += `<div class="status success">âœ… ä¼šè¯IDå­˜åœ¨: ${sessionId.substring(0, 10)}...</div>`;
            } else {
                html += '<div class="status error">âŒ ä¼šè¯IDä¸å­˜åœ¨</div>';
            }

            statusDiv.innerHTML = html;
            log('ç³»ç»ŸçŠ¶æ€æ£€æŸ¥å®Œæˆ');
        }

        async function testMarkSingle() {
            const testId = 'test_conv_' + Date.now();
            log(`å¼€å§‹æµ‹è¯•å•ä¸ªå¯¹è¯æ ‡è®°: ${testId}`);
            
            try {
                const success = await window.markConversationAsRead(testId);
                if (success) {
                    log(`âœ… å•ä¸ªå¯¹è¯æ ‡è®°æˆåŠŸ: ${testId}`, 'success');
                } else {
                    log(`âŒ å•ä¸ªå¯¹è¯æ ‡è®°å¤±è´¥: ${testId}`, 'error');
                }
            } catch (error) {
                log(`âŒ å•ä¸ªå¯¹è¯æ ‡è®°å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testMarkMultiple() {
            const testIds = [
                'test_conv_1_' + Date.now(),
                'test_conv_2_' + Date.now(),
                'test_conv_3_' + Date.now()
            ];
            
            log(`å¼€å§‹æµ‹è¯•æ‰¹é‡æ ‡è®°: ${testIds.length} ä¸ªå¯¹è¯`);
            
            try {
                const results = await window.UnifiedReadManager.markMultipleAsRead(testIds);
                log(`âœ… æ‰¹é‡æ ‡è®°å®Œæˆ - æˆåŠŸ: ${results.success.length}, å¤±è´¥: ${results.failed.length}`, 'success');
                log(`æˆåŠŸçš„å¯¹è¯: ${results.success.join(', ')}`);
                if (results.failed.length > 0) {
                    log(`å¤±è´¥çš„å¯¹è¯: ${results.failed.join(', ')}`, 'error');
                }
            } catch (error) {
                log(`âŒ æ‰¹é‡æ ‡è®°å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        async function testAutoMark() {
            const testId = 'auto_test_' + Date.now();
            log(`å¼€å§‹æµ‹è¯•è‡ªåŠ¨æ ‡è®°: ${testId}`);
            
            // æ¨¡æ‹Ÿå¯¹è¯é€‰æ‹©äº‹ä»¶
            document.dispatchEvent(new CustomEvent('conversation:selected', {
                detail: { id: testId }
            }));
            
            log('âœ… è‡ªåŠ¨æ ‡è®°äº‹ä»¶å·²è§¦å‘ï¼ˆ1ç§’åç”Ÿæ•ˆï¼‰', 'info');
        }

        function enableDebug() {
            window.UnifiedReadManager.enableDebug();
            log('âœ… è°ƒè¯•æ¨¡å¼å·²å¯ç”¨', 'success');
        }

        async function testApiConnection() {
            log('å¼€å§‹æµ‹è¯•APIè¿æ¥...');
            
            try {
                const response = await fetch('/api/health');
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… APIè¿æ¥æ­£å¸¸', 'success');
                    log(`æœåŠ¡å™¨å“åº”: ${JSON.stringify(data)}`);
                } else {
                    log(`âŒ APIè¿æ¥å¤±è´¥: ${response.status} ${response.statusText}`, 'error');
                }
            } catch (error) {
                log(`âŒ APIè¿æ¥å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        function testSessionId() {
            const sessionId = localStorage.getItem('sessionId') || sessionStorage.getItem('sessionId');
            
            if (!sessionId) {
                // åˆ›å»ºæµ‹è¯•ä¼šè¯ID
                const testSessionId = 'test_session_' + Date.now();
                localStorage.setItem('sessionId', testSessionId);
                log(`âœ… åˆ›å»ºæµ‹è¯•ä¼šè¯ID: ${testSessionId}`, 'success');
            } else {
                log(`âœ… ç°æœ‰ä¼šè¯ID: ${sessionId}`, 'info');
            }
        }

        function clearLog() {
            document.getElementById('logArea').innerHTML = '';
            log('æ—¥å¿—å·²æ¸…ç©º');
        }

        // ç›‘å¬å·²è¯»äº‹ä»¶
        document.addEventListener('conversation:read', (event) => {
            log(`ğŸ”” æ”¶åˆ°å·²è¯»äº‹ä»¶: ${event.detail.conversationId} (è‡ªåŠ¨: ${event.detail.auto})`, 'info');
        });

        // é¡µé¢åŠ è½½æ—¶æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        window.addEventListener('load', () => {
            setTimeout(checkSystemStatus, 100);
            log('æµ‹è¯•é¡µé¢å·²åŠ è½½');
        });
    </script>
</body>
</html>