<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QuickTalk ç§»åŠ¨ç«¯ç®¡ç†åå° (ä¼˜åŒ–ç‰ˆ)</title>
    
    <!-- ==================== æ ¸å¿ƒæ ·å¼æ¨¡å— ==================== -->
    <!-- åŸºç¡€æ ·å¼ï¼ˆæŒ‰ä¼˜å…ˆçº§æ’åºï¼‰ -->
    <link rel="stylesheet" href="/static/css/reset.css">
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/responsive-layout.css">
    
    <!-- æ ¸å¿ƒåŠŸèƒ½æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/responsive-messages.css">
    <link rel="stylesheet" href="/static/css/chat-input-enhanced.css">
    <link rel="stylesheet" href="/static/css/conversation-avatar.css">
    
    <!-- UIç»„ä»¶æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/toast.css">
    <link rel="stylesheet" href="/static/css/modal-styles.css">
    <link rel="stylesheet" href="/static/css/button-styles.css">
    <link rel="stylesheet" href="/static/css/form-styles.css">
    
    <!-- å¸ƒå±€æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/top-bar.css">
    <link rel="stylesheet" href="/static/css/bottom-nav.css">
    <link rel="stylesheet" href="/static/css/mobile-layout.css">
    
    <!-- åŠŸèƒ½æ¨¡å—æ ·å¼ -->
    <link rel="stylesheet" href="/static/css/shop-card-styles.css">
    <link rel="stylesheet" href="/static/css/messages-list.css">
    <link rel="stylesheet" href="/static/css/state-styles.css">

    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <!-- æ¡Œé¢ç«¯ä¾§è¾¹å¯¼èˆªæ  -->
        <div data-include="/static/components/sidebar-nav.html"></div>
        
        <!-- ç§»åŠ¨ç«¯é¡¶éƒ¨çŠ¶æ€æ  -->
        <div data-include="/static/components/top-bar.html" class="d-md-none"></div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <div data-include="/static/components/main-content.html"></div>
        </div>

        <!-- ç§»åŠ¨ç«¯åº•éƒ¨å¯¼èˆªæ  -->
        <div data-include="/static/components/bottom-nav.html" class="d-md-none"></div>
    </div>

    <!-- ==================== æ ¸å¿ƒJavaScriptæ¨¡å— ==================== -->
    
    <!-- 1. åŸºç¡€è®¾æ–½å±‚ (Core Infrastructure) -->
    <script src="/static/js/core/module-registry.js"></script>
    <script src="/static/js/core/constants.js"></script>
    <script src="/static/js/core/logger.js"></script>
    <script src="/static/js/core/event-bus.js"></script>
    <script src="/static/js/core/responsive-view-manager.js"></script>
    
    <!-- 2. å·¥å…·åº“å±‚ (Utilities) -->
    <script src="/static/js/utils/global-utils.js"></script>
    <script src="/static/js/utils/auth-helper.js"></script>
    <script src="/static/js/utils/http-utils.js"></script>
    <script src="/static/js/utils/loading-utils.js"></script>
    <script src="/static/js/utils/notify-utils.js"></script>
    <script src="/static/js/utils/modal-utils.js"></script>
    <script src="/static/js/utils/partials-loader.js"></script>
    
    <!-- å¼€å‘å·¥å…· (ä»…å¼€å‘ç¯å¢ƒ) -->
    <script src="/static/js/utils/message-functionality-validator.js"></script>
    <script src="/static/js/utils/module-dependency-analyzer.js"></script>
    <script src="/static/js/utils/message-functionality-enhancer.js"></script>
    
    <!-- 3. é¢†åŸŸæ¨¡å‹å±‚ (Domain Models) -->
    <script src="/static/js/domain/entities/conversation.js"></script>
    <script src="/static/js/domain/entities/message.js"></script>
    <script src="/static/js/domain/entities/shop.js"></script>
    <script src="/static/js/domain/services/session-service.js"></script>
    
    <!-- 4. æ¶ˆæ¯æ ¸å¿ƒæ¨¡å— (Message Core) -->
    <script src="/static/js/message/core/message-event-bus.js"></script>
    <script src="/static/js/message/core/message-state-store.js"></script>
    <script src="/static/js/message/core/message-sender.js"></script>
    <script src="/static/js/message/ui/message-render-adapter.js"></script>
    
    <!-- 5. ä¸šåŠ¡ç®¡ç†å™¨ (Business Managers) -->
    <script src="/static/js/usecases/shops-manager-clean.js"></script>
    <script src="/static/js/usecases/conversations-manager-clean.js"></script>
    <script src="/static/js/usecases/messages-manager-clean.js"></script>
    <script src="/static/js/usecases/media-handler.js"></script>
    
    <!-- 6. WebSocketé€šä¿¡å±‚ (WebSocket Layer) -->
    <script src="/static/js/usecases/message-ws-adapter.js"></script>
    <!-- WebSocketåŸºç¡€è®¾æ–½ -->
    <script src="/static/js/websocket/websocket-base.js"></script>
    <script src="/static/js/websocket/ws-event-router.js"></script>
    <script src="/static/js/websocket/message-send-channel.js"></script>
    
    <!-- 7. æ¶ˆæ¯æ¨¡å—åè°ƒå™¨ (Message Module Coordinator) -->
    <script src="/static/js/core/message-coordinator.js"></script>
    
    <!-- 8. UIç»„ä»¶å±‚ (UI Components) -->
    <script src="/static/js/ui/toast.js"></script>
    <script src="/static/js/ui/empty-states.js"></script>
    <script src="/static/js/ui/loading-states.js"></script>
    <script src="/static/js/ui/message-bubble.js"></script>
    <script src="/static/js/ui/bottom-nav.js"></script>
    
    <!-- 9. ç§»åŠ¨ç«¯é€‚é…å™¨ (Mobile Adapters) -->
    <script src="/static/js/mobile/mobile-bootstrap.js"></script>
    <script src="/static/js/mobile/message-view-mobile-adapter.js"></script>
    <script src="/static/js/mobile/conversations-mobile-adapter.js"></script>
    <script src="/static/js/mobile/shops-mobile-adapter.js"></script>
    
    <!-- 10. åº”ç”¨å¯åŠ¨å™¨ (App Bootstrap) -->
    <script src="/static/js/bootstrap/app-bootstrap.js"></script>
    <script src="/static/js/bootstrap/messages-micro-bootstrap.js"></script>
    
    <!-- 11. æ¨¡æ€æ¡†å’Œè¡¨å• (Modals & Forms) -->
    <div data-include="/static/components/modals/modal-overlay.html"></div>
    <div data-include="/static/components/modals/shop-management-modal.html"></div>
    <div data-include="/static/components/modals/create-shop-modal.html"></div>
    <div data-include="/static/components/modals/edit-shop-modal.html"></div>
    <div data-include="/static/components/modals/integration-code-modal.html"></div>
    
    <!-- æ¨¡æ€æ¡†è„šæœ¬ -->
    <script src="/static/js/modals/create-shop-modal.js"></script>
    <script src="/static/js/modals/edit-shop-modal.js"></script>
    <script src="/static/js/modals/integration-code-modal.js"></script>
    
    <!-- 12. ç”¨ä¾‹æ¨¡å— (Essential Use Cases) -->
    <script src="/static/js/usecases/shop-actions.js"></script>
    <script src="/static/js/usecases/conversation-actions.js"></script>
    <script src="/static/js/usecases/page-navigation.js"></script>
    <script src="/static/js/usecases/auth-session.js"></script>
    
    <!-- åº”ç”¨åˆå§‹åŒ– -->
    <script>
        console.log('ğŸ“± QuickTalk Mobile Dashboard (ä¼˜åŒ–ç‰ˆ) å·²åŠ è½½');
        
        // åˆå§‹åŒ–æ¶ˆæ¯æ¸²æŸ“é€‚é…å™¨
        (function(){
            if (window.MessageRenderAdapter && !window.__MESSAGE_RENDER_INIT__) {
                try { 
                    window.MessageRenderAdapter.init(); 
                    window.__MESSAGE_RENDER_INIT__ = true; 
                } catch(e){ 
                    console.warn('MessageRenderAdapter init failed', e); 
                }
            }
        })();
        
        // åˆå§‹åŒ–æ¶ˆæ¯å‘é€é€šé“
        (function(){
            if (!window.MessageSendChannel || window.MessageSendChannelInstance) return;
            try {
                window.MessageSendChannel.init({
                    debug: false,
                    conversationResolver: function(){ 
                        return window.MessageStateStore && window.MessageStateStore.currentConversationId; 
                    },
                    onLocalEnqueue: function(localMsg){ 
                        if (window.MessageStateStore && localMsg) {
                            const cid = localMsg.conversation_id;
                            window.MessageStateStore.appendMessage(cid, { ...localMsg });
                        }
                    },
                    onLocalPatch: function(tempId, patch){
                        if (!window.MessageStateStore) return;
                        const cid = window.MessageStateStore.currentConversationId;
                        const list = window.MessageStateStore.getCurrentMessages();
                        const idx = list.findIndex(m=>m.temp_id===tempId);
                        if (idx>=0){
                            list[idx] = { ...list[idx], ...patch };
                            window.MessageEventBus && window.MessageEventBus.publish('message.updated',{ message:list[idx], conversationId: cid });
                        }
                    },
                    onFinalized: function(tempId, serverMsg){
                        if (window.MessageStateStore && serverMsg && serverMsg.conversation_id){
                            window.MessageStateStore.replaceTemp(tempId, serverMsg);
                        }
                    },
                    ackTimeoutMs: 8000
                });
            } catch(e){ 
                console.warn('MessageSendChannel init failed', e); 
            }
        })();
    </script>
</body>
</html>