<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>QuickTalk 移动端管理后台 (优化版)</title>
    
    <!-- ==================== 核心样式模块 ==================== -->
    <!-- 基础样式（按优先级排序） -->
    <link rel="stylesheet" href="/static/css/reset.css">
    <link rel="stylesheet" href="/static/css/variables.css">
    <link rel="stylesheet" href="/static/css/responsive-layout.css">
    
    <!-- 核心功能样式 -->
    <link rel="stylesheet" href="/static/css/responsive-messages.css">
    <link rel="stylesheet" href="/static/css/chat-input-enhanced.css">
    <link rel="stylesheet" href="/static/css/conversation-avatar.css">
    
    <!-- UI组件样式 -->
    <link rel="stylesheet" href="/static/css/toast.css">
    <link rel="stylesheet" href="/static/css/modal-styles.css">
    <link rel="stylesheet" href="/static/css/button-styles.css">
    <link rel="stylesheet" href="/static/css/form-styles.css">
    
    <!-- 布局样式 -->
    <link rel="stylesheet" href="/static/css/top-bar.css">
    <link rel="stylesheet" href="/static/css/bottom-nav.css">
    <link rel="stylesheet" href="/static/css/mobile-layout.css">
    
    <!-- 功能模块样式 -->
    <link rel="stylesheet" href="/static/css/shop-card-styles.css">
    <link rel="stylesheet" href="/static/css/messages-list.css">
    <link rel="stylesheet" href="/static/css/state-styles.css">

    <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
    <div class="app-container">
        <!-- 桌面端侧边导航栏 -->
        <div data-include="/static/components/sidebar-nav.html"></div>
        
        <!-- 移动端顶部状态栏 -->
        <div data-include="/static/components/top-bar.html" class="d-md-none"></div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <div data-include="/static/components/main-content.html"></div>
        </div>

        <!-- 移动端底部导航栏 -->
        <div data-include="/static/components/bottom-nav.html" class="d-md-none"></div>
    </div>

    <!-- ==================== 核心JavaScript模块 ==================== -->
    
    <!-- 1. 基础设施层 (Core Infrastructure) -->
    <script src="/static/js/core/module-registry.js"></script>
    <script src="/static/js/core/constants.js"></script>
    <script src="/static/js/core/logger.js"></script>
    <script src="/static/js/core/event-bus.js"></script>
    <script src="/static/js/core/responsive-view-manager.js"></script>
    
    <!-- 2. 工具库层 (Utilities) -->
    <script src="/static/js/utils/global-utils.js"></script>
    <script src="/static/js/utils/auth-helper.js"></script>
    <script src="/static/js/utils/http-utils.js"></script>
    <script src="/static/js/utils/loading-utils.js"></script>
    <script src="/static/js/utils/notify-utils.js"></script>
    <script src="/static/js/utils/modal-utils.js"></script>
    <script src="/static/js/utils/partials-loader.js"></script>
    
    <!-- 开发工具 (仅开发环境) -->
    <script src="/static/js/utils/message-functionality-validator.js"></script>
    <script src="/static/js/utils/module-dependency-analyzer.js"></script>
    <script src="/static/js/utils/message-functionality-enhancer.js"></script>
    
    <!-- 3. 领域模型层 (Domain Models) -->
    <script src="/static/js/domain/entities/conversation.js"></script>
    <script src="/static/js/domain/entities/message.js"></script>
    <script src="/static/js/domain/entities/shop.js"></script>
    <script src="/static/js/domain/services/session-service.js"></script>
    
    <!-- 4. 消息核心模块 (Message Core) -->
    <script src="/static/js/message/core/message-event-bus.js"></script>
    <script src="/static/js/message/core/message-state-store.js"></script>
    <script src="/static/js/message/core/message-sender.js"></script>
    <script src="/static/js/message/ui/message-render-adapter.js"></script>
    
    <!-- 5. 业务管理器 (Business Managers) -->
    <script src="/static/js/usecases/shops-manager-clean.js"></script>
    <script src="/static/js/usecases/conversations-manager-clean.js"></script>
    <script src="/static/js/usecases/messages-manager-clean.js"></script>
    <script src="/static/js/usecases/media-handler.js"></script>
    
    <!-- 6. WebSocket通信层 (WebSocket Layer) -->
    <script src="/static/js/usecases/message-ws-adapter.js"></script>
    <!-- WebSocket基础设施 -->
    <script src="/static/js/websocket/websocket-base.js"></script>
    <script src="/static/js/websocket/ws-event-router.js"></script>
    <script src="/static/js/websocket/message-send-channel.js"></script>
    
    <!-- 7. 消息模块协调器 (Message Module Coordinator) -->
    <script src="/static/js/core/message-coordinator.js"></script>
    
    <!-- 8. UI组件层 (UI Components) -->
    <script src="/static/js/ui/toast.js"></script>
    <script src="/static/js/ui/empty-states.js"></script>
    <script src="/static/js/ui/loading-states.js"></script>
    <script src="/static/js/ui/message-bubble.js"></script>
    <script src="/static/js/ui/bottom-nav.js"></script>
    
    <!-- 9. 移动端适配器 (Mobile Adapters) -->
    <script src="/static/js/mobile/mobile-bootstrap.js"></script>
    <script src="/static/js/mobile/message-view-mobile-adapter.js"></script>
    <script src="/static/js/mobile/conversations-mobile-adapter.js"></script>
    <script src="/static/js/mobile/shops-mobile-adapter.js"></script>
    
    <!-- 10. 应用启动器 (App Bootstrap) -->
    <script src="/static/js/bootstrap/app-bootstrap.js"></script>
    <script src="/static/js/bootstrap/messages-micro-bootstrap.js"></script>
    
    <!-- 11. 模态框和表单 (Modals & Forms) -->
    <div data-include="/static/components/modals/modal-overlay.html"></div>
    <div data-include="/static/components/modals/shop-management-modal.html"></div>
    <div data-include="/static/components/modals/create-shop-modal.html"></div>
    <div data-include="/static/components/modals/edit-shop-modal.html"></div>
    <div data-include="/static/components/modals/integration-code-modal.html"></div>
    
    <!-- 模态框脚本 -->
    <script src="/static/js/modals/create-shop-modal.js"></script>
    <script src="/static/js/modals/edit-shop-modal.js"></script>
    <script src="/static/js/modals/integration-code-modal.js"></script>
    
    <!-- 12. 用例模块 (Essential Use Cases) -->
    <script src="/static/js/usecases/shop-actions.js"></script>
    <script src="/static/js/usecases/conversation-actions.js"></script>
    <script src="/static/js/usecases/page-navigation.js"></script>
    <script src="/static/js/usecases/auth-session.js"></script>
    
    <!-- 应用初始化 -->
    <script>
        console.log('📱 QuickTalk Mobile Dashboard (优化版) 已加载');
        
        // 初始化消息渲染适配器
        (function(){
            if (window.MessageRenderAdapter && !window.__MESSAGE_RENDER_INIT__) {
                try { 
                    window.MessageRenderAdapter.init(); 
                    window.__MESSAGE_RENDER_INIT__ = true; 
                } catch(e){ 
                    console.warn('MessageRenderAdapter init failed', e); 
                }
            }
        })();
        
        // 初始化消息发送通道
        (function(){
            if (!window.MessageSendChannel || window.MessageSendChannelInstance) return;
            try {
                window.MessageSendChannel.init({
                    debug: false,
                    conversationResolver: function(){ 
                        return window.MessageStateStore && window.MessageStateStore.currentConversationId; 
                    },
                    onLocalEnqueue: function(localMsg){ 
                        if (window.MessageStateStore && localMsg) {
                            const cid = localMsg.conversation_id;
                            window.MessageStateStore.appendMessage(cid, { ...localMsg });
                        }
                    },
                    onLocalPatch: function(tempId, patch){
                        if (!window.MessageStateStore) return;
                        const cid = window.MessageStateStore.currentConversationId;
                        const list = window.MessageStateStore.getCurrentMessages();
                        const idx = list.findIndex(m=>m.temp_id===tempId);
                        if (idx>=0){
                            list[idx] = { ...list[idx], ...patch };
                            window.MessageEventBus && window.MessageEventBus.publish('message.updated',{ message:list[idx], conversationId: cid });
                        }
                    },
                    onFinalized: function(tempId, serverMsg){
                        if (window.MessageStateStore && serverMsg && serverMsg.conversation_id){
                            window.MessageStateStore.replaceTemp(tempId, serverMsg);
                        }
                    },
                    ackTimeoutMs: 8000
                });
            } catch(e){ 
                console.warn('MessageSendChannel init failed', e); 
            }
        })();
    </script>
</body>
</html>