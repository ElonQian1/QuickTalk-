<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>超级管理员恢复工具（受限）</title>
  <style>
    body { font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial; background:#f6f7fb; color:#2c3e50; margin:0; }
    .container { max-width: 760px; margin: 40px auto; background:#fff; border-radius:16px; padding:24px 28px; box-shadow:0 6px 24px rgba(0,0,0,.06); }
    h1 { font-size:22px; margin:0 0 8px; }
    .sub { color:#6c757d; margin-bottom:20px; }
    .card { background:#f8f9fa; border:1px solid #e9ecef; border-radius:12px; padding:16px; margin:16px 0; }
    .row { display:flex; gap:16px; flex-wrap:wrap; }
    .stat { flex:1 1 150px; background:#fff; border:1px solid #e9ecef; border-radius:12px; padding:12px; text-align:center; }
    .stat .num { font-size:20px; font-weight:700; color:#3f51b5; }
    button { background:#667eea; color:#fff; border:none; border-radius:10px; padding:12px 16px; cursor:pointer; font-weight:600; }
    button:disabled { opacity:.6; cursor:not-allowed; }
    pre { background:#0b1021; color:#c7d2fe; border-radius:12px; padding:12px; overflow:auto; }
    .ok { color:#2e7d32; }
    .warn { color:#ef6c00; }
    .err { color:#c62828; }
    a { color:#667eea; text-decoration:none; }
  </style>
</head>
<body>
  <div class="container">
    <h1>🛡️ 超级管理员恢复工具（受限）</h1>
    <div class="sub">仅当系统内不存在任何 super_admin 时，允许创建/提升 admin/admin123 为超级管理员。</div>

    <div class="card">
      <div class="row">
        <div class="stat">
          <div>管理员总数</div>
          <div id="totalAdmins" class="num">-</div>
        </div>
        <div class="stat">
          <div>超级管理员数量</div>
          <div id="superAdmins" class="num">-</div>
        </div>
        <div class="stat">
          <div>店铺总数</div>
          <div id="totalShops" class="num">-</div>
        </div>
      </div>
      <div id="status" class="sub"></div>
      <div style="display:flex; gap:12px;">
        <button id="btnRefresh">刷新统计</button>
        <button id="btnRecover">执行恢复 admin → super_admin</button>
        <a href="/admin" target="_blank"><button type="button">打开后台</button></a>
      </div>
    </div>

    <div class="card">
      <div style="margin-bottom:8px; font-weight:600;">接口响应</div>
      <pre id="output">等待操作...</pre>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);

    async function fetchStats() {
      try {
        const res = await fetch('/api/admin/stats');
        const data = await res.json();
        if (!data.success) throw new Error(data.message || '获取统计失败');
        const admins = data.data?.admins || [];
        const superCount = admins.filter(a => a.role === 'super_admin').length;
        const total = data.data?.summary?.total_accounts ?? admins.length;
        const shops = data.data?.summary?.total_shops ?? 0;
        $('totalAdmins').textContent = total;
        $('superAdmins').textContent = superCount;
        $('totalShops').textContent = shops;
        $('status').innerHTML = superCount > 0
          ? '<span class="warn">系统已存在超级管理员，恢复按钮将返回拒绝信息（安全保护生效）。</span>'
          : '<span class="ok">未检测到超级管理员，可执行受限恢复。</span>';
        $('output').textContent = JSON.stringify(data, null, 2);
      } catch (e) {
        $('output').textContent = '获取统计失败: ' + e.message;
        $('status').innerHTML = '<span class="err">无法获取统计，请确认后端在线。</span>';
      }
    }

    async function recover() {
      $('btnRecover').disabled = true;
      $('output').textContent = '请求中...';
      try {
        const res = await fetch('/api/admin/recover-super-admin', { method: 'POST' });
        const data = await res.json();
        $('output').textContent = JSON.stringify(data, null, 2);
        await fetchStats();
      } catch (e) {
        $('output').textContent = '恢复失败: ' + e.message;
      } finally {
        $('btnRecover').disabled = false;
      }
    }

    $('btnRefresh').addEventListener('click', fetchStats);
    $('btnRecover').addEventListener('click', recover);
    fetchStats();
  </script>
</body>
</html>
