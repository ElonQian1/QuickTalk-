# ğŸ“Š ELonTalk æ•°æ®åº“åˆå§‹åŒ–åˆ†æ

## ğŸ” å½“å‰æ•°æ®åº“åˆå§‹åŒ–æœºåˆ¶

### 1. å¯åŠ¨æµç¨‹åˆ†æ

#### å¯åŠ¨è„šæœ¬ (`start.sh`)
```bash
./customer-service-backend  # ç›´æ¥å¯åŠ¨åç«¯ï¼Œæ²¡æœ‰æ•°æ®åº“åˆå§‹åŒ–æ­¥éª¤
```

**é—®é¢˜**: å¯åŠ¨è„šæœ¬**æ²¡æœ‰**ä¸»åŠ¨è¿›è¡Œæ•°æ®åº“åˆå§‹åŒ–ï¼

#### åç«¯ä»£ç ä¸­çš„åˆå§‹åŒ– (`main.rs`)
```rust
let db = Database::new(&db_url).await?;

// å…³é”®é—®é¢˜ï¼šè¿ç§»è¢«æ³¨é‡Šæ‰äº†ï¼
/*
if let Err(e) = db.migrate().await {
    error!(error=?e, "Database migration failed");
    return Err(e);
}
*/
info!("Database initialized, skipping migration for now");
```

**é—®é¢˜**: æ•°æ®åº“è¿ç§»åœ¨å¯åŠ¨æ—¶**è¢«è·³è¿‡**äº†ï¼

### 2. æ•°æ®åº“åˆ›å»ºæœºåˆ¶

#### Database::new() å‡½æ•°
```rust
pub async fn new(database_url: &str) -> Result<Self> {
    let pool = SqlitePoolOptions::new()
        .max_connections(10)
        .connect(database_url)  // åªè¿æ¥ï¼Œä¸åˆ›å»ºè¡¨ï¼
        .await?;
    Ok(Database { pool })
}
```

**é—®é¢˜**: `Database::new()` åªåˆ›å»ºè¿æ¥æ± ï¼Œ**ä¸åˆ›å»ºè¡¨ç»“æ„**ï¼

#### å»¶è¿Ÿåˆå§‹åŒ–æœºåˆ¶
æ•°æ®åº“è¡¨çš„åˆ›å»ºé‡‡ç”¨"æ‡’åŠ è½½"æ–¹å¼ï¼š
```rust
// åœ¨å„ä¸ªæ•°æ®åº“æ“ä½œå‡½æ•°ä¸­
if let Err(e) = insert_res {
    let msg = e.to_string().to_lowercase();
    if msg.contains("no such table") {
        self.migrate().await?;  // é‡åˆ°è¡¨ä¸å­˜åœ¨æ—¶æ‰è¿ç§»
        // ç„¶åé‡è¯•æ“ä½œ
    }
}
```

### 3. é—®é¢˜æ ¹æº

#### ä¸ºä»€ä¹ˆæ•°æ®åº“æ˜¯ç©ºçš„ï¼Ÿ
1. **å¯åŠ¨æ—¶ä¸è¿ç§»**: `main.rs` ä¸­è¿ç§»ä»£ç è¢«æ³¨é‡Šæ‰
2. **æ‡’åŠ è½½å¤±è´¥**: å»¶è¿Ÿåˆå§‹åŒ–å¯èƒ½åœ¨æŸäº›æƒ…å†µä¸‹ä¸è§¦å‘
3. **SQLiteæ–‡ä»¶åˆ›å»º**: è¿æ¥æ—¶ä¼šåˆ›å»ºç©ºæ–‡ä»¶ï¼Œä½†ä¸åˆ›å»ºè¡¨

#### å½“å‰è¡Œä¸º
1. å¯åŠ¨åç«¯ â†’ åˆ›å»ºç©ºçš„ `customer_service.db` æ–‡ä»¶ (0å­—èŠ‚)
2. ç”¨æˆ·å°è¯•ç™»å½•/æ³¨å†Œ â†’ æŸ¥è¯¢ä¸å­˜åœ¨çš„è¡¨ â†’ 500é”™è¯¯
3. ç†è®ºä¸Šåº”è¯¥è§¦å‘ `migrate()` â†’ ä½†å¯èƒ½ç”±äºæŸç§åŸå› å¤±è´¥

## ğŸ”§ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ1: ä¿®å¤å¯åŠ¨æ—¶è¿ç§»ï¼ˆæ¨èï¼‰

ä¿®æ”¹ `backend/src/main.rs`:
```rust
// å–æ¶ˆæ³¨é‡Šè¿ç§»ä»£ç 
if let Err(e) = db.migrate().await {
    error!(error=?e, "Database migration failed");
    return Err(e);
}
info!("Database migration completed successfully");
```

### æ–¹æ¡ˆ2: å¢å¼ºå¯åŠ¨è„šæœ¬

åœ¨ `start.sh` ä¸­æ·»åŠ æ•°æ®åº“æ£€æŸ¥ï¼š
```bash
# æ£€æŸ¥æ•°æ®åº“æ˜¯å¦éœ€è¦åˆå§‹åŒ–
if [ ! -f "customer_service.db" ] || [ ! -s "customer_service.db" ]; then
    echo "ğŸ”§ åˆå§‹åŒ–æ•°æ®åº“..."
    # ä½¿ç”¨schema.sqlåˆå§‹åŒ–
    sqlite3 customer_service.db < database_schema.sql
    echo "âœ… æ•°æ®åº“åˆå§‹åŒ–å®Œæˆ"
fi

# ç„¶åå¯åŠ¨æœåŠ¡
./customer-service-backend
```

### æ–¹æ¡ˆ3: å¼ºåˆ¶è¿ç§»è„šæœ¬

åˆ›å»ºç‹¬ç«‹çš„åˆå§‹åŒ–è„šæœ¬ï¼š
```bash
# init-database.sh
echo "ğŸ”§ å¼ºåˆ¶åˆå§‹åŒ–æ•°æ®åº“..."
rm -f customer_service.db
sqlite3 customer_service.db < database_schema.sql
echo "âœ… æ•°æ®åº“é‡æ–°åˆ›å»ºå®Œæˆ"
```

## ğŸ¯ æœ€ä½³å®è·µå»ºè®®

### 1. ç«‹å³ä¿®å¤
å–æ¶ˆæ³¨é‡Š `main.rs` ä¸­çš„è¿ç§»ä»£ç ï¼Œç¡®ä¿æ¯æ¬¡å¯åŠ¨éƒ½æ£€æŸ¥å¹¶åˆ›å»ºè¡¨ç»“æ„ã€‚

### 2. å¢å¼ºå¯åŠ¨è„šæœ¬
åœ¨å¯åŠ¨è„šæœ¬ä¸­æ·»åŠ æ•°æ®åº“çŠ¶æ€æ£€æŸ¥å’Œè‡ªåŠ¨ä¿®å¤æœºåˆ¶ã€‚

### 3. æ·»åŠ å¥åº·æ£€æŸ¥
åœ¨åç«¯æ·»åŠ æ•°æ®åº“è¿æ¥å’Œè¡¨ç»“æ„çš„å¥åº·æ£€æŸ¥ç«¯ç‚¹ã€‚

## ğŸ“‹ å½“å‰é—®é¢˜æ€»ç»“

1. âŒ **å¯åŠ¨è„šæœ¬ä¸å¤„ç†æ•°æ®åº“åˆå§‹åŒ–**
2. âŒ **åç«¯å¯åŠ¨æ—¶è·³è¿‡è¿ç§»**  
3. âŒ **å»¶è¿Ÿåˆå§‹åŒ–æœºåˆ¶å¯èƒ½å¤±æ•ˆ**
4. âŒ **æ²¡æœ‰æ•°æ®åº“çŠ¶æ€æ£€æŸ¥**

è¿™è§£é‡Šäº†ä¸ºä»€ä¹ˆä½ çš„æœåŠ¡å™¨ä¸Šæ•°æ®åº“æ–‡ä»¶æ˜¯0å­—èŠ‚ï¼Œå¯¼è‡´APIè°ƒç”¨æ—¶500é”™è¯¯ï¼

## ğŸš€ å»ºè®®çš„ä¿®å¤é¡ºåº

1. è¿è¡Œ `./fix-database.sh` ç«‹å³è§£å†³å½“å‰é—®é¢˜
2. ä¿®æ”¹åç«¯ä»£ç å–æ¶ˆæ³¨é‡Šè¿ç§»é€»è¾‘
3. å¢å¼ºå¯åŠ¨è„šæœ¬æ·»åŠ æ•°æ®åº“æ£€æŸ¥
4. é‡æ–°æ„å»ºå’Œéƒ¨ç½²