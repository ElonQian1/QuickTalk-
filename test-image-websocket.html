<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickTalk客服图片消息测试</title>
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: white; border-radius: 8px; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
        .message.system { background: #e3f2fd; }
        .message.user { background: #e8f5e9; text-align: right; }
        .message.staff { background: #fff3e0; }
        .message-type { font-size: 12px; color: #666; margin-bottom: 5px; }
        .message-content { word-wrap: break-word; }
        .message-image { max-width: 300px; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .message-image:hover { transform: scale(1.02); }
        .message-image-info { font-size: 12px; color: #666; margin-top: 5px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .controls button { padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .controls input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .status { padding: 10px; background: #e8f5e9; border-radius: 4px; margin-bottom: 20px; }
        .log { height: 200px; overflow-y: auto; background: #1e1e1e; color: #fff; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QuickTalk客服图片消息测试</h1>
        
        <div class="status" id="status">
            状态: 连接中...
        </div>
        
        <div class="test-panel">
            <h3>消息测试</h3>
            <div class="controls">
                <input type="text" id="messageInput" placeholder="输入测试消息...">
                <button onclick="sendMessage()">发送</button>
                <button onclick="simulateImageMessage()">模拟图片消息</button>
                <button onclick="clearMessages()">清空</button>
            </div>
            
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="message-type">SYSTEM</div>
                    <div class="message-content">WebSocket客服系统初始化中...</div>
                </div>
            </div>
        </div>
        
        <div class="test-panel">
            <h3>调试日志</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // 配置
        const config = {
            shopKey: 'sk_ji85ucic9p00m12as1ygf34o8humuxfl',
            shopId: 'shop_1757591780450_1',
            userId: 'test_user_' + Date.now(),
            wsUrl: 'ws://localhost:3030/ws'
        };
        
        let ws = null;
        let isConnected = false;
        
        // 日志函数
        function log(message, type = 'INFO') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`${type}: ${message}`);
        }
        
        // 更新状态
        function updateStatus(message, isGood = true) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `状态: ${message}`;
            statusDiv.style.background = isGood ? '#e8f5e9' : '#ffebee';
        }
        
        // 添加消息到界面
        function addMessage(type, content, metadata = {}) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let messageHTML = `<div class="message-type">${type.toUpperCase()}</div>`;
            
            // 检查是否是图片消息
            if (metadata.messageType === 'image' && metadata.fileUrl) {
                messageHTML += `
                    <div class="message-content">
                        <img src="${metadata.fileUrl}" 
                             alt="${metadata.fileName || '图片'}" 
                             class="message-image"
                             onclick="previewImage('${metadata.fileUrl}')">
                        <div class="message-image-info">
                            📷 ${metadata.fileName || '图片'}<br>
                            ${content !== '[图片]' ? content : ''}
                        </div>
                    </div>
                `;
            } else {
                messageHTML += `<div class="message-content">${content}</div>`;
            }
            
            messageDiv.innerHTML = messageHTML;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // WebSocket连接
        function connectWebSocket() {
            log('正在连接WebSocket...');
            updateStatus('连接中...', false);
            
            ws = new WebSocket(config.wsUrl);
            
            ws.onopen = function() {
                log('WebSocket连接成功');
                updateStatus('已连接', true);
                isConnected = true;
                
                // 发送认证
                const authData = {
                    type: 'auth',
                    userId: config.userId,
                    shopKey: config.shopKey,
                    shopId: config.shopId
                };
                ws.send(JSON.stringify(authData));
                log('发送认证信息: ' + JSON.stringify(authData));
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log(`收到消息: ${JSON.stringify(data)}`);
                    handleWebSocketMessage(data);
                } catch (e) {
                    log(`消息解析失败: ${event.data}`, 'ERROR');
                }
            };
            
            ws.onclose = function(event) {
                log(`WebSocket连接关闭: code=${event.code}`, 'WARN');
                updateStatus('连接断开', false);
                isConnected = false;
                
                // 5秒后重连
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                log('WebSocket错误: ' + error, 'ERROR');
                updateStatus('连接错误', false);
            };
        }
        
        // 处理WebSocket消息
        function handleWebSocketMessage(data) {
            log(`处理消息类型: ${data.type}`);
            
            switch (data.type) {
                case 'auth_success':
                    addMessage('system', '认证成功');
                    break;
                    
                case 'staff_message':
                    log(`客服消息数据: ${JSON.stringify(data, null, 2)}`);
                    
                    // 检查消息类型
                    const messageType = data.message_type || data.messageType;
                    const content = data.message || data.content || '[无内容]';
                    
                    if (messageType === 'image' && data.file_url) {
                        log(`检测到图片消息: ${data.file_url}`);
                        addMessage('staff', content, {
                            messageType: 'image',
                            fileUrl: data.file_url,
                            fileName: data.file_name
                        });
                    } else {
                        log(`文本消息: ${content}`);
                        addMessage('staff', content);
                    }
                    break;
                    
                case 'new_message':
                    log(`新消息格式: ${JSON.stringify(data.message || data)}`);
                    if (data.message) {
                        handleWebSocketMessage({
                            type: 'staff_message',
                            ...data.message
                        });
                    }
                    break;
                    
                case 'message_sent':
                    addMessage('system', '消息发送确认');
                    break;
                    
                default:
                    addMessage('system', `未知消息类型: ${data.type}`);
                    break;
            }
        }
        
        // 发送消息
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !isConnected) return;
            
            const data = {
                type: 'send_message',
                userId: config.userId,
                message: message,
                shopKey: config.shopKey,
                shopId: config.shopId,
                timestamp: Date.now()
            };
            
            ws.send(JSON.stringify(data));
            addMessage('user', message);
            input.value = '';
            log(`发送消息: ${message}`);
        }
        
        // 模拟图片消息（测试用）
        function simulateImageMessage() {
            const testImageMessage = {
                type: 'staff_message',
                message: '这是一张测试图片',
                content: '这是一张测试图片',
                message_type: 'image',
                file_url: 'http://localhost:3030/uploads/images/test-image.jpg',
                file_name: 'test-image.jpg',
                timestamp: Date.now()
            };
            
            log(`模拟图片消息: ${JSON.stringify(testImageMessage)}`);
            handleWebSocketMessage(testImageMessage);
        }
        
        // 清空消息
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            document.getElementById('log').textContent = '';
        }
        
        // 图片预览（简单版）
        function previewImage(url) {
            window.open(url, '_blank');
        }
        
        // 回车发送
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // 初始化
        window.addEventListener('load', function() {
            log('页面加载完成，初始化WebSocket连接');
            setTimeout(connectWebSocket, 1000);
        });
    </script>
</body>
</html>