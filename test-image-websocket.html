<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QuickTalkå®¢æœå›¾ç‰‡æ¶ˆæ¯æµ‹è¯•</title>
    <style>
        body { margin: 0; padding: 20px; font-family: -apple-system, BlinkMacSystemFont, sans-serif; }
        .container { max-width: 800px; margin: 0 auto; }
        .test-panel { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 20px; }
        .messages { height: 400px; overflow-y: auto; border: 1px solid #ddd; padding: 15px; background: white; border-radius: 8px; }
        .message { margin-bottom: 15px; padding: 10px; border-radius: 8px; }
        .message.system { background: #e3f2fd; }
        .message.user { background: #e8f5e9; text-align: right; }
        .message.staff { background: #fff3e0; }
        .message-type { font-size: 12px; color: #666; margin-bottom: 5px; }
        .message-content { word-wrap: break-word; }
        .message-image { max-width: 300px; border-radius: 8px; cursor: pointer; transition: transform 0.2s; }
        .message-image:hover { transform: scale(1.02); }
        .message-image-info { font-size: 12px; color: #666; margin-top: 5px; }
        .controls { display: flex; gap: 10px; margin-bottom: 20px; }
        .controls button { padding: 8px 16px; background: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer; }
        .controls input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px; }
        .status { padding: 10px; background: #e8f5e9; border-radius: 4px; margin-bottom: 20px; }
        .log { height: 200px; overflow-y: auto; background: #1e1e1e; color: #fff; padding: 10px; border-radius: 4px; font-family: 'Courier New', monospace; font-size: 12px; }
    </style>
</head>
<body>
    <div class="container">
        <h1>QuickTalkå®¢æœå›¾ç‰‡æ¶ˆæ¯æµ‹è¯•</h1>
        
        <div class="status" id="status">
            çŠ¶æ€: è¿æ¥ä¸­...
        </div>
        
        <div class="test-panel">
            <h3>æ¶ˆæ¯æµ‹è¯•</h3>
            <div class="controls">
                <input type="text" id="messageInput" placeholder="è¾“å…¥æµ‹è¯•æ¶ˆæ¯...">
                <button onclick="sendMessage()">å‘é€</button>
                <button onclick="simulateImageMessage()">æ¨¡æ‹Ÿå›¾ç‰‡æ¶ˆæ¯</button>
                <button onclick="clearMessages()">æ¸…ç©º</button>
            </div>
            
            <div class="messages" id="messages">
                <div class="message system">
                    <div class="message-type">SYSTEM</div>
                    <div class="message-content">WebSocketå®¢æœç³»ç»Ÿåˆå§‹åŒ–ä¸­...</div>
                </div>
            </div>
        </div>
        
        <div class="test-panel">
            <h3>è°ƒè¯•æ—¥å¿—</h3>
            <div class="log" id="log"></div>
        </div>
    </div>

    <script>
        // é…ç½®
        const config = {
            shopKey: 'sk_ji85ucic9p00m12as1ygf34o8humuxfl',
            shopId: 'shop_1757591780450_1',
            userId: 'test_user_' + Date.now(),
            wsUrl: 'ws://localhost:3030/ws'
        };
        
        let ws = null;
        let isConnected = false;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'INFO') {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = `[${timestamp}] ${type}: ${message}\n`;
            logDiv.textContent += logEntry;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(`${type}: ${message}`);
        }
        
        // æ›´æ–°çŠ¶æ€
        function updateStatus(message, isGood = true) {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = `çŠ¶æ€: ${message}`;
            statusDiv.style.background = isGood ? '#e8f5e9' : '#ffebee';
        }
        
        // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
        function addMessage(type, content, metadata = {}) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let messageHTML = `<div class="message-type">${type.toUpperCase()}</div>`;
            
            // æ£€æŸ¥æ˜¯å¦æ˜¯å›¾ç‰‡æ¶ˆæ¯
            if (metadata.messageType === 'image' && metadata.fileUrl) {
                messageHTML += `
                    <div class="message-content">
                        <img src="${metadata.fileUrl}" 
                             alt="${metadata.fileName || 'å›¾ç‰‡'}" 
                             class="message-image"
                             onclick="previewImage('${metadata.fileUrl}')">
                        <div class="message-image-info">
                            ğŸ“· ${metadata.fileName || 'å›¾ç‰‡'}<br>
                            ${content !== '[å›¾ç‰‡]' ? content : ''}
                        </div>
                    </div>
                `;
            } else {
                messageHTML += `<div class="message-content">${content}</div>`;
            }
            
            messageDiv.innerHTML = messageHTML;
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        // WebSocketè¿æ¥
        function connectWebSocket() {
            log('æ­£åœ¨è¿æ¥WebSocket...');
            updateStatus('è¿æ¥ä¸­...', false);
            
            ws = new WebSocket(config.wsUrl);
            
            ws.onopen = function() {
                log('WebSocketè¿æ¥æˆåŠŸ');
                updateStatus('å·²è¿æ¥', true);
                isConnected = true;
                
                // å‘é€è®¤è¯
                const authData = {
                    type: 'auth',
                    userId: config.userId,
                    shopKey: config.shopKey,
                    shopId: config.shopId
                };
                ws.send(JSON.stringify(authData));
                log('å‘é€è®¤è¯ä¿¡æ¯: ' + JSON.stringify(authData));
            };
            
            ws.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    log(`æ”¶åˆ°æ¶ˆæ¯: ${JSON.stringify(data)}`);
                    handleWebSocketMessage(data);
                } catch (e) {
                    log(`æ¶ˆæ¯è§£æå¤±è´¥: ${event.data}`, 'ERROR');
                }
            };
            
            ws.onclose = function(event) {
                log(`WebSocketè¿æ¥å…³é—­: code=${event.code}`, 'WARN');
                updateStatus('è¿æ¥æ–­å¼€', false);
                isConnected = false;
                
                // 5ç§’åé‡è¿
                setTimeout(connectWebSocket, 5000);
            };
            
            ws.onerror = function(error) {
                log('WebSocketé”™è¯¯: ' + error, 'ERROR');
                updateStatus('è¿æ¥é”™è¯¯', false);
            };
        }
        
        // å¤„ç†WebSocketæ¶ˆæ¯
        function handleWebSocketMessage(data) {
            log(`å¤„ç†æ¶ˆæ¯ç±»å‹: ${data.type}`);
            
            switch (data.type) {
                case 'auth_success':
                    addMessage('system', 'è®¤è¯æˆåŠŸ');
                    break;
                    
                case 'staff_message':
                    log(`å®¢æœæ¶ˆæ¯æ•°æ®: ${JSON.stringify(data, null, 2)}`);
                    
                    // æ£€æŸ¥æ¶ˆæ¯ç±»å‹
                    const messageType = data.message_type || data.messageType;
                    const content = data.message || data.content || '[æ— å†…å®¹]';
                    
                    if (messageType === 'image' && data.file_url) {
                        log(`æ£€æµ‹åˆ°å›¾ç‰‡æ¶ˆæ¯: ${data.file_url}`);
                        addMessage('staff', content, {
                            messageType: 'image',
                            fileUrl: data.file_url,
                            fileName: data.file_name
                        });
                    } else {
                        log(`æ–‡æœ¬æ¶ˆæ¯: ${content}`);
                        addMessage('staff', content);
                    }
                    break;
                    
                case 'new_message':
                    log(`æ–°æ¶ˆæ¯æ ¼å¼: ${JSON.stringify(data.message || data)}`);
                    if (data.message) {
                        handleWebSocketMessage({
                            type: 'staff_message',
                            ...data.message
                        });
                    }
                    break;
                    
                case 'message_sent':
                    addMessage('system', 'æ¶ˆæ¯å‘é€ç¡®è®¤');
                    break;
                    
                default:
                    addMessage('system', `æœªçŸ¥æ¶ˆæ¯ç±»å‹: ${data.type}`);
                    break;
            }
        }
        
        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message || !isConnected) return;
            
            const data = {
                type: 'send_message',
                userId: config.userId,
                message: message,
                shopKey: config.shopKey,
                shopId: config.shopId,
                timestamp: Date.now()
            };
            
            ws.send(JSON.stringify(data));
            addMessage('user', message);
            input.value = '';
            log(`å‘é€æ¶ˆæ¯: ${message}`);
        }
        
        // æ¨¡æ‹Ÿå›¾ç‰‡æ¶ˆæ¯ï¼ˆæµ‹è¯•ç”¨ï¼‰
        function simulateImageMessage() {
            const testImageMessage = {
                type: 'staff_message',
                message: 'è¿™æ˜¯ä¸€å¼ æµ‹è¯•å›¾ç‰‡',
                content: 'è¿™æ˜¯ä¸€å¼ æµ‹è¯•å›¾ç‰‡',
                message_type: 'image',
                file_url: 'http://localhost:3030/uploads/images/test-image.jpg',
                file_name: 'test-image.jpg',
                timestamp: Date.now()
            };
            
            log(`æ¨¡æ‹Ÿå›¾ç‰‡æ¶ˆæ¯: ${JSON.stringify(testImageMessage)}`);
            handleWebSocketMessage(testImageMessage);
        }
        
        // æ¸…ç©ºæ¶ˆæ¯
        function clearMessages() {
            document.getElementById('messages').innerHTML = '';
            document.getElementById('log').textContent = '';
        }
        
        // å›¾ç‰‡é¢„è§ˆï¼ˆç®€å•ç‰ˆï¼‰
        function previewImage(url) {
            window.open(url, '_blank');
        }
        
        // å›è½¦å‘é€
        document.getElementById('messageInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });
        
        // åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–WebSocketè¿æ¥');
            setTimeout(connectWebSocket, 1000);
        });
    </script>
</body>
</html>