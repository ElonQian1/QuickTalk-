<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限控制测试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        
        .test-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-title {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
            margin-bottom: 15px;
        }
        
        .test-result {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        #console {
            background: #2d3748;
            color: #e2e8f0;
            padding: 15px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
    </style>
</head>
<body>
    <h1>🔒 QuickTalk 权限控制测试</h1>
    
    <div class="test-card">
        <h2 class="test-title">测试目标</h2>
        <p>验证未登录用户是否还能看到消息搜索模块（修复Bug）</p>
        <ul>
            <li>✅ 未登录状态：不应该看到搜索界面</li>
            <li>✅ 登录后有数据：应该看到搜索界面</li>
            <li>✅ 登录后无数据：暂时不显示搜索界面</li>
        </ul>
    </div>

    <div class="test-card">
        <h2 class="test-title">当前状态检测</h2>
        <button onclick="checkLoginStatus()">检查登录状态</button>
        <button onclick="checkSearchInterface()">检查搜索界面</button>
        <button onclick="testSearchInit()">测试搜索初始化</button>
        <button onclick="clearStorage()">清除本地存储</button>
        <div id="status-results"></div>
    </div>

    <div class="test-card">
        <h2 class="test-title">测试流程</h2>
        <button onclick="runFullTest()">运行完整测试</button>
        <div id="test-results"></div>
    </div>

    <div class="test-card">
        <h2 class="test-title">控制台日志</h2>
        <button onclick="clearConsole()">清除日志</button>
        <div id="console"></div>
    </div>

    <script>
        // 重写console.log来显示在页面上
        const originalConsoleLog = console.log;
        const originalConsoleError = console.error;
        const originalConsoleWarn = console.warn;
        
        const consoleDiv = document.getElementById('console');
        
        function addToConsole(type, message) {
            const timestamp = new Date().toLocaleTimeString();
            const prefix = type === 'error' ? '❌' : type === 'warn' ? '⚠️' : '📝';
            consoleDiv.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            consoleDiv.scrollTop = consoleDiv.scrollHeight;
        }
        
        console.log = function(...args) {
            originalConsoleLog.apply(console, args);
            addToConsole('log', args.join(' '));
        };
        
        console.error = function(...args) {
            originalConsoleError.apply(console, args);
            addToConsole('error', args.join(' '));
        };
        
        console.warn = function(...args) {
            originalConsoleWarn.apply(console, args);
            addToConsole('warn', args.join(' '));
        };

        function clearConsole() {
            consoleDiv.textContent = '';
        }

        function showResult(containerId, message, type = 'success') {
            const container = document.getElementById(containerId);
            const div = document.createElement('div');
            div.className = `test-result ${type}`;
            div.textContent = message;
            container.appendChild(div);
        }

        function clearResults(containerId) {
            document.getElementById(containerId).innerHTML = '';
        }

        function checkLoginStatus() {
            clearResults('status-results');
            
            const sessionId = localStorage.getItem('sessionId');
            const currentUser = localStorage.getItem('currentUser');
            
            if (sessionId) {
                showResult('status-results', `✅ 用户已登录 SessionId: ${sessionId}`, 'success');
                if (currentUser) {
                    const user = JSON.parse(currentUser);
                    showResult('status-results', `👤 当前用户: ${user.username}`, 'success');
                }
            } else {
                showResult('status-results', '🔒 用户未登录', 'warning');
            }
            
            console.log('检查登录状态完成');
        }

        function checkSearchInterface() {
            clearResults('status-results');
            
            const searchPanel = document.getElementById('searchPanel');
            const messageSearchManager = window.messageSearchManager;
            
            if (searchPanel) {
                showResult('status-results', '❌ 发现搜索界面存在（可能是Bug）', 'error');
            } else {
                showResult('status-results', '✅ 搜索界面不存在（正确）', 'success');
            }
            
            if (messageSearchManager) {
                showResult('status-results', '❌ 搜索管理器已初始化（可能是Bug）', 'error');
            } else {
                showResult('status-results', '✅ 搜索管理器未初始化（正确）', 'success');
            }
            
            console.log('检查搜索界面完成');
        }

        function testSearchInit() {
            clearResults('status-results');
            
            if (typeof initMessageSearch === 'function') {
                showResult('status-results', '✅ initMessageSearch 函数存在', 'success');
                
                const result = initMessageSearch();
                if (result) {
                    showResult('status-results', '⚠️ 搜索初始化成功', 'warning');
                } else {
                    showResult('status-results', '✅ 搜索初始化被正确阻止', 'success');
                }
            } else {
                showResult('status-results', '❌ initMessageSearch 函数不存在', 'error');
            }
            
            console.log('测试搜索初始化完成');
        }

        function clearStorage() {
            localStorage.clear();
            sessionStorage.clear();
            showResult('status-results', '🧹 本地存储已清除', 'success');
            console.log('本地存储已清除');
        }

        async function runFullTest() {
            clearResults('test-results');
            console.log('🚀 开始运行完整测试...');
            
            // 测试1：清除存储，检查未登录状态
            localStorage.clear();
            showResult('test-results', '测试1: 清除存储，模拟未登录状态', 'success');
            
            // 等待一下让状态更新
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const searchPanelBefore = document.getElementById('searchPanel');
            if (!searchPanelBefore && !window.messageSearchManager) {
                showResult('test-results', '✅ 未登录状态下搜索功能被正确阻止', 'success');
            } else {
                showResult('test-results', '❌ 未登录状态下仍然有搜索功能', 'error');
            }
            
            // 测试2：模拟登录
            showResult('test-results', '测试2: 模拟用户登录', 'success');
            localStorage.setItem('sessionId', 'test_session_' + Date.now());
            localStorage.setItem('currentUser', JSON.stringify({
                id: 1,
                username: 'test_user',
                role: 'shop_owner'
            }));
            
            // 测试3：尝试初始化搜索功能
            showResult('test-results', '测试3: 尝试初始化搜索功能', 'success');
            if (typeof initMessageSearch === 'function') {
                const initResult = initMessageSearch();
                if (initResult) {
                    showResult('test-results', '✅ 登录后搜索功能可以正常初始化', 'success');
                } else {
                    showResult('test-results', '⚠️ 登录后搜索功能初始化失败（可能因为没有消息容器）', 'warning');
                }
            }
            
            console.log('✅ 完整测试完成');
        }

        // 页面加载时自动检查状态
        window.addEventListener('load', () => {
            console.log('🔍 权限控制测试页面已加载');
            checkLoginStatus();
            checkSearchInterface();
        });
    </script>
</body>
</html>
