<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>权限控制测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .test-section {
            margin-bottom: 30px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
        }
        .user-switch {
            background: #667eea;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            margin: 5px;
            cursor: pointer;
        }
        .user-switch:hover {
            background: #5a6fd8;
        }
        .user-switch.active {
            background: #28a745;
        }
        .permission-result {
            margin: 10px 0;
            padding: 8px;
            border-radius: 4px;
        }
        .permission-result.allowed {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .permission-result.denied {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        .shop-management-demo {
            border: 1px solid #ddd;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            background: #f8f9fa;
        }
        .option-btn {
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 12px 16px;
            font-size: 14px;
            color: #495057;
            cursor: pointer;
            transition: all 0.2s ease;
            text-align: left;
            display: block;
            width: 100%;
            margin: 5px 0;
        }
        .option-btn:hover {
            border-color: #667eea;
            background: #f8f9ff;
            color: #667eea;
        }
        .option-btn.success {
            color: #28a745;
            border-color: #28a745;
        }
        .option-btn.warning {
            color: #ffc107;
            border-color: #ffc107;
        }
        .option-btn.primary {
            color: #667eea;
            border-color: #667eea;
        }
        .option-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background: #f8f9fa;
        }
        .info-message {
            background: #e7f1ff;
            border: 1px solid #b8daff;
            border-radius: 8px;
            padding: 12px;
            margin: 10px 0;
            font-size: 14px;
        }
        .info-message.success {
            background: #d4edda;
            border-color: #c3e6cb;
            color: #155724;
        }
        .info-message.warning {
            background: #fff3cd;
            border-color: #ffeaa7;
            color: #856404;
        }
        .info-message.error {
            background: #f8d7da;
            border-color: #f5c6cb;
            color: #721c24;
        }
        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-approved { background: #e7f1ff; color: #0c5aa6; }
        .status-active { background: #d4edda; color: #155724; }
        .status-inactive { background: #f8d7da; color: #721c24; }
        .status-rejected { background: #f8d7da; color: #721c24; }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔐 权限控制系统测试</h1>
        
        <div class="test-section">
            <h3>用户身份切换</h3>
            <p>当前用户: <span id="current-user">未设置</span></p>
            <button class="user-switch" onclick="switchUser('admin')">管理员 (admin)</button>
            <button class="user-switch" onclick="switchUser('shop_owner')">店主 (shop_owner)</button>
            <button class="user-switch" onclick="switchUser('agent')">客服 (agent)</button>
        </div>

        <div class="test-section">
            <h3>权限检查测试</h3>
            <button onclick="testPermissions()">测试所有权限</button>
            <div id="permission-results"></div>
        </div>

        <div class="test-section">
            <h3>店铺管理界面预览</h3>
            <p>选择店铺状态查看不同用户看到的管理界面：</p>
            <select id="shop-status" onchange="updateShopDemo()">
                <option value="pending">待审核 (pending)</option>
                <option value="approved">已批准 (approved)</option>
                <option value="active">活跃 (active)</option>
                <option value="inactive">非活跃 (inactive)</option>
                <option value="rejected">已拒绝 (rejected)</option>
            </select>
            <div id="shop-demo"></div>
        </div>
    </div>

    <script>
        // 模拟用户数据
        let userData = { role: 'shop_owner', username: '测试用户' };
        
        // 切换用户身份
        function switchUser(role) {
            userData.role = role;
            document.getElementById('current-user').textContent = `${role} (${getRoleText(role)})`;
            
            // 更新按钮状态
            document.querySelectorAll('.user-switch').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            // 重新测试权限
            testPermissions();
            updateShopDemo();
        }

        function getRoleText(role) {
            const roleMap = {
                'super_admin': '超级管理员',
                'admin': '管理员',
                'shop_owner': '店主',
                'agent': '客服'
            };
            return roleMap[role] || role;
        }

        // 权限检查函数（从原系统复制）
        function isAdmin() {
            return userData && (userData.role === 'admin' || userData.role === 'super_admin');
        }

        function canManageShops() {
            return isAdmin();
        }

        function canApproveShops() {
            return isAdmin();
        }

        function hasActionPermission(action) {
            const userIsAdmin = isAdmin();
            
            const adminOnlyActions = ['approve', 'reject', 'activate', 'deactivate'];
            if (adminOnlyActions.includes(action) && !userIsAdmin) {
                return false;
            }
            
            const publicActions = ['edit', 'integration'];
            if (publicActions.includes(action)) {
                return true;
            }
            
            if (action === 'employees') {
                return userIsAdmin || (userData.role === 'shop_owner');
            }
            
            return true;
        }

        function getStatusText(status) {
            const statusMap = {
                'pending': '待审核',
                'approved': '已批准',
                'active': '活跃',
                'rejected': '已拒绝',
                'inactive': '非活跃'
            };
            return statusMap[status] || status;
        }

        // 测试所有权限
        function testPermissions() {
            const actions = ['approve', 'reject', 'activate', 'deactivate', 'edit', 'employees', 'integration'];
            const resultsDiv = document.getElementById('permission-results');
            
            let html = '<h4>权限测试结果：</h4>';
            actions.forEach(action => {
                const allowed = hasActionPermission(action);
                const resultClass = allowed ? 'allowed' : 'denied';
                const resultText = allowed ? '✅ 允许' : '❌ 拒绝';
                html += `<div class="permission-result ${resultClass}">
                    <strong>${action}</strong>: ${resultText}
                </div>`;
            });
            
            resultsDiv.innerHTML = html;
        }

        // 生成店铺管理演示
        function generateManagementDemo(shop) {
            const userIsAdmin = isAdmin();
            let optionsHtml = '<div class="management-options">';
            
            if (userIsAdmin) {
                optionsHtml += `
                    <div class="option-group">
                        <h4>管理员操作</h4>
                        <div class="admin-info">
                            <p><strong>店铺:</strong> ${shop.name}</p>
                            <p><strong>状态:</strong> <span class="status-badge status-${shop.status}">${getStatusText(shop.status)}</span></p>
                        </div>
                `;
                
                switch (shop.status) {
                    case 'pending':
                        optionsHtml += `
                            <button class="option-btn success" onclick="simulateAction('approve')">
                                ✅ 批准店铺
                            </button>
                            <button class="option-btn warning" onclick="simulateAction('reject')">
                                ❌ 拒绝店铺
                            </button>
                        `;
                        break;
                    case 'approved':
                        optionsHtml += `
                            <button class="option-btn primary" onclick="simulateAction('activate')">
                                🚀 激活店铺
                            </button>
                            <button class="option-btn warning" onclick="simulateAction('reject')">
                                ❌ 撤销批准
                            </button>
                        `;
                        break;
                    case 'active':
                        optionsHtml += `
                            <button class="option-btn warning" onclick="simulateAction('deactivate')">
                                ⏸️ 停用店铺
                            </button>
                        `;
                        break;
                    case 'inactive':
                        optionsHtml += `
                            <button class="option-btn primary" onclick="simulateAction('activate')">
                                🚀 重新激活
                            </button>
                        `;
                        break;
                    case 'rejected':
                        optionsHtml += `
                            <button class="option-btn success" onclick="simulateAction('approve')">
                                ✅ 重新批准
                            </button>
                        `;
                        break;
                }
                
                optionsHtml += `
                    </div>
                    <div class="option-group">
                        <h4>通用管理</h4>
                        <button class="option-btn" onclick="simulateAction('employees')">
                            👥 员工管理
                        </button>
                        <button class="option-btn" onclick="simulateAction('edit')">
                            ✏️ 编辑信息
                        </button>
                        <button class="option-btn" onclick="simulateAction('integration')">
                            🔗 集成代码
                        </button>
                    </div>
                `;
            } else {
                optionsHtml += `
                    <div class="option-group">
                        <h4>店铺管理</h4>
                        <div class="shop-owner-info">
                            <p><strong>店铺:</strong> ${shop.name}</p>
                            <p><strong>状态:</strong> <span class="status-badge status-${shop.status}">${getStatusText(shop.status)}</span></p>
                        </div>
                `;
                
                switch (shop.status) {
                    case 'pending':
                        optionsHtml += `
                            <div class="info-message">
                                <p>您的店铺正在审核中，请耐心等待管理员审核。</p>
                            </div>
                            <button class="option-btn" onclick="simulateAction('edit')">
                                ✏️ 编辑信息
                            </button>
                        `;
                        break;
                    case 'approved':
                        optionsHtml += `
                            <div class="info-message success">
                                <p>恭喜！您的店铺已通过审核，请付费激活。</p>
                            </div>
                            <button class="option-btn primary" onclick="simulateAction('pay')">
                                💳 付费激活
                            </button>
                        `;
                        break;
                    case 'active':
                        optionsHtml += `
                            <div class="info-message success">
                                <p>您的店铺正在正常运营中。</p>
                            </div>
                            <button class="option-btn" onclick="simulateAction('employees')">
                                👥 员工管理
                            </button>
                            <button class="option-btn" onclick="simulateAction('integration')">
                                🔗 集成代码
                            </button>
                        `;
                        break;
                    case 'inactive':
                        optionsHtml += `
                            <div class="info-message warning">
                                <p>您的店铺已停用，请续费重新激活。</p>
                            </div>
                            <button class="option-btn primary" onclick="simulateAction('renew')">
                                💳 续费激活
                            </button>
                        `;
                        break;
                    case 'rejected':
                        optionsHtml += `
                            <div class="info-message error">
                                <p>很抱歉，您的店铺审核未通过，请修改后重新申请。</p>
                            </div>
                            <button class="option-btn warning" onclick="simulateAction('edit')">
                                ✏️ 修改信息
                            </button>
                        `;
                        break;
                }
                
                optionsHtml += `
                        <button class="option-btn" onclick="simulateAction('view')">
                            👁️ 查看详情
                        </button>
                    </div>
                `;
            }
            
            optionsHtml += '</div>';
            return optionsHtml;
        }

        function updateShopDemo() {
            const status = document.getElementById('shop-status').value;
            const shop = {
                id: 1,
                name: '测试店铺',
                status: status,
                domain: 'test.example.com',
                created_at: '2024-01-01'
            };
            
            const demoHtml = generateManagementDemo(shop);
            document.getElementById('shop-demo').innerHTML = `
                <div class="shop-management-demo">
                    <h4>当前用户角色: ${getRoleText(userData.role)}</h4>
                    ${demoHtml}
                </div>
            `;
        }

        function simulateAction(action) {
            if (hasActionPermission(action)) {
                alert(`✅ 权限允许：执行 ${action} 操作`);
            } else {
                alert(`❌ 权限拒绝：您没有权限执行 ${action} 操作`);
            }
        }

        // 初始化
        switchUser('shop_owner');
        updateShopDemo();
    </script>
</body>
</html>