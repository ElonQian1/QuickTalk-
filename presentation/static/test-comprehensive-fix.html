<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>ç»¼åˆæ˜¾ç¤ºä¿®å¤æµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .shop-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 6px; background: #fff; }
        .shop-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .shop-icon { width: 40px; height: 40px; border-radius: 50%; background: #007bff; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .shop-status { padding: 4px 8px; border-radius: 12px; font-size: 12px; color: white; }
        .status-active { background: #28a745; }
        .status-inactive { background: #6c757d; }
        .shop-name { font-size: 18px; font-weight: bold; margin: 10px 0 5px 0; }
        .shop-domain { color: #6c757d; font-size: 14px; margin-bottom: 15px; }
        .shop-stats { display: flex; gap: 20px; }
        .shop-stat { text-align: center; }
        .shop-stat-value { font-size: 24px; font-weight: bold; color: #007bff; }
        .shop-stat-label { font-size: 12px; color: #6c757d; }
        .conversation-item { border: 1px solid #eee; padding: 15px; margin: 10px 0; border-radius: 6px; background: #fff; display: flex; align-items: center; gap: 15px; }
        .conversation-avatar { width: 40px; height: 40px; border-radius: 50%; background: #6c757d; color: white; display: flex; align-items: center; justify-content: center; font-weight: bold; }
        .conversation-content { flex: 1; }
        .conversation-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .customer-name { font-weight: bold; }
        .message-time { font-size: 12px; color: #999; }
        .last-message { font-size: 14px; color: #333; }
        .unread-badge { background: #dc3545; color: white; padding: 4px 8px; border-radius: 12px; font-size: 12px; min-width: 20px; text-align: center; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .test-button.danger { background: #dc3545; }
        .test-button.success { background: #28a745; }
        .debug-info { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; font-size: 12px; white-space: pre-wrap; }
        .status-indicator { display: inline-block; width: 10px; height: 10px; border-radius: 50%; margin-right: 5px; }
        .status-ok { background: #28a745; }
        .status-error { background: #dc3545; }
        .status-warning { background: #ffc107; }
    </style>
</head>
<body>
    <h1>ğŸ”§ ç»¼åˆæ˜¾ç¤ºä¿®å¤æµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š æ¨¡å—çŠ¶æ€ç›‘æ§</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="test-button" onclick="checkAllModules()">æ£€æŸ¥æ‰€æœ‰æ¨¡å—</button>
            <button class="test-button" onclick="enableAllDebug()">å¯ç”¨å…¨éƒ¨è°ƒè¯•</button>
            <button class="test-button danger" onclick="clearAllCache()">æ¸…ç©ºç¼“å­˜</button>
        </div>
        <div id="moduleStatus" class="debug-info">ç‚¹å‡»"æ£€æŸ¥æ‰€æœ‰æ¨¡å—"æŸ¥çœ‹çŠ¶æ€</div>
    </div>

    <div class="test-section">
        <h2>ğŸª æµ‹è¯•åº—é“ºæ•°æ®</h2>
        
        <!-- æµ‹è¯•åº—é“º1 -->
        <div class="shop-card" data-shop-id="test-shop-001">
            <div class="shop-header">
                <div class="shop-icon">T</div>
                <div class="shop-status status-inactive" data-shop-id="test-shop-001">ç­‰å¾…ä¸­</div>
            </div>
            <div class="shop-name">æµ‹è¯•åº—é“º001</div>
            <div class="shop-domain">test-shop-001.example.com</div>
            <div class="shop-stats">
                <div class="shop-stat" data-stat-type="å¯¹è¯" data-shop-id="test-shop-001">
                    <div class="shop-stat-value">0</div>
                    <div class="shop-stat-label">å¯¹è¯</div>
                </div>
                <div class="shop-stat" data-stat-type="æœªè¯»" data-shop-id="test-shop-001">
                    <div class="shop-stat-value">0</div>
                    <div class="shop-stat-label">æœªè¯»</div>
                </div>
            </div>
        </div>
        
        <!-- æµ‹è¯•åº—é“º2 -->
        <div class="shop-card" data-shop-id="test-shop-002">
            <div class="shop-header">
                <div class="shop-icon">S</div>
                <div class="shop-status status-active" data-shop-id="test-shop-002">æœ‰å¯¹è¯</div>
            </div>
            <div class="shop-name">ç¤ºä¾‹åº—é“º002</div>
            <div class="shop-domain">sample-shop-002.example.com</div>
            <div class="shop-stats">
                <div class="shop-stat" data-stat-type="å¯¹è¯" data-shop-id="test-shop-002">
                    <div class="shop-stat-value">5</div>
                    <div class="shop-stat-label">å¯¹è¯</div>
                </div>
                <div class="shop-stat" data-stat-type="æœªè¯»" data-shop-id="test-shop-002">
                    <div class="shop-stat-value">3</div>
                    <div class="shop-stat-label">æœªè¯»</div>
                </div>
            </div>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="test-button" onclick="testShopUpdate('test-shop-001')">æ›´æ–°åº—é“º001æ•°æ®</button>
            <button class="test-button" onclick="testShopUpdate('test-shop-002')">æ›´æ–°åº—é“º002æ•°æ®</button>
            <button class="test-button success" onclick="refreshAllShops()">åˆ·æ–°æ‰€æœ‰åº—é“º</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ’¬ æµ‹è¯•å¯¹è¯æ•°æ®</h2>
        
        <!-- æµ‹è¯•å¯¹è¯1 -->
        <div class="conversation-item" data-conversation-id="conv-001" data-shop-id="test-shop-001">
            <div class="conversation-avatar">1</div>
            <div class="conversation-content">
                <div class="conversation-header">
                    <span class="customer-name">å®¢æˆ·001</span>
                    <span class="message-time" data-conversation-id="conv-001">2025-09-29 16:30:00</span>
                </div>
                <div class="last-message" data-conversation-id="conv-001">ç­‰å¾…å®¢æˆ·æ¶ˆæ¯...</div>
            </div>
            <div class="unread-badge" data-conversation-id="conv-001" style="display: none;">0</div>
        </div>
        
        <!-- æµ‹è¯•å¯¹è¯2 -->
        <div class="conversation-item" data-conversation-id="conv-002" data-shop-id="test-shop-002">
            <div class="conversation-avatar">2</div>
            <div class="conversation-content">
                <div class="conversation-header">
                    <span class="customer-name">å®¢æˆ·002</span>
                    <span class="message-time" data-conversation-id="conv-002">2025-09-29 15:45:30</span>
                </div>
                <div class="last-message" data-conversation-id="conv-002">ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹äº§å“ä¿¡æ¯</div>
            </div>
            <div class="unread-badge" data-conversation-id="conv-002">2</div>
        </div>
        
        <div style="margin-top: 15px;">
            <button class="test-button" onclick="testMessageUpdate('conv-001')">æ›´æ–°å¯¹è¯001æ¶ˆæ¯</button>
            <button class="test-button" onclick="testMessageUpdate('conv-002')">æ›´æ–°å¯¹è¯002æ¶ˆæ¯</button>
            <button class="test-button success" onclick="refreshAllConversations()">åˆ·æ–°æ‰€æœ‰å¯¹è¯</button>
        </div>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ è‡ªåŠ¨æµ‹è¯•æ§åˆ¶</h2>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;">
            <button class="test-button success" onclick="startAutoTest()">å¼€å§‹è‡ªåŠ¨æµ‹è¯•</button>
            <button class="test-button danger" onclick="stopAutoTest()">åœæ­¢è‡ªåŠ¨æµ‹è¯•</button>
            <button class="test-button" onclick="runSingleTest()">è¿è¡Œå•æ¬¡æµ‹è¯•</button>
            <button class="test-button" onclick="getFixStatus()">è·å–ä¿®å¤çŠ¶æ€</button>
        </div>
        <div id="autoTestStatus" class="debug-info">è‡ªåŠ¨æµ‹è¯•æœªè¿è¡Œ</div>
    </div>

    <div class="test-section">
        <h2>ğŸ“‹ å®æ—¶æ—¥å¿—</h2>
        <button class="test-button" onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
        <div id="testLogs" class="debug-info" style="height: 200px; overflow-y: auto;">æ—¥å¿—å°†æ˜¾ç¤ºåœ¨è¿™é‡Œ...</div>
    </div>

    <!-- å¼•å…¥æ‰€æœ‰æ¨¡å— -->
    <script src="/js/dom-enhancer.js"></script>
    <script src="/js/realtime-data-manager.js"></script>
    <script src="/js/data-sync-manager.js"></script>
    <script src="/js/display-fixer.js"></script>

    <script>
        let autoTestInterval = null;
        let messageCounter = 0;
        
        // æ—¥å¿—å‡½æ•°
        function log(message, type = 'info') {
            const logs = document.getElementById('testLogs');
            const timestamp = new Date().toLocaleTimeString();
            const typeIcon = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logs.innerHTML += `[${timestamp}] ${typeIcon} ${message}\n`;
            logs.scrollTop = logs.scrollHeight;
            console.log(`[æµ‹è¯•] ${message}`);
        }

        function clearLogs() {
            document.getElementById('testLogs').innerHTML = '';
        }

        // æ£€æŸ¥æ‰€æœ‰æ¨¡å—çŠ¶æ€
        function checkAllModules() {
            const status = document.getElementById('moduleStatus');
            let info = '<h3>æ¨¡å—åŠ è½½çŠ¶æ€:</h3>';
            
            const modules = [
                'DOMEnhancer',
                'RealtimeDataManager', 
                'DataSyncManager',
                'DisplayFixer'
            ];
            
            modules.forEach(moduleName => {
                const module = window[moduleName];
                const isLoaded = typeof module !== 'undefined';
                const statusIcon = isLoaded ? 'âœ…' : 'âŒ';
                info += `<p>${statusIcon} ${moduleName}: ${typeof module}</p>`;
                
                if (isLoaded && module.getDebugInfo) {
                    try {
                        const debugInfo = module.getDebugInfo ? module.getDebugInfo() : 
                                        module.getFixStatus ? module.getFixStatus() :
                                        module.getEnhancementStatus ? module.getEnhancementStatus() : {};
                        info += `<pre>  ${JSON.stringify(debugInfo, null, 2)}</pre>`;
                    } catch (e) {
                        info += `<p>  è°ƒè¯•ä¿¡æ¯è·å–å¤±è´¥: ${e.message}</p>`;
                    }
                }
            });
            
            status.innerHTML = info;
            log('æ¨¡å—çŠ¶æ€æ£€æŸ¥å®Œæˆ');
        }

        // å¯ç”¨æ‰€æœ‰è°ƒè¯•æ¨¡å¼
        function enableAllDebug() {
            const modules = ['DOMEnhancer', 'RealtimeDataManager', 'DataSyncManager', 'DisplayFixer'];
            let enabledCount = 0;
            
            modules.forEach(moduleName => {
                const module = window[moduleName];
                if (module && module.enableDebugMode) {
                    module.enableDebugMode();
                    enabledCount++;
                }
            });
            
            log(`å·²å¯ç”¨ ${enabledCount} ä¸ªæ¨¡å—çš„è°ƒè¯•æ¨¡å¼`, 'success');
        }

        // æ¸…ç©ºæ‰€æœ‰ç¼“å­˜
        function clearAllCache() {
            ['DataSyncManager', 'RealtimeDataManager'].forEach(moduleName => {
                const module = window[moduleName];
                if (module && module.clearCache) {
                    module.clearCache();
                }
            });
            
            localStorage.clear(); // æ¸…ç©ºlocalStorage
            log('æ‰€æœ‰ç¼“å­˜å·²æ¸…ç©º', 'success');
        }

        // æµ‹è¯•åº—é“ºæ›´æ–°
        function testShopUpdate(shopId) {
            const stats = {
                conversation_count: Math.floor(Math.random() * 15) + 1,
                unread_count: Math.floor(Math.random() * 8)
            };
            
            log(`æ¨¡æ‹Ÿåº—é“º ${shopId} æ›´æ–°: å¯¹è¯${stats.conversation_count}, æœªè¯»${stats.unread_count}`);
            
            if (window.DataSyncManager) {
                window.DataSyncManager.updateShopStatsDOM(shopId, stats);
            }
        }

        // æµ‹è¯•æ¶ˆæ¯æ›´æ–°
        function testMessageUpdate(conversationId) {
            messageCounter++;
            const messageData = {
                id: conversationId,
                last_message: `æµ‹è¯•æ¶ˆæ¯ #${messageCounter}: ${new Date().toLocaleTimeString()}`,
                last_message_time: new Date().toISOString(),
                unread_count: Math.floor(Math.random() * 5) + 1
            };
            
            log(`æ¨¡æ‹Ÿå¯¹è¯ ${conversationId} æ¶ˆæ¯æ›´æ–°: "${messageData.last_message}"`);
            
            if (window.DataSyncManager) {
                window.DataSyncManager.updateConversationDOM(conversationId, messageData);
            }
        }

        // åˆ·æ–°æ‰€æœ‰åº—é“º
        function refreshAllShops() {
            if (window.DataSyncManager) {
                window.DataSyncManager.refreshAllVisibleShops().then(() => {
                    log('æ‰€æœ‰åº—é“ºæ•°æ®åˆ·æ–°å®Œæˆ', 'success');
                }).catch(error => {
                    log(`åº—é“ºæ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
                });
            }
        }

        // åˆ·æ–°æ‰€æœ‰å¯¹è¯
        function refreshAllConversations() {
            if (window.DataSyncManager) {
                window.DataSyncManager.refreshAllVisibleConversations().then(() => {
                    log('æ‰€æœ‰å¯¹è¯æ•°æ®åˆ·æ–°å®Œæˆ', 'success');
                }).catch(error => {
                    log(`å¯¹è¯æ•°æ®åˆ·æ–°å¤±è´¥: ${error.message}`, 'error');
                });
            }
        }

        // å¼€å§‹è‡ªåŠ¨æµ‹è¯•
        function startAutoTest() {
            if (autoTestInterval) {
                clearInterval(autoTestInterval);
            }
            
            document.getElementById('autoTestStatus').textContent = 'ğŸ”„ è‡ªåŠ¨æµ‹è¯•è¿è¡Œä¸­... æ¯3ç§’æ‰§è¡Œä¸€æ¬¡æ“ä½œ';
            
            autoTestInterval = setInterval(() => {
                const testType = Math.random();
                
                if (testType < 0.4) {
                    // 40% æ¦‚ç‡æµ‹è¯•åº—é“ºæ›´æ–°
                    const shopIds = ['test-shop-001', 'test-shop-002'];
                    const shopId = shopIds[Math.floor(Math.random() * shopIds.length)];
                    testShopUpdate(shopId);
                } else if (testType < 0.8) {
                    // 40% æ¦‚ç‡æµ‹è¯•æ¶ˆæ¯æ›´æ–°
                    const convIds = ['conv-001', 'conv-002'];
                    const convId = convIds[Math.floor(Math.random() * convIds.length)];
                    testMessageUpdate(convId);
                } else {
                    // 20% æ¦‚ç‡è¿è¡Œä¿®å¤
                    runSingleTest();
                }
            }, 3000);
            
            log('è‡ªåŠ¨æµ‹è¯•å·²å¼€å§‹', 'success');
        }

        // åœæ­¢è‡ªåŠ¨æµ‹è¯•
        function stopAutoTest() {
            if (autoTestInterval) {
                clearInterval(autoTestInterval);
                autoTestInterval = null;
            }
            
            document.getElementById('autoTestStatus').textContent = 'â¹ï¸ è‡ªåŠ¨æµ‹è¯•å·²åœæ­¢';
            log('è‡ªåŠ¨æµ‹è¯•å·²åœæ­¢', 'success');
        }

        // è¿è¡Œå•æ¬¡æµ‹è¯•
        function runSingleTest() {
            log('æ‰§è¡Œå•æ¬¡ç»¼åˆæµ‹è¯•...');
            
            // æ‰‹åŠ¨è§¦å‘ä¿®å¤
            if (window.DisplayFixer) {
                window.DisplayFixer.manualFix();
                log('æ˜¾ç¤ºä¿®å¤å™¨å·²è§¦å‘');
            }
            
            // æ£€æŸ¥DOMå¢å¼ºçŠ¶æ€
            if (window.DOMEnhancer) {
                window.DOMEnhancer.enhanceAllExistingElements();
                log('DOMå¢å¼ºå™¨å·²é‡æ–°è¿è¡Œ');
            }
        }

        // è·å–ä¿®å¤çŠ¶æ€
        function getFixStatus() {
            if (window.DisplayFixer) {
                const status = window.DisplayFixer.getFixStatus();
                log(`ä¿®å¤çŠ¶æ€: ${JSON.stringify(status, null, 2)}`);
            }
            
            checkAllModules(); // åŒæ—¶æ›´æ–°æ¨¡å—çŠ¶æ€æ˜¾ç¤º
        }

        // é¡µé¢åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            log('æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            setTimeout(() => {
                // åˆå§‹åŒ–æ‰€æœ‰æ¨¡å—
                const modules = ['DOMEnhancer', 'RealtimeDataManager', 'DataSyncManager', 'DisplayFixer'];
                let initializedCount = 0;
                
                modules.forEach(moduleName => {
                    const module = window[moduleName];
                    if (module) {
                        if (module.enableDebugMode) module.enableDebugMode();
                        if (module.initialize) module.initialize();
                        if (module.startAutoEnhancement) module.startAutoEnhancement();
                        initializedCount++;
                    }
                });
                
                log(`å·²åˆå§‹åŒ– ${initializedCount} ä¸ªæ¨¡å—`, 'success');
                
                // å»¶è¿Ÿæ£€æŸ¥çŠ¶æ€
                setTimeout(() => {
                    checkAllModules();
                    log('åˆå§‹çŠ¶æ€æ£€æŸ¥å®Œæˆ');
                }, 1000);
            }, 500);
        });
    </script>
</body>
</html>