<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—é“ºç‚¹å‡»è°ƒè¯•</title>
    <link rel="stylesheet" href="/css/multi-shop-customer-service.css">
    <style>
        body {
            margin: 0;
            padding: 20px;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }
        .debug-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .debug-title {
            font-weight: bold;
            color: #333;
            margin-bottom: 10px;
        }
        .test-btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
        }
        .test-btn:hover {
            background: #5a6fd8;
        }
        #debugLog {
            background: #f5f5f5;
            padding: 10px;
            border-radius: 5px;
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åº—é“ºç‚¹å‡»è°ƒè¯•é¡µé¢</h1>
    
    <div class="debug-section">
        <div class="debug-title">1. æµ‹è¯•JavaScriptåŠ è½½</div>
        <button class="test-btn" onclick="testJavaScriptLoading()">æµ‹è¯•JSåŠ è½½</button>
        <button class="test-btn" onclick="testManagerInstance()">æµ‹è¯•ç®¡ç†å™¨å®ä¾‹</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">2. æµ‹è¯•APIè¿æ¥</div>
        <button class="test-btn" onclick="testAuthAPI()">æµ‹è¯•è®¤è¯API</button>
        <button class="test-btn" onclick="testShopsAPI()">æµ‹è¯•åº—é“ºAPI</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">3. æµ‹è¯•åº—é“ºç‚¹å‡»</div>
        <button class="test-btn" onclick="testShopClick()">æ¨¡æ‹Ÿåº—é“ºç‚¹å‡»</button>
        <button class="test-btn" onclick="testConversationsAPI()">æµ‹è¯•å¯¹è¯API</button>
    </div>
    
    <div class="debug-section">
        <div class="debug-title">4. è°ƒè¯•æ—¥å¿—</div>
        <div id="debugLog"></div>
        <button class="test-btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script src="/js/multi-shop-customer-service-manager.js"></script>
    <script>
        let customerServiceManager = null;
        
        function log(message) {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function testJavaScriptLoading() {
            try {
                if (typeof MultiShopCustomerServiceManager !== 'undefined') {
                    log('âœ… MultiShopCustomerServiceManager ç±»å·²åŠ è½½');
                } else {
                    log('âŒ MultiShopCustomerServiceManager ç±»æœªæ‰¾åˆ°');
                }
            } catch (error) {
                log('âŒ JavaScriptåŠ è½½é”™è¯¯: ' + error.message);
            }
        }
        
        function testManagerInstance() {
            try {
                if (!customerServiceManager) {
                    customerServiceManager = new MultiShopCustomerServiceManager();
                    log('âœ… ç®¡ç†å™¨å®ä¾‹åˆ›å»ºæˆåŠŸ');
                } else {
                    log('â„¹ï¸ ç®¡ç†å™¨å®ä¾‹å·²å­˜åœ¨');
                }
                
                // æµ‹è¯•æ–¹æ³•æ˜¯å¦å­˜åœ¨
                if (typeof customerServiceManager.showShopDetail === 'function') {
                    log('âœ… showShopDetail æ–¹æ³•å­˜åœ¨');
                } else {
                    log('âŒ showShopDetail æ–¹æ³•ä¸å­˜åœ¨');
                }
            } catch (error) {
                log('âŒ åˆ›å»ºç®¡ç†å™¨å®ä¾‹å¤±è´¥: ' + error.message);
            }
        }
        
        async function testAuthAPI() {
            try {
                // å…ˆè®¾ç½®æµ‹è¯•session
                localStorage.setItem('sessionId', 'test_session_123');
                
                const response = await fetch('/api/auth/me', {
                    headers: { 'X-Session-Id': 'test_session_123' }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… è®¤è¯APIæˆåŠŸ: ' + JSON.stringify(data));
                } else {
                    log('âŒ è®¤è¯APIå¤±è´¥: ' + response.status + ' ' + response.statusText);
                }
            } catch (error) {
                log('âŒ è®¤è¯APIé”™è¯¯: ' + error.message);
            }
        }
        
        async function testShopsAPI() {
            try {
                const sessionId = localStorage.getItem('sessionId') || 'test_session_123';
                const response = await fetch('/api/auth/me', {
                    headers: { 'X-Session-Id': sessionId }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… åº—é“ºæ•°æ®: ' + data.shops.length + ' ä¸ªåº—é“º');
                    data.shops.forEach(shop => {
                        log(`   - ${shop.name} (${shop.id})`);
                    });
                } else {
                    log('âŒ è·å–åº—é“ºå¤±è´¥: ' + response.status);
                }
            } catch (error) {
                log('âŒ åº—é“ºAPIé”™è¯¯: ' + error.message);
            }
        }
        
        async function testShopClick() {
            try {
                if (!customerServiceManager) {
                    customerServiceManager = new MultiShopCustomerServiceManager();
                }
                
                // å…ˆåˆå§‹åŒ–åŸºç¡€æ•°æ®
                await customerServiceManager.authenticateUser();
                await customerServiceManager.loadShopsWithPermissions();
                
                if (customerServiceManager.shops.length === 0) {
                    log('âŒ æ²¡æœ‰åº—é“ºæ•°æ®å¯ä¾›æµ‹è¯•');
                    return;
                }
                
                const testShop = customerServiceManager.shops[0];
                log('ğŸ§ª æµ‹è¯•ç‚¹å‡»åº—é“º: ' + testShop.name + ' (' + testShop.id + ')');
                
                // æ¨¡æ‹Ÿåº—é“ºç‚¹å‡»
                await customerServiceManager.showShopDetail(testShop.id);
                log('âœ… åº—é“ºç‚¹å‡»æµ‹è¯•å®Œæˆ');
                
            } catch (error) {
                log('âŒ åº—é“ºç‚¹å‡»æµ‹è¯•å¤±è´¥: ' + error.message);
                console.error('å®Œæ•´é”™è¯¯:', error);
            }
        }
        
        async function testConversationsAPI() {
            try {
                const sessionId = localStorage.getItem('sessionId') || 'test_session_123';
                
                // å…ˆè·å–åº—é“ºåˆ—è¡¨
                const authResponse = await fetch('/api/auth/me', {
                    headers: { 'X-Session-Id': sessionId }
                });
                
                if (!authResponse.ok) {
                    log('âŒ è®¤è¯å¤±è´¥ï¼Œæ— æ³•æµ‹è¯•å¯¹è¯API');
                    return;
                }
                
                const authData = await authResponse.json();
                if (authData.shops.length === 0) {
                    log('âŒ æ²¡æœ‰åº—é“ºå¯ä¾›æµ‹è¯•å¯¹è¯API');
                    return;
                }
                
                const testShopId = authData.shops[0].id;
                log('ğŸ§ª æµ‹è¯•åº—é“ºå¯¹è¯API: ' + testShopId);
                
                const response = await fetch(`/api/shops/${testShopId}/conversations`, {
                    headers: { 'X-Session-Id': sessionId }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… å¯¹è¯APIæˆåŠŸ: ' + (data.conversations ? data.conversations.length : 0) + ' ä¸ªå¯¹è¯');
                } else {
                    log('âŒ å¯¹è¯APIå¤±è´¥: ' + response.status + ' ' + response.statusText);
                }
                
            } catch (error) {
                log('âŒ å¯¹è¯APIé”™è¯¯: ' + error.message);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æµ‹è¯•
        window.addEventListener('load', () => {
            log('ğŸ“± è°ƒè¯•é¡µé¢å·²åŠ è½½');
            testJavaScriptLoading();
        });
    </script>
</body>
</html>
