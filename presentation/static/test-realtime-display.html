<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>å®æ—¶æ•°æ®æ˜¾ç¤ºæµ‹è¯•</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .test-section { background: white; padding: 20px; margin: 20px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .shop-card { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 6px; }
        .shop-stat { display: inline-block; margin: 5px 10px; padding: 10px; background: #f8f9fa; border-radius: 4px; }
        .shop-stat-value { font-size: 18px; font-weight: bold; color: #007bff; }
        .shop-stat-label { font-size: 12px; color: #6c757d; }
        .conversation-item { border: 1px solid #eee; padding: 10px; margin: 5px 0; border-radius: 4px; }
        .message-time { font-size: 12px; color: #999; }
        .last-message { font-size: 14px; color: #333; margin: 5px 0; }
        .unread-badge { background: #dc3545; color: white; padding: 2px 6px; border-radius: 10px; font-size: 12px; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .debug-info { background: #f8f9fa; padding: 10px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; font-size: 12px; }
    </style>
</head>
<body>
    <h1>ğŸ§ª å®æ—¶æ•°æ®æ˜¾ç¤ºæµ‹è¯•</h1>
    
    <div class="test-section">
        <h2>ğŸ“Š æ¨¡å—çŠ¶æ€æ£€æŸ¥</h2>
        <button class="test-button" onclick="checkModuleStatus()">æ£€æŸ¥æ¨¡å—çŠ¶æ€</button>
        <button class="test-button" onclick="enableDebugMode()">å¯ç”¨è°ƒè¯•æ¨¡å¼</button>
        <div id="moduleStatus" class="debug-info"></div>
    </div>

    <div class="test-section">
        <h2>ğŸª æ¨¡æ‹Ÿåº—é“ºç»Ÿè®¡</h2>
        <div class="shop-card" data-shop-id="test-shop-1">
            <h3>æµ‹è¯•åº—é“º #1</h3>
            <div class="shop-stat" data-stat-type="å¯¹è¯" data-shop-id="test-shop-1">
                <div class="shop-stat-value">0</div>
                <div class="shop-stat-label">å¯¹è¯</div>
            </div>
            <div class="shop-stat" data-stat-type="æœªè¯»" data-shop-id="test-shop-1">
                <div class="shop-stat-value">0</div>
                <div class="shop-stat-label">æœªè¯»</div>
            </div>
        </div>
        <button class="test-button" onclick="simulateShopUpdate('test-shop-1')">æ¨¡æ‹Ÿåº—é“ºæ•°æ®æ›´æ–°</button>
    </div>

    <div class="test-section">
        <h2>ğŸ’¬ æ¨¡æ‹Ÿå¯¹è¯æ¶ˆæ¯</h2>
        <div class="conversation-item" data-conversation-id="test-conv-1" data-shop-id="test-shop-1">
            <strong>å®¢æˆ·001</strong>
            <span class="message-time" data-conversation-id="test-conv-1">2025-09-29 16:30:00</span>
            <div class="last-message" data-conversation-id="test-conv-1">ç­‰å¾…å®¢æˆ·æ¶ˆæ¯...</div>
            <div class="unread-badge" data-conversation-id="test-conv-1" style="display: none;">0</div>
        </div>
        <button class="test-button" onclick="simulateNewMessage('test-conv-1')">æ¨¡æ‹Ÿæ–°æ¶ˆæ¯</button>
        <button class="test-button" onclick="simulateMultipleMessages()">æ¨¡æ‹Ÿå¤šæ¡æ¶ˆæ¯</button>
    </div>

    <div class="test-section">
        <h2>ğŸ”„ å®æ—¶æ›´æ–°æµ‹è¯•</h2>
        <button class="test-button" onclick="startRealtimeTest()">å¼€å§‹å®æ—¶æµ‹è¯•</button>
        <button class="test-button" onclick="stopRealtimeTest()">åœæ­¢æµ‹è¯•</button>
        <div id="testStatus" class="debug-info"></div>
    </div>

    <!-- å¼•å…¥æ¨¡å— -->
    <script src="/js/dom-enhancer.js"></script>
    <script src="/js/realtime-data-manager.js"></script>

    <script>
        let testInterval = null;
        let messageCounter = 0;

        function checkModuleStatus() {
            const status = document.getElementById('moduleStatus');
            let info = '<h3>æ¨¡å—åŠ è½½çŠ¶æ€:</h3>';
            
            info += `<p>DOMEnhancer: ${typeof window.DOMEnhancer}</p>`;
            info += `<p>RealtimeDataManager: ${typeof window.RealtimeDataManager}</p>`;
            
            if (window.DOMEnhancer) {
                const enhancerStatus = window.DOMEnhancer.getEnhancementStatus();
                info += `<p>DOMå¢å¼ºå™¨çŠ¶æ€: ${JSON.stringify(enhancerStatus, null, 2)}</p>`;
            }
            
            if (window.RealtimeDataManager) {
                const realtimeStatus = window.RealtimeDataManager.getDebugInfo();
                info += `<p>å®æ—¶ç®¡ç†å™¨çŠ¶æ€: ${JSON.stringify(realtimeStatus, null, 2)}</p>`;
            }
            
            status.innerHTML = info;
        }

        function enableDebugMode() {
            if (window.DOMEnhancer) {
                window.DOMEnhancer.enableDebugMode();
                console.log('ğŸ”§ DOMå¢å¼ºå™¨è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
            }
            
            if (window.RealtimeDataManager) {
                window.RealtimeDataManager.enableDebugMode();
                console.log('ğŸ“Š å®æ—¶æ•°æ®ç®¡ç†å™¨è°ƒè¯•æ¨¡å¼å·²å¯ç”¨');
            }
            
            // å¯ç”¨DOMè‡ªåŠ¨å¢å¼º
            if (window.DOMEnhancer) {
                window.DOMEnhancer.startAutoEnhancement();
                window.DOMEnhancer.enhanceAllExistingElements();
            }
            
            alert('è°ƒè¯•æ¨¡å¼å·²å¯ç”¨ï¼Œè¯·æŸ¥çœ‹æ§åˆ¶å°è¾“å‡º');
        }

        function simulateShopUpdate(shopId) {
            const stats = {
                conversation_count: Math.floor(Math.random() * 10) + 1,
                unread_count: Math.floor(Math.random() * 5)
            };
            
            console.log(`æ¨¡æ‹Ÿåº—é“º ${shopId} æ•°æ®æ›´æ–°:`, stats);
            
            if (window.RealtimeDataManager) {
                window.RealtimeDataManager.updateShopStatsDOM(shopId, stats);
            }
        }

        function simulateNewMessage(conversationId) {
            messageCounter++;
            const messageData = {
                id: conversationId,
                last_message: `è¿™æ˜¯ç¬¬ ${messageCounter} æ¡æµ‹è¯•æ¶ˆæ¯`,
                last_message_time: new Date().toISOString(),
                unread_count: messageCounter
            };
            
            console.log(`æ¨¡æ‹Ÿå¯¹è¯ ${conversationId} æ–°æ¶ˆæ¯:`, messageData);
            
            if (window.RealtimeDataManager) {
                window.RealtimeDataManager.updateConversationData(messageData);
            }
        }

        function simulateMultipleMessages() {
            for (let i = 0; i < 3; i++) {
                setTimeout(() => {
                    simulateNewMessage('test-conv-1');
                }, i * 1000);
            }
        }

        function startRealtimeTest() {
            if (testInterval) {
                clearInterval(testInterval);
            }
            
            const status = document.getElementById('testStatus');
            status.innerHTML = '<p>ğŸ”„ å®æ—¶æµ‹è¯•è¿è¡Œä¸­... æ¯3ç§’æ›´æ–°ä¸€æ¬¡æ•°æ®</p>';
            
            testInterval = setInterval(() => {
                // éšæœºæ›´æ–°åº—é“ºæˆ–å¯¹è¯
                if (Math.random() > 0.5) {
                    simulateShopUpdate('test-shop-1');
                } else {
                    simulateNewMessage('test-conv-1');
                }
            }, 3000);
        }

        function stopRealtimeTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            const status = document.getElementById('testStatus');
            status.innerHTML = '<p>â¹ï¸ å®æ—¶æµ‹è¯•å·²åœæ­¢</p>';
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            console.log('ğŸ§ª æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // å»¶è¿Ÿåˆå§‹åŒ–æ¨¡å—
            setTimeout(() => {
                if (window.DOMEnhancer) {
                    window.DOMEnhancer.enableDebugMode();
                    window.DOMEnhancer.startAutoEnhancement();
                    window.DOMEnhancer.enhanceAllExistingElements();
                }
                
                if (window.RealtimeDataManager) {
                    window.RealtimeDataManager.enableDebugMode();
                    window.RealtimeDataManager.initialize();
                }
                
                console.log('âœ… æµ‹è¯•æ¨¡å—åˆå§‹åŒ–å®Œæˆ');
                checkModuleStatus();
            }, 500);
        });
    </script>
</body>
</html>