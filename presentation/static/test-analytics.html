<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ•°æ®åˆ†æåŠŸèƒ½æµ‹è¯• - QuickTalkå®¢æœç³»ç»Ÿ</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f7fa;
            color: #2c3e50;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 30px;
        }

        .test-section {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .test-section h2 {
            color: #2c3e50;
            margin-top: 0;
            border-bottom: 2px solid #ecf0f1;
            padding-bottom: 10px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .test-item {
            border: 1px solid #e3e8ef;
            border-radius: 8px;
            padding: 20px;
            background: #f8f9fa;
        }

        .test-item h3 {
            margin-top: 0;
            color: #3498db;
        }

        .btn {
            background: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            margin: 5px;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #2980b9;
            transform: translateY(-1px);
        }

        .btn.success {
            background: #2ecc71;
        }

        .btn.warning {
            background: #f39c12;
        }

        .btn.danger {
            background: #e74c3c;
        }

        .result {
            margin-top: 15px;
            padding: 15px;
            border-radius: 6px;
            font-size: 14px;
            white-space: pre-wrap;
            max-height: 300px;
            overflow-y: auto;
        }

        .result.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .result.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .result.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: bold;
            color: #3498db;
        }

        .stat-label {
            color: #7f8c8d;
            margin-top: 8px;
        }

        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #3498db;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .nav-links {
            text-align: center;
            margin: 30px 0;
        }

        .nav-links a {
            color: #3498db;
            text-decoration: none;
            margin: 0 15px;
            font-weight: 500;
        }

        .nav-links a:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“Š æ•°æ®åˆ†æåŠŸèƒ½æµ‹è¯•</h1>
            <p>ç¬¬ä¸‰é˜¶æ®µ: æ•°æ®åˆ†æä»ªè¡¨æ¿åŠŸèƒ½æµ‹è¯•é¡µé¢</p>
        </div>

        <div class="nav-links">
            <a href="/analytics">ğŸ¯ åˆ†æä»ªè¡¨æ¿</a>
            <a href="/mobile/admin">ğŸ’¼ å®¢æœç®¡ç†</a>
            <a href="/test-search-history.html">ğŸ” æœç´¢æµ‹è¯•</a>
            <a href="/">ğŸ  è¿”å›é¦–é¡µ</a>
        </div>

        <!-- APIæµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h2>ğŸš€ APIåŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>å®æ—¶ç›‘æ§æ•°æ®</h3>
                    <p>æµ‹è¯•è·å–å®æ—¶ç›‘æ§æŒ‡æ ‡</p>
                    <button class="btn" onclick="testRealtimeMetrics()">æµ‹è¯•å®æ—¶æ•°æ®</button>
                    <div id="realtime-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>å®¢æœæ•ˆç‡åˆ†æ</h3>
                    <p>æµ‹è¯•å®¢æœæ•ˆç‡åˆ†æAPI</p>
                    <button class="btn" onclick="testStaffEfficiency()">æµ‹è¯•æ•ˆç‡åˆ†æ</button>
                    <div id="efficiency-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>å®¢æˆ·æ»¡æ„åº¦ç»Ÿè®¡</h3>
                    <p>æµ‹è¯•å®¢æˆ·æ»¡æ„åº¦ç»Ÿè®¡API</p>
                    <button class="btn" onclick="testCustomerSatisfaction()">æµ‹è¯•æ»¡æ„åº¦</button>
                    <div id="satisfaction-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>å·¥ä½œè´Ÿè½½åˆ†æ</h3>
                    <p>æµ‹è¯•å·¥ä½œè´Ÿè½½åˆ†æAPI</p>
                    <button class="btn" onclick="testWorkloadAnalysis()">æµ‹è¯•è´Ÿè½½åˆ†æ</button>
                    <div id="workload-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>KPIæŠ¥å‘Šç”Ÿæˆ</h3>
                    <p>æµ‹è¯•KPIæŠ¥å‘Šç”ŸæˆAPI</p>
                    <button class="btn" onclick="testKpiReport()">ç”ŸæˆKPIæŠ¥å‘Š</button>
                    <div id="kpi-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>ç”¨æˆ·æ´»åŠ¨è®°å½•</h3>
                    <p>æµ‹è¯•ç”¨æˆ·æ´»åŠ¨æ—¥å¿—API</p>
                    <button class="btn" onclick="testLogActivity()">è®°å½•æ´»åŠ¨</button>
                    <div id="activity-result" class="result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- æ•°æ®åº“æµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h2>ğŸ—„ï¸ æ•°æ®åº“åŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>è¡¨ç»“æ„æ£€æŸ¥</h3>
                    <p>æ£€æŸ¥åˆ†æç›¸å…³è¡¨æ˜¯å¦åˆ›å»ºæˆåŠŸ</p>
                    <button class="btn" onclick="checkTables()">æ£€æŸ¥è¡¨ç»“æ„</button>
                    <div id="tables-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>æ¨¡æ‹Ÿæ•°æ®æ’å…¥</h3>
                    <p>æ’å…¥æµ‹è¯•æ•°æ®ç”¨äºæ¼”ç¤º</p>
                    <button class="btn warning" onclick="insertTestData()">æ’å…¥æµ‹è¯•æ•°æ®</button>
                    <div id="insert-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>æ•°æ®æŸ¥è¯¢æµ‹è¯•</h3>
                    <p>æµ‹è¯•æ•°æ®æŸ¥è¯¢å’Œèšåˆ</p>
                    <button class="btn" onclick="testDataQuery()">æŸ¥è¯¢æµ‹è¯•</button>
                    <div id="query-result" class="result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- ç»¼åˆæµ‹è¯•åŒºåŸŸ -->
        <div class="test-section">
            <h2>ğŸ§ª ç»¼åˆåŠŸèƒ½æµ‹è¯•</h2>
            <div class="test-grid">
                <div class="test-item">
                    <h3>å®Œæ•´æµç¨‹æµ‹è¯•</h3>
                    <p>æµ‹è¯•ä»æ•°æ®é‡‡é›†åˆ°æŠ¥å‘Šç”Ÿæˆçš„å®Œæ•´æµç¨‹</p>
                    <button class="btn success" onclick="runFullTest()">è¿è¡Œå®Œæ•´æµ‹è¯•</button>
                    <div id="full-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>æ€§èƒ½å‹åŠ›æµ‹è¯•</h3>
                    <p>æµ‹è¯•APIæ€§èƒ½å’Œå“åº”æ—¶é—´</p>
                    <button class="btn warning" onclick="runPerformanceTest()">æ€§èƒ½æµ‹è¯•</button>
                    <div id="performance-result" class="result" style="display: none;"></div>
                </div>

                <div class="test-item">
                    <h3>é”™è¯¯å¤„ç†æµ‹è¯•</h3>
                    <p>æµ‹è¯•å¼‚å¸¸æƒ…å†µå’Œé”™è¯¯å¤„ç†</p>
                    <button class="btn danger" onclick="testErrorHandling()">é”™è¯¯æµ‹è¯•</button>
                    <div id="error-result" class="result" style="display: none;"></div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡ä¿¡æ¯ -->
        <div class="test-section">
            <h2>ğŸ“ˆ æµ‹è¯•ç»Ÿè®¡</h2>
            <div class="stats" id="test-stats">
                <div class="stat-card">
                    <div class="stat-value" id="total-tests">0</div>
                    <div class="stat-label">æ€»æµ‹è¯•æ•°</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="passed-tests">0</div>
                    <div class="stat-label">é€šè¿‡æµ‹è¯•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="failed-tests">0</div>
                    <div class="stat-label">å¤±è´¥æµ‹è¯•</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="avg-response">0ms</div>
                    <div class="stat-label">å¹³å‡å“åº”</div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // æµ‹è¯•ç»Ÿè®¡
        let testStats = {
            total: 0,
            passed: 0,
            failed: 0,
            responseTimes: []
        };

        // é»˜è®¤åº—é“ºID
        const DEFAULT_SHOP_ID = 'test_shop_001';

        /**
         * æ˜¾ç¤ºåŠ è½½çŠ¶æ€
         */
        function showLoading(elementId) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = 'result info';
            element.innerHTML = '<span class="loading"></span>æ­£åœ¨æµ‹è¯•...';
        }

        /**
         * æ˜¾ç¤ºç»“æœ
         */
        function showResult(elementId, success, message, data = null) {
            const element = document.getElementById(elementId);
            element.style.display = 'block';
            element.className = success ? 'result success' : 'result error';
            
            let content = success ? 'âœ… ' + message : 'âŒ ' + message;
            if (data) {
                content += '\n\n' + JSON.stringify(data, null, 2);
            }
            
            element.textContent = content;
            
            // æ›´æ–°ç»Ÿè®¡
            testStats.total++;
            if (success) {
                testStats.passed++;
            } else {
                testStats.failed++;
            }
            updateStats();
        }

        /**
         * æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
         */
        function updateStats() {
            document.getElementById('total-tests').textContent = testStats.total;
            document.getElementById('passed-tests').textContent = testStats.passed;
            document.getElementById('failed-tests').textContent = testStats.failed;
            
            if (testStats.responseTimes.length > 0) {
                const avg = testStats.responseTimes.reduce((a, b) => a + b, 0) / testStats.responseTimes.length;
                document.getElementById('avg-response').textContent = Math.round(avg) + 'ms';
            }
        }

        /**
         * APIè¯·æ±‚è¾…åŠ©å‡½æ•°
         */
        async function apiRequest(url, options = {}) {
            const startTime = Date.now();
            try {
                const response = await fetch(url, {
                    headers: {
                        'Content-Type': 'application/json',
                        ...options.headers
                    },
                    ...options
                });
                
                const responseTime = Date.now() - startTime;
                testStats.responseTimes.push(responseTime);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                return await response.json();
            } catch (error) {
                const responseTime = Date.now() - startTime;
                testStats.responseTimes.push(responseTime);
                throw error;
            }
        }

        /**
         * æµ‹è¯•å®æ—¶ç›‘æ§æ•°æ®
         */
        async function testRealtimeMetrics() {
            showLoading('realtime-result');
            
            try {
                const data = await apiRequest(`/api/analytics/realtime/${DEFAULT_SHOP_ID}?timeRange=24h`);
                showResult('realtime-result', true, 'å®æ—¶ç›‘æ§æ•°æ®è·å–æˆåŠŸ', data);
            } catch (error) {
                showResult('realtime-result', false, 'å®æ—¶ç›‘æ§æ•°æ®è·å–å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•å®¢æœæ•ˆç‡åˆ†æ
         */
        async function testStaffEfficiency() {
            showLoading('efficiency-result');
            
            try {
                const data = await apiRequest(`/api/analytics/staff-efficiency/${DEFAULT_SHOP_ID}?timeRange=7d`);
                showResult('efficiency-result', true, 'å®¢æœæ•ˆç‡åˆ†æè·å–æˆåŠŸ', data);
            } catch (error) {
                showResult('efficiency-result', false, 'å®¢æœæ•ˆç‡åˆ†æè·å–å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•å®¢æˆ·æ»¡æ„åº¦ç»Ÿè®¡
         */
        async function testCustomerSatisfaction() {
            showLoading('satisfaction-result');
            
            try {
                const data = await apiRequest(`/api/analytics/customer-satisfaction/${DEFAULT_SHOP_ID}?timeRange=30d`);
                showResult('satisfaction-result', true, 'å®¢æˆ·æ»¡æ„åº¦ç»Ÿè®¡è·å–æˆåŠŸ', data);
            } catch (error) {
                showResult('satisfaction-result', false, 'å®¢æˆ·æ»¡æ„åº¦ç»Ÿè®¡è·å–å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•å·¥ä½œè´Ÿè½½åˆ†æ
         */
        async function testWorkloadAnalysis() {
            showLoading('workload-result');
            
            try {
                const data = await apiRequest(`/api/analytics/workload/${DEFAULT_SHOP_ID}?timeRange=7d`);
                showResult('workload-result', true, 'å·¥ä½œè´Ÿè½½åˆ†æè·å–æˆåŠŸ', data);
            } catch (error) {
                showResult('workload-result', false, 'å·¥ä½œè´Ÿè½½åˆ†æè·å–å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•KPIæŠ¥å‘Šç”Ÿæˆ
         */
        async function testKpiReport() {
            showLoading('kpi-result');
            
            try {
                const data = await apiRequest(`/api/analytics/kpi-report/${DEFAULT_SHOP_ID}?reportType=weekly`);
                showResult('kpi-result', true, 'KPIæŠ¥å‘Šç”ŸæˆæˆåŠŸ', data);
            } catch (error) {
                showResult('kpi-result', false, 'KPIæŠ¥å‘Šç”Ÿæˆå¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•ç”¨æˆ·æ´»åŠ¨è®°å½•
         */
        async function testLogActivity() {
            showLoading('activity-result');
            
            try {
                const activityData = {
                    userId: 'test_user_001',
                    shopId: DEFAULT_SHOP_ID,
                    activityType: 'login',
                    details: {
                        testRun: true,
                        timestamp: new Date().toISOString()
                    },
                    sessionDuration: 300
                };
                
                const data = await apiRequest('/api/analytics/log-activity', {
                    method: 'POST',
                    body: JSON.stringify(activityData)
                });
                
                showResult('activity-result', true, 'ç”¨æˆ·æ´»åŠ¨è®°å½•æˆåŠŸ', data);
            } catch (error) {
                showResult('activity-result', false, 'ç”¨æˆ·æ´»åŠ¨è®°å½•å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æ£€æŸ¥æ•°æ®åº“è¡¨ç»“æ„
         */
        async function checkTables() {
            showLoading('tables-result');
            
            try {
                // é€šè¿‡å°è¯•æŸ¥è¯¢æ¥æ£€æŸ¥è¡¨æ˜¯å¦å­˜åœ¨
                const results = await Promise.allSettled([
                    apiRequest(`/api/analytics/realtime/${DEFAULT_SHOP_ID}`),
                    apiRequest(`/api/analytics/staff-efficiency/${DEFAULT_SHOP_ID}`),
                    apiRequest(`/api/analytics/customer-satisfaction/${DEFAULT_SHOP_ID}`),
                    apiRequest(`/api/analytics/workload/${DEFAULT_SHOP_ID}`)
                ]);
                
                const tableStatus = {
                    analyticsAPIs: results.filter(r => r.status === 'fulfilled').length,
                    totalAPIs: results.length,
                    errors: results.filter(r => r.status === 'rejected').map(r => r.reason.message)
                };
                
                const success = tableStatus.analyticsAPIs > 0;
                showResult('tables-result', success, `æ•°æ®åº“è¡¨æ£€æŸ¥å®Œæˆ (${tableStatus.analyticsAPIs}/${tableStatus.totalAPIs} APIså¯ç”¨)`, tableStatus);
            } catch (error) {
                showResult('tables-result', false, 'æ•°æ®åº“è¡¨æ£€æŸ¥å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æ’å…¥æµ‹è¯•æ•°æ®
         */
        async function insertTestData() {
            showLoading('insert-result');
            
            try {
                // æ¨¡æ‹Ÿæ’å…¥å¤šæ¡æ´»åŠ¨è®°å½•
                const activities = [
                    { userId: 'user_001', activityType: 'login', sessionDuration: 1800 },
                    { userId: 'user_002', activityType: 'message_sent', sessionDuration: 900 },
                    { userId: 'user_003', activityType: 'message_received', sessionDuration: 1200 },
                    { userId: 'user_001', activityType: 'logout', sessionDuration: 1800 }
                ];
                
                const results = [];
                for (const activity of activities) {
                    try {
                        const data = await apiRequest('/api/analytics/log-activity', {
                            method: 'POST',
                            body: JSON.stringify({
                                ...activity,
                                shopId: DEFAULT_SHOP_ID,
                                details: { testData: true }
                            })
                        });
                        results.push({ success: true, data });
                    } catch (error) {
                        results.push({ success: false, error: error.message });
                    }
                }
                
                const successCount = results.filter(r => r.success).length;
                const success = successCount > 0;
                
                showResult('insert-result', success, `æµ‹è¯•æ•°æ®æ’å…¥å®Œæˆ (${successCount}/${activities.length} æˆåŠŸ)`, {
                    insertedRecords: successCount,
                    totalRecords: activities.length,
                    results
                });
            } catch (error) {
                showResult('insert-result', false, 'æµ‹è¯•æ•°æ®æ’å…¥å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•æ•°æ®æŸ¥è¯¢
         */
        async function testDataQuery() {
            showLoading('query-result');
            
            try {
                // æµ‹è¯•ä¸åŒæ—¶é—´èŒƒå›´çš„æŸ¥è¯¢
                const timeRanges = ['1h', '24h', '7d', '30d'];
                const results = {};
                
                for (const range of timeRanges) {
                    try {
                        const data = await apiRequest(`/api/analytics/realtime/${DEFAULT_SHOP_ID}?timeRange=${range}`);
                        results[range] = {
                            success: true,
                            conversations: data.data?.conversations?.total || 0,
                            messages: data.data?.messages?.total || 0
                        };
                    } catch (error) {
                        results[range] = {
                            success: false,
                            error: error.message
                        };
                    }
                }
                
                const successCount = Object.values(results).filter(r => r.success).length;
                const success = successCount > 0;
                
                showResult('query-result', success, `æ•°æ®æŸ¥è¯¢æµ‹è¯•å®Œæˆ (${successCount}/${timeRanges.length} æˆåŠŸ)`, results);
            } catch (error) {
                showResult('query-result', false, 'æ•°æ®æŸ¥è¯¢æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        /**
         * è¿è¡Œå®Œæ•´æµç¨‹æµ‹è¯•
         */
        async function runFullTest() {
            showLoading('full-result');
            
            try {
                console.log('å¼€å§‹å®Œæ•´æµç¨‹æµ‹è¯•...');
                
                // 1. è®°å½•ç”¨æˆ·æ´»åŠ¨
                const activityResult = await apiRequest('/api/analytics/log-activity', {
                    method: 'POST',
                    body: JSON.stringify({
                        userId: 'test_full_user',
                        shopId: DEFAULT_SHOP_ID,
                        activityType: 'login',
                        details: { fullTest: true }
                    })
                });
                
                // 2. è·å–å®æ—¶æ•°æ®
                const realtimeResult = await apiRequest(`/api/analytics/realtime/${DEFAULT_SHOP_ID}`);
                
                // 3. ç”ŸæˆKPIæŠ¥å‘Š
                const kpiResult = await apiRequest(`/api/analytics/kpi-report/${DEFAULT_SHOP_ID}`);
                
                // 4. è®°å½•æ€§èƒ½æŒ‡æ ‡
                const performanceResult = await apiRequest('/api/analytics/performance-metrics', {
                    method: 'POST',
                    body: JSON.stringify({
                        metricName: 'full_test_execution',
                        metricValue: Date.now(),
                        metricUnit: 'timestamp',
                        responseTime: 150,
                        memoryUsage: 65,
                        cpuUsage: 30
                    })
                });
                
                const results = {
                    activityLog: activityResult.success,
                    realtimeData: realtimeResult.success,
                    kpiReport: kpiResult.success,
                    performanceMetrics: performanceResult.success,
                    totalSteps: 4,
                    completedSteps: [
                        activityResult.success,
                        realtimeResult.success,
                        kpiResult.success,
                        performanceResult.success
                    ].filter(Boolean).length
                };
                
                const success = results.completedSteps >= 2; // è‡³å°‘å®Œæˆä¸€åŠæ­¥éª¤
                showResult('full-result', success, `å®Œæ•´æµç¨‹æµ‹è¯•å®Œæˆ (${results.completedSteps}/${results.totalSteps} æ­¥éª¤æˆåŠŸ)`, results);
            } catch (error) {
                showResult('full-result', false, 'å®Œæ•´æµç¨‹æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        /**
         * è¿è¡Œæ€§èƒ½æµ‹è¯•
         */
        async function runPerformanceTest() {
            showLoading('performance-result');
            
            try {
                const testCount = 10;
                const results = [];
                
                console.log(`å¼€å§‹æ€§èƒ½æµ‹è¯•ï¼Œå‘é€ ${testCount} ä¸ªè¯·æ±‚...`);
                
                const startTime = Date.now();
                
                // å¹¶å‘è¯·æ±‚æµ‹è¯•
                const promises = [];
                for (let i = 0; i < testCount; i++) {
                    promises.push(
                        apiRequest(`/api/analytics/realtime/${DEFAULT_SHOP_ID}`)
                            .then(data => ({ success: true, responseTime: Date.now() - startTime }))
                            .catch(error => ({ success: false, error: error.message }))
                    );
                }
                
                const responses = await Promise.all(promises);
                const totalTime = Date.now() - startTime;
                
                const successCount = responses.filter(r => r.success).length;
                const avgResponseTime = totalTime / testCount;
                
                const performanceData = {
                    totalRequests: testCount,
                    successfulRequests: successCount,
                    failedRequests: testCount - successCount,
                    totalTime: totalTime,
                    averageResponseTime: Math.round(avgResponseTime),
                    requestsPerSecond: Math.round((testCount / totalTime) * 1000),
                    successRate: Math.round((successCount / testCount) * 100)
                };
                
                const success = successCount >= testCount * 0.8; // 80%æˆåŠŸç‡
                showResult('performance-result', success, `æ€§èƒ½æµ‹è¯•å®Œæˆ (${performanceData.successRate}% æˆåŠŸç‡)`, performanceData);
            } catch (error) {
                showResult('performance-result', false, 'æ€§èƒ½æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        /**
         * æµ‹è¯•é”™è¯¯å¤„ç†
         */
        async function testErrorHandling() {
            showLoading('error-result');
            
            try {
                const errorTests = [
                    {
                        name: 'æ— æ•ˆåº—é“ºID',
                        url: '/api/analytics/realtime/invalid_shop_id',
                        expectedError: true
                    },
                    {
                        name: 'æ— æ•ˆæ—¶é—´èŒƒå›´',
                        url: `/api/analytics/realtime/${DEFAULT_SHOP_ID}?timeRange=invalid`,
                        expectedError: false // åº”è¯¥ä½¿ç”¨é»˜è®¤å€¼
                    },
                    {
                        name: 'ä¸å­˜åœ¨çš„ç«¯ç‚¹',
                        url: '/api/analytics/nonexistent',
                        expectedError: true
                    },
                    {
                        name: 'æ— æ•ˆJSONæ•°æ®',
                        url: '/api/analytics/log-activity',
                        method: 'POST',
                        body: 'invalid json',
                        expectedError: true
                    }
                ];
                
                const results = [];
                
                for (const test of errorTests) {
                    try {
                        const options = {};
                        if (test.method) options.method = test.method;
                        if (test.body) options.body = test.body;
                        
                        const response = await apiRequest(test.url, options);
                        
                        results.push({
                            test: test.name,
                            expectedError: test.expectedError,
                            actualError: false,
                            success: !test.expectedError, // å¦‚æœä¸æœŸæœ›é”™è¯¯ä½†æ²¡æœ‰é”™è¯¯ï¼Œåˆ™æˆåŠŸ
                            response: response
                        });
                    } catch (error) {
                        results.push({
                            test: test.name,
                            expectedError: test.expectedError,
                            actualError: true,
                            success: test.expectedError, // å¦‚æœæœŸæœ›é”™è¯¯ä¸”å‘ç”Ÿé”™è¯¯ï¼Œåˆ™æˆåŠŸ
                            error: error.message
                        });
                    }
                }
                
                const successCount = results.filter(r => r.success).length;
                const success = successCount >= results.length * 0.75; // 75%æˆåŠŸç‡
                
                showResult('error-result', success, `é”™è¯¯å¤„ç†æµ‹è¯•å®Œæˆ (${successCount}/${results.length} é€šè¿‡)`, {
                    testResults: results,
                    successRate: Math.round((successCount / results.length) * 100)
                });
            } catch (error) {
                showResult('error-result', false, 'é”™è¯¯å¤„ç†æµ‹è¯•å¤±è´¥: ' + error.message);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆåçš„åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', () => {
            console.log('ğŸ“Š æ•°æ®åˆ†æåŠŸèƒ½æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            
            // æ˜¾ç¤ºå½“å‰æµ‹è¯•ç¯å¢ƒä¿¡æ¯
            const envInfo = {
                userAgent: navigator.userAgent,
                currentTime: new Date().toLocaleString(),
                testShopId: DEFAULT_SHOP_ID,
                baseUrl: window.location.origin
            };
            
            console.log('ğŸ”§ æµ‹è¯•ç¯å¢ƒä¿¡æ¯:', envInfo);
        });
    </script>
</body>
</html>
