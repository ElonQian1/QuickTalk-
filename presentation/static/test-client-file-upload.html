<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>测试客户端文件上传功能</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            background: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }
        
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        
        .test-info {
            background: #e3f2fd;
            border: 1px solid #2196f3;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }
        
        .test-info h3 {
            margin: 0 0 10px 0;
            color: #1976d2;
        }
        
        .simulation-area {
            background: #f5f5f5;
            border: 2px dashed #ccc;
            border-radius: 10px;
            padding: 20px;
            margin: 20px 0;
            min-height: 400px;
            position: relative;
        }
        
        .domain-info {
            position: absolute;
            top: 10px;
            right: 10px;
            background: #667eea;
            color: white;
            padding: 5px 10px;
            border-radius: 15px;
            font-size: 12px;
        }
        
        .step {
            background: white;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
        }
        
        .step h4 {
            margin: 0 0 10px 0;
            color: #333;
        }
        
        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 600;
            margin: 5px;
        }
        
        button:hover {
            background: #5a6fd8;
        }
        
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>📷 QuickTalk客户端文件上传功能测试</h1>
        
        <div class="test-info">
            <h3>🎯 测试目标</h3>
            <p>验证客户端集成代码的文件上传功能，确保用户可以向店铺发送图片、视频等多媒体文件。</p>
            <ul>
                <li>📤 客户端文件选择和上传</li>
                <li>🖼️ 图片预览功能</li>
                <li>📊 上传进度显示</li>
                <li>💬 多媒体消息发送到WebSocket</li>
                <li>🔄 与店铺后台的实时通信</li>
            </ul>
        </div>

        <div class="simulation-area">
            <div class="domain-info">模拟域名: bbs16.929991.xyz</div>
            <h3>🌐 客户端网站模拟</h3>
            <p>这里模拟客户网站嵌入QuickTalk客服系统的情况：</p>
            
            <!-- 这里将嵌入动态加载的客服代码 -->
            <div id="customer-service-area">
                <p>正在加载QuickTalk客服系统...</p>
            </div>
        </div>

        <div class="step">
            <h4>📋 测试步骤</h4>
            <ol>
                <li>点击下方按钮加载客服系统</li>
                <li>点击客服按钮打开聊天窗口</li>
                <li>点击聊天窗口中的📷按钮</li>
                <li>选择图片或其他文件</li>
                <li>查看预览效果</li>
                <li>点击"发送文件"按钮</li>
                <li>观察上传进度和最终结果</li>
            </ol>
            
            <button onclick="loadCustomerService()">🚀 加载客服系统</button>
            <button onclick="showTestLog()">📊 显示测试日志</button>
            <button onclick="clearLog()">🧹 清空日志</button>
            
            <div class="log" id="testLog" style="display: none;"></div>
        </div>

        <div class="step">
            <h4>🔍 验证点</h4>
            <ul id="checkpoints">
                <li>✅ 客服系统加载成功</li>
                <li>⏳ 文件上传按钮显示</li>
                <li>⏳ 文件选择对话框打开</li>
                <li>⏳ 图片预览正常显示</li>
                <li>⏳ 上传进度条工作</li>
                <li>⏳ 多媒体消息发送成功</li>
                <li>⏳ 店铺后台收到文件</li>
            </ul>
        </div>
    </div>

    <script>
        let testLog = [];
        
        function log(message) {
            const timestamp = new Date().toLocaleTimeString();
            testLog.push(`[${timestamp}] ${message}`);
            console.log(message);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logElement = document.getElementById('testLog');
            if (logElement.style.display !== 'none') {
                logElement.innerHTML = testLog.join('\n');
                logElement.scrollTop = logElement.scrollHeight;
            }
        }
        
        function showTestLog() {
            const logElement = document.getElementById('testLog');
            logElement.style.display = logElement.style.display === 'none' ? 'block' : 'none';
            updateLogDisplay();
        }
        
        function clearLog() {
            testLog = [];
            updateLogDisplay();
        }
        
        function updateCheckpoint(index, status) {
            const checkpoints = document.querySelectorAll('#checkpoints li');
            if (checkpoints[index]) {
                checkpoints[index].innerHTML = checkpoints[index].innerHTML.replace(/^[✅⏳❌]/, status);
            }
        }
        
        function loadCustomerService() {
            log('🚀 开始加载QuickTalk客服系统...');
            
            // 模拟客户网站嵌入的动态加载代码
            const script = document.createElement('script');
            script.innerHTML = `
                (function() {
                    // QuickTalk配置 - 这是唯一需要定制的部分
                    const QUICKTALK_CONFIG = {
                        shopKey: 'sk_ji85ucic9p00m12as1ygf34o8humuxfl',
                        shopId: 'shop_1757591780450_1',
                        shopName: '时尚服装店',
                        authorizedDomain: 'bbs16.929991.xyz',
                        
                        // 服务器配置
                        serverUrl: 'http://localhost:3030',
                        
                        // 版本控制
                        version: '1.0.0',
                        cacheBreaker: Date.now() // 强制刷新缓存
                    };
                    
                    // 由于是测试环境，跳过域名验证
                    console.log('🚀 QuickTalk客服系统：开始动态加载...');
                    parent.log('✅ 配置验证通过，开始加载资源...');
                    
                    // 动态加载样式文件
                    function loadCSS() {
                        const link = document.createElement('link');
                        link.rel = 'stylesheet';
                        link.type = 'text/css';
                        link.href = QUICKTALK_CONFIG.serverUrl + '/embed/customer-service.css?v=' + QUICKTALK_CONFIG.cacheBreaker;
                        link.onload = () => {
                            parent.log('✅ CSS样式加载成功');
                        };
                        link.onerror = () => {
                            parent.log('❌ CSS样式加载失败');
                        };
                        document.head.appendChild(link);
                    }
                    
                    // 动态加载JavaScript文件
                    function loadJS() {
                        const script = document.createElement('script');
                        script.type = 'text/javascript';
                        script.src = QUICKTALK_CONFIG.serverUrl + '/embed/customer-service.js?v=' + QUICKTALK_CONFIG.cacheBreaker;
                        
                        script.onload = () => {
                            parent.log('✅ JavaScript脚本加载成功');
                            parent.updateCheckpoint(0, '✅');
                            
                            // 初始化客服系统
                            if (window.QuickTalkCustomerService) {
                                window.QuickTalkCustomerService.init(QUICKTALK_CONFIG);
                                parent.log('✅ QuickTalk客服系统初始化完成');
                                parent.updateCheckpoint(1, '✅');
                                
                                // 监听文件上传事件
                                const originalShowFileUpload = window.QuickTalkCustomerService.showFileUpload;
                                window.QuickTalkCustomerService.showFileUpload = function() {
                                    parent.log('📷 用户点击文件上传按钮');
                                    parent.updateCheckpoint(2, '✅');
                                    return originalShowFileUpload.call(this);
                                };
                                
                                const originalHandleFileSelect = window.QuickTalkCustomerService.handleFileSelect;
                                window.QuickTalkCustomerService.handleFileSelect = function(event) {
                                    parent.log('📁 用户选择了文件: ' + event.target.files[0]?.name);
                                    parent.updateCheckpoint(3, '✅');
                                    return originalHandleFileSelect.call(this, event);
                                };
                                
                                const originalUploadAndSendFile = window.QuickTalkCustomerService.uploadAndSendFile;
                                window.QuickTalkCustomerService.uploadAndSendFile = async function() {
                                    parent.log('📤 开始上传文件...');
                                    parent.updateCheckpoint(4, '✅');
                                    try {
                                        const result = await originalUploadAndSendFile.call(this);
                                        parent.log('✅ 文件上传和发送成功！');
                                        parent.updateCheckpoint(5, '✅');
                                        return result;
                                    } catch (error) {
                                        parent.log('❌ 文件上传失败: ' + error.message);
                                        parent.updateCheckpoint(5, '❌');
                                        throw error;
                                    }
                                };
                            } else {
                                parent.log('❌ QuickTalk客服系统初始化失败：主模块未找到');
                                parent.updateCheckpoint(0, '❌');
                            }
                        };
                        
                        script.onerror = () => {
                            parent.log('❌ JavaScript脚本加载失败');
                            parent.updateCheckpoint(0, '❌');
                        };
                        
                        document.head.appendChild(script);
                    }
                    
                    // 开始加载
                    try {
                        loadCSS();
                        loadJS();
                    } catch (e) {
                        parent.log('❌ 加载过程中发生错误: ' + e.message);
                    }
                    
                    // 全局暴露配置（供动态加载的脚本使用）
                    window.QUICKTALK_EMBED_CONFIG = QUICKTALK_CONFIG;
                })();
            `;
            
            document.head.appendChild(script);
            
            setTimeout(() => {
                document.getElementById('customer-service-area').innerHTML = '<p>✅ 客服系统加载完成！请查看页面右下角的客服按钮。</p>';
            }, 2000);
        }
        
        // 页面加载完成后的初始化
        document.addEventListener('DOMContentLoaded', function() {
            log('📋 测试页面初始化完成');
            log('💡 点击"加载客服系统"按钮开始测试');
        });
    </script>
</body>
</html>