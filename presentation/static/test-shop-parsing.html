<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>店铺数据解析测试</title>
</head>
<body>
    <h1>店铺数据解析测试</h1>
    <div id="output"></div>
    
    <script>
        // 模拟API响应格式测试
        async function testDataParsing() {
            const output = document.getElementById('output');
            
            // 测试场景1：正确的API响应格式
            console.log('🧪 测试场景1：正确的API响应格式');
            const apiResponse = {
                success: true,
                data: [
                    { id: '1', name: '测试店铺1', domain: 'test1.com' },
                    { id: '2', name: '测试店铺2', domain: 'test2.com' }
                ],
                message: 'Success'
            };
            
            let shopsData = null;
            
            // 应用我们的解析逻辑
            if (apiResponse.success && Array.isArray(apiResponse.data)) {
                console.log('✅ 成功获取店铺数据:', apiResponse.data);
                shopsData = apiResponse.data;
            } else if (Array.isArray(apiResponse)) {
                console.log('✅ 直接数组格式店铺数据:', apiResponse);
                shopsData = apiResponse;
            } else {
                console.warn('⚠️ 意外的响应格式:', apiResponse);
                shopsData = [];
            }
            
            // 确保shopsData是数组
            if (!Array.isArray(shopsData)) {
                console.error('❌ shopsData不是数组:', typeof shopsData, shopsData);
                shopsData = [];
            }
            
            console.log('📊 最终的店铺数据:', shopsData);
            
            // 测试map功能
            try {
                const shopsHTML = shopsData.map(shop => `
                    <div>店铺: ${shop.name} - ${shop.domain}</div>
                `).join('');
                
                output.innerHTML = `
                    <h2>✅ 测试成功</h2>
                    <p>数据类型: ${Array.isArray(shopsData) ? '数组' : typeof shopsData}</p>
                    <p>数据长度: ${shopsData.length}</p>
                    <h3>解析结果:</h3>
                    ${shopsHTML}
                `;
                console.log('✅ map操作成功完成');
            } catch (error) {
                output.innerHTML = `
                    <h2>❌ 测试失败</h2>
                    <p>错误: ${error.message}</p>
                    <p>数据类型: ${typeof shopsData}</p>
                    <p>数据值: ${JSON.stringify(shopsData)}</p>
                `;
                console.error('❌ map操作失败:', error);
            }
            
            // 测试场景2：错误的数据格式
            console.log('\n🧪 测试场景2：错误的数据格式');
            const badResponse = {
                success: true,
                data: "not an array", // 错误的数据类型
                message: 'Bad data'
            };
            
            let badShopsData = null;
            if (badResponse.success && Array.isArray(badResponse.data)) {
                badShopsData = badResponse.data;
            } else if (Array.isArray(badResponse)) {
                badShopsData = badResponse;
            } else {
                console.warn('⚠️ 意外的响应格式:', badResponse);
                badShopsData = [];
            }
            
            if (!Array.isArray(badShopsData)) {
                console.error('❌ badShopsData不是数组，已修正为空数组');
                badShopsData = [];
            }
            
            console.log('📊 修正后的数据:', badShopsData);
            console.log('✅ 错误处理测试完成');
        }
        
        // 页面加载后运行测试
        window.onload = testDataParsing;
    </script>
</body>
</html>