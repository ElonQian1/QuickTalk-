<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>高级通知系统演示 - QuickTalk客服系统</title>
    <link rel="stylesheet" href="/css/notification-manager.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .demo-header {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }

        .demo-header h1 {
            margin: 0;
            font-size: 2.5rem;
        }

        .demo-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .demo-info {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .demo-info h3 {
            margin-top: 0;
            color: #333;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .feature-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .feature-item h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .feature-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }

        .demo-actions {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .demo-actions h3 {
            margin-top: 0;
            color: #333;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .demo-log {
            background: #2d3748;
            color: #a0aec0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .log-entry {
            margin: 0.5rem 0;
            padding: 0.25rem 0;
        }

        .log-timestamp {
            color: #63b3ed;
        }

        .log-level-info { color: #68d391; }
        .log-level-warn { color: #fbd38d; }
        .log-level-error { color: #fc8181; }
    </style>
</head>
<body>
    <div class="demo-header">
        <h1>📡 高级通知系统演示</h1>
        <p>多渠道实时通知推送系统 - 支持WebSocket、邮件、短信、推送等多种方式</p>
    </div>

    <div class="demo-container">
        <!-- 系统介绍 -->
        <div class="demo-info">
            <h3>🚀 系统特性</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>🔌 实时通知</h4>
                    <p>基于WebSocket的实时通知推送，支持即时消息传递</p>
                </div>
                <div class="feature-item">
                    <h4>📱 多渠道支持</h4>
                    <p>支持WebSocket、邮件、短信、推送等多种通知渠道</p>
                </div>
                <div class="feature-item">
                    <h4>🎨 模板管理</h4>
                    <p>灵活的通知模板系统，支持变量替换和多样化内容</p>
                </div>
                <div class="feature-item">
                    <h4>📊 统计分析</h4>
                    <p>详细的发送统计和成功率分析，支持多维度数据展示</p>
                </div>
                <div class="feature-item">
                    <h4>⏰ 定时发送</h4>
                    <p>支持定时通知发送，灵活的调度机制</p>
                </div>
                <div class="feature-item">
                    <h4>🔐 订阅管理</h4>
                    <p>用户可自定义订阅偏好，精准推送相关内容</p>
                </div>
            </div>
        </div>

        <!-- 演示操作 -->
        <div class="demo-actions">
            <h3>🎮 演示操作</h3>
            <p>连接状态: <span class="status-indicator status-connecting" id="connection-status"></span><span id="connection-text">连接中...</span></p>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="sendWelcomeNotification()">发送欢迎通知</button>
                <button class="btn btn-info" onclick="sendMessageNotification()">发送消息通知</button>
                <button class="btn btn-warning" onclick="sendSystemNotification()">发送系统通知</button>
                <button class="btn btn-secondary" onclick="loadNotificationStats()">查看统计数据</button>
                <button class="btn btn-primary" onclick="createSampleTemplate()">创建示例模板</button>
                <button class="btn btn-info" onclick="testAllChannels()">测试所有渠道</button>
            </div>

            <div class="demo-log" id="demo-log">
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:00]</span>
                    <span class="log-level-info">[INFO]</span>
                    高级通知系统演示已启动
                </div>
            </div>
        </div>

        <!-- 通知管理器 -->
        <div id="notification-manager-container">
            <!-- 通知管理器将在这里动态加载 -->
        </div>
    </div>

    <script src="/js/notification-manager.js"></script>
    <script>
        let wsConnection = null;
        let isConnected = false;

        // 初始化WebSocket连接
        function initializeWebSocket() {
            try {
                wsConnection = new WebSocket(`ws://${window.location.host}/ws`);
                
                wsConnection.onopen = function() {
                    isConnected = true;
                    updateConnectionStatus('online', '已连接');
                    addLogEntry('WebSocket连接已建立', 'info');
                };
                
                wsConnection.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addLogEntry(`收到消息: ${data.type}`, 'info');
                        
                        if (data.type === 'notification') {
                            displayReceivedNotification(data);
                        }
                    } catch (error) {
                        addLogEntry(`消息解析失败: ${error.message}`, 'error');
                    }
                };
                
                wsConnection.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus('offline', '连接断开');
                    addLogEntry('WebSocket连接已断开', 'warn');
                    
                    // 重连逻辑
                    setTimeout(() => {
                        addLogEntry('正在尝试重连...', 'info');
                        initializeWebSocket();
                    }, 5000);
                };
                
                wsConnection.onerror = function(error) {
                    addLogEntry(`WebSocket错误: ${error}`, 'error');
                };
                
            } catch (error) {
                addLogEntry(`连接失败: ${error.message}`, 'error');
                updateConnectionStatus('offline', '连接失败');
            }
        }

        // 更新连接状态
        function updateConnectionStatus(status, text) {
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // 添加日志条目
        function addLogEntry(message, level = 'info') {
            const logContainer = document.getElementById('demo-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">[${level.toUpperCase()}]</span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // 发送API请求
        async function sendApiRequest(url, data = {}) {
            try {
                addLogEntry(`发送请求: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry(`请求成功: ${result.message || '操作完成'}`, 'info');
                } else {
                    addLogEntry(`请求失败: ${result.error}`, 'error');
                }
                
                return result;
                
            } catch (error) {
                addLogEntry(`请求异常: ${error.message}`, 'error');
                throw error;
            }
        }

        // 发送欢迎通知
        async function sendWelcomeNotification() {
            await sendApiRequest('/api/notifications/send', {
                shopId: 'demo_shop',
                userId: 'demo_user',
                title: '欢迎来到QuickTalk客服系统',
                message: '欢迎您使用我们的高级通知系统！这是一条欢迎消息示例。',
                type: 'welcome',
                priority: 'normal',
                channels: ['websocket', 'push'],
                metadata: {
                    source: 'demo',
                    category: 'welcome'
                }
            });
        }

        // 发送消息通知
        async function sendMessageNotification() {
            await sendApiRequest('/api/notifications/send', {
                shopId: 'demo_shop',
                userId: 'demo_user',
                title: '您有新消息',
                message: '客服代表向您发送了新消息，请及时查看回复。',
                type: 'message',
                priority: 'high',
                channels: ['websocket', 'email'],
                metadata: {
                    source: 'demo',
                    category: 'message',
                    messageId: 'msg_' + Date.now()
                }
            });
        }

        // 发送系统通知
        async function sendSystemNotification() {
            await sendApiRequest('/api/notifications/send', {
                title: '系统维护通知',
                message: '系统将于今晚23:00-01:00进行维护升级，期间可能暂停服务，请您提前做好准备。',
                type: 'system',
                priority: 'urgent',
                channels: ['websocket', 'email', 'push'],
                metadata: {
                    source: 'demo',
                    category: 'maintenance'
                }
            });
        }

        // 查看统计数据
        async function loadNotificationStats() {
            try {
                addLogEntry('正在获取统计数据...', 'info');
                
                const response = await fetch('/api/notifications/stats/demo_shop');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    addLogEntry(`统计数据 - 已发送: ${stats.totalStats.sent}, 成功率: ${stats.totalStats.successRate}`, 'info');
                    addLogEntry(`队列状态 - 待处理: ${stats.queueStatus.pending}`, 'info');
                } else {
                    addLogEntry(`获取统计失败: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLogEntry(`获取统计异常: ${error.message}`, 'error');
            }
        }

        // 创建示例模板
        async function createSampleTemplate() {
            await sendApiRequest('/api/notifications/templates', {
                shopId: 'demo_shop',
                name: '订单状态更新',
                title: '您的订单{{orderNumber}}状态已更新',
                content: '尊敬的{{customerName}}，您的订单{{orderNumber}}状态已更新为{{status}}，预计{{deliveryTime}}送达。',
                type: 'order',
                channels: ['websocket', 'email', 'sms'],
                variables: ['orderNumber', 'customerName', 'status', 'deliveryTime'],
                createdBy: 'demo_admin'
            });
        }

        // 测试所有渠道
        async function testAllChannels() {
            const channels = ['websocket', 'email', 'push', 'sms'];
            
            for (let i = 0; i < channels.length; i++) {
                const channel = channels[i];
                await sendApiRequest('/api/notifications/send', {
                    shopId: 'demo_shop',
                    userId: 'demo_user',
                    title: `${channel.toUpperCase()}通道测试`,
                    message: `这是${channel}通道的测试消息，测试时间：${new Date().toLocaleString()}`,
                    type: 'test',
                    priority: 'normal',
                    channels: [channel],
                    metadata: {
                        source: 'demo',
                        testChannel: channel
                    }
                });
                
                // 间隔发送
                if (i < channels.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        // 显示收到的通知
        function displayReceivedNotification(notification) {
            addLogEntry(`收到通知: ${notification.title}`, 'info');
            
            // 创建通知显示元素
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification-demo-item';
            notificationDiv.style.cssText = `
                background: #e3f2fd;
                border: 1px solid #2196f3;
                border-radius: 4px;
                padding: 10px;
                margin: 5px 0;
                position: relative;
            `;
            
            notificationDiv.innerHTML = `
                <strong>${notification.title}</strong><br>
                <span style="color: #666;">${notification.message}</span><br>
                <small style="color: #999;">类型: ${notification.notificationType} | 优先级: ${notification.priority}</small>
            `;
            
            // 添加到日志前面
            const logContainer = document.getElementById('demo-log');
            logContainer.insertBefore(notificationDiv, logContainer.firstChild);
            
            // 3秒后移除
            setTimeout(() => {
                if (notificationDiv.parentElement) {
                    notificationDiv.remove();
                }
            }, 3000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('页面加载完成', 'info');
            
            // 初始化WebSocket连接
            setTimeout(() => {
                initializeWebSocket();
            }, 1000);
            
            // 延迟加载通知管理器
            setTimeout(() => {
                addLogEntry('通知管理器UI已加载', 'info');
            }, 2000);
        });
    </script>
</body>
</html>