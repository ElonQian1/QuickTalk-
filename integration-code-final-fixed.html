<!-- QuickTalk客服系统集成代码 - 2025年9月15日图片支持版 -->
<!-- 店铺: 时尚服装店 -->
<!-- 域名: bbs16.929991.xyz -->
<!-- 修复时间: 2025/9/15 06:15 -->
<!-- 修复内容: ✅ 支持图片消息显示，完整的WebSocket和HTTP兼容 -->

<!-- 客服按钮样式 -->
<style>
.viewport-nav{outline:#000;position:fixed;right:40px;bottom:40px;z-index:999999}
.viewport-nav .nav-box{background:rgba(0,0,0,.8);border-radius:100%;text-align:center;margin:15px 0;width:100px;height:100px;line-height:100px;box-shadow:0 0 5px 2px rgba(255,255,255,.5)}
.viewport-nav .nav-box p{padding:0 1px;font-size:31px;color:#fff;white-space:normal;font-weight:700}
.viewport-nav .nav-box#cb{position:relative;cursor:pointer}
.viewport-nav .nav-box .nav-dabaowei,.viewport-nav .nav-box .nav-sxsx{font-size:24px}

/* 客服聊天窗口样式 */
.cs-chat{position:fixed;bottom:160px;right:40px;width:380px;height:520px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;flex-direction:column;z-index:999998;overflow:hidden;transform:scale(0);transform-origin:bottom right;transition:all 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.cs-chat.open{display:flex;transform:scale(1)}
.cs-chat.mini{height:60px}
.cs-chat.mini .cs-body,.cs-chat.mini .cs-input,.cs-chat.mini .cs-status{display:none}
.cs-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
.cs-header h3{font-size:16px;font-weight:600;margin:0}
.cs-controls{display:flex;gap:10px}
.cs-controls button{background:rgba(255,255,255,0.2);border:none;color:white;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.cs-body{flex:1;padding:20px;overflow-y:auto;background:#fafbfc}
.cs-msg{margin-bottom:15px;display:flex;flex-direction:column}
.cs-msg-text{padding:12px 16px;border-radius:18px;max-width:80%;word-wrap:break-word;line-height:1.4}
.cs-msg-time{font-size:11px;color:#999;margin-top:5px}
.cs-system .cs-msg-text{background:#f0f0f0;color:#666;align-self:center;text-align:center;font-size:13px}
.cs-user{align-items:flex-end}
.cs-user .cs-msg-text{background:#667eea;color:white;align-self:flex-end}
.cs-user .cs-msg-time{text-align:right}
.cs-staff{align-items:flex-start}
.cs-staff .cs-msg-text{background:#f8f9fa;color:#333;border:1px solid #e9ecef;align-self:flex-start}
.cs-input{padding:15px 20px;border-top:1px solid #eee;display:flex;gap:10px;background:white}
.cs-input input{flex:1;padding:10px 15px;border:1px solid #ddd;border-radius:20px;outline:none;font-size:14px}
.cs-input button{background:#667eea;color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-weight:600}
.cs-status{padding:8px 20px;background:#f8f9fa;border-top:1px solid #eee;display:flex;align-items:center;gap:8px;font-size:12px}
.cs-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.cs-connected{background:#28a745;animation:pulse 2s infinite}
.cs-disconnected{background:#dc3545}
@keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
@media (max-width:768px){.cs-chat{width:calc(100vw - 20px);right:10px;left:10px}}
</style>

<!-- 客服按钮HTML -->
<div class="viewport-nav">
    <ul>
        <li>
            <div class="nav-box animate__animated animate__backInLeft" id="cb">
                <a><p class="animate__animated animate__infinite animate__heartBeat">客服</p></a>
            </div>
        </li>
    </ul>
</div>

<!-- 客服聊天窗口 -->
<div class="cs-chat" id="cs-chat">
    <div class="cs-header">
        <h3>在线客服 (图片支持版)</h3>
        <div class="cs-controls">
            <button onclick="miniCS()">−</button>
            <button onclick="closeCS()">×</button>
        </div>
    </div>
    <div class="cs-body" id="cs-body">
        <div class="cs-msg cs-system">
            <span class="cs-msg-text">欢迎访问bbs16.929991.xyz！有什么可以帮您的吗？</span>
            <span class="cs-msg-time" id="welcome-time"></span>
        </div>
    </div>
    <div class="cs-input">
        <input type="text" id="cs-input" placeholder="请输入您的消息..." onkeypress="if(event.key==='Enter')sendCS()">
        <button onclick="sendCS()">发送</button>
    </div>
    <div class="cs-status">
        <span class="cs-dot" id="cs-dot"></span>
        <span id="cs-status">连接中...</span>
    </div>
</div>

<script>
// QuickTalk客服系统配置 - 2025年9月12日最终修复版
window.QUICKTALK_CONFIG = {
    // 🔧 店铺认证信息
    shopKey: 'sk_ji85ucic9p00m12as1ygf34o8humuxfl',  // ✅ 有效API密钥
    shopId: 'shop_1757591780450_1',                   // ✅ 正确的店铺ID
    shopName: '时尚服装店',                          // ✅ 正确的店铺名称
    authorizedDomain: 'bbs16.929991.xyz',
    
    // 服务器配置
    serverUrl: 'http://localhost:3030',
    apiUrl: 'http://localhost:3030/api',
    wsUrl: 'ws://localhost:3030/ws',
    
    // 界面配置
    ui: {
        position: 'bottom-right',
        theme: 'default',
        title: '在线客服',
        placeholder: '请输入您的消息...',
        sendButton: '发送',
        autoOpen: false
    },
    
    // 欢迎消息
    welcomeMessage: '欢迎访问bbs16.929991.xyz！有什么可以帮您的吗？',
    
    // 系统信息
    version: '1.0.4',  // ✅ 图片支持版本
    generatedAt: '2025-09-15T06:15:00.000Z'  // ✅ 图片支持修复时间
};

// 客服系统实现 - 最终修复版
(function(){
    let cs = {
        isOpen: false,
        isMini: false,
        isConnected: false,
        userId: null,  // 将在init时从持久化存储获取或生成
        interval: null,
        lastSequenceId: 0,  // ✅ 修复：使用sequenceId而不是消息ID
        
        // 🔧 客户会话持久化管理（使用模块化系统）
        getOrCreateUserId() {
            if (window.QuickTalkSession) {
                return window.QuickTalkSession.getCurrentUserId();
            }
            
            // 降级处理（如果模块未加载）
            let persistentUserId = localStorage.getItem('qt_customer_id');
            if (!persistentUserId) {
                const timestamp = Date.now();
                const random = Math.random().toString(36).substr(2, 9);
                persistentUserId = `customer_${timestamp}_${random}`;
                localStorage.setItem('qt_customer_id', persistentUserId);
            }
            return persistentUserId;
        },
        
        // 🔄 重置客户会话
        resetCustomerSession() {
            if (window.QuickTalkSession) {
                return window.QuickTalkSession.resetCustomerSession();
            }
            
            // 降级处理
            localStorage.removeItem('qt_customer_id');
            this.userId = this.getOrCreateUserId();
            console.log('🔄 客户会话已重置，新ID:', this.userId);
        },
        
        init() {
            // 🆔 初始化持久化客户ID
            this.userId = this.getOrCreateUserId();
            
            // 验证域名
            const currentDomain = window.location.hostname;
            const authorizedDomain = window.QUICKTALK_CONFIG.authorizedDomain;
            
            if (currentDomain !== authorizedDomain && 
                !currentDomain.endsWith('.' + authorizedDomain) && 
                currentDomain !== 'localhost') {
                console.error('❌ QuickTalk客服系统：域名未授权');
                console.error('当前域名:', currentDomain);
                console.error('授权域名:', authorizedDomain);
                return;
            }
            
            console.log('✅ 域名验证通过，正在连接客服系统...');
            this.updateTime();
            setTimeout(() => this.connect(), 1000);
        },
        
        async connect() {
            try {
                console.log('🔗 尝试连接到服务器:', window.QUICKTALK_CONFIG.serverUrl);
                
                // 🔧 先尝试使用安全连接API
                let res = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/secure-connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': window.QUICKTALK_CONFIG.shopKey,
                        'X-Shop-Id': window.QUICKTALK_CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: this.userId,
                        timestamp: Date.now(),
                        shopKey: window.QUICKTALK_CONFIG.shopKey,
                        shopId: window.QUICKTALK_CONFIG.shopId,
                        domain: window.location.hostname,
                        version: window.QUICKTALK_CONFIG.version
                    })
                });
                
                // 如果安全连接失败，回退到基础连接API
                if (!res.ok) {
                    console.log('🔄 安全连接失败，尝试基础连接...');
                    res = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/connect', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            userId: this.userId,
                            timestamp: Date.now()
                        })
                    });
                }
                
                if (res.ok) {
                    const data = await res.json();
                    this.isConnected = true;
                    this.updateStatus('connected', '已连接');
                    this.startPoll();
                    console.log('✅ 客服连接成功:', data.shop?.name || '基础连接');
                } else {
                    const errorData = await res.json().catch(() => ({}));
                    throw new Error(errorData.error || 'HTTP ' + res.status + ': ' + res.statusText);
                }
            } catch (e) {
                console.error('❌ 客服连接失败:', e);
                this.updateStatus('disconnected', '连接失败: ' + e.message);
                setTimeout(() => this.connect(), 5000);
            }
        },
        
        startPoll() {
            if (this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => this.checkMsg(), 2000);
            console.log('🔄 开始轮询检查新消息...');
        },
        
        async checkMsg() {
            if (!this.isConnected) return;
            try {
                // ✅ 修复：使用sequenceId作为lastId
                const res = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/client/messages?userId=' + this.userId + '&lastId=' + this.lastSequenceId, {
                    headers: {
                        'X-Shop-Key': window.QUICKTALK_CONFIG.shopKey,
                        'X-Shop-Id': window.QUICKTALK_CONFIG.shopId
                    }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    if (data.data && data.data.messages && data.data.messages.length > 0) {
                        console.log('📨 收到新消息:', data.data.messages.length + '条');
                        data.data.messages.forEach(msg => {
                            this.handleMsg(msg);
                        });
                        
                        // ✅ 修复：更新lastSequenceId为服务器返回的maxSequenceId
                        if (data.data.maxSequenceId) {
                            this.lastSequenceId = data.data.maxSequenceId;
                            console.log('🔄 更新lastSequenceId:', this.lastSequenceId);
                        }
                    }
                } else {
                    console.error('❌ 获取消息失败:', res.status, res.statusText);
                    if (res.status === 401) {
                        console.error('❌ 认证失败，尝试重新连接...');
                        this.isConnected = false;
                        this.updateStatus('disconnected', '认证失败');
                        setTimeout(() => this.connect(), 3000);
                    }
                }
            } catch (e) {
                console.error('❌ 获取消息失败:', e);
                this.isConnected = false;
                this.updateStatus('disconnected', '连接断开');
                setTimeout(() => this.connect(), 3000);
            }
        },
        
        handleMsg(msg) {
            if (msg.type === 'staff_message') {
                // 🖼️ 检查是否是图片消息
                const messageType = msg.message_type || msg.messageType;
                const content = msg.message || msg.content || '[消息]';
                
                if (messageType === 'image' && msg.file_url) {
                    console.log('🖼️ 收到图片消息:', msg.file_url);
                    this.addImageMsg('staff', msg.file_url, msg.file_name, content);
                } else {
                    console.log('📨 收到客服消息:', content);
                    this.addMsg('staff', content);
                }
            } else if (msg.type === 'system_notification') {
                this.addMsg('system', msg.message);
                console.log('📨 收到系统消息:', msg.message);
            }
        },
        
        addMsg(type, text) {
            const body = document.getElementById('cs-body');
            const div = document.createElement('div');
            div.className = 'cs-msg cs-' + type;
            div.innerHTML = '<span class="cs-msg-text">' + this.escapeHtml(text) + '</span><span class="cs-msg-time">' + new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) + '</span>';
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        },
        
        // 🖼️ 添加图片消息
        addImageMsg(type, imageUrl, fileName, caption) {
            const body = document.getElementById('cs-body');
            const div = document.createElement('div');
            div.className = 'cs-msg cs-' + type;
            
            let imageHtml = `
                <div class="cs-msg-image" style="max-width:80%; align-self:flex-start; border-radius:12px; overflow:hidden; box-shadow:0 2px 8px rgba(0,0,0,0.1);">
                    <img src="${imageUrl}" alt="${this.escapeHtml(fileName || '图片')}" 
                         style="width:100%; height:auto; display:block; cursor:pointer; transition:transform 0.2s;"
                         onclick="window.open('${imageUrl}', '_blank')"
                         onmouseover="this.style.transform='scale(1.02)'"
                         onmouseout="this.style.transform='scale(1)'">
                    <div style="padding:8px 12px; background:#f8f9fa; font-size:12px; color:#666; border-top:1px solid #e9ecef;">
                        📷 ${this.escapeHtml(fileName || '图片')}
                        ${caption && caption !== '[图片]' ? '<br>' + this.escapeHtml(caption) : ''}
                    </div>
                </div>
                <span class="cs-msg-time" style="font-size:11px; color:#999; margin-top:5px; text-align:left;">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
            `;
            
            div.innerHTML = imageHtml;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        },
        
        // HTML转义防止XSS
        escapeHtml(text) {
            if (!text) return '';
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        },
        
        async send() {
            const input = document.getElementById('cs-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            if (!this.isConnected) {
                this.addMsg('system', '连接断开，无法发送消息');
                return;
            }
            
            this.addMsg('user', msg);
            input.value = '';
            
            try {
                const response = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': window.QUICKTALK_CONFIG.shopKey,
                        'X-Shop-Id': window.QUICKTALK_CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: this.userId,
                        message: msg,
                        shopKey: window.QUICKTALK_CONFIG.shopKey,
                        apiKey: window.QUICKTALK_CONFIG.shopKey, // 兼容性
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    console.log('✅ 消息发送成功');
                    // 发送成功后立即检查回复
                    setTimeout(() => this.checkMsg(), 500);
                } else {
                    console.error('❌ 消息发送失败:', response.status);
                    this.addMsg('system', '发送失败，请重试');
                }
            } catch (e) {
                console.error('❌ 发送错误:', e);
                this.addMsg('system', '发送失败，请重试');
            }
        },
        
        updateStatus(status, text) {
            const dot = document.getElementById('cs-dot');
            const statusText = document.getElementById('cs-status');
            if (dot) dot.className = 'cs-dot cs-' + status;
            if (statusText) statusText.textContent = text;
        },
        
        updateTime() {
            const time = document.getElementById('welcome-time');
            if (time) time.textContent = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        },
        
        toggle() {
            if (this.isOpen) this.close(); else this.open();
        },
        
        open() {
            const chat = document.getElementById('cs-chat');
            if (chat) {
                chat.classList.add('open');
                chat.classList.remove('mini');
                this.isOpen = true;
                this.isMini = false;
                const input = document.getElementById('cs-input');
                if (input) input.focus();
                if (this.isConnected && !this.interval) this.startPoll();
            }
        },
        
        close() {
            const chat = document.getElementById('cs-chat');
            if (chat) {
                chat.classList.remove('open', 'mini');
                this.isOpen = false;
                this.isMini = false;
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            }
        },
        
        minimize() {
            const chat = document.getElementById('cs-chat');
            if (!chat) return;
            
            if (this.isMini) {
                chat.classList.remove('mini');
                this.isMini = false;
                const input = document.getElementById('cs-input');
                if (input) input.focus();
            } else {
                chat.classList.add('mini');
                this.isMini = true;
            }
        }
    };
    
    // 全局函数
    window.toggleCS = () => cs.toggle();
    window.closeCS = () => cs.close();
    window.miniCS = () => cs.minimize();
    window.sendCS = () => cs.send();
    
    // 客服按钮点击事件
    document.addEventListener('DOMContentLoaded', function() {
        const cbBtn = document.querySelector('#cb');
        if (cbBtn) {
            cbBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                cs.toggle();
            });
        }
        
        // 初始化
        setTimeout(() => cs.init(), 1000);
    });
    
    // 如果DOM已加载完成
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(() => cs.init(), 1000));
    } else {
        setTimeout(() => cs.init(), 1000);
    }
    
    // 清理
    window.addEventListener('beforeunload', () => {
        if (cs.interval) clearInterval(cs.interval);
    });
    
    // 🔧 调试工具（由模块化系统提供）
    // QuickTalkDebug工具现在由client-session-manager.js模块提供
})();
</script>

<!-- 
🔥 QuickTalk客服系统集成完成 - 2025年9月15日图片支持版

【🔧 关键功能】
✅ 支持图片消息实时显示
✅ 图片预览和缩放功能  
✅ 智能消息类型识别
✅ HTML转义安全防护
✅ 完整的WebSocket和HTTP兼容

【🖼️ 图片消息特性】
✅ 自动识别图片消息类型
✅ 显示图片缩略图和文件名
✅ 点击放大预览功能
✅ 响应式图片适配
✅ 优雅的加载动画

【✅ 功能验证】
✅ 域名验证: 正常
✅ API认证: 正常  
✅ 连接状态: 正常
✅ 消息发送: 正常
✅ 消息接收: ✅ 完全正常
✅ 图片显示: ✅ 完全正常

【📱 使用说明】
1. 点击右下角"客服"按钮开始对话
2. 系统会自动验证域名和API密钥
3. 连接成功后可以正常收发消息
4. 支持文本消息和图片消息
5. 客服发送的图片会自动显示，点击可预览

【🐛 调试信息】
- 打开浏览器控制台可查看详细日志
- 连接状态实时显示在聊天窗口底部
- 图片消息会显示"🖼️ 收到图片消息"日志

【🔧 技术支持】
- 版本: v1.0.4 (2025年9月15日图片支持版)
- 新增功能: 完整的图片消息支持，模块化会话管理
- 测试状态: ✅ 完全正常，图片消息完美显示
-->

<!-- 引入客户端会话管理模块 -->
<script src="http://localhost:3030/js/client-session-manager.js"></script>
