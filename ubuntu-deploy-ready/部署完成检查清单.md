# ✅ Ubuntu HTTPS 部署完成检查清单

## 📦 Windows 端 - 部署包准备

### ✅ 编译完成确认
- [x] Rust 后端交叉编译成功
- [x] 二进制文件: `customer-service-backend` (8.04 MB)
- [x] 编译时间: 2025-10-15 23:04
- [x] 目标平台: x86_64-unknown-linux-musl
- [x] TLS 支持: Rustls (纯Rust, 无OpenSSL依赖)
- [x] 数据库: Sea-ORM 自动迁移

### ✅ 部署文件清单
- [x] 后端二进制: `customer-service-backend`
- [x] 环境配置: `.env` (HTTPS强制模式)
- [x] SSL证书: `certs/server.crt`, `certs/server.key`
- [x] 前端文件: `static/` 目录
- [x] 部署脚本: `deploy.sh`
- [x] 启动脚本: `start.sh`
- [x] 服务配置: `customer-service.service`
- [x] 文档资料: 所有 .md 文件

### ✅ 上传准备
**目标路径**: `/root/ubuntu-deploy-ready/`

**上传命令** (选择一种):
```powershell
# 方法1: SCP直接上传
scp -r E:\duihua\customer-service-system\ubuntu-deploy-ready root@43.139.82.12:/root/

# 方法2: 使用WinSCP/FileZilla等SFTP工具
```

---

## 🌐 Ubuntu 服务器端 - 部署执行

### 1️⃣ 连接服务器
```bash
ssh root@43.139.82.12
```

### 2️⃣ 验证文件上传
```bash
cd /root/ubuntu-deploy-ready
ls -lh customer-service-backend
# 应显示 8.0M 左右的文件

# 检查文件完整性
ls -la
# 应包含: customer-service-backend, .env, certs/, static/, *.sh
```

### 3️⃣ 执行自动部署
```bash
chmod +x deploy.sh
./deploy.sh
```

**部署脚本会自动完成**:
- ✅ 系统更新和工具安装
- ✅ 文件权限设置
- ✅ 数据库初始化
- ✅ 防火墙配置 (22, 8080, 8443)
- ✅ systemd 服务安装
- ✅ 服务启动

### 4️⃣ 验证服务状态
```bash
# 检查服务状态
systemctl status customer-service
# 应显示: Active: active (running)

# 查看实时日志
journalctl -u customer-service -f
# 应看到: "Server running on..." 等启动信息
```

### 5️⃣ 验证端口监听
```bash
netstat -tulpn | grep -E '8080|8443'
# 应显示:
# tcp  0.0.0.0:8080  (HTTP)
# tcp  0.0.0.0:8443  (HTTPS)
```

### 6️⃣ 验证防火墙
```bash
ufw status verbose
# 应显示:
# 22/tcp   ALLOW IN    Anywhere
# 8080/tcp ALLOW IN    Anywhere
# 8443/tcp ALLOW IN    Anywhere
# Status: active
```

### 7️⃣ 验证数据库
```bash
ls -lh customer_service.db
# 应显示数据库文件 (几十KB)

sqlite3 customer_service.db "SELECT name FROM sqlite_master WHERE type='table';"
# 应显示所有表: users, shops, customers, sessions, messages等
```

---

## 🌐 浏览器端 - 访问测试

### ✅ HTTPS 访问 (推荐)
- **域名**: https://elontalk.duckdns.org:8443
- **IP**: https://43.139.82.12:8443

**首次访问提示**:
- ⚠️ 浏览器会显示"不安全"警告（自签名证书）
- 点击"高级" -> "继续访问"

### ✅ HTTP 访问 (会自动重定向)
- **域名**: http://elontalk.duckdns.org:8080
- **IP**: http://43.139.82.12:8080
- 会自动重定向到 HTTPS

### ✅ 功能测试
1. 访问管理后台首页
2. 测试用户注册
3. 测试用户登录
4. 检查静态资源加载 (JS, CSS, 图片)
5. 测试 WebSocket 连接

---

## 🔍 故障排查步骤

### 问题1: 服务无法启动
```bash
# 查看详细错误日志
journalctl -u customer-service -n 100 --no-pager

# 检查二进制文件权限
ls -l customer-service-backend
chmod +x customer-service-backend

# 手动测试运行
cd /root/ubuntu-deploy-ready
./customer-service-backend
```

### 问题2: 端口被占用
```bash
# 检查端口占用
netstat -tulpn | grep -E '8080|8443'

# 如有其他进程占用，kill掉
kill -9 <PID>

# 重启服务
systemctl restart customer-service
```

### 问题3: 数据库权限错误
```bash
# 修复权限
chmod 755 /root/ubuntu-deploy-ready
chmod 644 customer_service.db

# 如果数据库损坏，删除重建
rm customer_service.db
systemctl restart customer-service
```

### 问题4: 静态文件404
```bash
# 检查static目录权限
ls -la static/
chmod -R 755 static/

# 检查index.html
ls -l static/index.html
```

### 问题5: 防火墙阻止访问
```bash
# 重新配置防火墙
ufw --force reset
ufw allow 22/tcp
ufw allow 8080/tcp
ufw allow 8443/tcp
ufw --force enable

# 检查云服务商安全组规则
# 确保开放 22, 8080, 8443 端口
```

### 问题6: SSL证书错误
```bash
# 验证证书文件
openssl x509 -in certs/server.crt -text -noout

# 检查权限
chmod 644 certs/server.crt
chmod 600 certs/server.key

# 重启服务
systemctl restart customer-service
```

---

## 📊 性能检查

### CPU 和内存
```bash
# 查看资源使用
top -p $(pgrep customer-service)

# 预期:
# CPU: < 5% (空闲时)
# 内存: < 100MB
```

### 数据库性能
```bash
# 检查数据库大小
du -h customer_service.db

# 测试查询速度
time sqlite3 customer_service.db "SELECT COUNT(*) FROM users;"
```

### 网络连接
```bash
# 查看当前连接数
ss -tan | grep -E '8080|8443' | wc -l
```

---

## 🔐 安全加固建议

### 升级到受信任证书
```bash
# 使用 Let's Encrypt 申请免费证书
chmod +x setup-https.sh
./setup-https.sh
```

### 配置自动备份
```bash
# 添加到 crontab
crontab -e

# 每天凌晨3点备份数据库
0 3 * * * cp /root/ubuntu-deploy-ready/customer_service.db /root/backup/db_$(date +\%Y\%m\%d).db
```

### 日志轮转
```bash
# 限制日志大小
journalctl --vacuum-size=100M
journalctl --vacuum-time=7d
```

---

## 📞 完成确认

部署成功的标志:
- ✅ 服务状态: `active (running)`
- ✅ 端口监听: 8080 (HTTP) + 8443 (HTTPS)
- ✅ 浏览器可访问: https://elontalk.duckdns.org:8443
- ✅ 日志正常: 无错误信息
- ✅ 数据库可用: 可以注册/登录
- ✅ WebSocket 连接: 实时消息正常

---

## 📚 相关文档

- `部署说明_HTTPS版本.md` - 详细部署说明
- `QUICKSTART.md` - 快速开始指南
- `README.md` - 项目总览
- `上传指南.md` - 文件上传说明
- `最终部署检查.md` - 部署检查要点

---

**检查清单版本**: v1.0  
**适用系统**: Ubuntu 24.04 LTS  
**创建时间**: 2025-10-15 23:04
