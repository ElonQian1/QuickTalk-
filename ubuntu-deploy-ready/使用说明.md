# Ubuntu 服务器启动说明

## ❌ 问题诊断：服务器启动后立即 Terminated

### 可能原因

1. **SSH 会话断开** - 如果直接在 SSH 中运行 `./customer-service-backend`，SSH 断开时程序会被终止
2. **端口已被占用** - 虽然代码会尝试终止旧进程，但可能存在竞争条件
3. **权限问题** - 文件或目录权限不正确
4. **程序 Bug** - 程序内部错误导致立即退出

## ✅ 解决方案

### 方案 1: 使用 systemd 服务（推荐）

```bash
# 确保服务配置正确
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start customer-service

# 查看服务状态
sudo systemctl status customer-service

# 查看日志
sudo journalctl -u customer-service -f
```

### 方案 2: 使用 debug 启动脚本

```bash
cd /root/ubuntu-deploy-ready

# 添加执行权限
chmod +x debug-start.sh

# 运行调试启动脚本
./debug-start.sh

# 查看日志
tail -f server.log
```

### 方案 3: 使用 screen/tmux（临时方案）

```bash
# 安装 screen
apt-get install screen

# 创建新会话
screen -S customer-service

# 启动服务器
cd /root/ubuntu-deploy-ready
./customer-service-backend

# 分离会话: 按 Ctrl+A, 然后按 D
# 重新连接: screen -r customer-service
```

### 方案 4: 手动后台运行

```bash
cd /root/ubuntu-deploy-ready

# 后台运行并输出到日志
nohup ./customer-service-backend > server.log 2>&1 &

# 查看进程
ps aux | grep customer-service

# 查看日志
tail -f server.log
```

## 🔍 调试步骤

如果服务器仍然 Terminated，按以下步骤检查：

### 1. 检查端口占用

```bash
# 检查 8443 端口
lsof -ti:8443

# 检查 8080 端口  
lsof -ti:8080

# 如果有进程占用，手动终止
kill -9 $(lsof -ti:8443)
kill -9 $(lsof -ti:8080)
```

### 2. 检查文件权限

```bash
cd /root/ubuntu-deploy-ready

# 检查可执行文件
ls -l customer-service-backend

# 添加执行权限
chmod +x customer-service-backend

# 检查证书文件
ls -l certs/
```

### 3. 检查环境变量

```bash
cat .env

# 确保包含:
# TLS_MODE=https
# DATABASE_URL=sqlite:customer_service.db
# ACME_ENABLED=true
```

### 4. 查看详细日志

```bash
# 启用详细日志
export RUST_LOG=debug
export RUST_BACKTRACE=full

# 运行程序
./customer-service-backend 2>&1 | tee detailed.log
```

### 5. 检查系统资源

```bash
# 检查内存
free -h

# 检查磁盘空间
df -h

# 检查进程数限制
ulimit -a
```

## 📋 systemd 服务配置

确保 `/root/ubuntu-deploy-ready/customer-service.service` 包含正确配置:

```ini
[Unit]
Description=ELonTalk Customer Service System (HTTPS)
After=network.target

[Service]
Type=simple
User=root
WorkingDirectory=/root/ubuntu-deploy-ready
ExecStart=/root/ubuntu-deploy-ready/customer-service-backend
Environment=DATABASE_URL=sqlite:customer_service.db
Environment=RUST_LOG=info
Restart=always
RestartSec=10
StandardOutput=journal
StandardError=journal

[Install]
WantedBy=multi-user.target
```

安装服务:

```bash
# 复制服务文件
cp /root/ubuntu-deploy-ready/customer-service.service /etc/systemd/system/

# 重新加载 systemd
systemctl daemon-reload

# 启用开机自启
systemctl enable customer-service

# 启动服务
systemctl start customer-service

# 查看状态
systemctl status customer-service
```

## 🆘 如果所有方法都失败

1. **重新编译**:
   ```bash
   cd /root/ubuntu-deploy-ready/backend
   cargo clean
   cargo build --release --features https
   cp target/release/customer-service-backend ..
   ```

2. **检查程序版本**:
   ```bash
   ./customer-service-backend --version
   ldd ./customer-service-backend  # 检查依赖
   ```

3. **使用 strace 诊断**:
   ```bash
   strace -f ./customer-service-backend 2>&1 | tee strace.log
   ```

4. **联系技术支持**，提供:
   - `server.log` 日志文件
   - `strace.log` 追踪文件
   - `systemctl status customer-service` 输出
   - `journalctl -u customer-service -n 100` 输出
