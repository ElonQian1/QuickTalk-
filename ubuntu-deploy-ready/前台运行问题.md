# å‰å°è¿è¡Œé—®é¢˜è§£å†³æ–¹æ¡ˆ

## âŒ é—®é¢˜ç°è±¡

ç¨‹åºåœ¨å‰å°è¿è¡Œæ—¶æ˜¾ç¤ºå¯åŠ¨æˆåŠŸï¼Œä½†ç«‹å³æ˜¾ç¤º `Terminated` å¹¶é€€å‡ºï¼š

```
ğŸš€ HTTPSæœåŠ¡å™¨å¯åŠ¨åœ¨: https://0.0.0.0:8443
ğŸ”— å¯ä»¥é€šè¿‡ä»¥ä¸‹åœ°å€è®¿é—®:
   https://localhost:8443
   https://0.0.0.0:8443
Terminated
```

## ğŸ” å¯èƒ½åŸå› 

### 1. ç¨‹åºç¼–è¯‘é—®é¢˜
å¯èƒ½åœ¨ç¼–è¯‘æ—¶**æ²¡æœ‰å¯ç”¨ https ç‰¹æ€§**ï¼Œå¯¼è‡´æœåŠ¡å™¨ä»£ç è¢«æ¡ä»¶ç¼–è¯‘è·³è¿‡ã€‚

### 2. axum_server ç«‹å³è¿”å›
`axum_server::bind_rustls().serve()` æ–¹æ³•å¯èƒ½å› ä¸ºæŸäº›é”™è¯¯ç«‹å³è¿”å›ï¼Œè€Œä¸æ˜¯é˜»å¡ç­‰å¾…è¿æ¥ã€‚

### 3. å¼‚æ­¥è¿è¡Œæ—¶é—®é¢˜
HTTP é‡å®šå‘æœåŠ¡å™¨åœ¨ `tokio::spawn` ä¸­å¯åŠ¨ï¼Œå¦‚æœä¸»ä»»åŠ¡ç«‹å³å®Œæˆï¼Œæ•´ä¸ªç¨‹åºå°±ä¼šé€€å‡ºã€‚

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆ 1: é‡æ–°ç¼–è¯‘ï¼ˆç¡®ä¿å¯ç”¨ https ç‰¹æ€§ï¼‰

```bash
# åœ¨ Ubuntu æœåŠ¡å™¨ä¸Šæ‰§è¡Œ
cd /root/ubuntu-deploy-ready/backend

# æ¸…ç†æ—§çš„ç¼–è¯‘æ–‡ä»¶
cargo clean

# é‡æ–°ç¼–è¯‘ï¼ˆæ˜ç¡®å¯ç”¨ https ç‰¹æ€§ï¼‰
cargo build --release --features https

# å¤åˆ¶åˆ°éƒ¨ç½²ç›®å½•
cp target/release/customer-service-backend ../
chmod +x ../customer-service-backend

# æµ‹è¯•è¿è¡Œ
cd ..
./customer-service-backend
```

### æ–¹æ¡ˆ 2: è¿è¡Œè¯Šæ–­è„šæœ¬

```bash
cd /root/ubuntu-deploy-ready

# æ·»åŠ æ‰§è¡Œæƒé™
chmod +x diagnose-foreground.sh

# è¿è¡Œè¯Šæ–­
./diagnose-foreground.sh
```

è¯Šæ–­è„šæœ¬ä¼šæ£€æŸ¥ï¼š
- å¯æ‰§è¡Œæ–‡ä»¶æ˜¯å¦åŒ…å« HTTPS ä»£ç 
- ä¾èµ–åº“æ˜¯å¦å®Œæ•´
- è¯ä¹¦æ–‡ä»¶æ˜¯å¦å­˜åœ¨
- ç¨‹åºèƒ½å¦æ­£å¸¸å¯åŠ¨

### æ–¹æ¡ˆ 3: ä½¿ç”¨è¯¦ç»†æ—¥å¿—è¿è¡Œ

```bash
cd /root/ubuntu-deploy-ready

# å¯ç”¨è¯¦ç»†æ—¥å¿—å’Œå›æº¯
RUST_LOG=trace RUST_BACKTRACE=full ./customer-service-backend 2>&1 | tee detailed.log

# æŸ¥çœ‹æ—¥å¿—ä¸­çš„é”™è¯¯ä¿¡æ¯
```

### æ–¹æ¡ˆ 4: ä½¿ç”¨ strace è¯Šæ–­

```bash
cd /root/ubuntu-deploy-ready

# è¿½è¸ªç³»ç»Ÿè°ƒç”¨
strace -f -o strace.log ./customer-service-backend

# æŸ¥çœ‹å“ªé‡Œé€€å‡ºäº†
grep -A 5 -B 5 "exit" strace.log
```

### æ–¹æ¡ˆ 5: æ£€æŸ¥ Cargo.toml ç‰¹æ€§é…ç½®

ç¡®ä¿ `backend/Cargo.toml` ä¸­æ­£ç¡®é…ç½®äº† https ç‰¹æ€§ï¼š

```toml
[features]
default = []
https = ["rustls-pemfile", "axum-server", "instant-acme", "rcgen", "reqwest", "x509-parser", "async-trait"]

[dependencies]
axum-server = { version = "0.6", features = ["tls-rustls"], optional = true }
```

## ğŸ”§ ä¸´æ—¶è§£å†³æ–¹æ¡ˆ

å¦‚æœé‡æ–°ç¼–è¯‘ä»ç„¶å¤±è´¥ï¼Œå¯ä»¥ï¼š

### 1. ç¦ç”¨ HTTPSï¼Œä½¿ç”¨ HTTP æ¨¡å¼

ç¼–è¾‘ `.env` æ–‡ä»¶ï¼š

```bash
# ä¸´æ—¶ç¦ç”¨ HTTPS
TLS_MODE=disabled
# æˆ–
FORCE_HTTP=true
```

ç„¶åè¿è¡Œï¼š

```bash
./customer-service-backend
```

### 2. ä½¿ç”¨ HTTP ç«¯å£æµ‹è¯•

```bash
# æµ‹è¯• HTTP æ˜¯å¦èƒ½æ­£å¸¸å·¥ä½œ
curl http://localhost:8080/health
```

## ğŸ“‹ æ£€æŸ¥æ¸…å•

åœ¨è”ç³»æŠ€æœ¯æ”¯æŒå‰ï¼Œè¯·ç¡®è®¤ï¼š

- [ ] å·²è¿è¡Œè¯Šæ–­è„šæœ¬ `./diagnose-foreground.sh`
- [ ] å·²å°è¯•é‡æ–°ç¼–è¯‘ `cargo build --release --features https`
- [ ] å·²æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ TLS_MODE é…ç½®
- [ ] å·²æŸ¥çœ‹è¯¦ç»†æ—¥å¿— `RUST_LOG=trace ./customer-service-backend`
- [ ] å·²ç¡®è®¤è¯ä¹¦æ–‡ä»¶å­˜åœ¨ `ls -l certs/`
- [ ] å·²æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨ `lsof -ti:8443`

## ğŸ†˜ å¦‚æœä»ç„¶å¤±è´¥

æä¾›ä»¥ä¸‹ä¿¡æ¯ä»¥ä¾¿è¯Šæ–­ï¼š

1. **è¯Šæ–­è„šæœ¬è¾“å‡º**:
   ```bash
   ./diagnose-foreground.sh > diagnosis.txt 2>&1
   ```

2. **è¯¦ç»†æ—¥å¿—**:
   ```bash
   RUST_LOG=trace RUST_BACKTRACE=full ./customer-service-backend > detailed.log 2>&1
   ```

3. **ç³»ç»Ÿè°ƒç”¨è¿½è¸ª**:
   ```bash
   strace -f ./customer-service-backend 2>&1 | tail -n 100
   ```

4. **ç¼–è¯‘ä¿¡æ¯**:
   ```bash
   cd backend
   cargo build --release --features https 2>&1 | tee build.log
   ```

## ğŸ’¡ æ¨èåšæ³•

**æœ€ç¨³å®šçš„è¿è¡Œæ–¹å¼æ˜¯ä½¿ç”¨ systemd æœåŠ¡**ï¼Œè€Œä¸æ˜¯ç›´æ¥å‰å°è¿è¡Œï¼š

```bash
# å®‰è£… systemd æœåŠ¡
sudo cp customer-service.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable customer-service
sudo systemctl start customer-service

# æŸ¥çœ‹æ—¥å¿—
sudo journalctl -u customer-service -f
```

è¿™æ ·å¯ä»¥ï¼š
- âœ… å¼€æœºè‡ªå¯åŠ¨
- âœ… è‡ªåŠ¨é‡å¯ï¼ˆå´©æºƒæ—¶ï¼‰
- âœ… ç»Ÿä¸€çš„æ—¥å¿—ç®¡ç†
- âœ… æ›´å¥½çš„è¿›ç¨‹ç®¡ç†

---

**æ›´æ–°æ—¶é—´**: 2025-10-17
**çŠ¶æ€**: å¾…è¯Šæ–­
