# 前台运行问题解决方案

## ❌ 问题现象

程序在前台运行时显示启动成功，但立即显示 `Terminated` 并退出：

```
🚀 HTTPS服务器启动在: https://0.0.0.0:8443
🔗 可以通过以下地址访问:
   https://localhost:8443
   https://0.0.0.0:8443
Terminated
```

## 🔍 可能原因

### 1. 程序编译问题
可能在编译时**没有启用 https 特性**，导致服务器代码被条件编译跳过。

### 2. axum_server 立即返回
`axum_server::bind_rustls().serve()` 方法可能因为某些错误立即返回，而不是阻塞等待连接。

### 3. 异步运行时问题
HTTP 重定向服务器在 `tokio::spawn` 中启动，如果主任务立即完成，整个程序就会退出。

## ✅ 解决方案

### 方案 1: 重新编译（确保启用 https 特性）

```bash
# 在 Ubuntu 服务器上执行
cd /root/ubuntu-deploy-ready/backend

# 清理旧的编译文件
cargo clean

# 重新编译（明确启用 https 特性）
cargo build --release --features https

# 复制到部署目录
cp target/release/customer-service-backend ../
chmod +x ../customer-service-backend

# 测试运行
cd ..
./customer-service-backend
```

### 方案 2: 运行诊断脚本

```bash
cd /root/ubuntu-deploy-ready

# 添加执行权限
chmod +x diagnose-foreground.sh

# 运行诊断
./diagnose-foreground.sh
```

诊断脚本会检查：
- 可执行文件是否包含 HTTPS 代码
- 依赖库是否完整
- 证书文件是否存在
- 程序能否正常启动

### 方案 3: 使用详细日志运行

```bash
cd /root/ubuntu-deploy-ready

# 启用详细日志和回溯
RUST_LOG=trace RUST_BACKTRACE=full ./customer-service-backend 2>&1 | tee detailed.log

# 查看日志中的错误信息
```

### 方案 4: 使用 strace 诊断

```bash
cd /root/ubuntu-deploy-ready

# 追踪系统调用
strace -f -o strace.log ./customer-service-backend

# 查看哪里退出了
grep -A 5 -B 5 "exit" strace.log
```

### 方案 5: 检查 Cargo.toml 特性配置

确保 `backend/Cargo.toml` 中正确配置了 https 特性：

```toml
[features]
default = []
https = ["rustls-pemfile", "axum-server", "instant-acme", "rcgen", "reqwest", "x509-parser", "async-trait"]

[dependencies]
axum-server = { version = "0.6", features = ["tls-rustls"], optional = true }
```

## 🔧 临时解决方案

如果重新编译仍然失败，可以：

### 1. 禁用 HTTPS，使用 HTTP 模式

编辑 `.env` 文件：

```bash
# 临时禁用 HTTPS
TLS_MODE=disabled
# 或
FORCE_HTTP=true
```

然后运行：

```bash
./customer-service-backend
```

### 2. 使用 HTTP 端口测试

```bash
# 测试 HTTP 是否能正常工作
curl http://localhost:8080/health
```

## 📋 检查清单

在联系技术支持前，请确认：

- [ ] 已运行诊断脚本 `./diagnose-foreground.sh`
- [ ] 已尝试重新编译 `cargo build --release --features https`
- [ ] 已检查 `.env` 文件中的 TLS_MODE 配置
- [ ] 已查看详细日志 `RUST_LOG=trace ./customer-service-backend`
- [ ] 已确认证书文件存在 `ls -l certs/`
- [ ] 已检查端口是否被占用 `lsof -ti:8443`

## 🆘 如果仍然失败

提供以下信息以便诊断：

1. **诊断脚本输出**:
   ```bash
   ./diagnose-foreground.sh > diagnosis.txt 2>&1
   ```

2. **详细日志**:
   ```bash
   RUST_LOG=trace RUST_BACKTRACE=full ./customer-service-backend > detailed.log 2>&1
   ```

3. **系统调用追踪**:
   ```bash
   strace -f ./customer-service-backend 2>&1 | tail -n 100
   ```

4. **编译信息**:
   ```bash
   cd backend
   cargo build --release --features https 2>&1 | tee build.log
   ```

## 💡 推荐做法

**最稳定的运行方式是使用 systemd 服务**，而不是直接前台运行：

```bash
# 安装 systemd 服务
sudo cp customer-service.service /etc/systemd/system/
sudo systemctl daemon-reload
sudo systemctl enable customer-service
sudo systemctl start customer-service

# 查看日志
sudo journalctl -u customer-service -f
```

这样可以：
- ✅ 开机自启动
- ✅ 自动重启（崩溃时）
- ✅ 统一的日志管理
- ✅ 更好的进程管理

---

**更新时间**: 2025-10-17
**状态**: 待诊断
