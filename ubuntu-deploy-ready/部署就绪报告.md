# 🚀 Ubuntu 部署就绪报告

**生成时间**: 2025-10-16 23:44  
**编译类型**: Release  
**目标平台**: x86_64-unknown-linux-musl (Ubuntu Linux)

---

## ✅ 部署包内容确认

### 核心文件
- ✅ **customer-service-backend** (10.36 MB) - 新编译的 Rust 后端（带 ACME + HTTPS）
- ✅ **.env** - 生产环境配置（已配置 ACME）
- ✅ **customer-service.service** - systemd 服务文件
- ✅ **start.sh** - 启动脚本

### 目录结构
```
ubuntu-deploy-ready/
├── customer-service-backend     # 新编译的二进制（10.36 MB）
├── .env                         # 环境配置
├── customer-service.service     # systemd 服务
├── start.sh                     # 启动脚本
├── certs/                       # 证书目录（ACME 自动填充）
└── static/                      # 前端静态文件
```

---

## 🔐 ACME 自动证书配置

### 当前配置
```env
ACME_ENABLED=true
ACME_DIRECTORY_URL=https://acme-v02.api.letsencrypt.org/directory
ACME_EMAIL=siwmm@163.com
ACME_DOMAINS=elontalk.duckdns.org
ACME_CHALLENGE=dns-01
DUCKDNS_DOMAIN=elontalk
DUCKDNS_TOKEN=400bfeb6-b2fe-40e8-8cb6-7d38a2b943ca
```

### ⚠️ 首次部署建议
**强烈建议首次使用 Staging 环境测试！**

修改 `.env` 中的 ACME_DIRECTORY_URL：
```env
# 测试环境（推荐首次使用）
ACME_DIRECTORY_URL=https://acme-staging-v02.api.letsencrypt.org/directory
```

测试成功后改为生产环境：
```env
# 生产环境（测试通过后启用）
ACME_DIRECTORY_URL=https://acme-v02.api.letsencrypt.org/directory
```

---

## 📋 部署步骤

### 1. 上传部署包
将整个 `ubuntu-deploy-ready` 目录上传到服务器 `/root/ubuntu-deploy-ready`

```bash
# 在 Windows 上使用 SCP（PowerShell）
scp -r ubuntu-deploy-ready root@your-server-ip:/root/
```

### 2. 设置权限
```bash
ssh root@your-server-ip
cd /root/ubuntu-deploy-ready
chmod +x customer-service-backend
chmod +x start.sh
chmod +x *.sh
```

### 3. 首次启动（前台测试）
```bash
# 先在前台运行测试 ACME 功能
./customer-service-backend
```

观察输出，确认：
- ✅ 数据库初始化成功
- ✅ ACME DNS-01 验证通过
- ✅ 证书生成成功（保存到 certs/ 目录）
- ✅ HTTPS 服务器启动在 8443 端口

### 4. 安装 systemd 服务
```bash
# 复制服务文件
sudo cp customer-service.service /etc/systemd/system/

# 重载 systemd
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start customer-service

# 查看状态
sudo systemctl status customer-service

# 设置开机自启
sudo systemctl enable customer-service
```

### 5. 验证部署
```bash
# 检查服务状态
sudo systemctl status customer-service

# 查看日志
sudo journalctl -u customer-service -f

# 测试 HTTPS 连接
curl -v https://elontalk.duckdns.org:8443/api/health
```

---

## 🔍 故障排除

### ACME 相关问题

#### 1. DuckDNS API 失败
**症状**: `Failed to set TXT record`

**检查**:
```bash
# 手动测试 DuckDNS API
curl "https://www.duckdns.org/update?domains=elontalk&token=400bfeb6-b2fe-40e8-8cb6-7d38a2b943ca&txt=test&verbose=true"
```

应该返回 `OK`

#### 2. DNS 传播超时
**症状**: `DNS TXT record not propagated`

**解决**:
```env
# 在 .env 中增加等待时间（默认 60 秒）
DNS_PROPAGATION_WAIT=120
```

#### 3. Rate Limit（速率限制）
**症状**: `Too many failed authorization attempts`

**解决**: 这就是为什么要先用 staging 环境测试！
- Staging 环境无速率限制
- 测试通过后再切换到生产环境

### 证书验证

```bash
# 查看生成的证书
openssl x509 -in certs/server.crt -text -noout

# 检查证书有效期
openssl x509 -in certs/server.crt -noout -dates

# 验证证书链
openssl verify -CAfile certs/server.crt certs/server.crt
```

---

## 📊 编译信息

```
编译命令: cargo zigbuild --release --target x86_64-unknown-linux-musl --features https
编译时间: 2025-10-16 23:44:32
二进制大小: 10.36 MB
编译警告: 41 个（主要是未使用的导入和变量）
编译错误: 0

启用的 Features:
- https: HTTPS/TLS 支持
- ACME: 自动证书管理（instant-acme 0.7）
- DuckDNS: DNS-01 验证提供商
- x509-parser: 证书过期检查
```

---

## 🎯 关键提醒

### ✅ 必做事项
1. 首次部署使用 ACME Staging 环境
2. 确保 8443 端口在防火墙中开放
3. 验证 DuckDNS 域名解析正确
4. 前台运行测试通过后再配置 systemd

### ⚠️ 注意事项
1. Let's Encrypt 生产环境有速率限制：
   - 每个域名每周 5 次失败验证
   - 每个账户每周 50 个证书
2. DNS-01 验证需要等待 DNS 传播（默认 60 秒）
3. 证书自动续期：到期前 30 天触发

### 🔒 安全建议
1. 修改 JWT_SECRET 为强密码
2. 定期备份数据库文件
3. 监控证书过期时间
4. 定期检查服务日志

---

## 📞 技术支持

### 查看日志
```bash
# 实时日志
sudo journalctl -u customer-service -f

# 最近 100 行
sudo journalctl -u customer-service -n 100

# 今天的日志
sudo journalctl -u customer-service --since today
```

### 重启服务
```bash
sudo systemctl restart customer-service
```

### 查看 ACME 证书信息
```bash
cd /root/ubuntu-deploy-ready/certs
ls -lh
openssl x509 -in server.crt -text -noout | grep -E 'Subject:|Issuer:|Not After'
```

---

## ✨ 部署完成后

访问你的客服系统：
- **主页**: https://elontalk.duckdns.org:8443
- **API 健康检查**: https://elontalk.duckdns.org:8443/api/health
- **后台登录**: https://elontalk.duckdns.org:8443/login

**🎉 祝部署顺利！**
