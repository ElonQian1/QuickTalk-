<style>
.viewport-nav{outline:#000;position:fixed;right:40px;bottom:40px;z-index:999999}
.viewport-nav .nav-box{background:rgba(0,0,0,.8);border-radius:100%;text-align:center;margin:15px 0;width:100px;height:100px;line-height:100px;box-shadow:0 0 5px 2px rgba(255,255,255,.5)}
.viewport-nav .nav-box p{padding:0 1px;font-size:31px;color:#fff;white-space:normal;font-weight:700}
.viewport-nav .nav-box#cb{position:relative;cursor:pointer}
.viewport-nav .nav-box .cbweixin{top:-320px;right:138px;position:absolute;width:500px;background-color:#eee;border-radius:10px;padding:10px;z-index:999;transform:scale(0);transform-origin:right center;transition:.3s linear;box-shadow:0 0 1px rgba(0,0,0)}
.viewport-nav .nav-box .cbweixin::before{content:'';width:50px;height:50px;position:absolute;background-color:#eee;right:-25px;top:calc(50% + (37px));transform:rotate(45deg);border-top:1px solid rgba(0,0,0,.1);border-right:1px solid rgba(0,0,0,.1)}
.viewport-nav .nav-box .cbweixin::after{content:'X';font-size:18px;width:30px;height:30px;line-height:30px;position:absolute;border-radius:100%;top:0;right:0;cursor:context-menu}
.viewport-nav .nav-box .cbweixin p{color:#000;font-size:20px}
.viewport-nav .nav-box .cbweixin-img{margin:0 auto;width:400px;height:400px}
.viewport-nav .nav-box .cbweixin img{width:100%}
.viewport-nav .nav-box .nav-dabaowei,.viewport-nav .nav-box .nav-sxsx{font-size:24px}

/* æ–°å¢å®¢æœèŠå¤©çª—å£æ ·å¼ */
.cs-chat{position:fixed;bottom:160px;right:40px;width:380px;height:520px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;flex-direction:column;z-index:999998;overflow:hidden;transform:scale(0);transform-origin:bottom right;transition:all 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
.cs-chat.open{display:flex;transform:scale(1)}
.cs-chat.mini{height:60px}
.cs-chat.mini .cs-body,.cs-chat.mini .cs-input,.cs-chat.mini .cs-status{display:none}
.cs-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
.cs-header h3{font-size:16px;font-weight:600;margin:0}
.cs-controls{display:flex;gap:10px}
.cs-controls button{background:rgba(255,255,255,0.2);border:none;color:white;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
.cs-body{flex:1;padding:20px;overflow-y:auto;background:#fafbfc}
.cs-msg{margin-bottom:15px;display:flex;flex-direction:column}
.cs-msg-text{padding:12px 16px;border-radius:18px;max-width:80%;word-wrap:break-word;line-height:1.4}
.cs-msg-time{font-size:11px;color:#999;margin-top:5px}
.cs-system .cs-msg-text{background:#f0f0f0;color:#666;align-self:center;text-align:center;font-size:13px}
.cs-user{align-items:flex-end}
.cs-user .cs-msg-text{background:#667eea;color:white;align-self:flex-end}
.cs-user .cs-msg-time{text-align:right}
.cs-staff{align-items:flex-start}
.cs-staff .cs-msg-text{background:#f8f9fa;color:#333;border:1px solid #e9ecef;align-self:flex-start}
.cs-input{padding:15px 20px;border-top:1px solid #eee;display:flex;gap:10px;background:white}
.cs-input input{flex:1;padding:10px 15px;border:1px solid #ddd;border-radius:20px;outline:none;font-size:14px}
.cs-input button{background:#667eea;color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-weight:600}
.cs-status{padding:8px 20px;background:#f8f9fa;border-top:1px solid #eee;display:flex;align-items:center;gap:8px;font-size:12px}
.cs-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
.cs-connected{background:#28a745;animation:pulse 2s infinite}
.cs-disconnected{background:#dc3545}
@keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
@media (max-width:768px){.cs-chat{width:calc(100vw - 20px);right:10px;left:10px}}
</style>

<div class="viewport-nav">
    <ul>
        <li><div class="nav-box"><p>ç™»å…¥</p></div></li>
        <li><div class="nav-box"><p>æ³¨å†Œ</p></div></li>
        <li>
            <div class="nav-box animate__animated animate__backInLeft" id="cb">
                <a><p class="animate__animated animate__infinite animate__heartBeat">å®¢æœ</p></a>
                <div class="cbweixin">
                    <p>å®¢æœå¾®ä¿¡</p>
                    <div class="cbweixin-img">
                        <img src="/wx.jpg">
                    </div>
                    <p>æ‰«ä¸€æ‰«æ·»åŠ å¾®ä¿¡</p>
                </div>
            </div>
        </li>
        <li><div class="nav-box"><p>ä¼˜æƒ </p></div></li>
    </ul>
</div>

<!-- æ–°å¢å®¢æœèŠå¤©çª—å£ -->
<div class="cs-chat" id="cs-chat">
    <div class="cs-header">
        <h3>åœ¨çº¿å®¢æœ</h3>
        <div class="cs-controls">
            <button onclick="miniCS()">âˆ’</button>
            <button onclick="closeCS()">Ã—</button>
        </div>
    </div>
    <div class="cs-body" id="cs-body">
        <div class="cs-msg cs-system">
            <span class="cs-msg-text">æ¬¢è¿ä½¿ç”¨åœ¨çº¿å®¢æœï¼Œè¯·é—®æœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ</span>
            <span class="cs-msg-time" id="welcome-time"></span>
        </div>
    </div>
    <div class="cs-input">
        <input type="text" id="cs-input" placeholder="è¯·è¾“å…¥æ‚¨çš„æ¶ˆæ¯..." onkeypress="if(event.key==='Enter')sendCS()">
        <button onclick="sendCS()">å‘é€</button>
    </div>
    <div class="cs-status">
        <span class="cs-dot" id="cs-dot"></span>
        <span id="cs-status">è¿æ¥ä¸­...</span>
    </div>
</div>

<script>
(function(){
    // ğŸ”¥ é‡è¦ï¼šè¯·å°†ä¸‹é¢çš„åœ°å€æ›¿æ¢ä¸ºæ‚¨çš„ ngrok åœ°å€
    const SERVER_URL = 'http://localhost:3030/'; // ä¾‹å¦‚ï¼š'https://abc123.ngrok.io'
    
    let cs = {
        isOpen: false,
        isMini: false,
        isConnected: false,
        userId: 'user_' + Math.random().toString(36).substr(2,9) + '_' + Date.now(),
        interval: null,
        lastId: 0,
        
        init() {
            this.updateTime();
            setTimeout(() => this.connect(), 1000);
        },
        
        async connect() {
            try {
                console.log('ğŸ”— å°è¯•è¿æ¥åˆ°æœåŠ¡å™¨:', SERVER_URL);
                const res = await fetch(`${SERVER_URL}/api/connect`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({userId: this.userId, timestamp: Date.now()})
                });
                
                if (res.ok) {
                    this.isConnected = true;
                    this.updateStatus('connected', 'å·²è¿æ¥');
                    this.startPoll();
                    console.log('âœ… å®¢æœè¿æ¥æˆåŠŸ');
                } else {
                    throw new Error(`HTTP ${res.status}: ${res.statusText}`);
                }
            } catch (e) {
                console.error('âŒ å®¢æœè¿æ¥å¤±è´¥:', e);
                this.updateStatus('disconnected', 'è¿æ¥å¤±è´¥: ' + e.message);
                setTimeout(() => this.connect(), 5000);
            }
        },
        
        startPoll() {
            if (this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => this.checkMsg(), 2000);
        },
        
        async checkMsg() {
            if (!this.isConnected) return;
            try {
                const res = await fetch(`${SERVER_URL}/api/messages?userId=${this.userId}&lastId=${this.lastId}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.messages && data.messages.length > 0) {
                        data.messages.forEach(msg => {
                            this.handleMsg(msg);
                            this.lastId = Math.max(this.lastId, msg.id || 0);
                        });
                    }
                }
            } catch (e) {
                this.isConnected = false;
                this.updateStatus('disconnected', 'è¿æ¥æ–­å¼€');
                setTimeout(() => this.connect(), 3000);
            }
        },
        
        handleMsg(msg) {
            if (msg.type === 'staff_message') {
                this.addMsg('staff', msg.message);
            } else if (msg.type === 'system_notification') {
                this.addMsg('system', msg.message);
            }
        },
        
        addMsg(type, text) {
            const body = document.getElementById('cs-body');
            const div = document.createElement('div');
            div.className = `cs-msg cs-${type}`;
            div.innerHTML = `
                <span class="cs-msg-text">${text}</span>
                <span class="cs-msg-time">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
            `;
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        },
        
        async send() {
            const input = document.getElementById('cs-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            if (!this.isConnected) {
                this.addMsg('system', 'è¿æ¥æ–­å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
                return;
            }
            
            this.addMsg('user', msg);
            input.value = '';
            
            try {
                await fetch(`${SERVER_URL}/api/send`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({userId: this.userId, message: msg, timestamp: Date.now()})
                });
            } catch (e) {
                this.addMsg('system', 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        },
        
        updateStatus(status, text) {
            document.getElementById('cs-dot').className = `cs-dot cs-${status}`;
            document.getElementById('cs-status').textContent = text;
        },
        
        updateTime() {
            const time = document.getElementById('welcome-time');
            if (time) time.textContent = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        },
        
        toggle() {
            if (this.isOpen) this.close(); else this.open();
        },
        
        open() {
            const chat = document.getElementById('cs-chat');
            chat.classList.add('open');
            chat.classList.remove('mini');
            this.isOpen = true;
            this.isMini = false;
            document.getElementById('cs-input').focus();
            if (this.isConnected && !this.interval) this.startPoll();
        },
        
        close() {
            const chat = document.getElementById('cs-chat');
            chat.classList.remove('open', 'mini');
            this.isOpen = false;
            this.isMini = false;
            if (this.interval) {
                clearInterval(this.interval);
                this.interval = null;
            }
        },
        
        minimize() {
            const chat = document.getElementById('cs-chat');
            if (this.isMini) {
                chat.classList.remove('mini');
                this.isMini = false;
                document.getElementById('cs-input').focus();
            } else {
                chat.classList.add('mini');
                this.isMini = true;
            }
        }
    };
    
    // å…¨å±€å‡½æ•°
    window.toggleCS = () => cs.toggle();
    window.closeCS = () => cs.close();
    window.miniCS = () => cs.minimize();
    window.sendCS = () => cs.send();
    
    // åŸæœ‰çš„å¾®ä¿¡åŠŸèƒ½ä¿æŒä¸å˜
    const cbBtn = document.querySelector('#cb');
    const cbBtnWeixin = document.querySelector('.cbweixin');
    
    if (cbBtn && cbBtnWeixin) {
        // é¼ æ ‡æ‚¬åœæ˜¾ç¤ºå¾®ä¿¡äºŒç»´ç 
        cbBtn.addEventListener('mouseenter', function() {
            cbBtnWeixin.style.transform = 'scale(1)';
        });
        
        cbBtn.addEventListener('mouseleave', function() {
            setTimeout(() => {
                if (!cbBtnWeixin.matches(':hover')) {
                    cbBtnWeixin.style.transform = 'scale(0)';
                }
            }, 100);
        });
        
        cbBtnWeixin.addEventListener('mouseleave', function() {
            cbBtnWeixin.style.transform = 'scale(0)';
        });
        
        // ç‚¹å‡»å®¢æœæŒ‰é’®æ‰“å¼€èŠå¤©çª—å£
        cbBtn.addEventListener('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            cbBtnWeixin.style.transform = 'scale(0)'; // éšè—å¾®ä¿¡äºŒç»´ç 
            cs.toggle(); // æ‰“å¼€èŠå¤©çª—å£
        });
    }
    
    // åˆå§‹åŒ–
    if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => setTimeout(() => cs.init(), 1000));
    } else {
        setTimeout(() => cs.init(), 1000);
    }
    
    // æ¸…ç†
    window.addEventListener('beforeunload', () => {
        if (cs.interval) clearInterval(cs.interval);
    });
})();
</script>

<!-- 
ğŸ”¥ ä½¿ç”¨è¯´æ˜ï¼š
1. å°† YOUR_NGROK_URL æ›¿æ¢ä¸ºæ‚¨çš„å®é™… ngrok åœ°å€
   ä¾‹å¦‚ï¼šconst SERVER_URL = 'https://abc123.ngrok.io';

2. ä¿å­˜å¹¶ä¸Šä¼ åˆ°æœ‹å‹çš„ç½‘ç«™

3. åŠŸèƒ½è¯´æ˜ï¼š
   - é¼ æ ‡æ‚¬åœå®¢æœæŒ‰é’®ï¼šæ˜¾ç¤ºå¾®ä¿¡äºŒç»´ç 
   - ç‚¹å‡»å®¢æœæŒ‰é’®ï¼šæ‰“å¼€åœ¨çº¿èŠå¤©çª—å£
   - ä¸¤ä¸ªåŠŸèƒ½å®Œç¾å…±å­˜ï¼Œäº’ä¸å¹²æ‰°

4. ç¡®ä¿æ‚¨çš„æœ¬åœ°æœåŠ¡å™¨å’Œ ngrok æ­£åœ¨è¿è¡Œ
-->
