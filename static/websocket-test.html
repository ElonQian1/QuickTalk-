<!DOCTYPE html>
<html>
<head>
    <title>WebSocketå®¢æœç³»ç»Ÿæµ‹è¯•</title>
    <meta charset="UTF-8">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-section { margin: 20px 0; padding: 15px; border: 1px solid #ccc; border-radius: 5px; }
        .log { height: 200px; overflow-y: auto; background: #f5f5f5; padding: 10px; border: 1px solid #ddd; font-family: monospace; font-size: 12px; }
        .input-group { margin: 10px 0; }
        .input-group label { display: inline-block; width: 100px; }
        .status { padding: 5px; border-radius: 3px; }
        .connected { background: #d4edda; color: #155724; }
        .disconnected { background: #f8d7da; color: #721c24; }
        button { padding: 8px 16px; margin: 5px; background: #007bff; color: white; border: none; border-radius: 3px; cursor: pointer; }
        button:hover { background: #0056b3; }
        input[type="text"] { padding: 5px; border: 1px solid #ccc; border-radius: 3px; width: 200px; }
    </style>
</head>
<body>
    <h1>ğŸ”Œ WebSocketå®¢æœç³»ç»Ÿæµ‹è¯•</h1>
    
    <div class="test-section">
        <h3>è¿æ¥çŠ¶æ€</h3>
        <div id="status" class="status disconnected">æœªè¿æ¥</div>
        <br>
        <button onclick="connectWS()">è¿æ¥WebSocket</button>
        <button onclick="disconnectWS()">æ–­å¼€è¿æ¥</button>
    </div>
    
    <div class="test-section">
        <h3>å‘é€æ¶ˆæ¯</h3>
        <div class="input-group">
            <label>ç”¨æˆ·ID:</label>
            <input type="text" id="userId" value="user_test123_1757000000000" placeholder="ç”¨æˆ·ID">
        </div>
        <div class="input-group">
            <label>åº—é“ºID:</label>
            <input type="text" id="shopId" value="shop_1757591780450_1" placeholder="åº—é“ºID">
        </div>
        <div class="input-group">
            <label>æ¶ˆæ¯:</label>
            <input type="text" id="message" value="Hello WebSocket!" placeholder="æ¶ˆæ¯å†…å®¹">
        </div>
        <button onclick="sendAuth()">å‘é€è®¤è¯</button>
        <button onclick="sendMessage()">å‘é€æ¶ˆæ¯</button>
    </div>
    
    <div class="test-section">
        <h3>å®¢æœå›å¤æµ‹è¯•</h3>
        <div class="input-group">
            <label>å›å¤æ¶ˆæ¯:</label>
            <input type="text" id="replyMessage" value="æ‚¨å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ" placeholder="å®¢æœå›å¤å†…å®¹">
        </div>
        <button onclick="sendReply()">å‘é€å®¢æœå›å¤ (HTTP)</button>
    </div>
    
    <div class="test-section">
        <h3>WebSocketæ—¥å¿—</h3>
        <div id="log" class="log"></div>
        <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
    </div>

    <script>
        let ws = null;
        let isConnected = false;
        
        const shopKey = 'sk_ji85ucic9p00m12as1ygf34o8humuxfl';
        
        function log(message) {
            const logDiv = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}\n`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }
        
        function updateStatus(connected, message) {
            const statusDiv = document.getElementById('status');
            isConnected = connected;
            if (connected) {
                statusDiv.className = 'status connected';
                statusDiv.textContent = 'å·²è¿æ¥ - ' + message;
            } else {
                statusDiv.className = 'status disconnected';
                statusDiv.textContent = 'æœªè¿æ¥ - ' + message;
            }
        }
        
        function connectWS() {
            if (ws) {
                log('âš ï¸ WebSocketå·²ç»è¿æ¥');
                return;
            }
            
            log('ğŸ”— æ­£åœ¨è¿æ¥WebSocket...');
            ws = new WebSocket('ws://localhost:3030/ws');
            
            ws.onopen = () => {
                log('âœ… WebSocketè¿æ¥æˆåŠŸ');
                updateStatus(true, 'WebSocketè¿æ¥æ­£å¸¸');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    log(`ğŸ“¨ æ”¶åˆ°æ¶ˆæ¯: ${data.type} - ${data.message || JSON.stringify(data)}`);
                } catch (e) {
                    log(`ğŸ“¨ æ”¶åˆ°åŸå§‹æ¶ˆæ¯: ${event.data}`);
                }
            };
            
            ws.onclose = (event) => {
                log(`ğŸ”Œ è¿æ¥å…³é—­: ä»£ç =${event.code}, åŸå› =${event.reason}`);
                updateStatus(false, 'è¿æ¥å·²å…³é—­');
                ws = null;
            };
            
            ws.onerror = (error) => {
                log('âŒ WebSocketé”™è¯¯: ' + error);
                updateStatus(false, 'è¿æ¥é”™è¯¯');
            };
        }
        
        function disconnectWS() {
            if (ws) {
                ws.close();
                ws = null;
                log('ğŸ”Œ ä¸»åŠ¨æ–­å¼€è¿æ¥');
                updateStatus(false, 'ä¸»åŠ¨æ–­å¼€');
            }
        }
        
        function sendAuth() {
            if (!ws || !isConnected) {
                log('âŒ WebSocketæœªè¿æ¥');
                return;
            }
            
            const userId = document.getElementById('userId').value;
            const shopId = document.getElementById('shopId').value;
            
            const authData = {
                type: 'auth',
                userId: userId,
                shopId: shopId,
                shopKey: shopKey
            };
            
            ws.send(JSON.stringify(authData));
            log(`ğŸ“¤ å‘é€è®¤è¯: ${userId} @ ${shopId}`);
        }
        
        function sendMessage() {
            if (!ws || !isConnected) {
                log('âŒ WebSocketæœªè¿æ¥');
                return;
            }
            
            const userId = document.getElementById('userId').value;
            const shopId = document.getElementById('shopId').value;
            const message = document.getElementById('message').value;
            
            const messageData = {
                type: 'send_message',
                userId: userId,
                shopId: shopId,
                shopKey: shopKey,
                message: message,
                timestamp: Date.now()
            };
            
            ws.send(JSON.stringify(messageData));
            log(`ğŸ“¤ å‘é€æ¶ˆæ¯: "${message}"`);
        }
        
        async function sendReply() {
            const userId = document.getElementById('userId').value;
            const replyMessage = document.getElementById('replyMessage').value;
            
            // æ„é€ conversationId
            const shopId = document.getElementById('shopId').value;
            const conversationId = `${shopId}_${userId}`;
            
            try {
                const response = await fetch('/api/admin/send-reply', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        conversationId: conversationId,
                        content: replyMessage,
                        senderId: 'admin_test',
                        messageType: 'staff'
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log(`âœ… å®¢æœå›å¤å‘é€æˆåŠŸ: WebSocketæ¨é€=${result.data.pushed}`);
                } else {
                    log(`âŒ å®¢æœå›å¤å‘é€å¤±è´¥: ${result.error}`);
                }
            } catch (e) {
                log(`âŒ å®¢æœå›å¤å‘é€é”™è¯¯: ${e.message}`);
            }
        }
        
        function clearLog() {
            document.getElementById('log').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿æ¥
        window.addEventListener('load', () => {
            log('ğŸš€ WebSocketæµ‹è¯•é¡µé¢å·²åŠ è½½');
            log('ğŸ’¡ æç¤º: å…ˆç‚¹å‡»"è¿æ¥WebSocket"ï¼Œç„¶å"å‘é€è®¤è¯"ï¼Œæœ€åå¯ä»¥æµ‹è¯•æ¶ˆæ¯å‘é€');
        });
    </script>
</body>
</html>
