<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#667eea">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="QuickTalkå®¢æœ">
    
    <!-- PWA æ¸…å•æ–‡ä»¶ -->
    <link rel="manifest" href="/manifest.json">
    
    <!-- iOS å›¾æ ‡ -->
    <link rel="apple-touch-icon" href="/icons/icon-192x192.png">
    <link rel="apple-touch-icon" sizes="152x152" href="/icons/icon-152x152.png">
    <link rel="apple-touch-icon" sizes="180x180" href="/icons/icon-180x180.png">
    
    <!-- å¯åŠ¨ç”»é¢ -->
    <link rel="apple-touch-startup-image" href="/icons/splash-640x1136.png" media="(device-width: 320px) and (device-height: 568px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/icons/splash-750x1334.png" media="(device-width: 375px) and (device-height: 667px) and (-webkit-device-pixel-ratio: 2)">
    <link rel="apple-touch-startup-image" href="/icons/splash-1242x2208.png" media="(device-width: 414px) and (device-height: 736px) and (-webkit-device-pixel-ratio: 3)">
    
    <title>å¢å¼ºç§»åŠ¨å®¢æœ - QuickTalk</title>
    <link rel="stylesheet" href="/css/enhanced-mobile-customer-service.css">
</head>
<body>
    <!-- çŠ¶æ€æ å ä½ -->
    <div class="status-bar"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div id="app" class="app-container">
        
        <!-- é¦–é¡µ - æ¶ˆæ¯æ€»è§ˆ -->
        <div id="homePage" class="page active">
            <!-- å¤´éƒ¨ -->
            <div class="page-header">
                <div class="header-content">
                    <h1 class="page-title">å®¢æœæ¶ˆæ¯</h1>
                    <div class="header-actions">
                        <button class="header-btn" onclick="showSettings()">âš™ï¸</button>
                        <button class="header-btn" onclick="refreshData()">ğŸ”„</button>
                    </div>
                </div>
            </div>

            <!-- ç»Ÿè®¡å¡ç‰‡ -->
            <div class="stats-summary">
                <div class="stats-item highlight">
                    <div class="stats-number" id="totalUnreadCount">0</div>
                    <div class="stats-label">æœªè¯»æ¶ˆæ¯</div>
                </div>
                <div class="stats-item">
                    <div class="stats-number" id="totalShopsCount">0</div>
                    <div class="stats-label">åº—é“ºæ•°é‡</div>
                </div>
            </div>

            <!-- åº—é“ºåˆ—è¡¨ -->
            <div class="shop-list-container">
                <div class="section-header">
                    <h2>åº—é“ºæ¶ˆæ¯</h2>
                </div>
                <div id="shopList" class="shop-list">
                    <!-- åŠ¨æ€åŠ è½½åº—é“ºåˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- åº—é“ºå¯¹è¯åˆ—è¡¨é¡µ -->
        <div id="shopPage" class="page">
            <div class="page-header">
                <div class="header-content">
                    <button class="back-btn" onclick="goBack()">â€¹</button>
                    <div class="header-info">
                        <h1 class="page-title" id="shopPageTitle">åº—é“ºå¯¹è¯</h1>
                        <div class="page-subtitle" id="shopPageSubtitle">æŸ¥çœ‹æ‰€æœ‰å¯¹è¯</div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" onclick="refreshConversations()">ğŸ”„</button>
                    </div>
                </div>
            </div>

            <div class="conversation-list-container">
                <div id="conversationList" class="conversation-list">
                    <!-- åŠ¨æ€åŠ è½½å¯¹è¯åˆ—è¡¨ -->
                </div>
            </div>
        </div>

        <!-- èŠå¤©é¡µé¢ -->
        <div id="chatPage" class="page">
            <div class="chat-header">
                <div class="header-content">
                    <button class="back-btn" onclick="goBack()">â€¹</button>
                    <div class="chat-info">
                        <div class="chat-title" id="chatTitle">å®¢æˆ·èŠå¤©</div>
                        <div class="chat-subtitle" id="chatSubtitle">åœ¨çº¿</div>
                    </div>
                    <div class="header-actions">
                        <button class="header-btn" onclick="showChatMenu()">â‹¯</button>
                    </div>
                </div>
            </div>

            <!-- èŠå¤©æ¶ˆæ¯åŒºåŸŸ -->
            <div class="chat-messages" id="chatMessages">
                <!-- åŠ¨æ€åŠ è½½æ¶ˆæ¯ -->
            </div>

            <!-- å¢å¼ºè¾“å…¥åŒºåŸŸ -->
            <div class="enhanced-input-area">
                <div class="input-tools">
                    <button class="tool-btn" id="cameraBtn" onclick="enhancedMobileService.takePhoto()" title="æ‹ç…§">ğŸ“·</button>
                    <button class="tool-btn" id="voiceBtn" onclick="toggleVoiceRecording()" title="è¯­éŸ³">ğŸ¤</button>
                    <button class="tool-btn" id="locationBtn" onclick="enhancedMobileService.shareLocation()" title="ä½ç½®">ğŸ“</button>
                </div>
                
                <div class="input-container">
                    <textarea 
                        id="messageInput" 
                        class="enhanced-input" 
                        placeholder="è¾“å…¥æ¶ˆæ¯..."
                        rows="1"
                        maxlength="1000"
                    ></textarea>
                </div>
                
                <button class="tool-btn send-btn" id="sendBtn" onclick="sendMessage()" disabled>â¤</button>
            </div>
        </div>
    </div>

    <!-- æ¨¡æ€æ¡†å®¹å™¨ -->
    <div id="modalContainer"></div>

    <!-- PWA å®‰è£…æç¤º -->
    <div id="installPrompt" class="install-prompt" style="display: none;">
        <div class="install-content">
            <div class="install-icon">ğŸ“±</div>
            <div class="install-text">
                <div class="install-title">å®‰è£…åˆ°ä¸»å±å¹•</div>
                <div class="install-subtitle">è·å¾—æ›´å¥½çš„ä½¿ç”¨ä½“éªŒ</div>
            </div>
            <div class="install-actions">
                <button class="install-btn dismiss" onclick="dismissInstallPrompt()">ç¨å</button>
                <button class="install-btn install" onclick="installPWA()">å®‰è£…</button>
            </div>
        </div>
    </div>

    <script src="/js/enhanced-mobile-customer-service.js"></script>
    <script>
        // é¡µé¢å¯¼èˆªç®¡ç†
        let pageStack = ['home'];
        let currentShop = null;
        let currentConversation = null;

        // é¡µé¢åˆ‡æ¢
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId).classList.add('active');
        }

        function goBack() {
            if (pageStack.length > 1) {
                pageStack.pop();
                const previousPage = pageStack[pageStack.length - 1];
                showPage(previousPage + 'Page');
                
                // æ›´æ–°é¡µé¢çŠ¶æ€
                if (previousPage === 'home') {
                    currentShop = null;
                    currentConversation = null;
                } else if (previousPage === 'shop') {
                    currentConversation = null;
                }
            }
        }

        // è¿›å…¥åº—é“ºé¡µé¢
        function enterShop(shopId, shopName) {
            currentShop = { id: shopId, name: shopName };
            pageStack.push('shop');
            
            document.getElementById('shopPageTitle').textContent = shopName;
            document.getElementById('shopPageSubtitle').textContent = 'æŸ¥çœ‹æ‰€æœ‰å¯¹è¯';
            
            showPage('shopPage');
            loadConversations(shopId);
        }

        // è¿›å…¥èŠå¤©é¡µé¢
        function enterChat(conversationId, customerName) {
            currentConversation = { id: conversationId, customerName: customerName };
            pageStack.push('chat');
            
            document.getElementById('chatTitle').textContent = customerName;
            document.getElementById('chatSubtitle').textContent = 'åœ¨çº¿';
            
            showPage('chatPage');
            loadMessages(conversationId);
        }

        // è¯­éŸ³å½•åˆ¶åˆ‡æ¢
        let isRecording = false;
        function toggleVoiceRecording() {
            if (isRecording) {
                enhancedMobileService.stopVoiceRecording();
                isRecording = false;
                document.getElementById('voiceBtn').classList.remove('active');
            } else {
                enhancedMobileService.startVoiceRecording();
                isRecording = true;
                document.getElementById('voiceBtn').classList.add('active');
            }
        }

        // å‘é€æ¶ˆæ¯
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (message && currentConversation) {
                // å‘é€æ¶ˆæ¯é€»è¾‘
                enhancedMobileService.sendMessage(message, 'text');
                input.value = '';
                updateSendButton();
                
                // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
                addMessageToChat(message, 'sent');
            }
        }

        // è¾“å…¥æ¡†äº‹ä»¶å¤„ç†
        document.addEventListener('DOMContentLoaded', function() {
            const messageInput = document.getElementById('messageInput');
            const sendBtn = document.getElementById('sendBtn');
            
            // è‡ªåŠ¨è°ƒæ•´è¾“å…¥æ¡†é«˜åº¦
            messageInput.addEventListener('input', function() {
                this.style.height = 'auto';
                this.style.height = Math.min(this.scrollHeight, 100) + 'px';
                updateSendButton();
            });
            
            // å›è½¦å‘é€æ¶ˆæ¯
            messageInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            function updateSendButton() {
                const hasText = messageInput.value.trim().length > 0;
                sendBtn.disabled = !hasText;
                sendBtn.style.opacity = hasText ? '1' : '0.5';
            }
        });

        // æ·»åŠ æ¶ˆæ¯åˆ°èŠå¤©ç•Œé¢
        function addMessageToChat(content, type, messageType = 'text') {
            const messagesContainer = document.getElementById('chatMessages');
            const messageElement = document.createElement('div');
            messageElement.className = 'message-item';
            
            let messageContent = '';
            const timestamp = new Date().toLocaleTimeString('zh-CN', { 
                hour: '2-digit', 
                minute: '2-digit' 
            });
            
            switch (messageType) {
                case 'image':
                    messageContent = `<img src="${content}" class="message-image" onclick="showImagePreview('${content}')" alt="å›¾ç‰‡">`;
                    break;
                case 'audio':
                    messageContent = `
                        <div class="voice-message">
                            <button class="voice-play-btn" onclick="playVoice('${content}')">â–¶</button>
                            <div class="voice-waveform"></div>
                            <div class="voice-duration">0:05</div>
                        </div>
                    `;
                    break;
                case 'location':
                    const locationData = JSON.parse(content);
                    messageContent = `
                        <div class="location-message">
                            <div class="location-preview" onclick="showLocationMap(${locationData.latitude}, ${locationData.longitude})">
                                <div class="location-preview-icon">ğŸ“</div>
                                <div class="location-preview-text">
                                    <div class="location-preview-address">${locationData.address}</div>
                                    <div class="location-preview-coords">åæ ‡: ${locationData.latitude.toFixed(4)}, ${locationData.longitude.toFixed(4)}</div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                default:
                    messageContent = `<div class="message-content">${content}</div>`;
            }
            
            messageElement.innerHTML = `
                <div class="message-bubble ${type}">
                    ${messageContent}
                    <div class="message-time">${timestamp}</div>
                </div>
            `;
            
            messagesContainer.appendChild(messageElement);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // æ•°æ®åŠ è½½å‡½æ•°
        async function loadShops() {
            // æ¨¡æ‹Ÿåº—é“ºæ•°æ®
            const shops = [
                { id: '1', name: 'æµ‹è¯•åº—é“º1', unreadCount: 3, lastMessage: 'ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ', lastTime: '10:30' },
                { id: '2', name: 'æµ‹è¯•åº—é“º2', unreadCount: 0, lastMessage: 'å¥½çš„ï¼Œè°¢è°¢æ‚¨', lastTime: 'æ˜¨å¤©' },
                { id: '3', name: 'æµ‹è¯•åº—é“º3', unreadCount: 1, lastMessage: 'æˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹äº§å“', lastTime: '09:15' }
            ];
            
            const shopList = document.getElementById('shopList');
            shopList.innerHTML = shops.map(shop => `
                <div class="shop-item" onclick="enterShop('${shop.id}', '${shop.name}')">
                    <div class="shop-avatar">ğŸª</div>
                    <div class="shop-info">
                        <div class="shop-header">
                            <div class="shop-name">${shop.name}</div>
                            <div class="shop-time">${shop.lastTime}</div>
                        </div>
                        <div class="shop-message">${shop.lastMessage}</div>
                    </div>
                    ${shop.unreadCount > 0 ? `<div class="unread-badge">${shop.unreadCount}</div>` : ''}
                </div>
            `).join('');
            
            // æ›´æ–°ç»Ÿè®¡
            const totalUnread = shops.reduce((sum, shop) => sum + shop.unreadCount, 0);
            document.getElementById('totalUnreadCount').textContent = totalUnread;
            document.getElementById('totalShopsCount').textContent = shops.length;
        }

        async function loadConversations(shopId) {
            // æ¨¡æ‹Ÿå¯¹è¯æ•°æ®
            const conversations = [
                { id: '1', customerName: 'å¼ ä¸‰', unreadCount: 2, lastMessage: 'äº§å“è´¨é‡æ€ä¹ˆæ ·ï¼Ÿ', lastTime: '10:30', status: 'active' },
                { id: '2', customerName: 'æå››', unreadCount: 0, lastMessage: 'å¥½çš„ï¼Œè°¢è°¢', lastTime: '09:15', status: 'inactive' },
                { id: '3', customerName: 'ç‹äº”', unreadCount: 1, lastMessage: 'æˆ‘è¦é€€è´§', lastTime: 'æ˜¨å¤©', status: 'waiting' }
            ];
            
            const conversationList = document.getElementById('conversationList');
            conversationList.innerHTML = conversations.map(conv => `
                <div class="conversation-item ${conv.status}" onclick="enterChat('${conv.id}', '${conv.customerName}')">
                    <div class="customer-avatar">${conv.customerName.charAt(0)}</div>
                    <div class="conversation-info">
                        <div class="conversation-header">
                            <div class="customer-name">${conv.customerName}</div>
                            <div class="conversation-time">${conv.lastTime}</div>
                        </div>
                        <div class="conversation-message">${conv.lastMessage}</div>
                    </div>
                    ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
                    <div class="status-indicator ${conv.status}"></div>
                </div>
            `).join('');
        }

        async function loadMessages(conversationId) {
            // æ¨¡æ‹Ÿæ¶ˆæ¯æ•°æ®
            const messages = [
                { content: 'ä½ å¥½ï¼Œæœ‰ä»€ä¹ˆå¯ä»¥å¸®åŠ©æ‚¨çš„å—ï¼Ÿ', type: 'received', time: '10:25', messageType: 'text' },
                { content: 'æˆ‘æƒ³äº†è§£ä¸€ä¸‹ä½ ä»¬çš„äº§å“', type: 'sent', time: '10:26', messageType: 'text' },
                { content: 'å¥½çš„ï¼Œè¯·ç¨ç­‰ï¼Œæˆ‘ä¸ºæ‚¨ä»‹ç»ä¸€ä¸‹', type: 'received', time: '10:27', messageType: 'text' },
                { content: '/images/product-demo.jpg', type: 'received', time: '10:28', messageType: 'image' }
            ];
            
            const messagesContainer = document.getElementById('chatMessages');
            messagesContainer.innerHTML = '';
            
            messages.forEach(msg => {
                addMessageToChat(msg.content, msg.type, msg.messageType);
            });
        }

        // å·¥å…·å‡½æ•°
        function refreshData() {
            enhancedMobileService.triggerRefresh();
        }

        function refreshConversations() {
            if (currentShop) {
                loadConversations(currentShop.id);
            }
        }

        function showSettings() {
            // æ˜¾ç¤ºè®¾ç½®é¡µé¢
            console.log('æ˜¾ç¤ºè®¾ç½®');
        }

        function showChatMenu() {
            // æ˜¾ç¤ºèŠå¤©èœå•
            console.log('æ˜¾ç¤ºèŠå¤©èœå•');
        }

        function showImagePreview(imageUrl) {
            // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
            console.log('é¢„è§ˆå›¾ç‰‡:', imageUrl);
        }

        function playVoice(audioUrl) {
            // æ’­æ”¾è¯­éŸ³
            console.log('æ’­æ”¾è¯­éŸ³:', audioUrl);
        }

        function showLocationMap(lat, lng) {
            // æ˜¾ç¤ºåœ°å›¾
            console.log('æ˜¾ç¤ºåœ°å›¾:', lat, lng);
        }

        // PWA å®‰è£…ç›¸å…³
        let deferredPrompt;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            document.getElementById('installPrompt').style.display = 'block';
        });

        function installPWA() {
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('PWAå®‰è£…æˆåŠŸ');
                    }
                    deferredPrompt = null;
                    dismissInstallPrompt();
                });
            }
        }

        function dismissInstallPrompt() {
            document.getElementById('installPrompt').style.display = 'none';
        }

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            loadShops();
        });
    </script>
</body>
</html>