<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å®¢æœç®¡ç†ç³»ç»Ÿ - QuickTalk</title>
    
    <!-- åŸºç¡€æ ·å¼é‡ç½® -->
    <link rel="stylesheet" href="/assets/css/core/reset.css">
    <!-- åŸºç¡€æ ·å¼ -->
    <link rel="stylesheet" href="/assets/css/core/base.css">
    <!-- ç»„ä»¶æ ·å¼åº“ -->
    <link rel="stylesheet" href="/assets/css/components/index.css">
    
    <style>
        /* ç®¡ç†åå°ç‰¹å®šæ ·å¼ */
        body {
            font-family: var(--font-family-sans);
            background: var(--gray-100);
            height: 100vh;
            overflow: hidden;
        }

        /* åº”ç”¨å®¹å™¨ */
        .admin-app {
            display: flex;
            flex-direction: column;
            height: 100vh;
            background: var(--gray-100);
        }

        /* ç™»å½•ç•Œé¢ */
        .login-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, #764ba2 100%);
            padding: var(--spacing-md);
        }

        .login-container {
            background: white;
            padding: var(--spacing-xl);
            border-radius: var(--border-radius-lg);
            box-shadow: var(--box-shadow-lg);
            width: 100%;
            max-width: 400px;
        }

        .login-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .login-logo {
            font-size: 2rem;
            font-weight: var(--font-weight-bold);
            color: var(--primary-color);
            margin-bottom: var(--spacing-sm);
        }

        .login-subtitle {
            color: var(--gray-600);
            font-size: var(--font-size-sm);
        }

        /* çŠ¶æ€æ  */
        .status-bar {
            height: 44px;
            background: var(--primary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: var(--font-weight-semibold);
            position: relative;
            flex-shrink: 0;
        }

        .status-bar .connection-info {
            position: absolute;
            right: var(--spacing-md);
            font-size: var(--font-size-xs);
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--danger-color);
        }

        .status-indicator.connected {
            background: var(--success-color);
        }

        /* ä¸»è¦å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-navigation {
            background: white;
            border-bottom: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        /* å†…å®¹é¢æ¿ */
        .content-panels {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .content-panel {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .content-panel.active {
            opacity: 1;
            visibility: visible;
        }

        /* æ¶ˆæ¯é¢æ¿ */
        .messages-panel {
            background: white;
        }

        .chat-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .conversation-header {
            background: var(--gray-50);
            padding: var(--spacing-md);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .conversation-info h3 {
            margin: 0;
            font-size: var(--font-size-base);
            font-weight: var(--font-weight-medium);
        }

        .conversation-info p {
            margin: 0;
            font-size: var(--font-size-xs);
            color: var(--gray-600);
        }

        .chat-messages {
            flex: 1;
            padding: var(--spacing-md);
            overflow-y: auto;
            background: var(--gray-50);
        }

        .chat-input-area {
            background: white;
            border-top: 1px solid var(--border-color);
            padding: var(--spacing-md);
        }

        .input-group {
            display: flex;
            gap: var(--spacing-sm);
        }

        .message-input {
            flex: 1;
            resize: none;
            min-height: 40px;
            max-height: 120px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-sm) var(--spacing-md);
            font-size: var(--font-size-sm);
        }

        .message-input:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 123, 255, 0.25);
        }

        /* åº—é“ºç®¡ç†é¢æ¿ */
        .shops-panel {
            background: white;
            padding: var(--spacing-md);
        }

        .shop-grid {
            display: grid;
            gap: var(--spacing-md);
            margin-top: var(--spacing-md);
        }

        .shop-card {
            background: white;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: var(--spacing-md);
            transition: all 0.2s ease;
        }

        .shop-card:hover {
            border-color: var(--primary-color);
            box-shadow: var(--box-shadow-sm);
        }

        .shop-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-sm);
        }

        .shop-name {
            font-weight: var(--font-weight-medium);
            color: var(--gray-900);
        }

        .shop-status {
            font-size: var(--font-size-xs);
            padding: 2px 6px;
            border-radius: 10px;
            font-weight: var(--font-weight-medium);
        }

        .shop-status.active {
            background: rgba(40, 167, 69, 0.1);
            color: var(--success-color);
        }

        .shop-status.pending {
            background: rgba(255, 193, 7, 0.1);
            color: var(--warning-color);
        }

        .shop-info {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-bottom: var(--spacing-sm);
        }

        .shop-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* è®¾ç½®é¢æ¿ */
        .settings-panel {
            background: white;
            padding: var(--spacing-md);
        }

        .setting-group {
            margin-bottom: var(--spacing-lg);
        }

        .setting-group:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            display: block;
            font-weight: var(--font-weight-medium);
            margin-bottom: var(--spacing-sm);
            color: var(--gray-900);
        }

        .setting-description {
            font-size: var(--font-size-sm);
            color: var(--gray-600);
            margin-bottom: var(--spacing-sm);
        }

        /* æ¶ˆæ¯æ ·å¼ */
        .message {
            margin-bottom: var(--spacing-md);
            display: flex;
            flex-direction: column;
        }

        .message-customer {
            align-items: flex-start;
        }

        .message-agent {
            align-items: flex-end;
        }

        .message-system {
            align-items: center;
        }

        .message-content {
            max-width: 80%;
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius);
            margin-bottom: var(--spacing-xs);
            word-wrap: break-word;
        }

        .message-customer .message-content {
            background: var(--gray-200);
            color: var(--gray-900);
        }

        .message-agent .message-content {
            background: var(--primary-color);
            color: white;
        }

        .message-system .message-content {
            background: var(--gray-100);
            color: var(--gray-600);
            font-style: italic;
            font-size: var(--font-size-sm);
            text-align: center;
        }

        .message-time {
            font-size: var(--font-size-xs);
            color: var(--gray-500);
            padding: 0 var(--spacing-sm);
        }

        .message-info {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
        }

        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 480px) {
            .login-container {
                padding: var(--spacing-lg);
            }
            
            .conversation-header {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .chat-messages {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .chat-input-area {
                padding: var(--spacing-sm) var(--spacing-md);
            }
        }

        /* æ·±è‰²ä¸»é¢˜æ”¯æŒ */
        @media (prefers-color-scheme: dark) {
            .admin-app {
                background: var(--gray-900);
            }

            .login-container {
                background: var(--gray-800);
            }

            .messages-panel,
            .shops-panel,
            .settings-panel {
                background: var(--gray-800);
            }

            .conversation-header {
                background: var(--gray-700);
            }

            .chat-messages {
                background: var(--gray-700);
            }

            .chat-input-area {
                background: var(--gray-800);
                border-top-color: var(--gray-600);
            }

            .message-input {
                background: var(--gray-700);
                border-color: var(--gray-600);
                color: var(--gray-100);
            }

            .shop-card {
                background: var(--gray-800);
                border-color: var(--gray-600);
            }

            .message-customer .message-content {
                background: var(--gray-600);
                color: var(--gray-100);
            }

            .message-system .message-content {
                background: var(--gray-600);
                color: var(--gray-300);
            }
        }

        /* éšè—ç±» */
        .hidden {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="admin-app" id="admin-app">
        <!-- ç™»å½•ç•Œé¢ -->
        <div class="login-screen" id="login-screen">
            <div class="login-container">
                <div class="login-header">
                    <h1 class="login-logo">QuickTalk</h1>
                    <p class="login-subtitle">å®¢æœç®¡ç†ç³»ç»Ÿ</p>
                </div>
                <div class="login-form" id="login-form">
                    <!-- ç™»å½•è¡¨å•å°†é€šè¿‡JavaScriptåˆ›å»º -->
                </div>
            </div>
        </div>

        <!-- ä¸»åº”ç”¨ç•Œé¢ -->
        <div class="main-app hidden" id="main-app">
            <!-- çŠ¶æ€æ  -->
            <div class="status-bar">
                <span>å®¢æœç®¡ç†ç³»ç»Ÿ</span>
                <div class="connection-info">
                    <span class="status-indicator" id="ws-status"></span>
                    <span id="ws-status-text">ç¦»çº¿</span>
                </div>
            </div>

            <!-- ä¸»è¦å†…å®¹ -->
            <div class="main-content">
                <!-- æ ‡ç­¾é¡µå¯¼èˆª -->
                <div class="tab-navigation" id="tab-navigation">
                    <!-- å¯¼èˆªå°†é€šè¿‡JavaScriptåˆ›å»º -->
                </div>

                <!-- å†…å®¹é¢æ¿ -->
                <div class="content-panels">
                    <!-- æ¶ˆæ¯é¢æ¿ -->
                    <div class="content-panel active" id="messages-panel">
                        <div class="messages-panel">
                            <div class="chat-container">
                                <div class="conversation-header">
                                    <div class="conversation-info">
                                        <h3 id="conversation-title">é€‰æ‹©ä¸€ä¸ªå¯¹è¯</h3>
                                        <p id="conversation-subtitle">ç­‰å¾…å®¢æˆ·æ¶ˆæ¯...</p>
                                    </div>
                                    <div class="conversation-actions">
                                        <button class="btn btn-sm btn-outline-primary" id="refresh-btn">åˆ·æ–°</button>
                                    </div>
                                </div>
                                <div class="chat-messages" id="chat-messages">
                                    <!-- æ¶ˆæ¯å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                                </div>
                                <div class="chat-input-area">
                                    <div class="input-group">
                                        <textarea class="message-input" id="message-input" placeholder="è¾“å…¥å›å¤æ¶ˆæ¯..." rows="1"></textarea>
                                        <button class="btn btn-primary" id="send-btn">å‘é€</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- åº—é“ºç®¡ç†é¢æ¿ -->
                    <div class="content-panel" id="shops-panel">
                        <div class="shops-panel">
                            <div class="d-flex align-items-center justify-content-between mb-3">
                                <h2 class="fs-lg fw-semibold">åº—é“ºç®¡ç†</h2>
                                <button class="btn btn-primary btn-sm" id="add-shop-btn">æ·»åŠ åº—é“º</button>
                            </div>
                            <div class="shop-grid" id="shop-grid">
                                <!-- åº—é“ºå¡ç‰‡å°†é€šè¿‡JavaScriptåŠ¨æ€æ·»åŠ  -->
                            </div>
                        </div>
                    </div>

                    <!-- è®¾ç½®é¢æ¿ -->
                    <div class="content-panel" id="settings-panel">
                        <div class="settings-panel">
                            <h2 class="fs-lg fw-semibold mb-4">ç³»ç»Ÿè®¾ç½®</h2>
                            <div class="setting-group">
                                <label class="setting-label">é€šçŸ¥è®¾ç½®</label>
                                <p class="setting-description">é…ç½®æ–°æ¶ˆæ¯é€šçŸ¥æ–¹å¼</p>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="sound-notification">
                                    <label class="form-check-label" for="sound-notification">å£°éŸ³é€šçŸ¥</label>
                                </div>
                                <div class="form-check">
                                    <input type="checkbox" class="form-check-input" id="desktop-notification">
                                    <label class="form-check-label" for="desktop-notification">æ¡Œé¢é€šçŸ¥</label>
                                </div>
                            </div>
                            <div class="setting-group">
                                <label class="setting-label">è‡ªåŠ¨å›å¤</label>
                                <p class="setting-description">è®¾ç½®è‡ªåŠ¨å›å¤æ¶ˆæ¯</p>
                                <textarea class="form-control" id="auto-reply" placeholder="è¾“å…¥è‡ªåŠ¨å›å¤å†…å®¹..." rows="3"></textarea>
                            </div>
                            <div class="setting-group">
                                <label class="setting-label">å·¥ä½œæ—¶é—´</label>
                                <p class="setting-description">è®¾ç½®å®¢æœå·¥ä½œæ—¶é—´</p>
                                <div class="d-flex gap-2">
                                    <input type="time" class="form-control" id="work-start" value="09:00">
                                    <span class="align-self-center">åˆ°</span>
                                    <input type="time" class="form-control" id="work-end" value="18:00">
                                </div>
                            </div>
                            <div class="setting-group">
                                <button class="btn btn-primary" id="save-settings-btn">ä¿å­˜è®¾ç½®</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- æ ¸å¿ƒJavaScriptæ¨¡å— -->
    <script src="/assets/js/core/eventbus.js"></script>
    <script src="/assets/js/core/utils.js"></script>
    <script src="/assets/js/core/config.js"></script>
    
    <!-- UIç»„ä»¶åº“ -->
    <script src="/assets/js/components/index.js"></script>
    
    <!-- ä¸šåŠ¡ç®¡ç†å™¨ -->
    <script src="/assets/js/modules/user-manager.js"></script>
    <script src="/assets/js/modules/message-manager.js"></script>
    <script src="/assets/js/modules/shop-manager.js"></script>

    <script>
        // ç®¡ç†åå°åº”ç”¨
        class AdminApp {
            constructor() {
                this.isLoggedIn = false;
                this.currentUser = null;
                this.ws = null;
                this.currentConversation = null;
                this.activeTab = 'messages';
                
                // ç»„ä»¶å®ä¾‹
                this.navigation = null;
                this.userManager = null;
                this.messageManager = null;
                this.shopManager = null;
                
                this.init();
            }
            
            async init() {
                console.log('[AdminApp] åˆå§‹åŒ–å¼€å§‹');
                
                // åˆå§‹åŒ–ç®¡ç†å™¨
                this.userManager = new UserManager({
                    eventBus: window.EventBus,
                    utils: window.Utils
                });
                
                this.messageManager = new MessageManager({
                    eventBus: window.EventBus,
                    utils: window.Utils
                });
                
                this.shopManager = new ShopManager({
                    eventBus: window.EventBus,
                    utils: window.Utils
                });
                
                // ç»‘å®šäº‹ä»¶
                this.bindEvents();
                
                // åˆ›å»ºç™»å½•è¡¨å•
                this.createLoginForm();
                
                // æ£€æŸ¥æ˜¯å¦å·²ç™»å½•
                await this.checkLoginStatus();
                
                console.log('[AdminApp] åˆå§‹åŒ–å®Œæˆ');
            }
            
            bindEvents() {
                // ç›‘å¬ç”¨æˆ·ç›¸å…³äº‹ä»¶
                window.EventBus?.on('user:loginSuccess', (data) => {
                    this.handleLoginSuccess(data);
                });
                
                window.EventBus?.on('user:logout', () => {
                    this.handleLogout();
                });
                
                // ç›‘å¬æ¶ˆæ¯ç›¸å…³äº‹ä»¶
                window.EventBus?.on('message:received', (data) => {
                    this.handleNewMessage(data);
                });
                
                // ç›‘å¬WebSocketè¿æ¥çŠ¶æ€
                window.EventBus?.on('connection:statusChanged', (status) => {
                    this.updateConnectionStatus(status);
                });
            }
            
            createLoginForm() {
                const formContainer = document.getElementById('login-form');
                
                // ä½¿ç”¨Formç»„ä»¶åˆ›å»ºç™»å½•è¡¨å•
                const form = new window.Form(formContainer, {
                    fields: [
                        {
                            name: 'username',
                            type: 'text',
                            label: 'ç”¨æˆ·å',
                            required: true,
                            placeholder: 'è¯·è¾“å…¥ç”¨æˆ·å'
                        },
                        {
                            name: 'password',
                            type: 'password',
                            label: 'å¯†ç ',
                            required: true,
                            placeholder: 'è¯·è¾“å…¥å¯†ç '
                        }
                    ],
                    actions: [
                        {
                            text: 'ç™»å½•',
                            type: 'submit',
                            variant: 'primary',
                            block: true
                        }
                    ],
                    onSubmit: (data) => this.handleLogin(data),
                    eventBus: window.EventBus,
                    utils: window.Utils
                });
            }
            
            createNavigation() {
                const navContainer = document.getElementById('tab-navigation');
                
                // ä½¿ç”¨Navigationç»„ä»¶åˆ›å»ºæ ‡ç­¾é¡µå¯¼èˆª
                this.navigation = new window.Navigation(navContainer, {
                    type: 'tabs',
                    items: [
                        {
                            id: 'messages',
                            label: 'æ¶ˆæ¯',
                            icon: 'ğŸ’¬',
                            badge: 0
                        },
                        {
                            id: 'shops',
                            label: 'åº—é“º',
                            icon: 'ğŸª'
                        },
                        {
                            id: 'settings',
                            label: 'è®¾ç½®',
                            icon: 'âš™ï¸'
                        }
                    ],
                    activeItem: 'messages',
                    onItemClick: (itemId) => this.switchTab(itemId),
                    eventBus: window.EventBus,
                    utils: window.Utils
                });
            }
            
            async handleLogin(formData) {
                try {
                    const response = await fetch('/api/admin/login', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(formData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        this.handleLoginSuccess(result);
                    } else {
                        window.Notification?.error(result.message || 'ç™»å½•å¤±è´¥');
                    }
                } catch (error) {
                    console.error('ç™»å½•é”™è¯¯:', error);
                    window.Notification?.error('ç™»å½•å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            }
            
            handleLoginSuccess(data) {
                this.isLoggedIn = true;
                this.currentUser = data.user;
                
                // éšè—ç™»å½•ç•Œé¢ï¼Œæ˜¾ç¤ºä¸»åº”ç”¨
                document.getElementById('login-screen').classList.add('hidden');
                document.getElementById('main-app').classList.remove('hidden');
                
                // åˆ›å»ºå¯¼èˆª
                this.createNavigation();
                
                // è¿æ¥WebSocket
                this.connectWebSocket();
                
                // åŠ è½½åˆå§‹æ•°æ®
                this.loadInitialData();
                
                window.Notification?.success('ç™»å½•æˆåŠŸï¼');
            }
            
            handleLogout() {
                this.isLoggedIn = false;
                this.currentUser = null;
                
                // æ–­å¼€WebSocket
                if (this.ws) {
                    this.ws.close();
                    this.ws = null;
                }
                
                // æ˜¾ç¤ºç™»å½•ç•Œé¢
                document.getElementById('main-app').classList.add('hidden');
                document.getElementById('login-screen').classList.remove('hidden');
                
                window.Notification?.info('å·²é€€å‡ºç™»å½•');
            }
            
            async checkLoginStatus() {
                try {
                    const response = await fetch('/api/admin/status');
                    const result = await response.json();
                    
                    if (result.success && result.user) {
                        this.handleLoginSuccess(result);
                    }
                } catch (error) {
                    console.log('æœªç™»å½•æˆ–ç™»å½•å·²è¿‡æœŸ');
                }
            }
            
            connectWebSocket() {
                const wsUrl = `ws://localhost:3030/ws`;
                this.ws = new WebSocket(wsUrl);
                
                this.ws.onopen = () => {
                    console.log('WebSocket è¿æ¥å·²å»ºç«‹');
                    this.updateConnectionStatus('connected');
                    
                    // å‘é€ç®¡ç†å‘˜è¿æ¥æ¶ˆæ¯
                    this.ws.send(JSON.stringify({
                        type: 'admin-connect',
                        userId: this.currentUser.id
                    }));
                };
                
                this.ws.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleWebSocketMessage(data);
                    } catch (error) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                    }
                };
                
                this.ws.onclose = () => {
                    console.log('WebSocket è¿æ¥å·²æ–­å¼€');
                    this.updateConnectionStatus('disconnected');
                    
                    // å°è¯•é‡è¿
                    setTimeout(() => {
                        if (this.isLoggedIn) {
                            this.connectWebSocket();
                        }
                    }, 5000);
                };
                
                this.ws.onerror = (error) => {
                    console.error('WebSocket é”™è¯¯:', error);
                    this.updateConnectionStatus('error');
                };
            }
            
            handleWebSocketMessage(data) {
                switch (data.type) {
                    case 'new-conversation':
                        this.handleNewConversation(data);
                        break;
                    case 'message':
                        this.handleNewMessage(data);
                        break;
                    case 'conversation-closed':
                        this.handleConversationClosed(data);
                        break;
                }
            }
            
            handleNewConversation(data) {
                // æ›´æ–°æ¶ˆæ¯æ ‡ç­¾é¡µçš„å¾½ç« 
                if (this.navigation) {
                    const currentBadge = this.navigation.getItem('messages')?.badge || 0;
                    this.navigation.updateBadge('messages', currentBadge + 1);
                }
                
                window.Notification?.info(`æ–°çš„å®¢æˆ·å¯¹è¯: ${data.customerName || 'åŒ¿åå®¢æˆ·'}`);
            }
            
            handleNewMessage(data) {
                // å¦‚æœå½“å‰ä¸åœ¨æ¶ˆæ¯æ ‡ç­¾é¡µï¼Œæ›´æ–°å¾½ç« 
                if (this.activeTab !== 'messages') {
                    const currentBadge = this.navigation.getItem('messages')?.badge || 0;
                    this.navigation.updateBadge('messages', currentBadge + 1);
                }
                
                // å¦‚æœæ˜¯å½“å‰å¯¹è¯çš„æ¶ˆæ¯ï¼Œæ·»åŠ åˆ°èŠå¤©ç•Œé¢
                if (this.currentConversation && data.conversationId === this.currentConversation.id) {
                    this.addMessageToChat(data.content, 'customer', data.timestamp);
                }
                
                // æ˜¾ç¤ºé€šçŸ¥
                if (data.conversationId !== this.currentConversation?.id) {
                    window.Notification?.info(`æ–°æ¶ˆæ¯: ${data.content}`);
                }
            }
            
            switchTab(tabId) {
                // éšè—æ‰€æœ‰é¢æ¿
                document.querySelectorAll('.content-panel').forEach(panel => {
                    panel.classList.remove('active');
                });
                
                // æ˜¾ç¤ºé€‰ä¸­çš„é¢æ¿
                document.getElementById(`${tabId}-panel`).classList.add('active');
                
                this.activeTab = tabId;
                
                // å¦‚æœåˆ‡æ¢åˆ°æ¶ˆæ¯æ ‡ç­¾é¡µï¼Œæ¸…é™¤å¾½ç« 
                if (tabId === 'messages' && this.navigation) {
                    this.navigation.updateBadge('messages', 0);
                }
                
                // åŠ è½½å¯¹åº”æ•°æ®
                switch (tabId) {
                    case 'messages':
                        this.loadMessages();
                        break;
                    case 'shops':
                        this.loadShops();
                        break;
                    case 'settings':
                        this.loadSettings();
                        break;
                }
            }
            
            async loadInitialData() {
                // æ ¹æ®å½“å‰æ ‡ç­¾é¡µåŠ è½½æ•°æ®
                switch (this.activeTab) {
                    case 'messages':
                        await this.loadMessages();
                        break;
                    case 'shops':
                        await this.loadShops();
                        break;
                }
            }
            
            async loadMessages() {
                try {
                    // è¿™é‡ŒåŠ è½½æ¶ˆæ¯åˆ—è¡¨
                    // æš‚æ—¶æ˜¾ç¤ºå ä½å†…å®¹
                    this.addSystemMessage('ç­‰å¾…å®¢æˆ·æ¶ˆæ¯...');
                } catch (error) {
                    console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                    window.Notification?.error('åŠ è½½æ¶ˆæ¯å¤±è´¥');
                }
            }
            
            async loadShops() {
                try {
                    const shops = await this.shopManager.getShops();
                    this.renderShops(shops);
                } catch (error) {
                    console.error('åŠ è½½åº—é“ºå¤±è´¥:', error);
                    window.Notification?.error('åŠ è½½åº—é“ºå¤±è´¥');
                }
            }
            
            renderShops(shops) {
                const shopGrid = document.getElementById('shop-grid');
                shopGrid.innerHTML = '';
                
                shops.forEach(shop => {
                    const shopCard = document.createElement('div');
                    shopCard.className = 'shop-card';
                    shopCard.innerHTML = `
                        <div class="shop-header">
                            <span class="shop-name">${this.escapeHtml(shop.name)}</span>
                            <span class="shop-status ${shop.status}">${shop.status === 'active' ? 'å·²æ¿€æ´»' : 'å¾…å®¡æ ¸'}</span>
                        </div>
                        <div class="shop-info">
                            <div>åŸŸå: ${this.escapeHtml(shop.domain || 'æœªè®¾ç½®')}</div>
                            <div>åˆ›å»ºæ—¶é—´: ${new Date(shop.createdAt).toLocaleDateString()}</div>
                        </div>
                        <div class="shop-actions">
                            <button class="btn btn-sm btn-outline-primary" onclick="editShop('${shop.id}')">ç¼–è¾‘</button>
                            <button class="btn btn-sm btn-outline-${shop.status === 'active' ? 'warning' : 'success'}" onclick="toggleShopStatus('${shop.id}')">
                                ${shop.status === 'active' ? 'åœç”¨' : 'æ¿€æ´»'}
                            </button>
                        </div>
                    `;
                    shopGrid.appendChild(shopCard);
                });
            }
            
            loadSettings() {
                // åŠ è½½è®¾ç½®æ•°æ®
                // è¿™é‡Œå¯ä»¥ä»æœ¬åœ°å­˜å‚¨æˆ–æœåŠ¡å™¨åŠ è½½è®¾ç½®
            }
            
            async sendMessage() {
                const input = document.getElementById('message-input');
                const message = input.value.trim();
                
                if (!message || !this.currentConversation) return;
                
                // æ·»åŠ æ¶ˆæ¯åˆ°ç•Œé¢
                this.addMessageToChat(message, 'agent');
                input.value = '';
                
                // å‘é€åˆ°æœåŠ¡å™¨
                if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                    this.ws.send(JSON.stringify({
                        type: 'message',
                        content: message,
                        conversationId: this.currentConversation.id,
                        timestamp: Date.now()
                    }));
                }
            }
            
            addMessageToChat(content, sender, timestamp = null) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageEl = document.createElement('div');
                
                messageEl.className = `message message-${sender}`;
                
                const time = timestamp ? new Date(timestamp) : new Date();
                const timeStr = time.toLocaleTimeString('zh-CN', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                
                messageEl.innerHTML = `
                    <div class="message-content">${this.escapeHtml(content)}</div>
                    <div class="message-info">
                        <span class="message-time">${timeStr}</span>
                    </div>
                `;
                
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            addSystemMessage(content) {
                const messagesContainer = document.getElementById('chat-messages');
                const messageEl = document.createElement('div');
                
                messageEl.className = 'message message-system';
                messageEl.innerHTML = `
                    <div class="message-content">${this.escapeHtml(content)}</div>
                `;
                
                messagesContainer.appendChild(messageEl);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }
            
            updateConnectionStatus(status) {
                const indicator = document.getElementById('ws-status');
                const text = document.getElementById('ws-status-text');
                
                switch (status) {
                    case 'connected':
                        indicator.className = 'status-indicator connected';
                        text.textContent = 'åœ¨çº¿';
                        break;
                    case 'disconnected':
                        indicator.className = 'status-indicator';
                        text.textContent = 'ç¦»çº¿';
                        break;
                    case 'error':
                        indicator.className = 'status-indicator';
                        text.textContent = 'é”™è¯¯';
                        break;
                }
            }
            
            escapeHtml(text) {
                if (window.Utils && window.Utils.escapeHtml) {
                    return window.Utils.escapeHtml(text);
                }
                
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }
        }
        
        // å…¨å±€åº”ç”¨å®ä¾‹
        let adminApp;
        
        // å…¨å±€å‡½æ•°ï¼ˆä¿æŒå‘åå…¼å®¹ï¼‰
        function editShop(shopId) {
            console.log('ç¼–è¾‘åº—é“º:', shopId);
            // è¿™é‡Œå¯ä»¥æ‰“å¼€ç¼–è¾‘æ¨¡æ€æ¡†
        }
        
        function toggleShopStatus(shopId) {
            console.log('åˆ‡æ¢åº—é“ºçŠ¶æ€:', shopId);
            // è¿™é‡Œå¯ä»¥è°ƒç”¨APIåˆ‡æ¢åº—é“ºçŠ¶æ€
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            adminApp = new AdminApp();
            
            // ç»‘å®šå‘é€æŒ‰é’®
            document.getElementById('send-btn').addEventListener('click', () => {
                adminApp.sendMessage();
            });
            
            // ç»‘å®šè¾“å…¥æ¡†å›è½¦é”®
            document.getElementById('message-input').addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    adminApp.sendMessage();
                }
            });
            
            console.log('[AdminMobile] é¡µé¢åˆå§‹åŒ–å®Œæˆ');
        });
    </script>
</body>
</html>