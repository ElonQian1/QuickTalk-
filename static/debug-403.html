<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>403é”™è¯¯è¯Šæ–­</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test-box { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; background: #2196F3; color: white; cursor: pointer; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>ğŸ” 403é”™è¯¯ä¸“é¡¹è¯Šæ–­</h1>
    
    <div class="test-box">
        <h3>ğŸ¯ å¿«é€Ÿè¯Šæ–­</h3>
        <button onclick="quickDiagnose()">ğŸš€ ä¸€é”®è¯Šæ–­</button>
        <button onclick="testLogin()">ğŸ” æµ‹è¯•ç™»å½•</button>
        <button onclick="testShopsAPI()">ğŸª æµ‹è¯•åº—é“ºAPI</button>
        <button onclick="clearLog()">ğŸ—‘ï¸ æ¸…é™¤æ—¥å¿—</button>
    </div>

    <div class="test-box">
        <h3>ğŸ“‹ å½“å‰çŠ¶æ€</h3>
        <div id="currentStatus">æ£€æŸ¥ä¸­...</div>
    </div>

    <div class="test-box">
        <h3>ğŸ“ è¯Šæ–­æ—¥å¿—</h3>
        <div id="diagnosticLog" class="log">ç­‰å¾…è¯Šæ–­...</div>
    </div>

    <script>
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.push(`[${timestamp}] ${message}`);
            updateLogDisplay();
            console.log(message);
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('diagnosticLog');
            logDiv.innerHTML = `<pre>${logEntries.join('\n')}</pre>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
        }

        function updateStatus(html, className = '') {
            const statusDiv = document.getElementById('currentStatus');
            statusDiv.innerHTML = html;
            statusDiv.className = className;
        }

        async function quickDiagnose() {
            clearLog();
            log('ğŸš€ å¼€å§‹å¿«é€Ÿè¯Šæ–­...');
            
            await checkSessionIds();
            await testLogin();
            await testShopsAPI();
            
            log('âœ… è¯Šæ–­å®Œæˆ');
        }

        function checkSessionIds() {
            log('ğŸ” æ£€æŸ¥SessionId...');
            
            const localStorageId = localStorage.getItem('sessionId');
            const sessionStorageId = sessionStorage.getItem('currentSessionId');
            const globalSessionId = window.sessionId;
            
            log(`localStorage.sessionId: ${localStorageId || 'æ— '}`);
            log(`sessionStorage.currentSessionId: ${sessionStorageId || 'æ— '}`);
            log(`window.sessionId: ${globalSessionId || 'æ— '}`);
            
            const sessionId = localStorageId || sessionStorageId || globalSessionId;
            if (sessionId) {
                log(`âœ… æ‰¾åˆ°å¯ç”¨çš„sessionId: ${sessionId}`);
                updateStatus(`âœ… SessionId: ${sessionId}`, 'success');
                return sessionId;
            } else {
                log('âŒ æ²¡æœ‰æ‰¾åˆ°ä»»ä½•sessionId');
                updateStatus('âŒ æ²¡æœ‰SessionId', 'error');
                return null;
            }
        }

        async function testLogin() {
            log('ğŸ” æµ‹è¯•ç™»å½•çŠ¶æ€...');
            
            const sessionId = localStorage.getItem('sessionId') || 
                              sessionStorage.getItem('currentSessionId') || 
                              'test_session';
            
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                log(`ç™»å½•APIå“åº”: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const user = await response.json();
                    log(`âœ… ç™»å½•æˆåŠŸ: ${user.username} (${user.role})`);
                    updateStatus(`âœ… å·²ç™»å½•: ${user.username} (${user.role})`, 'success');
                    return user;
                } else {
                    const error = await response.text();
                    log(`âŒ ç™»å½•å¤±è´¥: ${error}`);
                    updateStatus(`âŒ ç™»å½•å¤±è´¥: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ ç™»å½•è¯·æ±‚å¼‚å¸¸: ${error.message}`);
                updateStatus(`âŒ è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                return null;
            }
        }

        async function testShopsAPI() {
            log('ğŸª æµ‹è¯•åº—é“ºAPI...');
            
            const sessionId = localStorage.getItem('sessionId') || 
                              sessionStorage.getItem('currentSessionId') || 
                              'test_session';
            
            try {
                log(`å‘é€è¯·æ±‚åˆ° /api/admin/shopsï¼ŒsessionId: ${sessionId}`);
                
                const response = await fetch('/api/admin/shops', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    }
                });
                
                log(`åº—é“ºAPIå“åº”: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const shops = await response.json();
                    log(`âœ… åº—é“ºAPIæˆåŠŸ: è·å–åˆ° ${shops.length} ä¸ªåº—é“º`);
                    if (shops.length > 0) {
                        log(`å‰3ä¸ªåº—é“º: ${shops.slice(0, 3).map(s => s.name).join(', ')}`);
                    }
                    updateStatus(`âœ… åº—é“ºæ•°æ®: ${shops.length} ä¸ª`, 'success');
                    return shops;
                } else {
                    const errorText = await response.text();
                    log(`âŒ åº—é“ºAPIå¤±è´¥ (${response.status}): ${errorText}`);
                    
                    if (response.status === 403) {
                        log('ğŸ” 403é”™è¯¯å¯èƒ½åŸå› :');
                        log('  1. SessionIdæ— æ•ˆæˆ–è¿‡æœŸ');
                        log('  2. ç”¨æˆ·æƒé™ä¸è¶³');
                        log('  3. è®¤è¯ä¸­é—´ä»¶é—®é¢˜');
                    }
                    
                    updateStatus(`âŒ APIé”™è¯¯: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`âŒ åº—é“ºAPIè¯·æ±‚å¼‚å¸¸: ${error.message}`);
                updateStatus(`âŒ è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                return null;
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨æ£€æŸ¥çŠ¶æ€
        window.addEventListener('DOMContentLoaded', () => {
            checkSessionIds();
        });
    </script>
</body>
</html>
