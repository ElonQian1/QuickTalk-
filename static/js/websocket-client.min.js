/**
 * ç»Ÿä¸€WebSocketå®¢æˆ·ç«¯åº“ - å‹ç¼©ç‰ˆ
 * ç”¨äºå‰ç«¯é¡µé¢ï¼Œæ›¿æ¢é‡å¤çš„WebSocketå®ç°
 */
class UnifiedWebSocketClient{constructor(e={}){this.serverUrl=e.serverUrl||this.getDefaultServerUrl(),this.wsUrl=this.serverUrl.replace(/^http/,"ws")+"/ws",this.enableReconnect=!1!==e.reconnect,this.enableHeartbeat=!1!==e.heartbeat,this.maxReconnectAttempts=e.maxReconnectAttempts||5,this.reconnectInterval=e.reconnectInterval||3e3,this.heartbeatInterval=e.heartbeatInterval||3e4,this.isMobile=e.mobile||this.detectMobile(),this.isEmbed=e.embed||!1,this.debug=e.debug||!1,this.ws=null,this.isConnected=!1,this.reconnectCount=0,this.lastPingTime=0,this.heartbeatTimer=null,this.reconnectTimer=null,this.onOpenCallback=null,this.onMessageCallback=null,this.onCloseCallback=null,this.onErrorCallback=null,this.onReconnectCallback=null,this.userId=e.userId||null,this.shopId=e.shopId||null,this.sessionId=e.sessionId||this.generateSessionId(),this.log("ğŸ”Œ UnifiedWebSocketClient åˆå§‹åŒ–å®Œæˆ")}async connect(){if(this.isConnected&&this.ws&&this.ws.readyState===WebSocket.OPEN)return void this.log("âš ï¸ WebSocketå·²è¿æ¥ï¼Œæ— éœ€é‡å¤è¿æ¥");try{this.log(`ğŸ”— è¿æ¥WebSocket: ${this.wsUrl}`),this.ws=new WebSocket(this.wsUrl),this.ws.onopen=this.handleOpen.bind(this),this.ws.onmessage=this.handleMessage.bind(this),this.ws.onclose=this.handleClose.bind(this),this.ws.onerror=this.handleError.bind(this)}catch(e){this.log("âŒ WebSocketè¿æ¥å¤±è´¥:",e),this.handleConnectionError(e)}}send(e){if(!this.isConnected||!this.ws||this.ws.readyState!==WebSocket.OPEN)return this.log("âš ï¸ WebSocketæœªè¿æ¥ï¼Œæ— æ³•å‘é€æ¶ˆæ¯"),!1;try{const t="string"==typeof e?e:JSON.stringify(e);return this.ws.send(t),this.log("ğŸ“¤ å‘é€æ¶ˆæ¯:",e),!0}catch(e){return this.log("âŒ å‘é€æ¶ˆæ¯å¤±è´¥:",e),!1}}authenticate(){return this.send({type:"auth",userId:this.userId,shopId:this.shopId,sessionId:this.sessionId,clientType:this.getClientType()})}disconnect(){this.enableReconnect=!1,this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.reconnectTimer&&(clearTimeout(this.reconnectTimer),this.reconnectTimer=null),this.ws&&(this.ws.close(),this.ws=null),this.isConnected=!1,this.log("ğŸ”Œ WebSocketè¿æ¥å·²æ–­å¼€")}handleOpen(){this.isConnected=!0,this.reconnectCount=0,this.log("âœ… WebSocketè¿æ¥æˆåŠŸ"),(this.userId||this.shopId)&&this.authenticate(),this.enableHeartbeat&&this.startHeartbeat(),this.onOpenCallback&&this.onOpenCallback()}handleMessage(e){try{const t=JSON.parse(e.data);if(this.log("ğŸ“¥ æ”¶åˆ°æ¶ˆæ¯:",t),"pong"===t.type)return void(this.lastPingTime=Date.now());if("auth_success"===t.type)return void this.log("ğŸ” è®¤è¯æˆåŠŸ");this.onMessageCallback&&this.onMessageCallback(t)}catch(t){this.log("âŒ æ¶ˆæ¯è§£æå¤±è´¥:",t),this.onMessageCallback&&this.onMessageCallback(e.data)}}handleClose(e){this.isConnected=!1,this.heartbeatTimer&&(clearInterval(this.heartbeatTimer),this.heartbeatTimer=null),this.log(`ğŸ”Œ WebSocketè¿æ¥å…³é—­: ${e.code} - ${e.reason||"æ— åŸå› "}`),this.onCloseCallback&&this.onCloseCallback(e),this.enableReconnect&&this.reconnectCount<this.maxReconnectAttempts&&this.scheduleReconnect()}handleError(e){this.log("âŒ WebSocketé”™è¯¯:",e),this.onErrorCallback&&this.onErrorCallback(e)}handleConnectionError(e){this.log("âŒ è¿æ¥é”™è¯¯:",e),this.enableReconnect&&this.reconnectCount<this.maxReconnectAttempts&&this.scheduleReconnect()}scheduleReconnect(){this.reconnectTimer||(this.reconnectCount++,setTimeout((()=>{this.reconnectTimer=null,this.onReconnectCallback&&this.onReconnectCallback(this.reconnectCount),this.connect()}),this.reconnectInterval*Math.pow(1.5,this.reconnectCount-1)))}startHeartbeat(){this.heartbeatTimer&&clearInterval(this.heartbeatTimer),this.heartbeatTimer=setInterval((()=>{this.isConnected&&this.ws&&this.ws.readyState===WebSocket.OPEN&&this.send({type:"ping",timestamp:Date.now()})}),this.heartbeatInterval)}onOpen(e){return this.onOpenCallback=e,this}onMessage(e){return this.onMessageCallback=e,this}onClose(e){return this.onCloseCallback=e,this}onError(e){return this.onErrorCallback=e,this}onReconnect(e){return this.onReconnectCallback=e,this}getDefaultServerUrl(){return"undefined"!=typeof window&&window.location?`${window.location.protocol}//${window.location.host}`:"ws://localhost:3030"}detectMobile(){return"undefined"!=typeof window&&/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)}getClientType(){return this.isEmbed?"embed":this.isMobile?"mobile":"desktop"}generateSessionId(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}log(...e){this.debug&&console.log("[UnifiedWebSocket]",...e)}getConnectionState(){return{isConnected:this.isConnected,readyState:this.ws?this.ws.readyState:WebSocket.CLOSED,reconnectCount:this.reconnectCount,userId:this.userId,shopId:this.shopId,sessionId:this.sessionId}}}UnifiedWebSocketClient.createDesktop=function(e={}){return new UnifiedWebSocketClient({...e,mobile:!1,embed:!1,debug:e.debug||!0})},UnifiedWebSocketClient.createMobile=function(e={}){return new UnifiedWebSocketClient({...e,mobile:!0,embed:!1,heartbeatInterval:45e3,debug:e.debug||!0})},UnifiedWebSocketClient.createEmbed=function(e={}){return new UnifiedWebSocketClient({...e,embed:!0,debug:e.debug||!1,heartbeatInterval:6e4})},"undefined"!=typeof module&&module.exports?module.exports=UnifiedWebSocketClient:"undefined"!=typeof window&&(window.UnifiedWebSocketClient=UnifiedWebSocketClient);