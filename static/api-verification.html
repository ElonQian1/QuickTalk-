<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <title>APIæ•°æ®å¿«é€ŸéªŒè¯</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; background: #f5f5f5; }
        .api-test { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .test-result { background: #f8f9fa; padding: 15px; margin: 10px 0; border-left: 4px solid #007bff; font-family: monospace; font-size: 12px; white-space: pre-wrap; max-height: 300px; overflow-y: auto; }
        .test-button { background: #007bff; color: white; border: none; padding: 10px 20px; margin: 5px; border-radius: 4px; cursor: pointer; }
        .test-button:hover { background: #0056b3; }
        .test-button.success { background: #28a745; }
        .test-button.danger { background: #dc3545; }
    </style>
</head>
<body>
    <h1>ğŸ” APIæ•°æ®éªŒè¯</h1>
    
    <div class="api-test">
        <h2>ğŸ“Š è·å–åº—é“ºåˆ—è¡¨</h2>
        <button class="test-button" onclick="fetchShops()">è·å–åº—é“ºæ•°æ®</button>
        <button class="test-button success" onclick="testShopStatsAPI()">æµ‹è¯•åº—é“ºç»Ÿè®¡API</button>
        <div id="shopsResult" class="test-result">ç‚¹å‡»æŒ‰é’®è·å–æ•°æ®...</div>
    </div>

    <div class="api-test">
        <h2>ğŸ’¬ è·å–å¯¹è¯åˆ—è¡¨</h2>
        <button class="test-button" onclick="fetchConversations()">è·å–å¯¹è¯æ•°æ®</button>
        <button class="test-button success" onclick="testConversationAPI()">æµ‹è¯•å¯¹è¯API</button>
        <div id="conversationsResult" class="test-result">ç‚¹å‡»æŒ‰é’®è·å–æ•°æ®...</div>
    </div>

    <div class="api-test">
        <h2>ğŸ”„ æ¨¡æ‹Ÿshop-statå’Œlast-messageä¿®å¤</h2>
        <button class="test-button" onclick="simulateShopStatFix()">æ¨¡æ‹Ÿshop-statä¿®å¤</button>
        <button class="test-button" onclick="simulateLastMessageFix()">æ¨¡æ‹Ÿlast-messageä¿®å¤</button>
        <button class="test-button danger" onclick="testBothFixes()">æµ‹è¯•ä¸¤ç§ä¿®å¤</button>
        <div id="fixResult" class="test-result">ç‚¹å‡»æŒ‰é’®æµ‹è¯•ä¿®å¤...</div>
    </div>

    <div class="api-test">
        <h2>ğŸ¯ å®æ—¶DOMæµ‹è¯•</h2>
        <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0;">
            <h3>æµ‹è¯•shop-statå…ƒç´ :</h3>
            <div class="shop-stat" data-stat-type="å¯¹è¯" data-shop-id="1">
                <div class="shop-stat-value">0</div>
                <div class="shop-stat-label">å¯¹è¯</div>
            </div>
            <div class="shop-stat" data-stat-type="æœªè¯»" data-shop-id="1">
                <div class="shop-stat-value">0</div>
                <div class="shop-stat-label">æœªè¯»</div>
            </div>
        </div>
        
        <div style="border: 1px solid #ddd; padding: 15px; margin: 10px 0;">
            <h3>æµ‹è¯•last-messageå…ƒç´ :</h3>
            <div class="last-message" data-conversation-id="1">ç­‰å¾…æ¶ˆæ¯...</div>
            <div class="last-message" data-conversation-id="2">åˆå§‹æ¶ˆæ¯å†…å®¹</div>
        </div>
        
        <button class="test-button success" onclick="updateTestElements()">æ›´æ–°æµ‹è¯•å…ƒç´ </button>
    </div>

    <script>
        // æ ¼å¼åŒ–è¾“å‡º
        function formatOutput(data, title = '') {
            return `${title}\n${JSON.stringify(data, null, 2)}`;
        }

        // è·å–åº—é“ºæ•°æ®
        async function fetchShops() {
            const result = document.getElementById('shopsResult');
            try {
                result.textContent = 'æ­£åœ¨è·å–åº—é“ºæ•°æ®...';
                const response = await fetch('/api/shops');
                const data = await response.json();
                result.textContent = formatOutput(data, 'âœ… åº—é“ºæ•°æ®è·å–æˆåŠŸ:');
            } catch (error) {
                result.textContent = `âŒ è·å–åº—é“ºæ•°æ®å¤±è´¥: ${error.message}`;
            }
        }

        // è·å–å¯¹è¯æ•°æ®
        async function fetchConversations() {
            const result = document.getElementById('conversationsResult');
            try {
                result.textContent = 'æ­£åœ¨è·å–å¯¹è¯æ•°æ®...';
                const response = await fetch('/api/conversations');
                const data = await response.json();
                result.textContent = formatOutput(data, 'âœ… å¯¹è¯æ•°æ®è·å–æˆåŠŸ:');
            } catch (error) {
                result.textContent = `âŒ è·å–å¯¹è¯æ•°æ®å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•åº—é“ºç»Ÿè®¡API
        async function testShopStatsAPI() {
            const result = document.getElementById('shopsResult');
            try {
                result.textContent = 'æ­£åœ¨æµ‹è¯•åº—é“ºç»Ÿè®¡...';
                
                // è·å–åº—é“ºåˆ—è¡¨
                const shopsResponse = await fetch('/api/shops');
                const shops = await shopsResponse.json();
                
                if (shops && shops.length > 0) {
                    const shopId = shops[0].id;
                    
                    // è·å–è¯¥åº—é“ºçš„å¯¹è¯ç»Ÿè®¡
                    const conversationsResponse = await fetch(`/api/conversations?shop_id=${shopId}`);
                    const conversations = await conversationsResponse.json();
                    
                    const stats = {
                        shop_id: shopId,
                        shop_name: shops[0].name,
                        conversation_count: conversations ? conversations.length : 0,
                        unread_count: conversations ? conversations.filter(c => c.unread_count > 0).length : 0
                    };
                    
                    result.textContent = formatOutput(stats, 'âœ… åº—é“ºç»Ÿè®¡è®¡ç®—æˆåŠŸ:');
                } else {
                    result.textContent = 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°åº—é“ºæ•°æ®';
                }
            } catch (error) {
                result.textContent = `âŒ åº—é“ºç»Ÿè®¡æµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•å¯¹è¯API
        async function testConversationAPI() {
            const result = document.getElementById('conversationsResult');
            try {
                result.textContent = 'æ­£åœ¨æµ‹è¯•å¯¹è¯API...';
                
                // è·å–å¯¹è¯åˆ—è¡¨
                const conversationsResponse = await fetch('/api/conversations');
                const conversations = await conversationsResponse.json();
                
                if (conversations && conversations.length > 0) {
                    const conv = conversations[0];
                    
                    // è·å–è¯¥å¯¹è¯çš„æ¶ˆæ¯
                    const messagesResponse = await fetch(`/api/conversations/${conv.id}/messages`);
                    const messages = await messagesResponse.json();
                    
                    const conversationDetail = {
                        conversation_id: conv.id,
                        customer_name: conv.customer_name || `å®¢æˆ·${String(conv.customer_id).padStart(3, '0')}`,
                        message_count: messages ? messages.length : 0,
                        last_message: messages && messages.length > 0 ? messages[messages.length - 1].content : 'æš‚æ— æ¶ˆæ¯',
                        last_message_time: messages && messages.length > 0 ? messages[messages.length - 1].created_at : null,
                        unread_count: conv.unread_count || 0
                    };
                    
                    result.textContent = formatOutput(conversationDetail, 'âœ… å¯¹è¯è¯¦æƒ…è·å–æˆåŠŸ:');
                } else {
                    result.textContent = 'âš ï¸ æ²¡æœ‰æ‰¾åˆ°å¯¹è¯æ•°æ®';
                }
            } catch (error) {
                result.textContent = `âŒ å¯¹è¯APIæµ‹è¯•å¤±è´¥: ${error.message}`;
            }
        }

        // æ¨¡æ‹Ÿshop-statä¿®å¤
        async function simulateShopStatFix() {
            const result = document.getElementById('fixResult');
            
            try {
                result.textContent = 'æ­£åœ¨æ¨¡æ‹Ÿshop-statä¿®å¤...\n';
                
                // è·å–çœŸå®æ•°æ®
                const shopsResponse = await fetch('/api/shops');
                const shops = await shopsResponse.json();
                
                if (shops && shops.length > 0) {
                    const shop = shops[0];
                    const conversationsResponse = await fetch(`/api/conversations?shop_id=${shop.id}`);
                    const conversations = await conversationsResponse.json();
                    
                    const stats = {
                        conversation_count: conversations ? conversations.length : 0,
                        unread_count: conversations ? conversations.filter(c => c.unread_count > 0).length : 0
                    };
                    
                    // æŸ¥æ‰¾å¹¶æ›´æ–°DOMå…ƒç´ 
                    const shopStatElements = document.querySelectorAll(`[data-shop-id="${shop.id}"].shop-stat`);
                    let updatedCount = 0;
                    
                    shopStatElements.forEach(element => {
                        const statType = element.getAttribute('data-stat-type');
                        const valueElement = element.querySelector('.shop-stat-value');
                        
                        if (valueElement) {
                            if (statType === 'å¯¹è¯') {
                                valueElement.textContent = stats.conversation_count;
                                updatedCount++;
                            } else if (statType === 'æœªè¯»') {
                                valueElement.textContent = stats.unread_count;
                                updatedCount++;
                            }
                        }
                    });
                    
                    result.textContent += `âœ… shop-statä¿®å¤å®Œæˆ\n`;
                    result.textContent += `åº—é“º: ${shop.name}\n`;
                    result.textContent += `å¯¹è¯æ•°: ${stats.conversation_count}\n`;
                    result.textContent += `æœªè¯»æ•°: ${stats.unread_count}\n`;
                    result.textContent += `æ›´æ–°å…ƒç´ æ•°: ${updatedCount}\n`;
                } else {
                    result.textContent += 'âš ï¸ æ²¡æœ‰åº—é“ºæ•°æ®å¯ç”¨äºæµ‹è¯•\n';
                }
            } catch (error) {
                result.textContent = `âŒ shop-statä¿®å¤å¤±è´¥: ${error.message}`;
            }
        }

        // æ¨¡æ‹Ÿlast-messageä¿®å¤
        async function simulateLastMessageFix() {
            const result = document.getElementById('fixResult');
            
            try {
                result.textContent = 'æ­£åœ¨æ¨¡æ‹Ÿlast-messageä¿®å¤...\n';
                
                // è·å–çœŸå®å¯¹è¯æ•°æ®
                const conversationsResponse = await fetch('/api/conversations');
                const conversations = await conversationsResponse.json();
                
                if (conversations && conversations.length > 0) {
                    let updatedCount = 0;
                    
                    for (const conv of conversations.slice(0, 3)) { // åªå¤„ç†å‰3ä¸ª
                        // è·å–æ¶ˆæ¯
                        const messagesResponse = await fetch(`/api/conversations/${conv.id}/messages`);
                        const messages = await messagesResponse.json();
                        
                        const lastMessage = messages && messages.length > 0 ? 
                            messages[messages.length - 1].content : 'æš‚æ— æ¶ˆæ¯';
                        
                        // æ›´æ–°DOM
                        const messageElements = document.querySelectorAll(`[data-conversation-id="${conv.id}"].last-message`);
                        messageElements.forEach(element => {
                            element.textContent = lastMessage;
                            updatedCount++;
                        });
                        
                        result.textContent += `å¯¹è¯${conv.id}: "${lastMessage}"\n`;
                    }
                    
                    result.textContent += `âœ… last-messageä¿®å¤å®Œæˆ\n`;
                    result.textContent += `æ›´æ–°å…ƒç´ æ•°: ${updatedCount}\n`;
                } else {
                    result.textContent += 'âš ï¸ æ²¡æœ‰å¯¹è¯æ•°æ®å¯ç”¨äºæµ‹è¯•\n';
                }
            } catch (error) {
                result.textContent = `âŒ last-messageä¿®å¤å¤±è´¥: ${error.message}`;
            }
        }

        // æµ‹è¯•ä¸¤ç§ä¿®å¤
        async function testBothFixes() {
            const result = document.getElementById('fixResult');
            result.textContent = 'å¼€å§‹ç»¼åˆä¿®å¤æµ‹è¯•...\n\n';
            
            await simulateShopStatFix();
            result.textContent += '\n';
            await simulateLastMessageFix();
            
            result.textContent += '\nğŸ‰ ç»¼åˆä¿®å¤æµ‹è¯•å®Œæˆ!';
        }

        // æ›´æ–°æµ‹è¯•å…ƒç´ 
        function updateTestElements() {
            // æ›´æ–°shop-statæµ‹è¯•å…ƒç´ 
            const shopStats = document.querySelectorAll('.shop-stat');
            shopStats.forEach((element, index) => {
                const valueElement = element.querySelector('.shop-stat-value');
                if (valueElement) {
                    valueElement.textContent = Math.floor(Math.random() * 20) + 1;
                }
            });
            
            // æ›´æ–°last-messageæµ‹è¯•å…ƒç´ 
            const lastMessages = document.querySelectorAll('.last-message');
            lastMessages.forEach((element, index) => {
                const messages = [
                    'ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹äº§å“ä¿¡æ¯',
                    'è¯·é—®è¿™ä¸ªå•†å“è¿˜æœ‰è´§å—ï¼Ÿ',
                    'èƒ½ä»‹ç»ä¸€ä¸‹å”®åæœåŠ¡å—ï¼Ÿ',
                    'ä»€ä¹ˆæ—¶å€™èƒ½å‘è´§ï¼Ÿ',
                    'è°¢è°¢æ‚¨çš„å¸®åŠ©'
                ];
                element.textContent = messages[Math.floor(Math.random() * messages.length)];
            });
            
            document.getElementById('fixResult').textContent = 'âœ… æµ‹è¯•å…ƒç´ å·²æ›´æ–°';
        }

        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨æ‰§è¡Œ
        document.addEventListener('DOMContentLoaded', function() {
            console.log('APIéªŒè¯é¡µé¢åŠ è½½å®Œæˆ');
            
            // 5ç§’åè‡ªåŠ¨è·å–æ•°æ®
            setTimeout(() => {
                fetchShops();
                setTimeout(() => {
                    fetchConversations();
                }, 1000);
            }, 2000);
        });
    </script>
</body>
</html>