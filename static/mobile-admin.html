<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>客服管理系统</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* 主容器 */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* 顶部状态栏 */
        .status-bar {
            height: 44px;
            background: #007AFF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            position: relative;
        }

        .connection-status {
            position: absolute;
            right: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34C759;
        }

        .status-dot.disconnected {
            background: #FF3B30;
        }

        /* 主内容区域 */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: white;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .page.active {
            transform: translateX(0);
        }

        /* 首页 */
        .home-page {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quick-actions h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .action-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .action-btn:hover {
            background: #e9ecef;
        }

        /* 消息页面 */
        .messages-page {
            display: flex;
            flex-direction: column;
        }

        .page-header {
            height: 60px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #e9ecef;
            position: relative;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
            text-align: center;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            background: none;
            border: none;
            font-size: 18px;
            color: #007AFF;
            cursor: pointer;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
        }

        /* 店铺列表 */
        .shop-list {
            padding: 0;
        }

        .search-section {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 60px;
            z-index: 10;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .shops-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }

        .stats-item {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
        }

        .stats-number {
            font-size: 24px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 12px;
            color: #666;
        }

        .shops-list {
            padding: 0;
        }

        .shop-card {
            background: white;
            margin: 10px 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007AFF;
            transition: all 0.3s ease;
        }

        .shop-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .shop-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }

        .shop-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .shop-item:hover {
            background: #f8f9fa;
        }

        .shop-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .shop-info {
            flex: 1;
            min-width: 0;
        }

        .shop-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .shop-domain {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .shop-role {
            font-size: 12px;
            color: #007AFF;
            font-weight: 500;
        }

        .shop-status-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-approved, .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-suspended {
            background: #e2e3e5;
            color: #41464b;
            border: 1px solid #d6d8db;
        }

        .shop-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
        }

        .shop-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .shop-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            min-width: calc(50% - 4px);
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #6C757D;
            color: white;
        }

        .btn-secondary:hover {
            background: #545B62;
        }

        .btn-success {
            background: #28A745;
            color: white;
        }

        .btn-success:hover {
            background: #1E7E34;
        }

        .btn-warning {
            background: #FFC107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #E0A800;
        }

        .btn-info {
            background: #17A2B8;
            color: white;
        }

        .btn-info:hover {
            background: #117A8B;
        }

        .shop-meta {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .shop-created, .shop-updated {
            font-size: 12px;
            color: #868e96;
            margin-bottom: 3px;
        }

        /* 加载和状态样式 */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
        }

        .error-state, .empty-state, .no-results-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .error-icon, .empty-icon, .no-results-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .error-message, .empty-message, .no-results-message {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
        }

        .retry-btn, .create-shop-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-shop-btn {
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 16px;
        }

        /* 悬浮按钮 */
        .floating-action {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 100;
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            transition: all 0.3s ease;
        }

        .fab-btn:hover {
            transform: scale(1.1);
        }

        .refresh-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        /* Toast 样式 */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            animation: toastShow 0.3s ease;
        }

        .toast-success {
            background: rgba(40, 167, 69, 0.9);
        }

        .toast-error {
            background: rgba(220, 53, 69, 0.9);
        }

        @keyframes toastShow {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .unread-badge {
            background: #FF3B30;
            color: white;
            border-radius: 12px;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* 用户对话列表 */
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .conversation-item:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 22.5px;
            background: #34C759;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #666;
        }

        .last-message {
            font-size: 14px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* 聊天界面 */
        .chat-page {
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            height: 60px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #e9ecef;
            color: #333;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.admin .message-content {
            background: #007AFF;
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        .chat-input {
            background: white;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 16px;
            outline: none;
        }

        .send-btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        /* 底部导航栏 */
        .bottom-nav {
            height: 80px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: color 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: #007AFF;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
        }

        .nav-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: #FF3B30;
            color: white;
            border-radius: 10px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* 响应式调整 */
        @media (max-width: 375px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* 加载状态 */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            text-align: center;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- 状态栏 -->
        <div class="status-bar">
            <span>客服管理系统</span>
            <div class="connection-status">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText">已连接</span>
            </div>
        </div>

        <!-- 主内容区域 -->
        <div class="main-content">
            <!-- 首页 -->
            <div class="page active" id="homePage">
                <div class="home-page">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalShops">0</div>
                            <div class="stat-label">管理店铺</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalMessages">0</div>
                            <div class="stat-label">未读消息</div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <h3>快捷操作</h3>
                        <button class="action-btn" onclick="switchPage('messages')">
                            📨 查看消息
                        </button>
                        <button class="action-btn" onclick="switchPage('shops')">
                            🏪 管理店铺
                        </button>
                        <button class="action-btn" onclick="showSettings()">
                            ⚙️ 系统设置
                        </button>
                    </div>
                </div>
            </div>

            <!-- 消息页面 -->
            <div class="page messages-page" id="messagesPage">
                <div class="page-header">
                    <button class="back-btn" onclick="goBack()">‹</button>
                    <div class="page-title" id="messagesTitle">消息</div>
                </div>
                <div class="page-content" id="messagesContent">
                    <div class="loading">正在加载...</div>
                </div>
            </div>

            <!-- 聊天页面 -->
            <div class="page chat-page" id="chatPage">
                <div class="chat-header">
                    <button class="back-btn" onclick="goBack()">‹</button>
                    <div class="page-title" id="chatTitle">聊天</div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="loading">正在加载消息...</div>
                </div>
                <div class="chat-input">
                    <input type="text" class="message-input" id="messageInput" placeholder="输入消息...">
                    <button class="send-btn" onclick="sendMessage()">➤</button>
                </div>
            </div>

            <!-- 店铺页面 -->
            <div class="page" id="shopsPage">
                <div class="page-header">
                    <div class="page-title">店铺管理</div>
                    <button class="refresh-btn" onclick="mobileShopManager.refreshShops()">🔄</button>
                </div>
                
                <!-- 搜索栏 -->
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="shopSearchInput" class="search-input" placeholder="搜索店铺名称或域名...">
                        <div class="search-icon">🔍</div>
                    </div>
                </div>

                <!-- 统计信息 -->
                <div class="shops-stats">
                    <div class="stats-item">
                        <div class="stats-number" id="totalShops">0</div>
                        <div class="stats-label">总店铺数</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-number" id="activeShops">0</div>
                        <div class="stats-label">运行中</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-number" id="pendingShops">0</div>
                        <div class="stats-label">审核中</div>
                    </div>
                </div>

                <!-- 店铺列表容器 -->
                <div class="page-content" id="shopsListContainer">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">正在加载店铺...</div>
                    </div>
                </div>

                <!-- 创建店铺按钮 -->
                <div class="floating-action">
                    <button class="fab-btn" onclick="mobileShopManager.createNewShop()" title="创建新店铺">
                        ➕
                    </button>
                </div>
            </div>

            <!-- 设置页面 -->
            <div class="page" id="settingsPage">
                <div class="page-header">
                    <div class="page-title">设置</div>
                </div>
                <div class="page-content">
                    <div class="loading">正在加载设置...</div>
                </div>
            </div>
        </div>

        <!-- 底部导航栏 -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="home" onclick="switchPage('home')">
                <div class="nav-icon">🏠</div>
                <div class="nav-label">首页</div>
            </div>
            <div class="nav-item" data-page="messages" onclick="switchPage('messages')">
                <div class="nav-icon">💬</div>
                <div class="nav-label">消息</div>
                <div class="nav-badge" id="messagesBadge" style="display: none;">0</div>
            </div>
            <div class="nav-item" data-page="shops" onclick="switchPage('shops')">
                <div class="nav-icon">🏪</div>
                <div class="nav-label">店铺</div>
            </div>
            <div class="nav-item" data-page="settings" onclick="switchPage('settings')">
                <div class="nav-icon">⚙️</div>
                <div class="nav-label">设置</div>
            </div>
        </div>
    </div>

    <script>
        // 全局变量
        let socket = null;
        let currentShops = [];
        let currentConversations = [];
        let currentChatUser = null;
        let currentChatShop = null;
        let pageStack = ['home'];
        let messageCounters = {};
        let totalUnreadCount = 0;

        // 页面管理类
        class PageManager {
            static switchPage(pageName, params = {}) {
                // 隐藏当前页面
                document.querySelectorAll('.page.active').forEach(page => {
                    page.classList.remove('active');
                });

                // 显示目标页面
                const targetPage = document.getElementById(pageName + 'Page');
                if (targetPage) {
                    targetPage.classList.add('active');
                    
                    // 更新导航栏状态
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');

                    // 更新页面栈
                    if (pageStack[pageStack.length - 1] !== pageName) {
                        pageStack.push(pageName);
                    }

                    // 根据页面类型加载数据
                    this.loadPageData(pageName, params);
                }
            }

            static goBack() {
                if (pageStack.length > 1) {
                    pageStack.pop();
                    const previousPage = pageStack[pageStack.length - 1];
                    this.switchPage(previousPage);
                }
            }

            static loadPageData(pageName, params) {
                switch (pageName) {
                    case 'messages':
                        MessageManager.loadShopList();
                        break;
                    case 'chat':
                        MessageManager.loadChatMessages(params.shopId, params.userId);
                        break;
                    case 'shops':
                        ShopManager.loadShops();
                        // 如果存在新的店铺管理器，优先使用
                        if (window.mobileShopManager) {
                            window.mobileShopManager.init();
                        }
                        break;
                    case 'settings':
                        SettingsManager.loadSettings();
                        break;
                }
            }
        }

        // 消息管理类
        class MessageManager {
            static loadShopList() {
                const content = document.getElementById('messagesContent');
                const title = document.getElementById('messagesTitle');
                
                title.textContent = '店铺列表';
                content.innerHTML = '<div class="loading">正在加载店铺...</div>';

                // 模拟加载店铺数据
                setTimeout(() => {
                    if (currentShops.length === 0) {
                        content.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">🏪</div>
                                <div>暂无店铺</div>
                                <small>请先添加店铺</small>
                            </div>
                        `;
                        return;
                    }

                    const shopListHTML = currentShops.map(shop => {
                        const unreadCount = messageCounters[shop.id] || 0;
                        return `
                            <div class="shop-item" onclick="MessageManager.viewShopConversations('${shop.id}')">
                                <div class="shop-avatar">${shop.name.charAt(0)}</div>
                                <div class="shop-info">
                                    <div class="shop-name">${shop.name}</div>
                                    <div class="shop-domain">${shop.domain}</div>
                                </div>
                                ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = `<div class="shop-list">${shopListHTML}</div>`;
                }, 500);
            }

            static viewShopConversations(shopId) {
                const shop = currentShops.find(s => s.id === shopId);
                if (!shop) return;

                const content = document.getElementById('messagesContent');
                const title = document.getElementById('messagesTitle');
                
                title.textContent = shop.name;
                content.innerHTML = '<div class="loading">正在加载对话...</div>';

                // 加载该店铺的用户对话列表
                this.loadConversationsForShop(shopId).then(conversations => {
                    if (conversations.length === 0) {
                        content.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">💬</div>
                                <div>暂无对话</div>
                                <small>等待用户发起对话</small>
                            </div>
                        `;
                        return;
                    }

                    const conversationListHTML = conversations.map(conv => {
                        return `
                            <div class="conversation-item" onclick="MessageManager.openChat('${shopId}', '${conv.userId}')">
                                <div class="user-avatar">${conv.userName.charAt(0)}</div>
                                <div class="conversation-info">
                                    <div class="conversation-meta">
                                        <div class="user-name">${conv.userName}</div>
                                        <div class="message-time">${this.formatTime(conv.lastMessageTime)}</div>
                                    </div>
                                    <div class="last-message">${conv.lastMessage}</div>
                                </div>
                                ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = conversationListHTML;
                });
            }

            static async loadConversationsForShop(shopId) {
                try {
                    const response = await fetch(`/api/shops/${shopId}/conversations`);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.error('加载对话列表失败:', error);
                }
                
                // 返回模拟数据
                return [
                    {
                        userId: 'user_123',
                        userName: '用户123',
                        lastMessage: '你好，我想咨询一下产品信息',
                        lastMessageTime: new Date(),
                        unreadCount: 2
                    }
                ];
            }

            static openChat(shopId, userId) {
                PageManager.switchPage('chat', { shopId, userId });
            }

            static loadChatMessages(shopId, userId) {
                currentChatShop = shopId;
                currentChatUser = userId;
                
                const shop = currentShops.find(s => s.id === shopId);
                const title = document.getElementById('chatTitle');
                const messagesContainer = document.getElementById('chatMessages');
                
                title.textContent = `${shop?.name || '店铺'} - 用户${userId}`;
                messagesContainer.innerHTML = '<div class="loading">正在加载消息...</div>';

                // 加载聊天消息
                this.loadMessages(shopId, userId).then(messages => {
                    this.renderChatMessages(messages);
                });
            }

            static async loadMessages(shopId, userId) {
                try {
                    const response = await fetch(`/api/shops/${shopId}/users/${userId}/messages`);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.error('加载消息失败:', error);
                }

                // 返回模拟数据
                return [
                    {
                        id: '1',
                        content: '你好，我想咨询一下产品信息',
                        sender: 'user',
                        timestamp: new Date(Date.now() - 60000)
                    },
                    {
                        id: '2',
                        content: '您好！请问您想了解哪方面的产品信息呢？',
                        sender: 'admin',
                        timestamp: new Date()
                    }
                ];
            }

            static renderChatMessages(messages) {
                const messagesContainer = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">💭</div>
                            <div>暂无消息</div>
                            <small>开始对话吧</small>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = messages.map(message => {
                    const senderClass = message.sender === 'user' ? 'user' : 'admin';
                    return `
                        <div class="message ${senderClass}">
                            <div class="message-content">${message.content}</div>
                            <div class="message-time">${this.formatTime(message.timestamp)}</div>
                        </div>
                    `;
                }).join('');

                messagesContainer.innerHTML = messagesHTML;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            static formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) { // 小于1分钟
                    return '刚刚';
                } else if (diff < 3600000) { // 小于1小时
                    return `${Math.floor(diff / 60000)}分钟前`;
                } else if (date.toDateString() === now.toDateString()) { // 今天
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                }
            }
        }

        // WebSocket管理类
        class SocketManager {
            static connect() {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                
                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    console.log('WebSocket连接已建立');
                    this.updateConnectionStatus(true);
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('解析WebSocket消息失败:', error);
                    }
                };

                socket.onclose = () => {
                    console.log('WebSocket连接已断开');
                    this.updateConnectionStatus(false);
                    // 5秒后重连
                    setTimeout(() => this.connect(), 5000);
                };

                socket.onerror = (error) => {
                    console.error('WebSocket连接错误:', error);
                    this.updateConnectionStatus(false);
                };
            }

            static handleMessage(data) {
                switch (data.type) {
                    case 'new_message':
                        this.handleNewMessage(data);
                        break;
                    case 'shop_update':
                        this.handleShopUpdate(data);
                        break;
                }
            }

            static handleNewMessage(data) {
                const { shopId, userId, message } = data;
                
                // 更新未读计数
                if (!messageCounters[shopId]) {
                    messageCounters[shopId] = 0;
                }
                messageCounters[shopId]++;
                totalUnreadCount++;

                // 更新UI
                this.updateUnreadBadge();

                // 如果正在查看该对话，实时显示消息
                if (currentChatShop === shopId && currentChatUser === userId) {
                    this.addMessageToChat(message);
                }

                // 播放提示音
                this.playNotificationSound();
            }

            static updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                
                if (connected) {
                    dot.classList.remove('disconnected');
                    text.textContent = '已连接';
                } else {
                    dot.classList.add('disconnected');
                    text.textContent = '未连接';
                }
            }

            static updateUnreadBadge() {
                const badge = document.getElementById('messagesBadge');
                const totalMessages = document.getElementById('totalMessages');
                
                if (totalUnreadCount > 0) {
                    badge.textContent = totalUnreadCount;
                    badge.style.display = 'flex';
                    totalMessages.textContent = totalUnreadCount;
                } else {
                    badge.style.display = 'none';
                    totalMessages.textContent = '0';
                }
            }

            static addMessageToChat(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageHTML = `
                    <div class="message user">
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${MessageManager.formatTime(message.timestamp)}</div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            static playNotificationSound() {
                // 创建音频提示
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQbBzKG0fPTgC4GJWy/7N2QQgsFXsPm7qNbHQU6ltn1x3UsBC9+zPLagTEIGGG57+OZSA0PVKzn77BdGgU1kNn1yHEqBC5zxPTchjEHGGO98+WVPQ0NUqzl766OeRs=' );
                audio.volume = 0.3;
                audio.play().catch(e => console.log('播放提示音失败:', e));
            }
        }

        // 店铺管理类
        class ShopManager {
            static async loadShops() {
                // 使用新的 MobileShopManager
                if (window.mobileShopManager) {
                    await window.mobileShopManager.loadShops();
                    return;
                }
                
                // 后备方案
                try {
                    const response = await fetch('/api/admin/shops');
                    if (response.ok) {
                        currentShops = await response.json();
                        this.updateShopStats();
                        this.renderShopsPage();
                    }
                } catch (error) {
                    console.error('加载店铺失败:', error);
                    // 使用模拟数据
                    currentShops = [
                        {
                            id: 'shop_1',
                            name: '测试店铺',
                            domain: 'bbs13.929991.xyz',
                            status: 'active'
                        }
                    ];
                    this.updateShopStats();
                    this.renderShopsPage();
                }
            }

            static updateShopStats() {
                // 更新首页统计
                document.getElementById('totalShops').textContent = currentShops.length;
                
                // 更新店铺页面统计
                const totalShopsElem = document.getElementById('totalShops');
                const activeShopsElem = document.getElementById('activeShops');
                const pendingShopsElem = document.getElementById('pendingShops');
                
                if (totalShopsElem) totalShopsElem.textContent = currentShops.length;
                
                const activeCount = currentShops.filter(shop => 
                    shop.approvalStatus === 'approved' || shop.approvalStatus === 'active'
                ).length;
                if (activeShopsElem) activeShopsElem.textContent = activeCount;
                
                const pendingCount = currentShops.filter(shop => 
                    shop.approvalStatus === 'pending'
                ).length;
                if (pendingShopsElem) pendingShopsElem.textContent = pendingCount;
            }

            static renderShopsPage() {
                const container = document.getElementById('shopsListContainer');
                if (!container) return;

                if (currentShops.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">🏪</div>
                            <div class="empty-message">暂无店铺</div>
                            <div class="empty-description">您还没有创建任何店铺</div>
                            <button class="create-shop-btn" onclick="window.location.href='/admin'">
                                创建第一个店铺
                            </button>
                        </div>
                    `;
                    return;
                }

                const shopsHTML = currentShops.map(shop => `
                    <div class="shop-card">
                        <div class="shop-header">
                            <div class="shop-avatar">
                                ${shop.name ? shop.name.charAt(0).toUpperCase() : 'S'}
                            </div>
                            <div class="shop-info">
                                <div class="shop-name">${shop.name || '未命名店铺'}</div>
                                <div class="shop-domain">${shop.domain || '未设置域名'}</div>
                                <div class="shop-role">店主</div>
                            </div>
                            <div class="shop-status-badge status-active">
                                运行中
                            </div>
                        </div>
                        
                        <div class="shop-stats">
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">待回复</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">今日对话</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">在线客服</div>
                            </div>
                        </div>

                        <div class="shop-actions">
                            <button class="action-btn btn-primary" onclick="ShopManager.viewMessages('${shop.id}')">
                                💬 查看消息
                            </button>
                            <button class="action-btn btn-secondary" onclick="ShopManager.manageShop('${shop.id}')">
                                ⚙️ 管理店铺
                            </button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="shops-list">
                        ${shopsHTML}
                    </div>
                `;
            }

            static viewMessages(shopId) {
                window.currentChatShop = shopId;
                window.switchPage('messages');
            }

            static manageShop(shopId) {
                console.log('管理店铺:', shopId);
                // 可以跳转到桌面版管理页面
                window.location.href = '/admin';
            }
        }

        // 设置管理类
        class SettingsManager {
            static loadSettings() {
                // 加载设置页面内容
            }
        }

        // 全局函数
        function switchPage(pageName) {
            PageManager.switchPage(pageName);
        }

        function goBack() {
            PageManager.goBack();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatShop || !currentChatUser) return;

            // 发送消息到服务器
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'send_message',
                    shopId: currentChatShop,
                    userId: currentChatUser,
                    message: message
                }));

                // 在界面上显示消息
                const messagesContainer = document.getElementById('chatMessages');
                const messageHTML = `
                    <div class="message admin">
                        <div class="message-content">${message}</div>
                        <div class="message-time">刚刚</div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                input.value = '';
            }
        }

        function showSettings() {
            switchPage('settings');
        }

        // 初始化应用
        document.addEventListener('DOMContentLoaded', function() {
            console.log('手机端客服管理系统启动');
            
            // 加载店铺管理器脚本
            const script = document.createElement('script');
            script.src = '/mobile-shop-manager.js';
            script.onload = function() {
                console.log('店铺管理器脚本加载完成');
                if (window.mobileShopManager) {
                    // 如果当前在店铺页面，初始化店铺管理器
                    const currentPage = document.querySelector('.page.active');
                    if (currentPage && currentPage.id === 'shopsPage') {
                        window.mobileShopManager.init();
                    }
                }
            };
            script.onerror = function() {
                console.warn('店铺管理器脚本加载失败，使用内置管理器');
            };
            document.head.appendChild(script);
            
            // 连接WebSocket
            SocketManager.connect();
            
            // 加载初始数据
            ShopManager.loadShops();
            
            // 设置消息输入框回车发送
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
