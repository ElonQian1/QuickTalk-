<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>å®¢æœç®¡ç†ç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            height: 100vh;
            overflow: hidden;
        }

        /* ä¸»å®¹å™¨ */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .status-bar {
            height: 44px;
            background: #007AFF;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
            position: relative;
        }

        .connection-status {
            position: absolute;
            right: 15px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #34C759;
        }

        .status-dot.disconnected {
            background: #FF3B30;
        }

        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            overflow: hidden;
            position: relative;
        }

        .page {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            overflow-y: auto;
            background: white;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .page.active {
            transform: translateX(0);
        }

        /* é¦–é¡µ */
        .home-page {
            padding: 20px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }

        .stat-number {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 14px;
            opacity: 0.9;
        }

        .quick-actions {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .quick-actions h3 {
            margin-bottom: 15px;
            color: #333;
        }

        .action-btn {
            display: block;
            width: 100%;
            padding: 15px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border: none;
            border-radius: 10px;
            text-align: left;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s;
        }

        .action-btn:hover {
            background: #e9ecef;
        }

        /* æ¶ˆæ¯é¡µé¢ */
        .messages-page {
            display: flex;
            flex-direction: column;
        }

        .page-header {
            height: 60px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #e9ecef;
            position: relative;
        }

        .page-title {
            font-size: 18px;
            font-weight: 600;
            color: #333;
            flex: 1;
            text-align: center;
        }

        .back-btn {
            position: absolute;
            left: 20px;
            background: none;
            border: none;
            font-size: 18px;
            color: #007AFF;
            cursor: pointer;
        }

        .page-content {
            flex: 1;
            overflow-y: auto;
        }

        /* åº—é“ºåˆ—è¡¨ */
        .shop-list {
            padding: 0;
        }

        .search-section {
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
            position: sticky;
            top: 60px;
            z-index: 10;
        }

        .search-box {
            position: relative;
            width: 100%;
        }

        .search-input {
            width: 100%;
            padding: 12px 45px 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 25px;
            font-size: 14px;
            background: #f8f9fa;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: #007AFF;
            background: white;
            box-shadow: 0 0 10px rgba(0, 122, 255, 0.1);
        }

        .search-icon {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }

        .shops-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            padding: 15px 20px;
            background: white;
            border-bottom: 1px solid #f0f0f0;
        }

        .stats-item {
            text-align: center;
            padding: 15px 10px;
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border-radius: 10px;
        }

        .stats-number {
            font-size: 24px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }

        .stats-label {
            font-size: 12px;
            color: #666;
        }

        .shops-list {
            padding: 0;
        }

        .shop-card {
            background: white;
            margin: 10px 20px;
            padding: 20px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            border-left: 4px solid #007AFF;
            transition: all 0.3s ease;
        }

        .shop-card:active {
            transform: scale(0.98);
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
        }

        .shop-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            position: relative;
        }

        .shop-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .shop-item:hover {
            background: #f8f9fa;
        }

        .shop-avatar {
            width: 50px;
            height: 50px;
            border-radius: 25px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 18px;
            margin-right: 15px;
            flex-shrink: 0;
        }

        .shop-info {
            flex: 1;
            min-width: 0;
        }

        .shop-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .shop-domain {
            font-size: 14px;
            color: #666;
            margin-bottom: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .shop-role {
            font-size: 12px;
            color: #007AFF;
            font-weight: 500;
        }

        .shop-status-badge {
            position: absolute;
            top: 0;
            right: 0;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .status-approved, .status-active {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-rejected {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-suspended {
            background: #e2e3e5;
            color: #41464b;
            border: 1px solid #d6d8db;
        }

        .shop-stats {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 15px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-item {
            text-align: center;
        }

        .stat-number {
            font-size: 20px;
            font-weight: bold;
            color: #007AFF;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 11px;
            color: #666;
        }

        .shop-description {
            font-size: 14px;
            color: #666;
            line-height: 1.4;
            margin: 10px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .shop-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 15px;
        }

        .action-btn {
            flex: 1;
            min-width: calc(50% - 4px);
            padding: 10px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }

        .btn-primary {
            background: #007AFF;
            color: white;
        }

        .btn-primary:hover {
            background: #0056CC;
        }

        .btn-secondary {
            background: #6C757D;
            color: white;
        }

        .btn-secondary:hover {
            background: #545B62;
        }

        .btn-success {
            background: #28A745;
            color: white;
        }

        .btn-success:hover {
            background: #1E7E34;
        }

        .btn-warning {
            background: #FFC107;
            color: #212529;
        }

        .btn-warning:hover {
            background: #E0A800;
        }

        .btn-info {
            background: #17A2B8;
            color: white;
        }

        .btn-info:hover {
            background: #117A8B;
        }

        .shop-meta {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e9ecef;
        }

        .shop-created, .shop-updated {
            font-size: 12px;
            color: #868e96;
            margin-bottom: 3px;
        }

        /* åŠ è½½å’ŒçŠ¶æ€æ ·å¼ */
        .loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            color: #666;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007AFF;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            font-size: 14px;
        }

        .error-state, .empty-state, .no-results-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
        }

        .error-icon, .empty-icon, .no-results-icon {
            font-size: 48px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .error-message, .empty-message, .no-results-message {
            font-size: 16px;
            margin-bottom: 10px;
        }

        .empty-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
        }

        .retry-btn, .create-shop-btn {
            background: #007AFF;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .create-shop-btn {
            border-radius: 25px;
            padding: 15px 30px;
            font-size: 16px;
        }

        /* æ‚¬æµ®æŒ‰é’® */
        .floating-action {
            position: fixed;
            bottom: 80px;
            right: 20px;
            z-index: 100;
        }

        .fab-btn {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, #007AFF 0%, #0056CC 100%);
            color: white;
            border: none;
            font-size: 24px;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 20px rgba(0, 122, 255, 0.3);
            transition: all 0.3s ease;
        }

        .fab-btn:hover {
            transform: scale(1.1);
        }

        .refresh-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        /* Toast æ ·å¼ */
        .toast {
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.8);
            color: white;
            padding: 12px 20px;
            border-radius: 25px;
            font-size: 14px;
            z-index: 1000;
            animation: toastShow 0.3s ease;
        }

        .toast-success {
            background: rgba(40, 167, 69, 0.9);
        }

        .toast-error {
            background: rgba(220, 53, 69, 0.9);
        }

        @keyframes toastShow {
            from {
                opacity: 0;
                transform: translateX(-50%) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(-50%) translateY(0);
            }
        }

        .unread-badge {
            background: #FF3B30;
            color: white;
            border-radius: 12px;
            min-width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* ç”¨æˆ·å¯¹è¯åˆ—è¡¨ */
        .conversation-item {
            display: flex;
            align-items: center;
            padding: 15px 20px;
            border-bottom: 1px solid #f0f0f0;
            cursor: pointer;
            transition: background 0.3s;
        }

        .conversation-item:hover {
            background: #f8f9fa;
        }

        .user-avatar {
            width: 45px;
            height: 45px;
            border-radius: 22.5px;
            background: #34C759;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            margin-right: 15px;
        }

        .conversation-info {
            flex: 1;
        }

        .conversation-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 5px;
        }

        .user-name {
            font-size: 16px;
            font-weight: 600;
            color: #333;
        }

        .message-time {
            font-size: 12px;
            color: #666;
        }

        .last-message {
            font-size: 14px;
            color: #666;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        /* èŠå¤©ç•Œé¢ */
        .chat-page {
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            height: 60px;
            background: white;
            display: flex;
            align-items: center;
            padding: 0 20px;
            border-bottom: 1px solid #e9ecef;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
        }

        .message {
            margin-bottom: 15px;
        }

        .message-content {
            max-width: 80%;
            padding: 12px 16px;
            border-radius: 18px;
            font-size: 16px;
            line-height: 1.4;
        }

        .message.user .message-content {
            background: #e9ecef;
            color: #333;
            margin-left: auto;
            border-bottom-right-radius: 5px;
        }

        .message.admin .message-content {
            background: #007AFF;
            color: white;
            margin-right: auto;
            border-bottom-left-radius: 5px;
        }

        .message-time {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }

        .chat-input {
            background: white;
            padding: 15px 20px;
            border-top: 1px solid #e9ecef;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .message-input {
            flex: 1;
            border: 1px solid #ddd;
            border-radius: 25px;
            padding: 10px 15px;
            font-size: 16px;
            outline: none;
        }

        .send-btn {
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 18px;
        }

        /* åº•éƒ¨å¯¼èˆªæ  */
        .bottom-nav {
            height: 80px;
            background: white;
            border-top: 1px solid #e9ecef;
            display: flex;
            justify-content: space-around;
            align-items: center;
            padding: 10px 0;
        }

        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            cursor: pointer;
            transition: color 0.3s;
            position: relative;
        }

        .nav-item.active {
            color: #007AFF;
        }

        .nav-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        .nav-label {
            font-size: 12px;
        }

        .nav-badge {
            position: absolute;
            top: -5px;
            right: -10px;
            background: #FF3B30;
            color: white;
            border-radius: 10px;
            min-width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            font-weight: bold;
        }

        /* å“åº”å¼è°ƒæ•´ */
        @media (max-width: 375px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }

        /* åŠ è½½çŠ¶æ€ */
        .loading {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
        }

        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: #666;
            text-align: center;
        }

        .empty-icon {
            font-size: 48px;
            margin-bottom: 10px;
            opacity: 0.3;
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- çŠ¶æ€æ  -->
        <div class="status-bar">
            <span>å®¢æœç®¡ç†ç³»ç»Ÿ</span>
            <div class="connection-status">
                <div class="status-dot" id="connectionDot"></div>
                <span id="connectionText">å·²è¿æ¥</span>
            </div>
        </div>

        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <div class="main-content">
            <!-- é¦–é¡µ -->
            <div class="page active" id="homePage">
                <div class="home-page">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-number" id="totalShops">0</div>
                            <div class="stat-label">ç®¡ç†åº—é“º</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="totalMessages">0</div>
                            <div class="stat-label">æœªè¯»æ¶ˆæ¯</div>
                        </div>
                    </div>
                    
                    <div class="quick-actions">
                        <h3>å¿«æ·æ“ä½œ</h3>
                        <button class="action-btn" onclick="switchPage('messages')">
                            ğŸ“¨ æŸ¥çœ‹æ¶ˆæ¯
                        </button>
                        <button class="action-btn" onclick="switchPage('shops')">
                            ğŸª ç®¡ç†åº—é“º
                        </button>
                        <button class="action-btn" onclick="showSettings()">
                            âš™ï¸ ç³»ç»Ÿè®¾ç½®
                        </button>
                    </div>
                </div>
            </div>

            <!-- æ¶ˆæ¯é¡µé¢ -->
            <div class="page messages-page" id="messagesPage">
                <div class="page-header">
                    <button class="back-btn" onclick="goBack()">â€¹</button>
                    <div class="page-title" id="messagesTitle">æ¶ˆæ¯</div>
                </div>
                <div class="page-content" id="messagesContent">
                    <div class="loading">æ­£åœ¨åŠ è½½...</div>
                </div>
            </div>

            <!-- èŠå¤©é¡µé¢ -->
            <div class="page chat-page" id="chatPage">
                <div class="chat-header">
                    <button class="back-btn" onclick="goBack()">â€¹</button>
                    <div class="page-title" id="chatTitle">èŠå¤©</div>
                </div>
                <div class="chat-messages" id="chatMessages">
                    <div class="loading">æ­£åœ¨åŠ è½½æ¶ˆæ¯...</div>
                </div>
                <div class="chat-input">
                    <input type="text" class="message-input" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯...">
                    <button class="send-btn" onclick="sendMessage()">â¤</button>
                </div>
            </div>

            <!-- åº—é“ºé¡µé¢ -->
            <div class="page" id="shopsPage">
                <div class="page-header">
                    <div class="page-title">åº—é“ºç®¡ç†</div>
                    <button class="refresh-btn" onclick="mobileShopManager.refreshShops()">ğŸ”„</button>
                </div>
                
                <!-- æœç´¢æ  -->
                <div class="search-section">
                    <div class="search-box">
                        <input type="text" id="shopSearchInput" class="search-input" placeholder="æœç´¢åº—é“ºåç§°æˆ–åŸŸå...">
                        <div class="search-icon">ğŸ”</div>
                    </div>
                </div>

                <!-- ç»Ÿè®¡ä¿¡æ¯ -->
                <div class="shops-stats">
                    <div class="stats-item">
                        <div class="stats-number" id="totalShops">0</div>
                        <div class="stats-label">æ€»åº—é“ºæ•°</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-number" id="activeShops">0</div>
                        <div class="stats-label">è¿è¡Œä¸­</div>
                    </div>
                    <div class="stats-item">
                        <div class="stats-number" id="pendingShops">0</div>
                        <div class="stats-label">å®¡æ ¸ä¸­</div>
                    </div>
                </div>

                <!-- åº—é“ºåˆ—è¡¨å®¹å™¨ -->
                <div class="page-content" id="shopsListContainer">
                    <div class="loading-state">
                        <div class="loading-spinner"></div>
                        <div class="loading-text">æ­£åœ¨åŠ è½½åº—é“º...</div>
                    </div>
                </div>

                <!-- åˆ›å»ºåº—é“ºæŒ‰é’® -->
                <div class="floating-action">
                    <button class="fab-btn" onclick="mobileShopManager.createNewShop()" title="åˆ›å»ºæ–°åº—é“º">
                        â•
                    </button>
                </div>
            </div>

            <!-- è®¾ç½®é¡µé¢ -->
            <div class="page" id="settingsPage">
                <div class="page-header">
                    <div class="page-title">è®¾ç½®</div>
                </div>
                <div class="page-content">
                    <div class="loading">æ­£åœ¨åŠ è½½è®¾ç½®...</div>
                </div>
            </div>
        </div>

        <!-- åº•éƒ¨å¯¼èˆªæ  -->
        <div class="bottom-nav">
            <div class="nav-item active" data-page="home" onclick="switchPage('home')">
                <div class="nav-icon">ğŸ </div>
                <div class="nav-label">é¦–é¡µ</div>
            </div>
            <div class="nav-item" data-page="messages" onclick="switchPage('messages')">
                <div class="nav-icon">ğŸ’¬</div>
                <div class="nav-label">æ¶ˆæ¯</div>
                <div class="nav-badge" id="messagesBadge" style="display: none;">0</div>
            </div>
            <div class="nav-item" data-page="shops" onclick="switchPage('shops')">
                <div class="nav-icon">ğŸª</div>
                <div class="nav-label">åº—é“º</div>
            </div>
            <div class="nav-item" data-page="settings" onclick="switchPage('settings')">
                <div class="nav-icon">âš™ï¸</div>
                <div class="nav-label">è®¾ç½®</div>
            </div>
        </div>
    </div>

    <script>
        // å…¨å±€å˜é‡
        let socket = null;
        let currentShops = [];
        let currentConversations = [];
        let currentChatUser = null;
        let currentChatShop = null;
        let pageStack = ['home'];
        let messageCounters = {};
        let totalUnreadCount = 0;

        // é¡µé¢ç®¡ç†ç±»
        class PageManager {
            static switchPage(pageName, params = {}) {
                // éšè—å½“å‰é¡µé¢
                document.querySelectorAll('.page.active').forEach(page => {
                    page.classList.remove('active');
                });

                // æ˜¾ç¤ºç›®æ ‡é¡µé¢
                const targetPage = document.getElementById(pageName + 'Page');
                if (targetPage) {
                    targetPage.classList.add('active');
                    
                    // æ›´æ–°å¯¼èˆªæ çŠ¶æ€
                    document.querySelectorAll('.nav-item').forEach(item => {
                        item.classList.remove('active');
                    });
                    document.querySelector(`[data-page="${pageName}"]`)?.classList.add('active');

                    // æ›´æ–°é¡µé¢æ ˆ
                    if (pageStack[pageStack.length - 1] !== pageName) {
                        pageStack.push(pageName);
                    }

                    // æ ¹æ®é¡µé¢ç±»å‹åŠ è½½æ•°æ®
                    this.loadPageData(pageName, params);
                }
            }

            static goBack() {
                if (pageStack.length > 1) {
                    pageStack.pop();
                    const previousPage = pageStack[pageStack.length - 1];
                    this.switchPage(previousPage);
                }
            }

            static loadPageData(pageName, params) {
                switch (pageName) {
                    case 'messages':
                        MessageManager.loadShopList();
                        break;
                    case 'chat':
                        MessageManager.loadChatMessages(params.shopId, params.userId);
                        break;
                    case 'shops':
                        ShopManager.loadShops();
                        // å¦‚æœå­˜åœ¨æ–°çš„åº—é“ºç®¡ç†å™¨ï¼Œä¼˜å…ˆä½¿ç”¨
                        if (window.mobileShopManager) {
                            window.mobileShopManager.init();
                        }
                        break;
                    case 'settings':
                        SettingsManager.loadSettings();
                        break;
                }
            }
        }

        // æ¶ˆæ¯ç®¡ç†ç±»
        class MessageManager {
            static loadShopList() {
                const content = document.getElementById('messagesContent');
                const title = document.getElementById('messagesTitle');
                
                title.textContent = 'åº—é“ºåˆ—è¡¨';
                content.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½åº—é“º...</div>';

                // æ¨¡æ‹ŸåŠ è½½åº—é“ºæ•°æ®
                setTimeout(() => {
                    if (currentShops.length === 0) {
                        content.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">ğŸª</div>
                                <div>æš‚æ— åº—é“º</div>
                                <small>è¯·å…ˆæ·»åŠ åº—é“º</small>
                            </div>
                        `;
                        return;
                    }

                    const shopListHTML = currentShops.map(shop => {
                        const unreadCount = messageCounters[shop.id] || 0;
                        return `
                            <div class="shop-item" onclick="MessageManager.viewShopConversations('${shop.id}')">
                                <div class="shop-avatar">${shop.name.charAt(0)}</div>
                                <div class="shop-info">
                                    <div class="shop-name">${shop.name}</div>
                                    <div class="shop-domain">${shop.domain}</div>
                                </div>
                                ${unreadCount > 0 ? `<div class="unread-badge">${unreadCount}</div>` : ''}
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = `<div class="shop-list">${shopListHTML}</div>`;
                }, 500);
            }

            static viewShopConversations(shopId) {
                const shop = currentShops.find(s => s.id === shopId);
                if (!shop) return;

                const content = document.getElementById('messagesContent');
                const title = document.getElementById('messagesTitle');
                
                title.textContent = shop.name;
                content.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½å¯¹è¯...</div>';

                // åŠ è½½è¯¥åº—é“ºçš„ç”¨æˆ·å¯¹è¯åˆ—è¡¨
                this.loadConversationsForShop(shopId).then(conversations => {
                    if (conversations.length === 0) {
                        content.innerHTML = `
                            <div class="empty-state">
                                <div class="empty-icon">ğŸ’¬</div>
                                <div>æš‚æ— å¯¹è¯</div>
                                <small>ç­‰å¾…ç”¨æˆ·å‘èµ·å¯¹è¯</small>
                            </div>
                        `;
                        return;
                    }

                    const conversationListHTML = conversations.map(conv => {
                        return `
                            <div class="conversation-item" onclick="MessageManager.openChat('${shopId}', '${conv.userId}')">
                                <div class="user-avatar">${conv.userName.charAt(0)}</div>
                                <div class="conversation-info">
                                    <div class="conversation-meta">
                                        <div class="user-name">${conv.userName}</div>
                                        <div class="message-time">${this.formatTime(conv.lastMessageTime)}</div>
                                    </div>
                                    <div class="last-message">${conv.lastMessage}</div>
                                </div>
                                ${conv.unreadCount > 0 ? `<div class="unread-badge">${conv.unreadCount}</div>` : ''}
                            </div>
                        `;
                    }).join('');

                    content.innerHTML = conversationListHTML;
                });
            }

            static async loadConversationsForShop(shopId) {
                try {
                    const response = await fetch(`/api/shops/${shopId}/conversations`);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.error('åŠ è½½å¯¹è¯åˆ—è¡¨å¤±è´¥:', error);
                }
                
                // è¿”å›æ¨¡æ‹Ÿæ•°æ®
                return [
                    {
                        userId: 'user_123',
                        userName: 'ç”¨æˆ·123',
                        lastMessage: 'ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹äº§å“ä¿¡æ¯',
                        lastMessageTime: new Date(),
                        unreadCount: 2
                    }
                ];
            }

            static openChat(shopId, userId) {
                PageManager.switchPage('chat', { shopId, userId });
            }

            static loadChatMessages(shopId, userId) {
                currentChatShop = shopId;
                currentChatUser = userId;
                
                const shop = currentShops.find(s => s.id === shopId);
                const title = document.getElementById('chatTitle');
                const messagesContainer = document.getElementById('chatMessages');
                
                title.textContent = `${shop?.name || 'åº—é“º'} - ç”¨æˆ·${userId}`;
                messagesContainer.innerHTML = '<div class="loading">æ­£åœ¨åŠ è½½æ¶ˆæ¯...</div>';

                // åŠ è½½èŠå¤©æ¶ˆæ¯
                this.loadMessages(shopId, userId).then(messages => {
                    this.renderChatMessages(messages);
                });
            }

            static async loadMessages(shopId, userId) {
                try {
                    const response = await fetch(`/api/shops/${shopId}/users/${userId}/messages`);
                    if (response.ok) {
                        return await response.json();
                    }
                } catch (error) {
                    console.error('åŠ è½½æ¶ˆæ¯å¤±è´¥:', error);
                }

                // è¿”å›æ¨¡æ‹Ÿæ•°æ®
                return [
                    {
                        id: '1',
                        content: 'ä½ å¥½ï¼Œæˆ‘æƒ³å’¨è¯¢ä¸€ä¸‹äº§å“ä¿¡æ¯',
                        sender: 'user',
                        timestamp: new Date(Date.now() - 60000)
                    },
                    {
                        id: '2',
                        content: 'æ‚¨å¥½ï¼è¯·é—®æ‚¨æƒ³äº†è§£å“ªæ–¹é¢çš„äº§å“ä¿¡æ¯å‘¢ï¼Ÿ',
                        sender: 'admin',
                        timestamp: new Date()
                    }
                ];
            }

            static renderChatMessages(messages) {
                const messagesContainer = document.getElementById('chatMessages');
                
                if (messages.length === 0) {
                    messagesContainer.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸ’­</div>
                            <div>æš‚æ— æ¶ˆæ¯</div>
                            <small>å¼€å§‹å¯¹è¯å§</small>
                        </div>
                    `;
                    return;
                }

                const messagesHTML = messages.map(message => {
                    const senderClass = message.sender === 'user' ? 'user' : 'admin';
                    return `
                        <div class="message ${senderClass}">
                            <div class="message-content">${message.content}</div>
                            <div class="message-time">${this.formatTime(message.timestamp)}</div>
                        </div>
                    `;
                }).join('');

                messagesContainer.innerHTML = messagesHTML;
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            static formatTime(timestamp) {
                const date = new Date(timestamp);
                const now = new Date();
                const diff = now - date;

                if (diff < 60000) { // å°äº1åˆ†é’Ÿ
                    return 'åˆšåˆš';
                } else if (diff < 3600000) { // å°äº1å°æ—¶
                    return `${Math.floor(diff / 60000)}åˆ†é’Ÿå‰`;
                } else if (date.toDateString() === now.toDateString()) { // ä»Šå¤©
                    return date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });
                }
            }
        }

        // WebSocketç®¡ç†ç±»
        class SocketManager {
            static connect() {
                const wsProtocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
                const wsUrl = `${wsProtocol}//${window.location.host}/ws`;
                
                socket = new WebSocket(wsUrl);

                socket.onopen = () => {
                    console.log('WebSocketè¿æ¥å·²å»ºç«‹');
                    this.updateConnectionStatus(true);
                };

                socket.onmessage = (event) => {
                    try {
                        const data = JSON.parse(event.data);
                        this.handleMessage(data);
                    } catch (error) {
                        console.error('è§£æWebSocketæ¶ˆæ¯å¤±è´¥:', error);
                    }
                };

                socket.onclose = () => {
                    console.log('WebSocketè¿æ¥å·²æ–­å¼€');
                    this.updateConnectionStatus(false);
                    // 5ç§’åé‡è¿
                    setTimeout(() => this.connect(), 5000);
                };

                socket.onerror = (error) => {
                    console.error('WebSocketè¿æ¥é”™è¯¯:', error);
                    this.updateConnectionStatus(false);
                };
            }

            static handleMessage(data) {
                switch (data.type) {
                    case 'new_message':
                        this.handleNewMessage(data);
                        break;
                    case 'shop_update':
                        this.handleShopUpdate(data);
                        break;
                }
            }

            static handleNewMessage(data) {
                const { shopId, userId, message } = data;
                
                // æ›´æ–°æœªè¯»è®¡æ•°
                if (!messageCounters[shopId]) {
                    messageCounters[shopId] = 0;
                }
                messageCounters[shopId]++;
                totalUnreadCount++;

                // æ›´æ–°UI
                this.updateUnreadBadge();

                // å¦‚æœæ­£åœ¨æŸ¥çœ‹è¯¥å¯¹è¯ï¼Œå®æ—¶æ˜¾ç¤ºæ¶ˆæ¯
                if (currentChatShop === shopId && currentChatUser === userId) {
                    this.addMessageToChat(message);
                }

                // æ’­æ”¾æç¤ºéŸ³
                this.playNotificationSound();
            }

            static updateConnectionStatus(connected) {
                const dot = document.getElementById('connectionDot');
                const text = document.getElementById('connectionText');
                
                if (connected) {
                    dot.classList.remove('disconnected');
                    text.textContent = 'å·²è¿æ¥';
                } else {
                    dot.classList.add('disconnected');
                    text.textContent = 'æœªè¿æ¥';
                }
            }

            static updateUnreadBadge() {
                const badge = document.getElementById('messagesBadge');
                const totalMessages = document.getElementById('totalMessages');
                
                if (totalUnreadCount > 0) {
                    badge.textContent = totalUnreadCount;
                    badge.style.display = 'flex';
                    totalMessages.textContent = totalUnreadCount;
                } else {
                    badge.style.display = 'none';
                    totalMessages.textContent = '0';
                }
            }

            static addMessageToChat(message) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageHTML = `
                    <div class="message user">
                        <div class="message-content">${message.content}</div>
                        <div class="message-time">${MessageManager.formatTime(message.timestamp)}</div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            static playNotificationSound() {
                // åˆ›å»ºéŸ³é¢‘æç¤º
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmQbBzKG0fPTgC4GJWy/7N2QQgsFXsPm7qNbHQU6ltn1x3UsBC9+zPLagTEIGGG57+OZSA0PVKzn77BdGgU1kNn1yHEqBC5zxPTchjEHGGO98+WVPQ0NUqzl766OeRs=' );
                audio.volume = 0.3;
                audio.play().catch(e => console.log('æ’­æ”¾æç¤ºéŸ³å¤±è´¥:', e));
            }
        }

        // åº—é“ºç®¡ç†ç±»
        class ShopManager {
            static async loadShops() {
                // ä½¿ç”¨æ–°çš„ MobileShopManager
                if (window.mobileShopManager) {
                    await window.mobileShopManager.loadShops();
                    return;
                }
                
                // åå¤‡æ–¹æ¡ˆ
                try {
                    const response = await fetch('/api/admin/shops');
                    if (response.ok) {
                        currentShops = await response.json();
                        this.updateShopStats();
                        this.renderShopsPage();
                    }
                } catch (error) {
                    console.error('åŠ è½½åº—é“ºå¤±è´¥:', error);
                    // ä½¿ç”¨æ¨¡æ‹Ÿæ•°æ®
                    currentShops = [
                        {
                            id: 'shop_1',
                            name: 'æµ‹è¯•åº—é“º',
                            domain: 'bbs13.929991.xyz',
                            status: 'active'
                        }
                    ];
                    this.updateShopStats();
                    this.renderShopsPage();
                }
            }

            static updateShopStats() {
                // æ›´æ–°é¦–é¡µç»Ÿè®¡
                document.getElementById('totalShops').textContent = currentShops.length;
                
                // æ›´æ–°åº—é“ºé¡µé¢ç»Ÿè®¡
                const totalShopsElem = document.getElementById('totalShops');
                const activeShopsElem = document.getElementById('activeShops');
                const pendingShopsElem = document.getElementById('pendingShops');
                
                if (totalShopsElem) totalShopsElem.textContent = currentShops.length;
                
                const activeCount = currentShops.filter(shop => 
                    shop.approvalStatus === 'approved' || shop.approvalStatus === 'active'
                ).length;
                if (activeShopsElem) activeShopsElem.textContent = activeCount;
                
                const pendingCount = currentShops.filter(shop => 
                    shop.approvalStatus === 'pending'
                ).length;
                if (pendingShopsElem) pendingShopsElem.textContent = pendingCount;
            }

            static renderShopsPage() {
                const container = document.getElementById('shopsListContainer');
                if (!container) return;

                if (currentShops.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-icon">ğŸª</div>
                            <div class="empty-message">æš‚æ— åº—é“º</div>
                            <div class="empty-description">æ‚¨è¿˜æ²¡æœ‰åˆ›å»ºä»»ä½•åº—é“º</div>
                            <button class="create-shop-btn" onclick="window.location.href='/admin'">
                                åˆ›å»ºç¬¬ä¸€ä¸ªåº—é“º
                            </button>
                        </div>
                    `;
                    return;
                }

                const shopsHTML = currentShops.map(shop => `
                    <div class="shop-card">
                        <div class="shop-header">
                            <div class="shop-avatar">
                                ${shop.name ? shop.name.charAt(0).toUpperCase() : 'S'}
                            </div>
                            <div class="shop-info">
                                <div class="shop-name">${shop.name || 'æœªå‘½ååº—é“º'}</div>
                                <div class="shop-domain">${shop.domain || 'æœªè®¾ç½®åŸŸå'}</div>
                                <div class="shop-role">åº—ä¸»</div>
                            </div>
                            <div class="shop-status-badge status-active">
                                è¿è¡Œä¸­
                            </div>
                        </div>
                        
                        <div class="shop-stats">
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">å¾…å›å¤</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">ä»Šæ—¥å¯¹è¯</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">åœ¨çº¿å®¢æœ</div>
                            </div>
                        </div>

                        <div class="shop-actions">
                            <button class="action-btn btn-primary" onclick="ShopManager.viewMessages('${shop.id}')">
                                ğŸ’¬ æŸ¥çœ‹æ¶ˆæ¯
                            </button>
                            <button class="action-btn btn-secondary" onclick="ShopManager.manageShop('${shop.id}')">
                                âš™ï¸ ç®¡ç†åº—é“º
                            </button>
                        </div>
                    </div>
                `).join('');

                container.innerHTML = `
                    <div class="shops-list">
                        ${shopsHTML}
                    </div>
                `;
            }

            static viewMessages(shopId) {
                window.currentChatShop = shopId;
                window.switchPage('messages');
            }

            static manageShop(shopId) {
                console.log('ç®¡ç†åº—é“º:', shopId);
                // å¯ä»¥è·³è½¬åˆ°æ¡Œé¢ç‰ˆç®¡ç†é¡µé¢
                window.location.href = '/admin';
            }
        }

        // è®¾ç½®ç®¡ç†ç±»
        class SettingsManager {
            static loadSettings() {
                // åŠ è½½è®¾ç½®é¡µé¢å†…å®¹
            }
        }

        // å…¨å±€å‡½æ•°
        function switchPage(pageName) {
            PageManager.switchPage(pageName);
        }

        function goBack() {
            PageManager.goBack();
        }

        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (!message || !currentChatShop || !currentChatUser) return;

            // å‘é€æ¶ˆæ¯åˆ°æœåŠ¡å™¨
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({
                    type: 'send_message',
                    shopId: currentChatShop,
                    userId: currentChatUser,
                    message: message
                }));

                // åœ¨ç•Œé¢ä¸Šæ˜¾ç¤ºæ¶ˆæ¯
                const messagesContainer = document.getElementById('chatMessages');
                const messageHTML = `
                    <div class="message admin">
                        <div class="message-content">${message}</div>
                        <div class="message-time">åˆšåˆš</div>
                    </div>
                `;
                messagesContainer.insertAdjacentHTML('beforeend', messageHTML);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;

                input.value = '';
            }
        }

        function showSettings() {
            switchPage('settings');
        }

        // åˆå§‹åŒ–åº”ç”¨
        document.addEventListener('DOMContentLoaded', function() {
            console.log('æ‰‹æœºç«¯å®¢æœç®¡ç†ç³»ç»Ÿå¯åŠ¨');
            
            // åŠ è½½åº—é“ºç®¡ç†å™¨è„šæœ¬
            const script = document.createElement('script');
            script.src = '/mobile-shop-manager.js';
            script.onload = function() {
                console.log('åº—é“ºç®¡ç†å™¨è„šæœ¬åŠ è½½å®Œæˆ');
                if (window.mobileShopManager) {
                    // å¦‚æœå½“å‰åœ¨åº—é“ºé¡µé¢ï¼Œåˆå§‹åŒ–åº—é“ºç®¡ç†å™¨
                    const currentPage = document.querySelector('.page.active');
                    if (currentPage && currentPage.id === 'shopsPage') {
                        window.mobileShopManager.init();
                    }
                }
            };
            script.onerror = function() {
                console.warn('åº—é“ºç®¡ç†å™¨è„šæœ¬åŠ è½½å¤±è´¥ï¼Œä½¿ç”¨å†…ç½®ç®¡ç†å™¨');
            };
            document.head.appendChild(script);
            
            // è¿æ¥WebSocket
            SocketManager.connect();
            
            // åŠ è½½åˆå§‹æ•°æ®
            ShopManager.loadShops();
            
            // è®¾ç½®æ¶ˆæ¯è¾“å…¥æ¡†å›è½¦å‘é€
            document.getElementById('messageInput').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
        });
    </script>
</body>
</html>
