<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åº—é“ºåŠŸèƒ½è¯Šæ–­</title>
    <style>
        body { 
            font-family: monospace; 
            padding: 20px; 
            background: #f5f5f5;
        }
        .diagnostic {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin: 10px 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .step {
            margin: 10px 0;
            padding: 10px;
            border-left: 4px solid #007AFF;
            background: #f8f9fa;
        }
        .success { border-color: #34C759; }
        .error { border-color: #FF3B30; }
        .warning { border-color: #FF9500; }
        button {
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 4px;
            background: #007AFF;
            color: white;
            cursor: pointer;
        }
        button:hover { background: #0056CC; }
        pre {
            background: #f1f1f1;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
            max-height: 300px;
        }
    </style>
</head>
<body>
    <h1>ğŸ” åº—é“ºåŠŸèƒ½è¯Šæ–­å·¥å…·</h1>
    
    <div class="diagnostic">
        <h3>ğŸ“‹ è¯Šæ–­æ­¥éª¤</h3>
        <button onclick="runDiagnostics()">ğŸš€ å¼€å§‹å®Œæ•´è¯Šæ–­</button>
        <button onclick="testLogin()">ğŸ” æµ‹è¯•ç™»å½•</button>
        <button onclick="testAPI()">ğŸ“¡ æµ‹è¯•API</button>
        <button onclick="clearResults()">ğŸ—‘ï¸ æ¸…é™¤ç»“æœ</button>
    </div>

    <div id="results"></div>

    <script>
        let results = [];

        function addResult(message, type = 'info') {
            results.push({
                timestamp: new Date().toLocaleTimeString(),
                message,
                type
            });
            updateDisplay();
        }

        function updateDisplay() {
            const container = document.getElementById('results');
            container.innerHTML = results.map(r => 
                `<div class="step ${r.type}">
                    <strong>[${r.timestamp}]</strong> ${r.message}
                </div>`
            ).join('');
            container.scrollTop = container.scrollHeight;
        }

        function clearResults() {
            results = [];
            updateDisplay();
        }

        async function runDiagnostics() {
            clearResults();
            addResult('ğŸš€ å¼€å§‹åº—é“ºåŠŸèƒ½å®Œæ•´è¯Šæ–­', 'info');
            
            await testLogin();
            await testAPI();
            await testShopManager();
            
            addResult('âœ… è¯Šæ–­å®Œæˆ', 'success');
        }

        async function testLogin() {
            addResult('ğŸ” æµ‹è¯•ç”¨æˆ·ç™»å½•çŠ¶æ€...', 'info');
            
            try {
                // æ£€æŸ¥localStorageä¸­çš„sessionId
                const sessionId = localStorage.getItem('sessionId');
                if (sessionId) {
                    addResult(`âœ… æ‰¾åˆ°sessionId: ${sessionId}`, 'success');
                } else {
                    addResult('âŒ localStorageä¸­æ²¡æœ‰sessionId', 'error');
                }

                // æ£€æŸ¥sessionStorage
                const sessionStorageId = sessionStorage.getItem('currentSessionId');
                if (sessionStorageId) {
                    addResult(`âœ… sessionStorageä¸­çš„sessionId: ${sessionStorageId}`, 'success');
                } else {
                    addResult('âš ï¸ sessionStorageä¸­æ²¡æœ‰sessionId', 'warning');
                }

                // æ£€æŸ¥å…¨å±€å˜é‡
                if (window.sessionId) {
                    addResult(`âœ… å…¨å±€å˜é‡sessionId: ${window.sessionId}`, 'success');
                } else {
                    addResult('âš ï¸ æ²¡æœ‰å…¨å±€sessionIdå˜é‡', 'warning');
                }

                // æµ‹è¯•ç™»å½•API
                const testSessionId = sessionId || sessionStorageId || 'test_session';
                const response = await fetch('/api/user/profile', {
                    headers: { 'X-Session-Id': testSessionId }
                });

                if (response.ok) {
                    const user = await response.json();
                    addResult(`âœ… ç”¨æˆ·è®¤è¯æˆåŠŸ: ${user.username} (${user.role})`, 'success');
                    return testSessionId;
                } else {
                    addResult(`âŒ ç”¨æˆ·è®¤è¯å¤±è´¥: ${response.status}`, 'error');
                    return null;
                }

            } catch (error) {
                addResult(`âŒ ç™»å½•æµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
                return null;
            }
        }

        async function testAPI() {
            addResult('ğŸ“¡ æµ‹è¯•åº—é“ºAPIæ¥å£...', 'info');
            
            const sessionId = localStorage.getItem('sessionId') || 
                              sessionStorage.getItem('currentSessionId') ||
                              'test_session';

            try {
                // æµ‹è¯• /api/admin/shops
                addResult(`ğŸ”„ è¯·æ±‚ /api/admin/shops (sessionId: ${sessionId})`, 'info');
                
                const response = await fetch('/api/admin/shops', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    }
                });

                addResult(`ğŸ“Š APIå“åº”çŠ¶æ€: ${response.status} ${response.statusText}`, 
                         response.ok ? 'success' : 'error');

                if (response.ok) {
                    const shops = await response.json();
                    addResult(`âœ… æˆåŠŸè·å–åº—é“ºæ•°æ®: ${shops.length} ä¸ªåº—é“º`, 'success');
                    
                    if (shops.length > 0) {
                        addResult(`ğŸ“ å‰3ä¸ªåº—é“º: ${shops.slice(0,3).map(s => s.name).join(', ')}`, 'info');
                    }
                    
                    return shops;
                } else {
                    const errorText = await response.text();
                    addResult(`âŒ APIé”™è¯¯å“åº”: ${errorText}`, 'error');
                    return null;
                }

            } catch (error) {
                addResult(`âŒ APIè¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                return null;
            }
        }

        async function testShopManager() {
            addResult('ğŸª æµ‹è¯•ShopManageråŠŸèƒ½...', 'info');
            
            try {
                // æ£€æŸ¥DOMå…ƒç´ 
                const shopsContent = document.getElementById('shopsContent');
                if (shopsContent) {
                    addResult('âœ… æ‰¾åˆ°shopsContentå®¹å™¨', 'success');
                } else {
                    addResult('âŒ æœªæ‰¾åˆ°shopsContentå®¹å™¨', 'error');
                }

                // æ£€æŸ¥ShopManagerç±»
                if (typeof ShopManager !== 'undefined') {
                    addResult('âœ… ShopManagerç±»å­˜åœ¨', 'success');
                    
                    // å°è¯•è°ƒç”¨loadShopsæ–¹æ³•
                    if (typeof ShopManager.loadShops === 'function') {
                        addResult('âœ… ShopManager.loadShopsæ–¹æ³•å­˜åœ¨', 'success');
                    } else {
                        addResult('âŒ ShopManager.loadShopsæ–¹æ³•ä¸å­˜åœ¨', 'error');
                    }
                } else {
                    addResult('âŒ ShopManagerç±»ä¸å­˜åœ¨', 'error');
                }

            } catch (error) {
                addResult(`âŒ ShopManageræµ‹è¯•å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨è¿è¡ŒåŸºç¡€æ£€æŸ¥
        window.addEventListener('DOMContentLoaded', () => {
            addResult('ğŸ”§ è¯Šæ–­å·¥å…·å·²åŠ è½½', 'info');
        });
    </script>
</body>
</html>
