<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†ç«¯èŠå¤©æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .chat-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .chat-header {
            background: #2196F3;
            color: white;
            padding: 15px 20px;
            font-size: 18px;
            font-weight: bold;
        }
        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 20px;
            background: #fafafa;
        }
        .message {
            margin: 10px 0;
            padding: 10px 15px;
            border-radius: 10px;
            max-width: 70%;
            word-wrap: break-word;
        }
        .user-message {
            background: #e3f2fd;
            margin-left: auto;
            text-align: right;
        }
        .admin-message {
            background: #f1f8e9;
            margin-right: auto;
        }
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
            border: 1px solid #ddd;
        }
        .message-text {
            margin-bottom: 8px;
        }
        .image-loading {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            border: 1px dashed #ccc;
            border-radius: 8px;
            color: #666;
        }
        .chat-input {
            padding: 20px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 10px;
        }
        .chat-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        .chat-input button {
            padding: 10px 20px;
            background: #2196F3;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .chat-input button:hover {
            background: #1976D2;
        }
        .file-input {
            display: none;
        }
        .file-button {
            padding: 10px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        .file-button:hover {
            background: #45a049;
        }
        .debug-panel {
            margin: 20px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }
        .debug-log {
            max-height: 200px;
            overflow-y: auto;
            background: #f1f1f1;
            padding: 10px;
            font-family: monospace;
            font-size: 12px;
            border-radius: 3px;
        }
    </style>
</head>
<body>
    <h1>ğŸ› ï¸ ç®¡ç†ç«¯èŠå¤©æµ‹è¯•</h1>
    
    <!-- è°ƒè¯•é¢æ¿ -->
    <div class="debug-panel">
        <h3>è°ƒè¯•ä¿¡æ¯</h3>
        <div>
            <strong>ä¼šè¯ID:</strong> <span id="conversationId">shop_1757591780450_1_user_test123_1757000000000</span>
            <button onclick="generateNewConversation()">ç”Ÿæˆæ–°ä¼šè¯</button>
        </div>
        <div style="margin-top: 10px;">
            <strong>è¿æ¥çŠ¶æ€:</strong> <span id="connectionStatus">æœªè¿æ¥</span>
            <button onclick="testConnection()">æµ‹è¯•è¿æ¥</button>
        </div>
        <div style="margin-top: 10px;">
            <strong>è°ƒè¯•æ—¥å¿—:</strong>
            <button onclick="clearDebugLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>
        <div id="debugLog" class="debug-log"></div>
    </div>
    
    <!-- èŠå¤©ç•Œé¢ -->
    <div class="chat-container">
        <div class="chat-header">
            ğŸ“± å®¢æœèŠå¤© - å›¾ç‰‡æ¶ˆæ¯æµ‹è¯•
        </div>
        <div id="chatMessages" class="chat-messages">
            <div class="message admin-message">
                <div class="message-text">æ¬¢è¿ä½¿ç”¨ç®¡ç†ç«¯èŠå¤©æµ‹è¯•ï¼æ‚¨å¯ä»¥å‘é€æ–‡å­—å’Œå›¾ç‰‡æ¶ˆæ¯ã€‚</div>
            </div>
        </div>
        <div class="chat-input">
            <input type="file" id="fileInput" class="file-input" accept="image/*" onchange="handleFileSelect(event)">
            <button class="file-button" onclick="document.getElementById('fileInput').click()">ğŸ“ å›¾ç‰‡</button>
            <input type="text" id="messageInput" placeholder="è¾“å…¥æ¶ˆæ¯..." onkeypress="handleKeyPress(event)">
            <button onclick="sendTextMessage()">å‘é€</button>
        </div>
    </div>

    <script>
        let conversationId = 'shop_1757591780450_1_user_test123_1757000000000';
        
        function debugLog(message) {
            const debugLogDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            debugLogDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            debugLogDiv.scrollTop = debugLogDiv.scrollHeight;
            console.log(message);
        }
        
        function clearDebugLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        function generateNewConversation() {
            const timestamp = Date.now();
            const userRandom = Math.random().toString(36).substr(2, 9);
            conversationId = `shop_1757591780450_1_user_${userRandom}_${timestamp}`;
            document.getElementById('conversationId').textContent = conversationId;
            debugLog(`ç”Ÿæˆæ–°ä¼šè¯ID: ${conversationId}`);
        }
        
        function testConnection() {
            debugLog('æµ‹è¯•æœåŠ¡å™¨è¿æ¥...');
            fetch('/api/shops')
                .then(response => {
                    if (response.ok) {
                        document.getElementById('connectionStatus').textContent = 'è¿æ¥æ­£å¸¸';
                        debugLog('âœ… æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                    } else {
                        document.getElementById('connectionStatus').textContent = 'è¿æ¥å¼‚å¸¸';
                        debugLog(`âŒ æœåŠ¡å™¨å“åº”å¼‚å¸¸: ${response.status}`);
                    }
                })
                .catch(error => {
                    document.getElementById('connectionStatus').textContent = 'è¿æ¥å¤±è´¥';
                    debugLog(`âŒ è¿æ¥å¤±è´¥: ${error.message}`);
                });
        }
        
        function addMessage(content, type = 'admin', isImage = false, fileId = null) {
            const chatMessages = document.getElementById('chatMessages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            if (isImage && fileId) {
                // æ·»åŠ å›¾ç‰‡æ¶ˆæ¯
                debugLog(`æ·»åŠ å›¾ç‰‡æ¶ˆæ¯, fileId: ${fileId}`);
                
                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = content || '[å›¾ç‰‡]';
                messageDiv.appendChild(textDiv);
                
                const loadingDiv = document.createElement('div');
                loadingDiv.className = 'image-loading';
                loadingDiv.textContent = 'å›¾ç‰‡åŠ è½½ä¸­...';
                messageDiv.appendChild(loadingDiv);
                
                // è·å–å›¾ç‰‡URL
                fetch(`/api/files/${fileId}?info=true`)
                    .then(response => response.json())
                    .then(result => {
                        debugLog(`å›¾ç‰‡ä¿¡æ¯å“åº”: ${JSON.stringify(result)}`);
                        if (result.success && result.file && result.file.url) {
                            const img = document.createElement('img');
                            img.className = 'message-image';
                            img.src = result.file.url;
                            img.alt = 'å›¾ç‰‡æ¶ˆæ¯';
                            img.onclick = () => window.open(result.file.url, '_blank');
                            
                            img.onload = () => {
                                loadingDiv.style.display = 'none';
                                messageDiv.appendChild(img);
                                debugLog('âœ… å›¾ç‰‡åŠ è½½æˆåŠŸ');
                            };
                            
                            img.onerror = () => {
                                loadingDiv.textContent = 'å›¾ç‰‡åŠ è½½å¤±è´¥';
                                debugLog('âŒ å›¾ç‰‡åŠ è½½å¤±è´¥');
                            };
                        } else {
                            loadingDiv.textContent = 'å›¾ç‰‡ä¿¡æ¯è·å–å¤±è´¥';
                            debugLog('âŒ å›¾ç‰‡ä¿¡æ¯è·å–å¤±è´¥');
                        }
                    })
                    .catch(error => {
                        loadingDiv.textContent = 'å›¾ç‰‡åŠ è½½å¼‚å¸¸';
                        debugLog(`âŒ å›¾ç‰‡åŠ è½½å¼‚å¸¸: ${error.message}`);
                    });
            } else {
                // æ·»åŠ æ–‡æœ¬æ¶ˆæ¯
                const textDiv = document.createElement('div');
                textDiv.className = 'message-text';
                textDiv.textContent = content;
                messageDiv.appendChild(textDiv);
            }
            
            chatMessages.appendChild(messageDiv);
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
        
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendTextMessage();
            }
        }
        
        function sendTextMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            if (!message) return;
            
            debugLog(`å‘é€æ–‡æœ¬æ¶ˆæ¯: ${message}`);
            addMessage(message, 'admin');
            input.value = '';
            
            // è¿™é‡Œå¯ä»¥æ·»åŠ å®é™…çš„æ¶ˆæ¯å‘é€é€»è¾‘
            debugLog('ğŸ“¤ æ–‡æœ¬æ¶ˆæ¯å·²æ·»åŠ åˆ°ç•Œé¢');
        }
        
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            debugLog(`é€‰æ‹©æ–‡ä»¶: ${file.name}, å¤§å°: ${file.size} bytes`);
            
            // ä¸Šä¼ æ–‡ä»¶
            uploadAndSendImage(file);
        }
        
        async function uploadAndSendImage(file) {
            try {
                debugLog('å¼€å§‹ä¸Šä¼ å›¾ç‰‡...');
                
                // å…ˆä¸Šä¼ åˆ°æ–‡ä»¶ç³»ç»Ÿ
                const formData = new FormData();
                formData.append('file', file); // ä¿®æ­£å­—æ®µåä¸º 'file'
                
                const uploadResponse = await fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const uploadResult = await uploadResponse.json();
                debugLog(`æ–‡ä»¶ä¸Šä¼ å“åº”: ${JSON.stringify(uploadResult)}`);
                
                if (!uploadResult.success) {
                    throw new Error(uploadResult.error || 'æ–‡ä»¶ä¸Šä¼ å¤±è´¥');
                }
                
                // FileUploadAPI è¿”å›çš„æ˜¯å•ä¸ªæ–‡ä»¶å¯¹è±¡ï¼Œä¸æ˜¯æ•°ç»„
                const fileId = uploadResult.file.id;
                debugLog(`æ–‡ä»¶ä¸Šä¼ æˆåŠŸ, fileId: ${fileId}`);
                
                // å‘é€å›¾ç‰‡æ¶ˆæ¯
                const messageData = {
                    fileId: fileId,
                    messageType: 'image',
                    content: '[å›¾ç‰‡]'
                };
                
                debugLog(`å‘é€å›¾ç‰‡æ¶ˆæ¯: ${JSON.stringify(messageData)}`);
                
                const messageResponse = await fetch(`/api/conversations/${conversationId}/messages/media`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });
                
                const messageResult = await messageResponse.json();
                debugLog(`å›¾ç‰‡æ¶ˆæ¯å“åº”: ${JSON.stringify(messageResult)}`);
                
                if (messageResult.success) {
                    addMessage('[å›¾ç‰‡]', 'admin', true, fileId);
                    debugLog('âœ… å›¾ç‰‡æ¶ˆæ¯å‘é€æˆåŠŸ');
                } else {
                    throw new Error(messageResult.error || 'å›¾ç‰‡æ¶ˆæ¯å‘é€å¤±è´¥');
                }
                
            } catch (error) {
                debugLog(`âŒ å›¾ç‰‡å‘é€å¤±è´¥: ${error.message}`);
                alert(`å›¾ç‰‡å‘é€å¤±è´¥: ${error.message}`);
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.onload = function() {
            debugLog('ç®¡ç†ç«¯èŠå¤©æµ‹è¯•é¡µé¢å·²åŠ è½½');
            testConnection();
        };
    </script>
</body>
</html>