<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é«˜çº§é€šçŸ¥ç³»ç»Ÿæ¼”ç¤º - QuickTalkå®¢æœç³»ç»Ÿ</title>
    <link rel="stylesheet" href="/css/notification-manager.css">
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }

        .demo-header {
            background: linear-gradient(135deg, #007bff, #6610f2);
            color: white;
            padding: 2rem 0;
            text-align: center;
        }

        .demo-header h1 {
            margin: 0;
            font-size: 2.5rem;
        }

        .demo-header p {
            margin: 0.5rem 0 0 0;
            opacity: 0.9;
        }

        .demo-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }

        .demo-info {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .demo-info h3 {
            margin-top: 0;
            color: #333;
        }

        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .feature-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 6px;
            border-left: 4px solid #007bff;
        }

        .feature-item h4 {
            margin: 0 0 0.5rem 0;
            color: #333;
        }

        .feature-item p {
            margin: 0;
            color: #666;
            font-size: 0.9rem;
        }

        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-online { background-color: #28a745; }
        .status-offline { background-color: #dc3545; }
        .status-connecting { background-color: #ffc107; }

        .demo-actions {
            background: white;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }

        .demo-actions h3 {
            margin-top: 0;
            color: #333;
        }

        .action-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            margin-top: 1rem;
        }

        .demo-log {
            background: #2d3748;
            color: #a0aec0;
            border-radius: 8px;
            padding: 1rem;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1rem;
        }

        .log-entry {
            margin: 0.5rem 0;
            padding: 0.25rem 0;
        }

        .log-timestamp {
            color: #63b3ed;
        }

        .log-level-info { color: #68d391; }
        .log-level-warn { color: #fbd38d; }
        .log-level-error { color: #fc8181; }
    </style>
</head>
<body>
    <div class="demo-header">
        <h1>ğŸ“¡ é«˜çº§é€šçŸ¥ç³»ç»Ÿæ¼”ç¤º</h1>
        <p>å¤šæ¸ é“å®æ—¶é€šçŸ¥æ¨é€ç³»ç»Ÿ - æ”¯æŒWebSocketã€é‚®ä»¶ã€çŸ­ä¿¡ã€æ¨é€ç­‰å¤šç§æ–¹å¼</p>
    </div>

    <div class="demo-container">
        <!-- ç³»ç»Ÿä»‹ç» -->
        <div class="demo-info">
            <h3>ğŸš€ ç³»ç»Ÿç‰¹æ€§</h3>
            <div class="feature-grid">
                <div class="feature-item">
                    <h4>ğŸ”Œ å®æ—¶é€šçŸ¥</h4>
                    <p>åŸºäºWebSocketçš„å®æ—¶é€šçŸ¥æ¨é€ï¼Œæ”¯æŒå³æ—¶æ¶ˆæ¯ä¼ é€’</p>
                </div>
                <div class="feature-item">
                    <h4>ğŸ“± å¤šæ¸ é“æ”¯æŒ</h4>
                    <p>æ”¯æŒWebSocketã€é‚®ä»¶ã€çŸ­ä¿¡ã€æ¨é€ç­‰å¤šç§é€šçŸ¥æ¸ é“</p>
                </div>
                <div class="feature-item">
                    <h4>ğŸ¨ æ¨¡æ¿ç®¡ç†</h4>
                    <p>çµæ´»çš„é€šçŸ¥æ¨¡æ¿ç³»ç»Ÿï¼Œæ”¯æŒå˜é‡æ›¿æ¢å’Œå¤šæ ·åŒ–å†…å®¹</p>
                </div>
                <div class="feature-item">
                    <h4>ğŸ“Š ç»Ÿè®¡åˆ†æ</h4>
                    <p>è¯¦ç»†çš„å‘é€ç»Ÿè®¡å’ŒæˆåŠŸç‡åˆ†æï¼Œæ”¯æŒå¤šç»´åº¦æ•°æ®å±•ç¤º</p>
                </div>
                <div class="feature-item">
                    <h4>â° å®šæ—¶å‘é€</h4>
                    <p>æ”¯æŒå®šæ—¶é€šçŸ¥å‘é€ï¼Œçµæ´»çš„è°ƒåº¦æœºåˆ¶</p>
                </div>
                <div class="feature-item">
                    <h4>ğŸ” è®¢é˜…ç®¡ç†</h4>
                    <p>ç”¨æˆ·å¯è‡ªå®šä¹‰è®¢é˜…åå¥½ï¼Œç²¾å‡†æ¨é€ç›¸å…³å†…å®¹</p>
                </div>
            </div>
        </div>

        <!-- æ¼”ç¤ºæ“ä½œ -->
        <div class="demo-actions">
            <h3>ğŸ® æ¼”ç¤ºæ“ä½œ</h3>
            <p>è¿æ¥çŠ¶æ€: <span class="status-indicator status-connecting" id="connection-status"></span><span id="connection-text">è¿æ¥ä¸­...</span></p>
            
            <div class="action-buttons">
                <button class="btn btn-primary" onclick="sendWelcomeNotification()">å‘é€æ¬¢è¿é€šçŸ¥</button>
                <button class="btn btn-info" onclick="sendMessageNotification()">å‘é€æ¶ˆæ¯é€šçŸ¥</button>
                <button class="btn btn-warning" onclick="sendSystemNotification()">å‘é€ç³»ç»Ÿé€šçŸ¥</button>
                <button class="btn btn-secondary" onclick="loadNotificationStats()">æŸ¥çœ‹ç»Ÿè®¡æ•°æ®</button>
                <button class="btn btn-primary" onclick="createSampleTemplate()">åˆ›å»ºç¤ºä¾‹æ¨¡æ¿</button>
                <button class="btn btn-info" onclick="testAllChannels()">æµ‹è¯•æ‰€æœ‰æ¸ é“</button>
            </div>

            <div class="demo-log" id="demo-log">
                <div class="log-entry">
                    <span class="log-timestamp">[00:00:00]</span>
                    <span class="log-level-info">[INFO]</span>
                    é«˜çº§é€šçŸ¥ç³»ç»Ÿæ¼”ç¤ºå·²å¯åŠ¨
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥ç®¡ç†å™¨ -->
        <div id="notification-manager-container">
            <!-- é€šçŸ¥ç®¡ç†å™¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
    </div>

    <script src="/js/notification-manager.js"></script>
    <script>
        let wsConnection = null;
        let isConnected = false;

        // åˆå§‹åŒ–WebSocketè¿æ¥
        function initializeWebSocket() {
            try {
                wsConnection = new WebSocket(`ws://${window.location.host}/ws`);
                
                wsConnection.onopen = function() {
                    isConnected = true;
                    updateConnectionStatus('online', 'å·²è¿æ¥');
                    addLogEntry('WebSocketè¿æ¥å·²å»ºç«‹', 'info');
                };
                
                wsConnection.onmessage = function(event) {
                    try {
                        const data = JSON.parse(event.data);
                        addLogEntry(`æ”¶åˆ°æ¶ˆæ¯: ${data.type}`, 'info');
                        
                        if (data.type === 'notification') {
                            displayReceivedNotification(data);
                        }
                    } catch (error) {
                        addLogEntry(`æ¶ˆæ¯è§£æå¤±è´¥: ${error.message}`, 'error');
                    }
                };
                
                wsConnection.onclose = function() {
                    isConnected = false;
                    updateConnectionStatus('offline', 'è¿æ¥æ–­å¼€');
                    addLogEntry('WebSocketè¿æ¥å·²æ–­å¼€', 'warn');
                    
                    // é‡è¿é€»è¾‘
                    setTimeout(() => {
                        addLogEntry('æ­£åœ¨å°è¯•é‡è¿...', 'info');
                        initializeWebSocket();
                    }, 5000);
                };
                
                wsConnection.onerror = function(error) {
                    addLogEntry(`WebSocketé”™è¯¯: ${error}`, 'error');
                };
                
            } catch (error) {
                addLogEntry(`è¿æ¥å¤±è´¥: ${error.message}`, 'error');
                updateConnectionStatus('offline', 'è¿æ¥å¤±è´¥');
            }
        }

        // æ›´æ–°è¿æ¥çŠ¶æ€
        function updateConnectionStatus(status, text) {
            const statusIndicator = document.getElementById('connection-status');
            const statusText = document.getElementById('connection-text');
            
            statusIndicator.className = `status-indicator status-${status}`;
            statusText.textContent = text;
        }

        // æ·»åŠ æ—¥å¿—æ¡ç›®
        function addLogEntry(message, level = 'info') {
            const logContainer = document.getElementById('demo-log');
            const timestamp = new Date().toLocaleTimeString();
            
            const logEntry = document.createElement('div');
            logEntry.className = 'log-entry';
            logEntry.innerHTML = `
                <span class="log-timestamp">[${timestamp}]</span>
                <span class="log-level-${level}">[${level.toUpperCase()}]</span>
                ${message}
            `;
            
            logContainer.appendChild(logEntry);
            logContainer.scrollTop = logContainer.scrollHeight;
        }

        // å‘é€APIè¯·æ±‚
        async function sendApiRequest(url, data = {}) {
            try {
                addLogEntry(`å‘é€è¯·æ±‚: ${url}`, 'info');
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    addLogEntry(`è¯·æ±‚æˆåŠŸ: ${result.message || 'æ“ä½œå®Œæˆ'}`, 'info');
                } else {
                    addLogEntry(`è¯·æ±‚å¤±è´¥: ${result.error}`, 'error');
                }
                
                return result;
                
            } catch (error) {
                addLogEntry(`è¯·æ±‚å¼‚å¸¸: ${error.message}`, 'error');
                throw error;
            }
        }

        // å‘é€æ¬¢è¿é€šçŸ¥
        async function sendWelcomeNotification() {
            await sendApiRequest('/api/notifications/send', {
                shopId: 'demo_shop',
                userId: 'demo_user',
                title: 'æ¬¢è¿æ¥åˆ°QuickTalkå®¢æœç³»ç»Ÿ',
                message: 'æ¬¢è¿æ‚¨ä½¿ç”¨æˆ‘ä»¬çš„é«˜çº§é€šçŸ¥ç³»ç»Ÿï¼è¿™æ˜¯ä¸€æ¡æ¬¢è¿æ¶ˆæ¯ç¤ºä¾‹ã€‚',
                type: 'welcome',
                priority: 'normal',
                channels: ['websocket', 'push'],
                metadata: {
                    source: 'demo',
                    category: 'welcome'
                }
            });
        }

        // å‘é€æ¶ˆæ¯é€šçŸ¥
        async function sendMessageNotification() {
            await sendApiRequest('/api/notifications/send', {
                shopId: 'demo_shop',
                userId: 'demo_user',
                title: 'æ‚¨æœ‰æ–°æ¶ˆæ¯',
                message: 'å®¢æœä»£è¡¨å‘æ‚¨å‘é€äº†æ–°æ¶ˆæ¯ï¼Œè¯·åŠæ—¶æŸ¥çœ‹å›å¤ã€‚',
                type: 'message',
                priority: 'high',
                channels: ['websocket', 'email'],
                metadata: {
                    source: 'demo',
                    category: 'message',
                    messageId: 'msg_' + Date.now()
                }
            });
        }

        // å‘é€ç³»ç»Ÿé€šçŸ¥
        async function sendSystemNotification() {
            await sendApiRequest('/api/notifications/send', {
                title: 'ç³»ç»Ÿç»´æŠ¤é€šçŸ¥',
                message: 'ç³»ç»Ÿå°†äºä»Šæ™š23:00-01:00è¿›è¡Œç»´æŠ¤å‡çº§ï¼ŒæœŸé—´å¯èƒ½æš‚åœæœåŠ¡ï¼Œè¯·æ‚¨æå‰åšå¥½å‡†å¤‡ã€‚',
                type: 'system',
                priority: 'urgent',
                channels: ['websocket', 'email', 'push'],
                metadata: {
                    source: 'demo',
                    category: 'maintenance'
                }
            });
        }

        // æŸ¥çœ‹ç»Ÿè®¡æ•°æ®
        async function loadNotificationStats() {
            try {
                addLogEntry('æ­£åœ¨è·å–ç»Ÿè®¡æ•°æ®...', 'info');
                
                const response = await fetch('/api/notifications/stats/demo_shop');
                const result = await response.json();
                
                if (result.success) {
                    const stats = result.stats;
                    addLogEntry(`ç»Ÿè®¡æ•°æ® - å·²å‘é€: ${stats.totalStats.sent}, æˆåŠŸç‡: ${stats.totalStats.successRate}`, 'info');
                    addLogEntry(`é˜Ÿåˆ—çŠ¶æ€ - å¾…å¤„ç†: ${stats.queueStatus.pending}`, 'info');
                } else {
                    addLogEntry(`è·å–ç»Ÿè®¡å¤±è´¥: ${result.error}`, 'error');
                }
                
            } catch (error) {
                addLogEntry(`è·å–ç»Ÿè®¡å¼‚å¸¸: ${error.message}`, 'error');
            }
        }

        // åˆ›å»ºç¤ºä¾‹æ¨¡æ¿
        async function createSampleTemplate() {
            await sendApiRequest('/api/notifications/templates', {
                shopId: 'demo_shop',
                name: 'è®¢å•çŠ¶æ€æ›´æ–°',
                title: 'æ‚¨çš„è®¢å•{{orderNumber}}çŠ¶æ€å·²æ›´æ–°',
                content: 'å°Šæ•¬çš„{{customerName}}ï¼Œæ‚¨çš„è®¢å•{{orderNumber}}çŠ¶æ€å·²æ›´æ–°ä¸º{{status}}ï¼Œé¢„è®¡{{deliveryTime}}é€è¾¾ã€‚',
                type: 'order',
                channels: ['websocket', 'email', 'sms'],
                variables: ['orderNumber', 'customerName', 'status', 'deliveryTime'],
                createdBy: 'demo_admin'
            });
        }

        // æµ‹è¯•æ‰€æœ‰æ¸ é“
        async function testAllChannels() {
            const channels = ['websocket', 'email', 'push', 'sms'];
            
            for (let i = 0; i < channels.length; i++) {
                const channel = channels[i];
                await sendApiRequest('/api/notifications/send', {
                    shopId: 'demo_shop',
                    userId: 'demo_user',
                    title: `${channel.toUpperCase()}é€šé“æµ‹è¯•`,
                    message: `è¿™æ˜¯${channel}é€šé“çš„æµ‹è¯•æ¶ˆæ¯ï¼Œæµ‹è¯•æ—¶é—´ï¼š${new Date().toLocaleString()}`,
                    type: 'test',
                    priority: 'normal',
                    channels: [channel],
                    metadata: {
                        source: 'demo',
                        testChannel: channel
                    }
                });
                
                // é—´éš”å‘é€
                if (i < channels.length - 1) {
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
            }
        }

        // æ˜¾ç¤ºæ”¶åˆ°çš„é€šçŸ¥
        function displayReceivedNotification(notification) {
            addLogEntry(`æ”¶åˆ°é€šçŸ¥: ${notification.title}`, 'info');
            
            // åˆ›å»ºé€šçŸ¥æ˜¾ç¤ºå…ƒç´ 
            const notificationDiv = document.createElement('div');
            notificationDiv.className = 'notification-demo-item';
            notificationDiv.style.cssText = `
                background: #e3f2fd;
                border: 1px solid #2196f3;
                border-radius: 4px;
                padding: 10px;
                margin: 5px 0;
                position: relative;
            `;
            
            notificationDiv.innerHTML = `
                <strong>${notification.title}</strong><br>
                <span style="color: #666;">${notification.message}</span><br>
                <small style="color: #999;">ç±»å‹: ${notification.notificationType} | ä¼˜å…ˆçº§: ${notification.priority}</small>
            `;
            
            // æ·»åŠ åˆ°æ—¥å¿—å‰é¢
            const logContainer = document.getElementById('demo-log');
            logContainer.insertBefore(notificationDiv, logContainer.firstChild);
            
            // 3ç§’åç§»é™¤
            setTimeout(() => {
                if (notificationDiv.parentElement) {
                    notificationDiv.remove();
                }
            }, 3000);
        }

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            addLogEntry('é¡µé¢åŠ è½½å®Œæˆ', 'info');
            
            // åˆå§‹åŒ–WebSocketè¿æ¥
            setTimeout(() => {
                initializeWebSocket();
            }, 1000);
            
            // å»¶è¿ŸåŠ è½½é€šçŸ¥ç®¡ç†å™¨
            setTimeout(() => {
                addLogEntry('é€šçŸ¥ç®¡ç†å™¨UIå·²åŠ è½½', 'info');
            }, 2000);
        });
    </script>
</body>
</html>