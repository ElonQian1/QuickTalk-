<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>网站首页 - 在线客服演示</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header>
        <h1>欢迎来到我们的网站</h1>
        <nav>
            <ul>
                <li><a href="#home">首页</a></li>
                <li><a href="#products">产品</a></li>
                <li><a href="#about">关于我们</a></li>
                <li><a href="#contact">联系我们</a></li>
            </ul>
        </nav>
    </header>

    <main>
        <section id="home">
            <h2>这是一个演示页面</h2>
            <p>这里演示了网页客服系统的功能。当您需要帮助时，可以点击右下角的客服按钮与我们的客服人员进行实时对话。</p>
            
            <div class="content">
                <h3>我们的服务</h3>
                <ul>
                    <li>24小时在线客服支持</li>
                    <li>专业的技术咨询</li>
                    <li>快速响应客户需求</li>
                    <li>多渠道沟通方式</li>
                </ul>
            </div>
        </section>
    </main>

    <!-- 客服按钮 -->
    <div id="customer-service-btn" class="customer-service-btn" onclick="toggleChat()">
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M20 2H4C2.9 2 2 2.9 2 4V22L6 18H20C21.1 18 22 17.1 22 16V4C22 2.9 21.1 2 20 2ZM20 16H5.17L4 17.17V4H20V16Z" fill="white"/>
            <path d="M7 9H17V11H7V9ZM7 12H15V14H7V12Z" fill="white"/>
        </svg>
        <span>客服</span>
    </div>

    <!-- 聊天窗口 -->
    <div id="chat-window" class="chat-window">
        <div class="chat-header">
            <h3>在线客服</h3>
            <div class="chat-controls">
                <button id="minimize-btn" onclick="minimizeChat()">−</button>
                <button id="close-btn" onclick="closeChat()">×</button>
            </div>
        </div>
        <div class="chat-body">
            <div id="chat-messages" class="chat-messages">
                <div class="message system-message">
                    <span class="message-text">欢迎使用在线客服，请问有什么可以帮助您的吗？</span>
                    <span class="message-time"></span>
                </div>
            </div>
            <div class="chat-input-container">
                <input type="text" id="chat-input" placeholder="请输入您的消息..." onkeypress="handleKeyPress(event)">
                <button id="send-btn" onclick="sendMessage()">发送</button>
            </div>
        </div>
        <div class="connection-status">
            <span id="status-indicator" class="status-disconnected"></span>
            <span id="status-text">连接中...</span>
        </div>
    </div>

    <!-- QuickTalk SDK 模块 -->
    <script src="js/core/models.js"></script>
    <script src="js/protocol/inbound-adapter.js"></script>
    <script src="js/transport/websocket-client.js"></script>
    <script src="js/core/message-router.js"></script>
    <script src="js/app/mobile-app.js"></script>
    <script src="js/compat/mobile-message-manager-compat.js"></script>
    <script src="js/core/state/state-store.js"></script>
    <script src="js/ui/templates/message-item.js"></script>
    
    <script>
    // 初始化客服系统
    let chatApp, messageManager;
    let isConnected = false;
    
    function toggleChat() {
        const chatWindow = document.getElementById('chat-window');
        chatWindow.style.display = chatWindow.style.display === 'flex' ? 'none' : 'flex';
        
        // 初始化连接
        if (!isConnected) {
            initializeCustomerService();
        }
    }
    
    function closeChat() {
        document.getElementById('chat-window').style.display = 'none';
    }
    
    function minimizeChat() {
        // 最小化逻辑
        closeChat();
    }
    
    function initializeCustomerService() {
        if (typeof QuickTalk === 'undefined') {
            console.error('QuickTalk SDK not loaded');
            return;
        }
        
        // 初始化应用
        chatApp = new QuickTalk.MobileApp();
        chatApp.init();
        
        // 监听消息
        chatApp.on('message.appended', (message) => {
            console.log('[客户端] 收到消息:', message);
            
            // 只显示管理员发送的消息
            if (message.senderType === 'agent') {
                addMessageToUI(message.content, 'received');
            }
        });
        
        // 更新连接状态
        updateStatus('已连接', true);
        isConnected = true;
    }
    
    function sendMessage() {
        const input = document.getElementById('chat-input');
        const message = input.value.trim();
        
        if (!message) return;
        
        // 添加到UI
        addMessageToUI(message, 'sent');
        
        // 发送消息
        if (chatApp && chatApp.wsClient) {
            chatApp.wsClient.send({
                type: 'customer_message',
                shop_id: '7426828f-cc70-4ed8-b25c-5e6d1802b9ea',
                content: message,
                timestamp: new Date().toISOString()
            });
        }
        
        input.value = '';
    }
    
    function handleKeyPress(event) {
        if (event.key === 'Enter') {
            sendMessage();
        }
    }
    
    function addMessageToUI(content, type) {
        const messagesContainer = document.getElementById('chat-messages');
        const messageDiv = document.createElement('div');
        messageDiv.className = `message ${type === 'sent' ? 'user-message' : 'received-message'}`;
        
        messageDiv.innerHTML = `
            <span class="message-text">${content}</span>
            <span class="message-time">${new Date().toLocaleTimeString()}</span>
        `;
        
        messagesContainer.appendChild(messageDiv);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
    }
    
    function updateStatus(text, connected) {
        document.getElementById('status-text').textContent = text;
        document.getElementById('status-indicator').className = 
            connected ? 'status-connected' : 'status-disconnected';
    }
    </script>
</body>
</html>
