<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width,            👆 <strong>点击</strong>：打开客服聊天nitial-scale=1.0">
    <title>本地测试页面 - 模拟朋友网站</title>
    <style>
        body {
            margin: 0;
            padding: 20px;
            background: #f0f2f5;
            font-family: Arial, sans-serif;
            min-height: 100vh;
        }
        
        .test-info {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-info h1 {
            color: #333;
            margin-top: 0;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
        }
        
        .success {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        
        .warning {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
        }
        
        .error {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        
        .main-content {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            text-align: center;
            min-height: 400px;
        }
        
        .main-content h2 {
            color: #666;
        }
        
        .main-content p {
            color: #999;
            line-height: 1.6;
        }
        
        .test-buttons {
            margin: 20px 0;
        }
        
        .test-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 0 10px;
            font-size: 14px;
        }
        
        .test-btn:hover {
            background: #0056b3;
        }
    </style>
</head>
<body>
    <div class="test-info">
        <h1>🧪 本地测试页面 - 模拟朋友网站环境</h1>
        
        <div class="status success">
            ✅ <strong>后端服务器：</strong> http://localhost:3030 (已启动)
        </div>
        
        <div class="status warning" id="connection-status">
            ⏳ <strong>客服连接：</strong> 正在检测...
        </div>
        
        <div class="status success">
            ✅ <strong>管理后台：</strong> <a href="http://localhost:3030/admin" target="_blank">http://localhost:3030/admin</a>
        </div>
        
        <p><strong>测试说明：</strong></p>
        <ul>
            <li>这个页面完全模拟您朋友的网站环境</li>
            <li>使用相同的客服代码结构</li>
            <li>直接连接到您的本地服务器 localhost:3030</li>
            <li>测试通过后，只需要替换为ngrok地址即可用于朋友网站</li>
        </ul>
    </div>
    
    <div class="main-content">
        <h2>模拟网站内容区域</h2>
        <p>这里是模拟的网站主要内容...</p>
        <p>这个页面完全复制了您朋友网站的客服代码结构</p>
        
        <div class="test-buttons">
            <button class="test-btn" onclick="testConnection()">测试连接</button>
            <button class="test-btn" onclick="openAdmin()">打开管理后台</button>
            <button class="test-btn" onclick="testChat()">强制打开客服</button>
        </div>
        
        <p style="margin-top: 40px;">
            👇 <strong>客服按钮在右下角</strong> 👇<br>
            🖱️ <strong>悬停</strong>：显示微信二维码<br>
            🖱️ <strong>点击</strong>：打开在线聊天
        </p>
    </div>

    <!-- 
    ============================================
    以下是完全复制的朋友网站客服代码
    ============================================ 
    -->
    
    <style>
    .viewport-nav{outline:#000;position:fixed;right:40px;bottom:40px;z-index:999999}
    .viewport-nav .nav-box{background:rgba(0,0,0,.8);border-radius:100%;text-align:center;margin:15px 0;width:100px;height:100px;line-height:100px;box-shadow:0 0 5px 2px rgba(255,255,255,.5)}
    .viewport-nav .nav-box p{padding:0 1px;font-size:31px;color:#fff;white-space:normal;font-weight:700}
    .viewport-nav .nav-box#cb{position:relative;cursor:pointer}
    .viewport-nav .nav-box .nav-dabaowei,.viewport-nav .nav-box .nav-sxsx{font-size:24px}

    /* 新增客服聊天窗口样式 */
    .cs-chat{position:fixed;bottom:160px;right:40px;width:380px;height:520px;background:white;border-radius:15px;box-shadow:0 10px 30px rgba(0,0,0,0.3);display:none;flex-direction:column;z-index:999998;overflow:hidden;transform:scale(0);transform-origin:bottom right;transition:all 0.3s ease;font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif}
    .cs-chat.open{display:flex;transform:scale(1)}
    .cs-chat.mini{height:60px}
    .cs-chat.mini .cs-body,.cs-chat.mini .cs-input,.cs-chat.mini .cs-status{display:none}
    .cs-header{background:linear-gradient(135deg,#667eea 0%,#764ba2 100%);color:white;padding:15px 20px;display:flex;justify-content:space-between;align-items:center}
    .cs-header h3{font-size:16px;font-weight:600;margin:0}
    .cs-controls{display:flex;gap:10px}
    .cs-controls button{background:rgba(255,255,255,0.2);border:none;color:white;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px;display:flex;align-items:center;justify-content:center}
    .cs-body{flex:1;padding:20px;overflow-y:auto;background:#fafbfc}
    .cs-msg{margin-bottom:15px;display:flex;flex-direction:column}
    .cs-msg-text{padding:12px 16px;border-radius:18px;max-width:80%;word-wrap:break-word;line-height:1.4}
    .cs-msg-time{font-size:11px;color:#999;margin-top:5px}
    .cs-system .cs-msg-text{background:#f0f0f0;color:#666;align-self:center;text-align:center;font-size:13px}
    .cs-user{align-items:flex-end}
    .cs-user .cs-msg-text{background:#667eea;color:white;align-self:flex-end}
    .cs-user .cs-msg-time{text-align:right}
    .cs-staff{align-items:flex-start}
    .cs-staff .cs-msg-text{background:#f8f9fa;color:#333;border:1px solid #e9ecef;align-self:flex-start}
    .cs-input{padding:15px 20px;border-top:1px solid #eee;display:flex;gap:10px;background:white}
    .cs-input input{flex:1;padding:10px 15px;border:1px solid #ddd;border-radius:20px;outline:none;font-size:14px}
    .cs-input button{background:#667eea;color:white;border:none;padding:10px 20px;border-radius:20px;cursor:pointer;font-weight:600}
    .cs-status{padding:8px 20px;background:#f8f9fa;border-top:1px solid #eee;display:flex;align-items:center;gap:8px;font-size:12px}
    .cs-dot{width:8px;height:8px;border-radius:50%;display:inline-block}
    .cs-connected{background:#28a745;animation:pulse 2s infinite}
    .cs-disconnected{background:#dc3545}
    @keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
    @media (max-width:768px){.cs-chat{width:calc(100vw - 20px);right:10px;left:10px}}
    </style>

    <div class="viewport-nav">
        <ul>
            <li><div class="nav-box"><p>登入</p></div></li>
            <li><div class="nav-box"><p>注册</p></div></li>
            <li>
                <div class="nav-box animate__animated animate__backInLeft" id="cb">
                    <a><p class="animate__animated animate__infinite animate__heartBeat">客服</p></a>
                </div>
            </li>
            <li><div class="nav-box"><p>优惠</p></div></li>
        </ul>
    </div>

    <!-- 新增客服聊天窗口 -->
    <div class="cs-chat" id="cs-chat">
        <div class="cs-header">
            <h3>在线客服</h3>
            <div class="cs-controls">
                <button onclick="miniCS()">−</button>
                <button onclick="closeCS()">×</button>
            </div>
        </div>
        <div class="cs-body" id="cs-body">
            <div class="cs-msg cs-system">
                <span class="cs-msg-text">欢迎使用在线客服，请问有什么可以帮助您的吗？</span>
                <span class="cs-msg-time" id="welcome-time"></span>
            </div>
        </div>
        <div class="cs-input">
            <input type="text" id="cs-input" placeholder="请输入您的消息..." onkeypress="if(event.key==='Enter')sendCS()">
            <button onclick="sendCS()">发送</button>
        </div>
        <div class="cs-status">
            <span class="cs-dot" id="cs-dot"></span>
            <span id="cs-status">连接中...</span>
        </div>
    </div>

    <script>
    (function(){
        // 🔥 重要：本地测试使用 localhost，朋友网站需要改为 ngrok 地址
        const SERVER_URL = 'http://localhost:3030'; // 本地测试地址
        
        let cs = {
            isOpen: false,
            isMini: false,
            isConnected: false,
            userId: 'test_user_' + Math.random().toString(36).substr(2,9) + '_' + Date.now(),
            interval: null,
            lastId: 0,
            
            init() {
                this.updateTime();
                setTimeout(() => this.connect(), 1000);
            },
            
            async connect() {
                try {
                    console.log('🔗 尝试连接到服务器:', SERVER_URL);
                    const res = await fetch(`${SERVER_URL}/api/connect`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({userId: this.userId, timestamp: Date.now()})
                    });
                    
                    if (res.ok) {
                        this.isConnected = true;
                        this.updateStatus('connected', '已连接');
                        this.startPoll();
                        console.log('✅ 客服连接成功');
                        this.updatePageStatus('success', '✅ 客服连接：已成功连接到本地服务器');
                    } else {
                        throw new Error('连接失败');
                    }
                } catch (e) {
                    console.error('❌ 客服连接失败:', e);
                    this.updateStatus('disconnected', '连接失败');
                    this.updatePageStatus('error', '❌ 客服连接：连接失败 - ' + e.message);
                    setTimeout(() => this.connect(), 5000);
                }
            },
            
            updatePageStatus(type, text) {
                const statusEl = document.getElementById('connection-status');
                if (statusEl) {
                    statusEl.className = `status ${type}`;
                    statusEl.innerHTML = text;
                }
            },
            
            startPoll() {
                if (this.interval) clearInterval(this.interval);
                this.interval = setInterval(() => this.checkMsg(), 2000);
            },
            
            async checkMsg() {
                if (!this.isConnected) return;
                try {
                    const res = await fetch(`${SERVER_URL}/api/messages?userId=${this.userId}&lastId=${this.lastId}`);
                    if (res.ok) {
                        const data = await res.json();
                        if (data.messages && data.messages.length > 0) {
                            data.messages.forEach(msg => {
                                this.handleMsg(msg);
                                this.lastId = Math.max(this.lastId, msg.id || 0);
                            });
                        }
                    }
                } catch (e) {
                    console.error('获取消息失败:', e);
                    this.isConnected = false;
                    this.updateStatus('disconnected', '连接断开');
                    this.updatePageStatus('warning', '⚠️ 客服连接：连接断开，正在重连...');
                    setTimeout(() => this.connect(), 3000);
                }
            },
            
            handleMsg(msg) {
                if (msg.type === 'staff_message') {
                    this.addMsg('staff', msg.message);
                } else if (msg.type === 'system_notification') {
                    this.addMsg('system', msg.message);
                }
            },
            
            addMsg(type, text) {
                const body = document.getElementById('cs-body');
                const div = document.createElement('div');
                div.className = `cs-msg cs-${type}`;
                div.innerHTML = `
                    <span class="cs-msg-text">${text}</span>
                    <span class="cs-msg-time">${new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'})}</span>
                `;
                body.appendChild(div);
                body.scrollTop = body.scrollHeight;
            },
            
            async send() {
                const input = document.getElementById('cs-input');
                const msg = input.value.trim();
                if (!msg) return;
                
                if (!this.isConnected) {
                    this.addMsg('system', '连接断开，无法发送消息');
                    return;
                }
                
                this.addMsg('user', msg);
                input.value = '';
                
                try {
                    await fetch(`${SERVER_URL}/api/send`, {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({userId: this.userId, message: msg, timestamp: Date.now()})
                    });
                } catch (e) {
                    this.addMsg('system', '发送失败，请重试');
                }
            },
            
            updateStatus(status, text) {
                document.getElementById('cs-dot').className = `cs-dot cs-${status}`;
                document.getElementById('cs-status').textContent = text;
            },
            
            updateTime() {
                const time = document.getElementById('welcome-time');
                if (time) time.textContent = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
            },
            
            toggle() {
                if (this.isOpen) this.close(); else this.open();
            },
            
            open() {
                const chat = document.getElementById('cs-chat');
                chat.classList.add('open');
                chat.classList.remove('mini');
                this.isOpen = true;
                this.isMini = false;
                document.getElementById('cs-input').focus();
                if (this.isConnected && !this.interval) this.startPoll();
            },
            
            close() {
                const chat = document.getElementById('cs-chat');
                chat.classList.remove('open', 'mini');
                this.isOpen = false;
                this.isMini = false;
                if (this.interval) {
                    clearInterval(this.interval);
                    this.interval = null;
                }
            },
            
            minimize() {
                const chat = document.getElementById('cs-chat');
                if (this.isMini) {
                    chat.classList.remove('mini');
                    this.isMini = false;
                    document.getElementById('cs-input').focus();
                } else {
                    chat.classList.add('mini');
                    this.isMini = true;
                }
            }
        };
        
        // 全局函数
        window.toggleCS = () => cs.toggle();
        window.closeCS = () => cs.close();
        window.miniCS = () => cs.minimize();
        window.sendCS = () => cs.send();
        
        // 测试函数
        window.testConnection = () => {
            cs.connect();
        };
        
        window.openAdmin = () => {
            window.open('http://localhost:3030/admin', '_blank');
        };
        
        window.testChat = () => {
            cs.open();
        };
        
        // 客服按钮点击事件
        const cbBtn = document.querySelector('#cb');
        
        if (cbBtn) {
            // 点击客服按钮打开聊天窗口
            cbBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                cs.toggle(); // 打开聊天窗口
            });
        }
        
        // 初始化
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', () => setTimeout(() => cs.init(), 1000));
        } else {
            setTimeout(() => cs.init(), 1000);
        }
        
        // 清理
        window.addEventListener('beforeunload', () => {
            if (cs.interval) clearInterval(cs.interval);
        });
    })();
    </script>
</body>
</html>
