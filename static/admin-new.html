<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÂÆ¢ÊúçÁÆ°ÁêÜÁ≥ªÁªü - Â§öÂ∫óÈì∫ÁÆ°ÁêÜ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ÁôªÂΩïÁïåÈù¢ */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .login-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            width: 100%;
            max-width: 400px;
        }
        
        .login-header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .login-header p {
            color: #666;
            font-size: 14px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-group select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
            background: white;
            appearance: none;
            background-image: url('data:image/svg+xml;utf8,<svg fill="%23333" height="24" viewBox="0 0 24 24" width="24" xmlns="http://www.w3.org/2000/svg"><path d="M7 10l5 5 5-5z"/></svg>');
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            cursor: pointer;
        }
        
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .btn {
            width: 100%;
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .error-message {
            background: #fee;
            color: #c33;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #c33;
        }
        
        .success-message {
            background: #efe;
            color: #393;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            border-left: 4px solid #393;
        }
        
        /* ‰∏ªÁïåÈù¢ */
        .main-container {
            display: none;
        }
        
        .header {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header h1 {
            color: #333;
            margin: 0;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .user-badge {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
        }
        
        .user-badge:hover {
            background: linear-gradient(135deg, #5a6fd8 0%, #6a4190 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }
        
        .promotion-btn {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .promotion-btn:hover {
            background: linear-gradient(135deg, #ff5252 0%, #e53935 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }
        
        .logout-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .create-shop-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
        }
        
        .create-shop-btn:hover {
            background: #218838;
        }
        
        .shops-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .shop-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            transition: transform 0.3s;
        }
        
        .shop-card:hover {
            transform: translateY(-5px);
        }
        
        .shop-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .shop-name {
            font-size: 18px;
            font-weight: 700;
            color: #333;
            margin: 0;
        }
        
        .shop-role {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .shop-role.role-owner {
            background: #4caf50;
            color: white;
        }
        
        .shop-role.role-manager {
            background: #ff9800;
            color: white;
        }
        
        .shop-role.role-employee {
            background: #2196f3;
            color: white;
        }

        .shop-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-pending {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.8; }
            100% { opacity: 1; }
        }

        .status-approved {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
            color: white;
        }

        .status-rejected {
            background: linear-gradient(135deg, #f44336, #c62828);
            color: white;
        }

        .shop-domain {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .shop-description {
            color: #888;
            font-size: 13px;
            margin-bottom: 15px;
            line-height: 1.4;
        }
        
        .shop-stats {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }
        
        .stat-item {
            text-align: center;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: 700;
            color: #667eea;
        }
        
        .stat-label {
            font-size: 12px;
            color: #666;
        }
        
        .shop-actions {
            display: flex;
            gap: 10px;
        }
        
        .action-btn {
            padding: 8px 15px;
            border-radius: 8px;
            border: none;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-success {
            background: #28a745;
            color: white;
        }
        
        .create-shop {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        
        .create-shop h3 {
            margin-bottom: 20px;
            color: #333;
        }
        
        .create-shop-form {
            display: flex;
            gap: 15px;
            align-items: end;
        }
        
        .create-shop-form .form-group {
            flex: 1;
            margin-bottom: 0;
        }
        
        .messages-panel {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .messages-header {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .messages-header h3 {
            margin: 0;
            color: #333;
        }
        
        .messages-body {
            padding: 20px;
            min-height: 400px;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px;
            color: #666;
        }
        
        /* Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }
        
        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 500px;
            max-height: 90vh;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px 25px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-header h3 {
            margin: 0;
            color: #333;
        }
        
        .close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #aaa;
        }
        
        .close:hover {
            color: #333;
        }
        
        .modal-form {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
            max-height: calc(90vh - 140px);
        }
        
        .modal-buttons {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            padding: 20px 25px;
            border-top: 1px solid #eee;
            background: white;
            border-radius: 0 0 15px 15px;
        }
        
        .btn-secondary {
            background: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-warning {
            background: linear-gradient(135deg, #ff9800, #f57c00);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-warning:hover {
            background: linear-gradient(135deg, #f57c00, #ef6c00);
            transform: translateY(-2px);
        }

        .btn-info {
            background: linear-gradient(135deg, #17a2b8, #138496);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-info:hover {
            background: linear-gradient(135deg, #138496, #0f6674);
            transform: translateY(-2px);
        }

        .btn-success {
            background: linear-gradient(135deg, #28a745, #20c997);
            color: white;
            border: none;
            transition: all 0.3s ease;
        }

        .btn-success:hover {
            background: linear-gradient(135deg, #20c997, #17a2b8);
            transform: translateY(-2px);
        }
        
        /* Êé®ÂπøÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .promotion-content {
            max-width: 600px;
        }
        
        .promotion-section {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
            border-left: 4px solid #ff6b6b;
        }
        
        .promotion-section h4 {
            margin: 0 0 15px 0;
            color: #333;
            font-size: 18px;
        }
        
        .reward-info {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        
        .reward-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .reward-icon {
            font-size: 24px;
            flex-shrink: 0;
        }
        
        .reward-item strong {
            color: #ff6b6b;
            font-size: 16px;
        }
        
        .reward-item p {
            margin: 5px 0 0 0;
            color: #666;
            font-size: 14px;
            line-height: 1.4;
        }
        
        .link-container {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
        }
        
        .promotion-link-input {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-family: monospace;
            background: white;
            font-size: 14px;
        }
        
        .copy-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        
        .copy-btn:hover {
            background: #218838;
        }
        
        .link-tip {
            color: #666;
            font-size: 14px;
            margin: 0;
            font-style: italic;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            text-align: center;
            padding: 20px;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
            color: #ff6b6b;
            margin-bottom: 5px;
        }
        
        .stat-label {
            color: #666;
            font-size: 14px;
        }
        
        /* ‰ª∑Ê†ºË°®Ê†∑Âºè */
        .price-table-container {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .price-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .price-table thead {
            background: linear-gradient(135deg, #ff6b6b, #ee5a52);
            color: white;
        }
        
        .price-table th,
        .price-table td {
            padding: 12px 8px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }
        
        .price-table th {
            font-weight: 600;
            font-size: 13px;
        }
        
        .price-table tbody tr:hover {
            background: #f8f9fa;
        }
        
        .price-table .total-price {
            font-weight: bold;
            color: #ff6b6b;
        }
        
        .price-table .savings {
            color: #28a745;
            font-weight: 500;
        }
        
        /* ‰ª∑Ê†ºËÆ°ÁÆóÂô®Ê†∑Âºè */
        .price-calculator {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .calculator-input {
            margin-bottom: 20px;
        }
        
        .calculator-input label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .input-group {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        #quantityInput {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            text-align: center;
            max-width: 200px;
        }
        
        #quantityInput:focus {
            border-color: #ff6b6b;
            outline: none;
        }
        
        .input-unit {
            color: #666;
            font-weight: 500;
        }
        
        .calculator-keypad {
            margin-bottom: 20px;
        }
        
        .keypad-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            max-width: 240px;
            margin: 0 auto;
        }
        
        .key-btn {
            padding: 12px;
            border: 2px solid #ddd;
            background: white;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .key-btn:hover {
            background: #f8f9fa;
            border-color: #ff6b6b;
        }
        
        .key-btn:active {
            transform: scale(0.95);
        }
        
        .key-clear {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }
        
        .key-clear:hover {
            background: #c82333;
        }
        
        .key-backspace {
            background: #ffc107;
            border-color: #ffc107;
        }
        
        .key-backspace:hover {
            background: #e0a800;
        }
        
        .calculator-result {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border: 2px solid #dee2e6;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-label {
            font-weight: 500;
            color: #333;
        }
        
        .result-value {
            font-weight: bold;
            font-size: 16px;
            color: #495057;
        }
        
        .result-item.total-price .result-value {
            color: #ff6b6b;
            font-size: 20px;
        }
        
        .result-item.savings .result-value {
            color: #28a745;
        }
        
        .share-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .share-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            flex: 1;
            min-width: 140px;
        }
        
        .share-btn:hover {
            background: #0056b3;
        }
        
        /* Â∫óÈì∫ÁÆ°ÁêÜÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .manage-modal {
            max-width: 800px;
            width: 95%;
        }
        
        .modal-body {
            padding: 0;
        }
        
        .tab-nav {
            display: flex;
            border-bottom: 1px solid #eee;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px 20px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            color: #666;
            transition: all 0.3s;
        }
        
        .tab-btn.active {
            background: white;
            color: #333;
            border-bottom: 2px solid #007bff;
        }
        
        .tab-btn:hover {
            background: #e9ecef;
        }
        
        .tab-content {
            display: none;
            padding: 25px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-header h4 {
            margin: 0;
            color: #333;
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .add-employee-form {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        
        .add-employee-form h5 {
            margin: 0 0 15px 0;
            color: #333;
        }

        .employee-help-text {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            border-radius: 6px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .employee-help-text p {
            margin: 0 0 10px 0;
            color: #1565c0;
            font-size: 14px;
        }

        .employee-help-text ul {
            margin: 0 0 10px 20px;
            padding: 0;
        }

        .employee-help-text li {
            margin-bottom: 5px;
            color: #424242;
            font-size: 13px;
        }
        
        .form-row {
            display: flex;
            gap: 15px;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .form-buttons {
            display: flex;
            gap: 10px;
            justify-content: flex-end;
            margin-top: 15px;
        }
        
        .form-buttons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        
        .form-buttons button[type="button"] {
            background: #6c757d;
            color: white;
        }
        
        .form-buttons button[type="submit"] {
            background: #007bff;
            color: white;
        }
        
        .employees-list {
            min-height: 200px;
        }
        
        .employee-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
        }
        
        .employee-info h6 {
            margin: 0 0 5px 0;
            color: #333;
        }

        .employee-role {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 5px;
        }

        .role-badge {
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .role-employee {
            background: #e3f2fd;
            color: #1976d2;
        }

        .role-manager {
            background: #fff3e0;
            color: #f57c00;
        }
        
        .role-owner {
            background: #e8f5e8;
            color: #4caf50;
        }

        .role-permissions {
            font-size: 11px;
            color: #666;
        }
        
        .role-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .employee-actions .role-badge {
            background: #f5f5f5;
            color: #666;
            border: 1px solid #ddd;
        }

        .employee-info small {
            color: #666;
        }
        
        .employee-actions {
            display: flex;
            gap: 10px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .hidden {
            display: none !important;
        }
        
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .create-shop-form {
                flex-direction: column;
            }
            
            .shop-stats {
                justify-content: center;
            }
            
            .shop-actions {
                justify-content: center;
            }
        }
        
        /* ============ Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊ†∑Âºè ============ */
        
        .admin-panel-btn {
            background: linear-gradient(135deg, #ff6b6b, #ee5a24);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }
        
        .admin-panel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 107, 107, 0.3);
        }

        .review-panel-btn {
            background: linear-gradient(135deg, #74b9ff, #0984e3);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
        }

        .review-panel-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.3);
        }
        
        .admin-modal {
            max-width: 1000px;
            width: 95%;
            max-height: 90vh;
        }
        
        .admin-section {
            margin-bottom: 30px;
        }
        
        .admin-section h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .search-box {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        
        .search-box input {
            flex: 1;
            padding: 8px 12px;
            border: 2px solid #e1e5e9;
            border-radius: 6px;
            font-size: 14px;
        }
        
        .search-box input:focus {
            border-color: #667eea;
            outline: none;
        }
        
        .owners-list {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .owner-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
            transition: all 0.3s ease;
        }
        
        .owner-item:hover {
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            transform: translateY(-2px);
        }
        
        .owner-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .owner-info h5 {
            margin: 0;
            color: #333;
            font-size: 16px;
        }
        
        .owner-info p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .owner-actions {
            display: flex;
            gap: 10px;
        }
        
        .owner-actions .btn {
            padding: 6px 12px;
            font-size: 12px;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:hover {
            background: #c0392b;
        }
        
        .btn-warning {
            background: #f39c12;
            color: white;
        }
        
        .btn-warning:hover {
            background: #e67e22;
        }
        
        .btn-success {
            background: #27ae60;
            color: white;
        }
        
        .btn-success:hover {
            background: #229954;
        }
        
        .owner-shops {
            margin-top: 15px;
        }
        
        .owner-shops h6 {
            margin: 0 0 10px 0;
            color: #333;
            font-size: 14px;
        }
        
        .shops-list {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        
        .shop-tag {
            background: #667eea;
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .shops-monitor {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .shop-monitor-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .shop-monitor-info h6 {
            margin: 0;
            color: #333;
        }
        
        .shop-monitor-info p {
            margin: 5px 0;
            color: #666;
            font-size: 14px;
        }
        
        .shop-status {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }
        
        .status-active {
            background: #d4edda;
            color: #155724;
        }
        
        .status-suspended {
            background: #f8d7da;
            color: #721c24;
        }
        
        .owner-details-modal {
            max-width: 800px;
        }
        
        .detail-section {
            margin-bottom: 20px;
        }
        
        .detail-section h5 {
            margin: 0 0 10px 0;
            color: #333;
            border-bottom: 1px solid #e1e5e9;
            padding-bottom: 5px;
        }
        
        .member-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }
        
        .member-tag {
            background: #f8f9fa;
            border: 1px solid #e1e5e9;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            color: #666;
        }

        /* ============ ÂÆ°Ê†∏ÁÆ°ÁêÜÈù¢ÊùøÊ†∑Âºè ============ */
        
        .pending-shops-container {
            max-height: 500px;
            overflow-y: auto;
        }

        .pending-shop-item {
            background: white;
            border: 1px solid #e1e5e9;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .pending-shop-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .pending-shop-info h5 {
            margin: 0 0 5px 0;
            color: #333;
            font-size: 18px;
        }

        .pending-shop-info .domain {
            color: #666;
            font-size: 14px;
            margin-bottom: 8px;
        }

        .pending-shop-info .description {
            color: #888;
            font-size: 13px;
            line-height: 1.4;
            background: #f8f9fa;
            padding: 10px;
            border-radius: 6px;
        }

        .pending-shop-meta {
            display: flex;
            gap: 15px;
            margin: 10px 0;
            font-size: 12px;
            color: #666;
        }

        .pending-shop-actions {
            display: flex;
            gap: 10px;
        }

        .review-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .review-approve {
            background: #00b894;
            color: white;
        }

        .review-approve:hover {
            background: #00a085;
            transform: translateY(-1px);
        }

        .review-reject {
            background: #d63031;
            color: white;
        }

        .review-reject:hover {
            background: #c92a2a;
            transform: translateY(-1px);
        }

        .empty-pending {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .empty-pending i {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
        }

        /* ÊªöÂä®Êù°Ê†∑Âºè */
        .modal-body::-webkit-scrollbar,
        .tab-content::-webkit-scrollbar,
        .modal-form::-webkit-scrollbar {
            width: 6px;
        }
        
        .modal-body::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track,
        .modal-form::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb,
        .tab-content::-webkit-scrollbar-thumb,
        .modal-form::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 3px;
        }
        
        .modal-body::-webkit-scrollbar-thumb:hover,
        .tab-content::-webkit-scrollbar-thumb:hover,
        .modal-form::-webkit-scrollbar-thumb:hover {
            background: #a1a1a1;
        }
        
        /* ÊîØ‰ªòÁõ∏ÂÖ≥Ê®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .payment-modal,
        .qr-modal,
        .activation-modal {
            max-height: 85vh !important;
            overflow-y: auto !important;
        }
        
        .payment-modal .modal-content,
        .qr-modal .modal-content,
        .activation-modal .modal-content {
            max-height: 85vh !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }
        
        .payment-modal .modal-body,
        .qr-modal .modal-body,
        .activation-modal .modal-body {
            overflow-y: auto !important;
            flex: 1 !important;
            padding: 20px !important;
        }
        
        /* ‰∫åÁª¥Á†ÅÂÆπÂô®ÊªöÂä® */
        .qr-container,
        .payment-container,
        .activation-container {
            max-height: 60vh;
            overflow-y: auto;
            padding: 10px;
        }

        /* Âä®ÊÄÅÊ®°ÊÄÅÊ°ÜÈÄöÁî®ÊªöÂä®ÊîØÊåÅ */
        .modal[id*="payment"] .modal-content,
        .modal[id*="qr"] .modal-content,
        .modal[id*="activation"] .modal-content,
        .modal[id*="pay"] .modal-content {
            max-height: 85vh !important;
            overflow: hidden !important;
            display: flex !important;
            flex-direction: column !important;
        }

        .modal[id*="payment"] .modal-body,
        .modal[id*="qr"] .modal-body,
        .modal[id*="activation"] .modal-body,
        .modal[id*="pay"] .modal-body {
            overflow-y: auto !important;
            flex: 1 !important;
        }
    </style>
</head>
<body>
    <!-- ÁôªÂΩïÁïåÈù¢ -->
    <div id="loginContainer" class="login-container">
        <div class="login-box">
            <div class="login-header">
                <h1>üè™ ÂÆ¢ÊúçÁÆ°ÁêÜÁ≥ªÁªü</h1>
                <p>Â§öÂ∫óÈì∫Áªü‰∏ÄÁÆ°ÁêÜÂπ≥Âè∞</p>
            </div>
            
            <div id="loginMessage"></div>
            
            <!-- ÁôªÂΩïË°®Âçï -->
            <form id="loginForm">
                <div class="form-group">
                    <label for="username">Áî®Êà∑Âêç</label>
                    <input type="text" id="username" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="password">ÂØÜÁ†Å</label>
                    <input type="password" id="password" name="password" required>
                </div>
                
                <button type="submit" class="btn" id="loginBtn">ÁôªÂΩï</button>
            </form>
            
            <!-- Ê≥®ÂÜåË°®Âçï -->
            <form id="registerForm" style="display: none;">
                <div class="form-group">
                    <label for="regUsername">Áî®Êà∑Âêç</label>
                    <input type="text" id="regUsername" name="username" required>
                </div>
                
                <div class="form-group">
                    <label for="regEmail">ÈÇÆÁÆ±</label>
                    <input type="email" id="regEmail" name="email" required>
                </div>
                
                <div class="form-group">
                    <label for="regPassword">ÂØÜÁ†Å</label>
                    <input type="password" id="regPassword" name="password" required minlength="6">
                </div>
                
                <div class="form-group">
                    <label for="confirmPassword">Á°ÆËÆ§ÂØÜÁ†Å</label>
                    <input type="password" id="confirmPassword" name="confirmPassword" required minlength="6">
                </div>
                
                <!-- ËßíËâ≤Á±ªÂûãÈöêËóèÔºåÈªòËÆ§‰∏∫Â∫ó‰∏ª -->
                <input type="hidden" id="role" name="role" value="owner">
                
                <button type="submit" class="btn" id="registerBtn">Ê≥®ÂÜå</button>
            </form>
            
            <!-- ÂàáÊç¢ÁôªÂΩï/Ê≥®ÂÜå -->
            <div style="margin-top: 20px; text-align: center;">
                <p style="color: #666; font-size: 14px;">
                    <span id="toggleText">ËøòÊ≤°ÊúâË¥¶Âè∑Ôºü</span>
                    <a href="#" id="toggleLink" style="color: #007bff; text-decoration: none;">Á´ãÂç≥Ê≥®ÂÜå</a>
                </p>
            </div>
            
            <div id="testAccounts" style="margin-top: 20px; text-align: center; font-size: 14px; color: #666;">
                <p><strong>ÊµãËØïË¥¶Âè∑Ôºö</strong></p>
                <p>Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò: admin / admin123</p>
                <p>Â∫ó‰∏ªË¥¶Âè∑: shop_owner / 123456</p>
            </div>
        </div>
    </div>

    <!-- ‰∏ªÁïåÈù¢ -->
    <div id="mainContainer" class="main-container">
        <div class="container">
            <div class="header">
                <h1>ÂÆ¢ÊúçÁÆ°ÁêÜÁ≥ªÁªü</h1>
                <div class="user-info">
                    <button class="promotion-btn" onclick="showPromotionModal()">
                        üéÅ Êé®ÂπøËµöÈí±
                    </button>
                    <!-- Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò‰∏ìÁî®ÊåâÈíÆ -->
                    <button class="admin-panel-btn" id="adminPanelBtn" onclick="showAdminPanel()" style="display: none;">
                        üîß ÁÆ°ÁêÜÈù¢Êùø
                    </button>
                    <button class="review-panel-btn" id="reviewPanelBtn" onclick="showReviewPanel()" style="display: none;">
                        üìã ÂÆ°Ê†∏ÁÆ°ÁêÜ
                    </button>
                    <button class="user-badge" id="userBadge" onclick="showProfileModal()">Âä†ËΩΩ‰∏≠...</button>
                    <button class="create-shop-btn" onclick="showCreateShopModal()">üè™ ÂàõÂª∫Â∫óÈì∫</button>
                    <button class="logout-btn" onclick="logout()">ÁôªÂá∫</button>
                </div>
            </div>

            <!-- Â∫óÈì∫ÂàóË°® -->
            <div class="shops-grid" id="shopsGrid">
                <div class="loading">Ê≠£Âú®Âä†ËΩΩÂ∫óÈì∫‰ø°ÊÅØ...</div>
            </div>

            <!-- ÂÆ¢ÊúçÊ∂àÊÅØÈù¢Êùø -->
            <div class="messages-panel" id="messagesPanel">
                <div class="messages-header">
                    <h3>üì® ÂÆ¢ÊúçÊ∂àÊÅØ</h3>
                </div>
                <div class="messages-body">
                    <div class="empty-state">
                        ÈÄâÊã©‰∏Ä‰∏™Â∫óÈì∫Êü•ÁúãÂÆ¢ÊúçÊ∂àÊÅØ
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÂàõÂª∫Â∫óÈì∫Ê®°ÊÄÅÊ°Ü -->
    <div id="createShopModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üè™ Áî≥ËØ∑Êñ∞Â∫óÈì∫</h3>
                <span class="close" onclick="hideCreateShopModal()">&times;</span>
            </div>
            <form id="createShopForm" class="modal-form">
                <div class="form-group">
                    <label for="shopName">Â∫óÈì∫ÂêçÁß∞</label>
                    <input type="text" id="shopName" name="shopName" required>
                </div>
                <div class="form-group">
                    <label for="shopDomain">Â∫óÈì∫ÂüüÂêç</label>
                    <input type="text" id="shopDomain" name="shopDomain" placeholder="example.com" required>
                </div>
                <div class="form-group">
                    <label for="shopDescription">ÂüüÂêçÊèèËø∞Ôºà‰∏öÂä°ËØ¥ÊòéÔºâ</label>
                    <textarea id="shopDescription" name="shopDescription" rows="3" placeholder="ËØ∑ÊèèËø∞ÊÇ®ÁöÑÁΩëÁ´ô‰∏öÂä°ÂÜÖÂÆπÔºåÊúâÂä©‰∫éÂÆ°Ê†∏ÈÄöËøá" required></textarea>
                </div>
                <div class="modal-buttons">
                    <button type="button" class="btn btn-secondary" onclick="hideCreateShopModal()">ÂèñÊ∂à</button>
                    <button type="submit" class="btn">üè™ Êèê‰∫§Áî≥ËØ∑</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Â∫óÈì∫ÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü -->
    <div id="manageShopModal" class="modal">
        <div class="modal-content manage-modal">
            <div class="modal-header">
                <h3 id="manageShopTitle">üè™ ÁÆ°ÁêÜÂ∫óÈì∫</h3>
                <span class="close" onclick="hideManageShopModal()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- ÂØºËà™Ê†áÁ≠æ -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="showTab('employees')">üë• ÂëòÂ∑•ÁÆ°ÁêÜ</button>
                    <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Â∫óÈì∫ËÆæÁΩÆ</button>
                </div>

                <!-- ÂëòÂ∑•ÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
                <div id="employeesTab" class="tab-content active">
                    <div class="section-header">
                        <h4>ÂëòÂ∑•ÂàóË°®</h4>
                        <button class="btn btn-small" onclick="showAddEmployeeForm()">‚ûï Ê∑ªÂä†ÂëòÂ∑•</button>
                    </div>
                    
                    <!-- Ê∑ªÂä†ÂëòÂ∑•Ë°®Âçï -->
                    <div id="addEmployeeForm" class="add-employee-form" style="display: none;">
                        <h5>Ê∑ªÂä†Êñ∞ÂëòÂ∑•</h5>
                        <div class="employee-help-text">
                            <p>üí° <strong>ÂëòÂ∑•ÊùÉÈôêËØ¥ÊòéÔºö</strong></p>
                            <ul>
                                <li><strong>ÂëòÂ∑•</strong>ÔºöÂèØ‰ª•ÂõûÂ§çÂÆ¢Êà∑Ê∂àÊÅØÔºåÂ§ÑÁêÜÂÆ¢ÊúçÂØπËØù</li>
                                <li><strong>ÁªèÁêÜ</strong>ÔºöÂèØ‰ª•ÂõûÂ§çÂÆ¢Êà∑Ê∂àÊÅØÔºåÊü•ÁúãÁªüËÆ°Êä•Ë°®ÔºåÁÆ°ÁêÜÂÖ∂‰ªñÂëòÂ∑•</li>
                            </ul>
                            <p>‚úÖ Ê∑ªÂä†ÁöÑÂëòÂ∑•Â∞ÜËÉΩÂ§üÁôªÂΩïÁ≥ªÁªüÂπ∂Â§ÑÁêÜÊú¨Â∫óÈì∫ÁöÑÂÆ¢ÊúçÂ∑•‰Ωú</p>
                        </div>
                        <form id="addEmployeeFormData">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="employeeUsername">Áî®Êà∑Âêç</label>
                                    <input type="text" id="employeeUsername" placeholder="ËæìÂÖ•Ë¶ÅÊ∑ªÂä†ÁöÑÁî®Êà∑Âêç" required>
                                </div>
                                <div class="form-group">
                                    <label for="employeeRole">ËßíËâ≤ÊùÉÈôê</label>
                                    <select id="employeeRole" required>
                                        <option value="employee">ÂëòÂ∑• (ÂÆ¢ÊúçÊùÉÈôê)</option>
                                        <option value="manager">ÁªèÁêÜ (ÁÆ°ÁêÜÊùÉÈôê)</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-buttons">
                                <button type="button" onclick="cancelAddEmployee()">ÂèñÊ∂à</button>
                                <button type="submit">‚ûï Ê∑ªÂä†ÂëòÂ∑•</button>
                            </div>
                        </form>
                    </div>

                    <!-- ÂëòÂ∑•ÂàóË°® -->
                    <div id="employeesList" class="employees-list">
                        <div class="loading">Ê≠£Âú®Âä†ËΩΩÂëòÂ∑•‰ø°ÊÅØ...</div>
                    </div>
                </div>

                <!-- Â∫óÈì∫ËÆæÁΩÆÊ†áÁ≠æÈ°µ -->
                <div id="settingsTab" class="tab-content">
                    <form id="shopSettingsForm">
                        <div class="form-group">
                            <label for="editShopName">Â∫óÈì∫ÂêçÁß∞</label>
                            <input type="text" id="editShopName" required>
                        </div>
                        <div class="form-group">
                            <label for="editShopDomain">Â∫óÈì∫ÂüüÂêç</label>
                            <input type="text" id="editShopDomain" required>
                        </div>
                        <div class="form-buttons">
                            <button type="submit" class="btn">‰øùÂ≠òËÆæÁΩÆ</button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ‰∏™‰∫∫ËµÑÊñôÁºñËæëÊ®°ÊÄÅÊ°Ü -->
    <div id="profileModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üë§ ‰∏™‰∫∫ËµÑÊñô</h3>
                <span class="close" onclick="hideProfileModal()">&times;</span>
            </div>
            <div class="modal-form">
                <form id="profileForm">
                    <div class="form-group">
                        <label for="profileUsername">Áî®Êà∑Âêç</label>
                        <input type="text" id="profileUsername" name="username" required>
                    </div>
                    <div class="form-group">
                        <label for="profileEmail">ÈÇÆÁÆ±</label>
                        <input type="email" id="profileEmail" name="email" required>
                    </div>
                    <!-- ËßíËâ≤Ê†èÂ∑≤ÈöêËóè -->
                    <hr style="margin: 20px 0; border: none; border-top: 1px solid #eee;">
                    <h4 style="margin-bottom: 15px; color: #333;">‰øÆÊîπÂØÜÁ†Å (ÂèØÈÄâ)</h4>
                    <div class="form-group">
                        <label for="currentPassword">ÂΩìÂâçÂØÜÁ†Å</label>
                        <input type="password" id="currentPassword" name="currentPassword" placeholder="Â¶ÇÈúÄ‰øÆÊîπÂØÜÁ†ÅÔºåËØ∑ËæìÂÖ•ÂΩìÂâçÂØÜÁ†Å">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Êñ∞ÂØÜÁ†Å</label>
                        <input type="password" id="newPassword" name="newPassword" placeholder="ÁïôÁ©∫Ë°®Á§∫‰∏ç‰øÆÊîπÂØÜÁ†Å">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Á°ÆËÆ§Êñ∞ÂØÜÁ†Å</label>
                        <input type="password" id="confirmPassword" name="confirmPassword" placeholder="ÂÜçÊ¨°ËæìÂÖ•Êñ∞ÂØÜÁ†Å">
                    </div>
                </form>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideProfileModal()">ÂèñÊ∂à</button>
                <button type="button" class="btn" onclick="submitProfileForm()">‰øùÂ≠ò‰øÆÊîπ</button>
            </div>
        </div>
    </div>

    <!-- Êé®ÂπøËµöÈí±Ê®°ÊÄÅÊ°Ü -->
    <div id="promotionModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üéÅ Êé®ÂπøËµöÈí± - Ëé∑Âæó10%ÂõûÊä•</h3>
                <span class="close" onclick="hidePromotionModal()">&times;</span>
            </div>
            <div class="modal-form">
                <div class="promotion-content">
                    <div class="promotion-section">
                        <h4>üí∞ Êé®ÂπøÂ•ñÂä±ÊîøÁ≠ñ</h4>
                        <div class="reward-info">
                            <div class="reward-item">
                                <span class="reward-icon">üéØ</span>
                                <div>
                                    <strong>Êé®Âπø‰Ω£ÈáëÔºö10%</strong>
                                    <p>ÊØèÊàêÂäüÊé®Ëçê‰∏Ä‰ΩçÊúãÂèãÊ≥®ÂÜåÂπ∂‰ΩøÁî®ÊúçÂä°ÔºåÊÇ®Â∞ÜËé∑Âæó‰ªñ‰ª¨Ê∂àË¥πÈáëÈ¢ùÁöÑ10%‰Ωú‰∏∫‰Ω£ÈáëÂõûÊä•</p>
                                </div>
                            </div>
                            <div class="reward-item">
                                <span class="reward-icon">‚ö°</span>
                                <div>
                                    <strong>ÂÆûÊó∂ÁªìÁÆó</strong>
                                    <p>ÊúãÂèãÊØèÊ¨°Ê∂àË¥πÂêéÔºå‰Ω£ÈáëÁ´ãÂç≥Âà∞Ë¥¶ÔºåÊó†ÈúÄÁ≠âÂæÖ</p>
                                </div>
                            </div>
                            <div class="reward-item">
                                <span class="reward-icon">üîÑ</span>
                                <div>
                                    <strong>ÈïøÊúüÊúâÊïà</strong>
                                    <p>Âè™Ë¶ÅÊòØÈÄöËøáÊÇ®ÁöÑÊé®ÂπøÈìæÊé•Ê≥®ÂÜåÁöÑÁî®Êà∑ÔºåÁªàË∫´‰∫´Âèó‰Ω£ÈáëÂàÜÊàê</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="promotion-section">
                        <h4>üîó ÊÇ®ÁöÑ‰∏ìÂ±ûÊé®ÂπøÈìæÊé•</h4>
                        <div class="link-container">
                            <input type="text" id="promotionLink" readonly 
                                   value="http://localhost:3030?ref=shop_owner" 
                                   class="promotion-link-input">
                            <button class="copy-btn" onclick="copyPromotionLink()">üìã Â§çÂà∂</button>
                        </div>
                        <p class="link-tip">Â∞ÜÊ≠§ÈìæÊé•ÂàÜ‰∫´ÁªôÊúãÂèãÔºå‰ªñ‰ª¨ÈÄöËøáÊ≠§ÈìæÊé•Ê≥®ÂÜåÂêéÔºåÊÇ®Â∞±ËÉΩËé∑Âæó‰Ω£ÈáëÔºÅ</p>
                    </div>
                    
                    <div class="promotion-section">
                        <h4>üìä Êé®ÂπøÊï∞ÊçÆ</h4>
                        <div class="stats-grid">
                            <div class="stat-item">
                                <div class="stat-number">0</div>
                                <div class="stat-label">Êé®Ëçê‰∫∫Êï∞</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">Ôø•0</div>
                                <div class="stat-label">Á¥ØËÆ°‰Ω£Èáë</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number">Ôø•0</div>
                                <div class="stat-label">Êú¨Êúà‰Ω£Èáë</div>
                            </div>
                        </div>
                    </div>

                    <!-- ‰ª∑Ê†ºË°®ÈÉ®ÂàÜ -->
                    <div class="promotion-section">
                        <h4>üí∞ Â•óÈ§ê‰ª∑Ê†ºË°®</h4>
                        <div class="price-table-container">
                            <table class="price-table">
                                <thead>
                                    <tr>
                                        <th>Ë¥≠‰π∞Êï∞Èáè</th>
                                        <th>ÊÄª‰ª∑</th>
                                        <th>Âçï‰ª∑</th>
                                        <th>ËäÇÁúÅÈáëÈ¢ù</th>
                                    </tr>
                                </thead>
                                <tbody id="priceTableBody">
                                    <!-- ‰ª∑Ê†ºÊï∞ÊçÆÂ∞ÜÈÄöËøáJavaScriptÁîüÊàê -->
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- ‰ª∑Ê†ºËÆ°ÁÆóÂô®ÈÉ®ÂàÜ -->
                    <div class="promotion-section">
                        <h4>üßÆ ‰ª∑Ê†ºËÆ°ÁÆóÂô®</h4>
                        <div class="price-calculator">
                            <div class="calculator-input">
                                <label for="quantityInput">ËØ∑ËæìÂÖ•Ë¥≠‰π∞Â•óÊï∞Ôºö</label>
                                <div class="input-group">
                                    <input type="number" id="quantityInput" min="1" max="999" placeholder="ËæìÂÖ•Êï∞Èáè" oninput="calculatePrice()">
                                    <span class="input-unit">Â•ó</span>
                                </div>
                            </div>
                            <div class="calculator-keypad">
                                <div class="keypad-grid">
                                    <button class="key-btn" onclick="inputNumber('1')">1</button>
                                    <button class="key-btn" onclick="inputNumber('2')">2</button>
                                    <button class="key-btn" onclick="inputNumber('3')">3</button>
                                    <button class="key-btn" onclick="inputNumber('4')">4</button>
                                    <button class="key-btn" onclick="inputNumber('5')">5</button>
                                    <button class="key-btn" onclick="inputNumber('6')">6</button>
                                    <button class="key-btn" onclick="inputNumber('7')">7</button>
                                    <button class="key-btn" onclick="inputNumber('8')">8</button>
                                    <button class="key-btn" onclick="inputNumber('9')">9</button>
                                    <button class="key-btn key-clear" onclick="clearInput()">Ê∏ÖÈô§</button>
                                    <button class="key-btn" onclick="inputNumber('0')">0</button>
                                    <button class="key-btn key-backspace" onclick="backspace()">‚Üê</button>
                                </div>
                            </div>
                            <div class="calculator-result" id="calculatorResult">
                                <div class="result-item">
                                    <span class="result-label">Ë¥≠‰π∞Êï∞ÈáèÔºö</span>
                                    <span class="result-value" id="resultQuantity">-</span>
                                </div>
                                <div class="result-item total-price">
                                    <span class="result-label">ÊÄª‰ª∑Ôºö</span>
                                    <span class="result-value" id="resultPrice">¬•-</span>
                                </div>
                                <div class="result-item">
                                    <span class="result-label">Âπ≥ÂùáÂçï‰ª∑Ôºö</span>
                                    <span class="result-value" id="resultUnitPrice">¬•-</span>
                                </div>
                                <div class="result-item savings">
                                    <span class="result-label">ËäÇÁúÅÈáëÈ¢ùÔºö</span>
                                    <span class="result-value" id="resultSavings">¬•-</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="promotion-section">
                        <h4>üì± ÂàÜ‰∫´ÊñπÂºè</h4>
                        <div class="share-buttons">
                            <button class="share-btn" onclick="shareToWeChat()">
                                üí¨ ÂàÜ‰∫´Âà∞ÂæÆ‰ø°
                            </button>
                            <button class="share-btn" onclick="shareToQQ()">
                                üêß ÂàÜ‰∫´Âà∞QQ
                            </button>
                            <button class="share-btn" onclick="generateQRCode()">
                                üì± ÁîüÊàê‰∫åÁª¥Á†Å
                            </button>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hidePromotionModal()">ÂÖ≥Èó≠</button>
                <button type="button" class="btn" onclick="openPromotionGuide()">Êü•ÁúãÊé®ÂπøÊåáÂçó</button>
            </div>
        </div>
    </div>

    <!-- Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÊ®°ÊÄÅÊ°Ü -->
    <div id="adminPanelModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3>üîß Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø</h3>
                <span class="close" onclick="hideAdminPanel()">&times;</span>
            </div>
            <div class="modal-body">
                <!-- ÁÆ°ÁêÜÂëòÂØºËà™Ê†áÁ≠æ -->
                <div class="tab-nav">
                    <button class="tab-btn active" onclick="showAdminTab('overview')">üìä Á≥ªÁªüÊ¶ÇËßà</button>
                    <button class="tab-btn" onclick="showAdminTab('owners')">üë• Â∫ó‰∏ªÁÆ°ÁêÜ</button>
                    <button class="tab-btn" onclick="showAdminTab('shops')">üè™ Â∫óÈì∫ÁõëÊéß</button>
                </div>

                <!-- Á≥ªÁªüÊ¶ÇËßàÊ†áÁ≠æÈ°µ -->
                <div id="overviewTab" class="tab-content active">
                    <div class="admin-section">
                        <h4>üìà Á≥ªÁªüÁªüËÆ°</h4>
                        <div class="stats-grid" id="systemStats">
                            <div class="stat-item">
                                <div class="stat-number" id="totalUsers">-</div>
                                <div class="stat-label">ÊÄªÁî®Êà∑Êï∞</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="totalShops">-</div>
                                <div class="stat-label">ÊÄªÂ∫óÈì∫Êï∞</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="shopOwners">-</div>
                                <div class="stat-label">Â∫ó‰∏ªÊï∞Èáè</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-number" id="employees">-</div>
                                <div class="stat-label">ÂëòÂ∑•Êï∞Èáè</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Â∫ó‰∏ªÁÆ°ÁêÜÊ†áÁ≠æÈ°µ -->
                <div id="ownersTab" class="tab-content">
                    <div class="admin-section">
                        <div class="section-header">
                            <h4>üë• Â∫ó‰∏ªÁÆ°ÁêÜ</h4>
                            <div class="search-box">
                                <input type="text" id="ownerSearch" placeholder="ÊêúÁ¥¢Â∫ó‰∏ªÁî®Êà∑Âêç„ÄÅÈÇÆÁÆ±ÊàñÂ∫óÈì∫Âêç..." 
                                       onkeyup="searchShopOwners()">
                                <button class="btn btn-small" onclick="searchShopOwners()">üîç ÊêúÁ¥¢</button>
                            </div>
                        </div>
                        
                        <div class="owners-list" id="ownersList">
                            <div class="loading">Ê≠£Âú®Âä†ËΩΩÂ∫ó‰∏ªÊï∞ÊçÆ...</div>
                        </div>
                    </div>
                </div>

                <!-- Â∫óÈì∫ÁõëÊéßÊ†áÁ≠æÈ°µ -->
                <div id="shopsTab" class="tab-content">
                    <div class="admin-section">
                        <h4>üè™ ÊâÄÊúâÂ∫óÈì∫ÁõëÊéß</h4>
                        <div class="shops-monitor" id="shopsMonitor">
                            <div class="loading">Ê≠£Âú®Âä†ËΩΩÂ∫óÈì∫Êï∞ÊçÆ...</div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideAdminPanel()">ÂÖ≥Èó≠</button>
                <button type="button" class="btn" onclick="refreshAdminData()">üîÑ Âà∑Êñ∞Êï∞ÊçÆ</button>
            </div>
        </div>
    </div>

    <!-- ÂÆ°Ê†∏ÁÆ°ÁêÜÈù¢ÊùøÊ®°ÊÄÅÊ°Ü -->
    <div id="reviewPanelModal" class="modal">
        <div class="modal-content admin-modal">
            <div class="modal-header">
                <h3>üìã ÂÆ°Ê†∏ÁÆ°ÁêÜ</h3>
                <span class="close" onclick="hideReviewPanel()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="review-section">
                    <h4>üìù ÂæÖÂÆ°Ê†∏Â∫óÈì∫ÂàóË°®</h4>
                    <div class="pending-shops-container" id="pendingShopsContainer">
                        <div class="loading">Ê≠£Âú®Âä†ËΩΩÂæÖÂÆ°Ê†∏Â∫óÈì∫...</div>
                    </div>
                </div>
            </div>
            <div class="modal-buttons">
                <button type="button" class="btn btn-secondary" onclick="hideReviewPanel()">ÂÖ≥Èó≠</button>
                <button type="button" class="btn" onclick="refreshPendingShops()">üîÑ Âà∑Êñ∞ÂàóË°®</button>
            </div>
        </div>
    </div>

    <script>
        let currentUser = null;
        let currentSession = null;
        let currentShops = [];

        // È°µÈù¢Âä†ËΩΩÊó∂Ê£ÄÊü•ÁôªÂΩïÁä∂ÊÄÅ
        window.addEventListener('DOMContentLoaded', () => {
            const savedSession = localStorage.getItem('sessionId');
            if (savedSession) {
                validateSession(savedSession);
            }
        });

        // È™åËØÅ‰ºöËØù
        async function validateSession(sessionId) {
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    currentUser = data.user;
                    currentSession = sessionId;
                    currentShops = data.shops;
                    showMainInterface();
                } else {
                    localStorage.removeItem('sessionId');
                    showLoginInterface();
                }
            } catch (error) {
                console.error('‰ºöËØùÈ™åËØÅÂ§±Ë¥•:', error);
                localStorage.removeItem('sessionId');
                showLoginInterface();
            }
        }

        // ÊòæÁ§∫ÁôªÂΩïÁïåÈù¢
        function showLoginInterface() {
            document.getElementById('loginContainer').style.display = 'flex';
            document.getElementById('mainContainer').style.display = 'none';
        }

        // ÊòæÁ§∫‰∏ªÁïåÈù¢
        function showMainInterface() {
            document.getElementById('loginContainer').style.display = 'none';
            document.getElementById('mainContainer').style.display = 'block';
            
            updateUserInfo();
            loadMyShops(); // ÂÖàÂä†ËΩΩÂ∫óÈì∫Êï∞ÊçÆÔºåloadMyShopsÂÜÖÈÉ®‰ºöË∞ÉÁî®loadShops()
        }

        // Êõ¥Êñ∞Áî®Êà∑‰ø°ÊÅØÊòæÁ§∫
        function updateUserInfo() {
            const badge = document.getElementById('userBadge');
            const adminBtn = document.getElementById('adminPanelBtn');
            const reviewBtn = document.getElementById('reviewPanelBtn');
            const roleText = {
                'super_admin': 'Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëò',
                'shop_owner': 'Â∫ó‰∏ª',
                'employee': 'ÂëòÂ∑•'
            };
            badge.textContent = `${currentUser.username} (${roleText[currentUser.role] || currentUser.role})`;
            
            // Âè™ÊúâË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊâçÊòæÁ§∫ÁÆ°ÁêÜÈù¢ÊùøÊåâÈíÆÂíåÂÆ°Ê†∏ÁÆ°ÁêÜÊåâÈíÆ
            if (currentUser.role === 'super_admin') {
                adminBtn.style.display = 'inline-block';
                reviewBtn.style.display = 'inline-block';
            } else {
                adminBtn.style.display = 'none';
                reviewBtn.style.display = 'none';
            }
        }

        // ============ ‰∏™‰∫∫ËµÑÊñôÁÆ°ÁêÜ ============
        
        // ÊòæÁ§∫‰∏™‰∫∫ËµÑÊñôÁºñËæëÊ®°ÊÄÅÊ°Ü
        function showProfileModal() {
            const modal = document.getElementById('profileModal');
            const form = document.getElementById('profileForm');
            
            // Â°´ÂÖÖÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
            document.getElementById('profileUsername').value = currentUser.username;
            document.getElementById('profileEmail').value = currentUser.email;
            
            // Ê∏ÖÁ©∫ÂØÜÁ†ÅÂ≠óÊÆµ
            document.getElementById('currentPassword').value = '';
            document.getElementById('newPassword').value = '';
            document.getElementById('confirmPassword').value = '';
            
            modal.style.display = 'block';
        }
        
        // ÈöêËóè‰∏™‰∫∫ËµÑÊñôÁºñËæëÊ®°ÊÄÅÊ°Ü
        function hideProfileModal() {
            document.getElementById('profileModal').style.display = 'none';
        }
        
        // Êèê‰∫§‰∏™‰∫∫ËµÑÊñôË°®Âçï
        function submitProfileForm() {
            const form = document.getElementById('profileForm');
            const formData = new FormData(form);
            const username = formData.get('username');
            const email = formData.get('email');
            const currentPassword = formData.get('currentPassword');
            const newPassword = formData.get('newPassword');
            const confirmPassword = formData.get('confirmPassword');
            
            // È™åËØÅË°®Âçï
            if (!username || !email) {
                alert('Áî®Êà∑ÂêçÂíåÈÇÆÁÆ±‰∏∫ÂøÖÂ°´È°π');
                return;
            }
            
            // Â¶ÇÊûúË¶Å‰øÆÊîπÂØÜÁ†ÅÔºåÈ™åËØÅÂØÜÁ†ÅÂ≠óÊÆµ
            if (newPassword || currentPassword) {
                if (!currentPassword) {
                    alert('‰øÆÊîπÂØÜÁ†ÅÈúÄË¶ÅÊèê‰æõÂΩìÂâçÂØÜÁ†Å');
                    return;
                }
                if (!newPassword) {
                    alert('ËØ∑ËæìÂÖ•Êñ∞ÂØÜÁ†Å');
                    return;
                }
                if (newPassword !== confirmPassword) {
                    alert('‰∏§Ê¨°ËæìÂÖ•ÁöÑÊñ∞ÂØÜÁ†Å‰∏ç‰∏ÄËá¥');
                    return;
                }
                if (newPassword.length < 6) {
                    alert('Êñ∞ÂØÜÁ†ÅÈïøÂ∫¶Ëá≥Â∞ë6‰Ωç');
                    return;
                }
            }
            
            const submitBtn = document.querySelector('#profileModal .btn:not(.btn-secondary)');
            submitBtn.disabled = true;
            submitBtn.textContent = '‰øùÂ≠ò‰∏≠...';
            
            // ÊâßË°åÂºÇÊ≠•Êõ¥Êñ∞
            performProfileUpdate(username, email, currentPassword, newPassword, submitBtn);
        }
        
        // ÊâßË°å‰∏™‰∫∫ËµÑÊñôÊõ¥Êñ∞ÁöÑÂºÇÊ≠•ÂáΩÊï∞
        async function performProfileUpdate(username, email, currentPassword, newPassword, submitBtn) {
            try {
                const updateData = { username, email };
                if (newPassword) {
                    updateData.currentPassword = currentPassword;
                    updateData.newPassword = newPassword;
                }
                
                const response = await fetch('/api/auth/profile', {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify(updateData)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // Êõ¥Êñ∞ÂΩìÂâçÁî®Êà∑‰ø°ÊÅØ
                    currentUser = { ...currentUser, ...data.profile };
                    updateUserInfo();
                    hideProfileModal();
                    alert('‰∏™‰∫∫ËµÑÊñôÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                } else {
                    alert(data.error || 'Êõ¥Êñ∞Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞‰∏™‰∫∫ËµÑÊñôÈîôËØØ:', error);
                alert('Êõ¥Êñ∞Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = '‰øùÂ≠ò‰øÆÊîπ';
            }
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const profileModal = document.getElementById('profileModal');
            const promotionModal = document.getElementById('promotionModal');
            
            if (event.target === profileModal) {
                hideProfileModal();
            }
            if (event.target === promotionModal) {
                hidePromotionModal();
            }
        }

        // ============ Êé®ÂπøËµöÈí±ÂäüËÉΩ ============
        
        // ÊòæÁ§∫Êé®ÂπøÊ®°ÊÄÅÊ°Ü
        function showPromotionModal() {
            const modal = document.getElementById('promotionModal');
            
            // Êõ¥Êñ∞Êé®ÂπøÈìæÊé•
            const link = `http://localhost:3030?ref=${currentUser.username}`;
            document.getElementById('promotionLink').value = link;
            
            // ËøôÈáåÂèØ‰ª•Âä†ËΩΩÊé®ÂπøÊï∞ÊçÆ
            loadPromotionData();
            
            modal.style.display = 'block';
        }
        
        // ÈöêËóèÊé®ÂπøÊ®°ÊÄÅÊ°Ü
        function hidePromotionModal() {
            document.getElementById('promotionModal').style.display = 'none';
        }
        
        // Â§çÂà∂Êé®ÂπøÈìæÊé•
        function copyPromotionLink() {
            const linkInput = document.getElementById('promotionLink');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // ÁßªÂä®Á´ØÂÖºÂÆπ
            
            try {
                document.execCommand('copy');
                alert('Êé®ÂπøÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
            } catch (err) {
                // ‰ΩøÁî®Áé∞‰ª£API
                navigator.clipboard.writeText(linkInput.value).then(() => {
                    alert('Êé®ÂπøÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                }).catch(() => {
                    alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®Â§çÂà∂ÈìæÊé•');
                });
            }
        }
        
        // ÂàÜ‰∫´Âà∞ÂæÆ‰ø°
        function shareToWeChat() {
            const link = document.getElementById('promotionLink').value;
            const message = `üéÅ ÈÇÄËØ∑ÊÇ®ÂÖçË¥π‰ΩìÈ™åÊàë‰ª¨ÁöÑÂÆ¢ÊúçÁ≥ªÁªüÔºÅÈÄöËøáÊàëÁöÑ‰∏ìÂ±ûÈìæÊé•Ê≥®ÂÜåÔºåÊàë‰ª¨ÈÉΩËÉΩËé∑Âæó‰ºòÊÉ†Âì¶ÔºÅ\\n\\nÁÇπÂáªÈìæÊé•Ôºö${link}`;
            
            // ÂàõÂª∫ÂàÜ‰∫´ÊñáÊú¨
            if (navigator.share) {
                navigator.share({
                    title: 'ÈÇÄËØ∑ÊÇ®‰ΩìÈ™åÂÆ¢ÊúçÁ≥ªÁªü',
                    text: message,
                    url: link
                });
            } else {
                // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(message).then(() => {
                    alert('ÂàÜ‰∫´ÂÜÖÂÆπÂ∑≤Â§çÂà∂ÔºåËØ∑Âú®ÂæÆ‰ø°‰∏≠Á≤òË¥¥ÂàÜ‰∫´ÔºÅ');
                });
            }
        }
        
        // ÂàÜ‰∫´Âà∞QQ
        function shareToQQ() {
            const link = document.getElementById('promotionLink').value;
            const title = encodeURIComponent('ÈÇÄËØ∑ÊÇ®‰ΩìÈ™åÂÆ¢ÊúçÁ≥ªÁªü');
            const summary = encodeURIComponent('ÂÖçË¥π‰ΩìÈ™å‰∏ì‰∏öÂÆ¢ÊúçÁ≥ªÁªüÔºåÈÄöËøáÊàëÁöÑÊé®ÂπøÈìæÊé•Ê≥®ÂÜåËøòÊúâ‰ºòÊÉ†ÔºÅ');
            
            const qqUrl = `https://connect.qq.com/widget/shareqq/index.html?url=${encodeURIComponent(link)}&title=${title}&summary=${summary}`;
            window.open(qqUrl, '_blank');
        }
        
        // ÁîüÊàê‰∫åÁª¥Á†Å
        function generateQRCode() {
            const link = document.getElementById('promotionLink').value;
            const qrUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(link)}`;
            
            // ÂàõÂª∫‰∫åÁª¥Á†ÅÊòæÁ§∫Á™óÂè£
            const qrWindow = window.open('', '_blank', 'width=300,height=350');
            qrWindow.document.write(`
                <html>
                    <head><title>Êé®Âπø‰∫åÁª¥Á†Å</title></head>
                    <body style="text-align: center; padding: 20px; font-family: Arial;">
                        <h3>Êâ´Á†ÅÊ≥®ÂÜåËé∑Âæó‰ºòÊÉ†</h3>
                        <img src="${qrUrl}" alt="Êé®Âπø‰∫åÁª¥Á†Å" style="border: 1px solid #ddd; padding: 10px;">
                        <p style="font-size: 12px; color: #666; margin-top: 15px;">
                            ‰øùÂ≠òÂõæÁâáÂàÜ‰∫´ÁªôÊúãÂèã<br>
                            ÊàñÁõ¥Êé•ËÆ©ÊúãÂèãÊâ´Á†ÅÊ≥®ÂÜå
                        </p>
                    </body>
                </html>
            `);
        }

        // ============ Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÂäüËÉΩ ============

        // ÊòæÁ§∫Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø
        function showAdminPanel() {
            if (currentUser.role !== 'super_admin') {
                alert('Âè™ÊúâË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊâçËÉΩËÆøÈóÆÊ≠§ÂäüËÉΩ');
                return;
            }
            
            document.getElementById('adminPanelModal').style.display = 'block';
            
            // ÈªòËÆ§ÊòæÁ§∫Á≥ªÁªüÊ¶ÇËßà
            showAdminTab('overview');
            
            // Âä†ËΩΩÂàùÂßãÊï∞ÊçÆ
            loadSystemStats();
            loadShopOwnersStats();
        }

        // ÈöêËóèË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø
        function hideAdminPanel() {
            document.getElementById('adminPanelModal').style.display = 'none';
        }

        // ÂàáÊç¢ÁÆ°ÁêÜÂëòÊ†áÁ≠æÈ°µ
        function showAdminTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÂÜÖÂÆπ
            document.querySelectorAll('#adminPanelModal .tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('#adminPanelModal .tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÊåáÂÆöÊ†áÁ≠æÂÜÖÂÆπ
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // ÊøÄÊ¥ªÂØπÂ∫îÁöÑÊ†áÁ≠æÊåâÈíÆ - ‰ΩøÁî®event.targetÂ¶ÇÊûúÂèØÁî®ÔºåÂê¶ÂàôÊü•ÊâæÊåâÈíÆ
            const targetBtn = event ? event.target : document.querySelector(`[onclick="showAdminTab('${tabName}')"]`);
            if (targetBtn) {
                targetBtn.classList.add('active');
            }
            
            // Ê†πÊçÆÊ†áÁ≠æÂä†ËΩΩÁõ∏Â∫îÊï∞ÊçÆ
            if (tabName === 'overview') {
                loadSystemStats();
            } else if (tabName === 'owners') {
                loadShopOwnersStats();
            } else if (tabName === 'shops') {
                loadAllShopsMonitor();
            }
        }

        // Âä†ËΩΩÁ≥ªÁªüÁªüËÆ°
        async function loadSystemStats() {
            try {
                const response = await fetch('/api/admin/system-stats', {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    const stats = data.stats;
                    
                    document.getElementById('totalUsers').textContent = stats.totalUsers;
                    document.getElementById('totalShops').textContent = stats.totalShops;
                    document.getElementById('shopOwners').textContent = stats.usersByRole.shop_owner || 0;
                    document.getElementById('employees').textContent = stats.usersByRole.employee || 0;
                } else {
                    console.error('Âä†ËΩΩÁ≥ªÁªüÁªüËÆ°Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≥ªÁªüÁªüËÆ°ÈîôËØØ:', error);
            }
        }

        // Âä†ËΩΩÂ∫ó‰∏ªÁªüËÆ°
        async function loadShopOwnersStats(keyword = '') {
            try {
                const url = keyword ? 
                    `/api/admin/shop-owners-stats?keyword=${encodeURIComponent(keyword)}` : 
                    '/api/admin/shop-owners-stats';

                const response = await fetch(url, {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderOwnersList(data.stats);
                } else {
                    document.getElementById('ownersList').innerHTML = '<div class="error">Âä†ËΩΩÂ∫ó‰∏ªÊï∞ÊçÆÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∫ó‰∏ªÁªüËÆ°ÈîôËØØ:', error);
                document.getElementById('ownersList').innerHTML = '<div class="error">Âä†ËΩΩÂ∫ó‰∏ªÊï∞ÊçÆÈîôËØØ</div>';
            }
        }

        // Ê∏≤ÊüìÂ∫ó‰∏ªÂàóË°®
        function renderOwnersList(owners) {
            const container = document.getElementById('ownersList');
            
            if (owners.length === 0) {
                container.innerHTML = '<div class="empty-state">Ê≤°ÊúâÊâæÂà∞Â∫ó‰∏ªÊï∞ÊçÆ</div>';
                return;
            }
            
            container.innerHTML = owners.map(owner => `
                <div class="owner-item">
                    <div class="owner-header">
                        <div class="owner-info">
                            <h5>${owner.user.username}</h5>
                            <p>üìß ${owner.user.email}</p>
                            <p>üè™ ÁÆ°ÁêÜ ${owner.shopsCount} ‰∏™Â∫óÈì∫ | üë• ÊÄªÂëòÂ∑• ${owner.totalMembers} ‰∫∫</p>
                            <p>üïí Ê≥®ÂÜåÊó∂Èó¥: ${new Date(owner.user.createdAt).toLocaleDateString()}</p>
                            ${owner.user.lastLoginAt ? `<p>üîê ÊúÄÂêéÁôªÂΩï: ${new Date(owner.user.lastLoginAt).toLocaleDateString()}</p>` : ''}
                        </div>
                        <div class="owner-actions">
                            <button class="btn btn-primary" onclick="viewOwnerDetails('${owner.user.id}')">
                                üìä ËØ¶ÊÉÖ
                            </button>
                            <button class="btn ${owner.user.status === 'suspended' ? 'btn-success' : 'btn-warning'}" 
                                    onclick="toggleOwnerStatus('${owner.user.id}', '${owner.user.status === 'suspended' ? 'active' : 'suspended'}')">
                                ${owner.user.status === 'suspended' ? '‚úÖ ÂêØÁî®' : '‚è∏Ô∏è Á¶ÅÁî®'}
                            </button>
                            <button class="btn btn-danger" onclick="deleteOwner('${owner.user.id}', '${owner.user.username}')">
                                üóëÔ∏è Âà†Èô§
                            </button>
                        </div>
                    </div>
                    ${owner.shops.length > 0 ? `
                        <div class="owner-shops">
                            <h6>ÁÆ°ÁêÜÁöÑÂ∫óÈì∫:</h6>
                            <div class="shops-list">
                                ${owner.shops.map(shop => `
                                    <span class="shop-tag">
                                        ${shop.name} 
                                        <span class="shop-status status-${shop.status}">${shop.status}</span>
                                        (${shop.memberCount}‰∫∫)
                                    </span>
                                `).join('')}
                            </div>
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }

        // ÊêúÁ¥¢Â∫ó‰∏ª
        function searchShopOwners() {
            const keyword = document.getElementById('ownerSearch').value.trim();
            loadShopOwnersStats(keyword);
        }

        // Êü•ÁúãÂ∫ó‰∏ªËØ¶ÊÉÖ
        async function viewOwnerDetails(ownerId) {
            try {
                const response = await fetch(`/api/admin/shop-owner/${ownerId}`, {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showOwnerDetailsModal(data);
                } else {
                    alert('Ëé∑ÂèñÂ∫ó‰∏ªËØ¶ÊÉÖÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂ∫ó‰∏ªËØ¶ÊÉÖÈîôËØØ:', error);
                alert('Ëé∑ÂèñÂ∫ó‰∏ªËØ¶ÊÉÖÈîôËØØ');
            }
        }

        // ÊòæÁ§∫Â∫ó‰∏ªËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function showOwnerDetailsModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            modal.innerHTML = `
                <div class="modal-content owner-details-modal">
                    <div class="modal-header">
                        <h3>üë§ Â∫ó‰∏ªËØ¶ÊÉÖ - ${data.owner.username}</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            <h5>üìã Âü∫Êú¨‰ø°ÊÅØ</h5>
                            <p><strong>Áî®Êà∑Âêç:</strong> ${data.owner.username}</p>
                            <p><strong>ÈÇÆÁÆ±:</strong> ${data.owner.email}</p>
                            <p><strong>ËßíËâ≤:</strong> ${data.owner.role}</p>
                            <p><strong>Áä∂ÊÄÅ:</strong> <span class="shop-status status-${data.owner.status || 'active'}">${data.owner.status || 'active'}</span></p>
                            <p><strong>Ê≥®ÂÜåÊó∂Èó¥:</strong> ${new Date(data.owner.createdAt).toLocaleString()}</p>
                            ${data.owner.lastLoginAt ? `<p><strong>ÊúÄÂêéÁôªÂΩï:</strong> ${new Date(data.owner.lastLoginAt).toLocaleString()}</p>` : ''}
                        </div>
                        
                        <div class="detail-section">
                            <h5>üè™ Â∫óÈì∫ËØ¶ÊÉÖ (${data.shopsCount}‰∏™)</h5>
                            ${data.shops.map(shop => `
                                <div class="shop-detail-item" style="border: 1px solid #e1e5e9; padding: 15px; margin: 10px 0; border-radius: 8px;">
                                    <h6>${shop.name} <span class="shop-status status-${shop.status}">${shop.status}</span></h6>
                                    <p><strong>ÂüüÂêç:</strong> ${shop.domain}</p>
                                    <p><strong>ÂàõÂª∫Êó∂Èó¥:</strong> ${new Date(shop.createdAt).toLocaleString()}</p>
                                    <p><strong>ÊàêÂëòÊï∞:</strong> ${shop.memberCount}‰∫∫</p>
                                    
                                    ${shop.members.length > 0 ? `
                                        <div style="margin-top: 10px;">
                                            <strong>ÊàêÂëòÂàóË°®:</strong>
                                            <div class="member-list">
                                                ${shop.members.map(member => 
                                                    `<span class="member-tag">${member.username} (${member.shopRole})</span>`
                                                ).join('')}
                                            </div>
                                        </div>
                                    ` : '<p>ÊöÇÊó†ÂÖ∂‰ªñÊàêÂëò</p>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ÂàáÊç¢Â∫ó‰∏ªÁä∂ÊÄÅ
        async function toggleOwnerStatus(ownerId, newStatus) {
            const action = newStatus === 'active' ? 'ÂêØÁî®' : 'Á¶ÅÁî®';
            
            if (!confirm(`Á°ÆÂÆöË¶Å${action}ËØ•Â∫ó‰∏ªË¥¶Âè∑ÂêóÔºüËøôÂ∞ÜÂêåÊó∂ÂΩ±ÂìçÂÖ∂ÁÆ°ÁêÜÁöÑÊâÄÊúâÂ∫óÈì∫„ÄÇ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/admin/shop-owner/${ownerId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ status: newStatus })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadShopOwnersStats(); // Âà∑Êñ∞ÂàóË°®
                } else {
                    const error = await response.json();
                    alert(`Êìç‰ΩúÂ§±Ë¥•: ${error.error}`);
                }
            } catch (error) {
                console.error('ÂàáÊç¢Â∫ó‰∏ªÁä∂ÊÄÅÈîôËØØ:', error);
                alert('Êìç‰ΩúÂ§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Âà†Èô§Â∫ó‰∏ª
        async function deleteOwner(ownerId, username) {
            const confirmText = 'DELETE_ALL_DATA';
            const userInput = prompt(`Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Â∫ó‰∏ª "${username}" ÂèäÂÖ∂ÊâÄÊúâÂ∫óÈì∫ÂíåÊï∞ÊçÆÔºåÊó†Ê≥ïÊÅ¢Â§çÔºÅ\n\nÂ¶ÇÊûúÁ°ÆÂÆöË¶ÅÂà†Èô§ÔºåËØ∑ËæìÂÖ•: ${confirmText}`);
            
            if (userInput !== confirmText) {
                alert('ÂèñÊ∂àÂà†Èô§Êìç‰Ωú');
                return;
            }

            try {
                const response = await fetch(`/api/admin/shop-owner/${ownerId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ confirm: confirmText })
                });

                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadShopOwnersStats(); // Âà∑Êñ∞ÂàóË°®
                    loadSystemStats(); // Âà∑Êñ∞Á≥ªÁªüÁªüËÆ°
                } else {
                    const error = await response.json();
                    alert(`Âà†Èô§Â§±Ë¥•: ${error.error}`);
                }
            } catch (error) {
                console.error('Âà†Èô§Â∫ó‰∏ªÈîôËØØ:', error);
                alert('Âà†Èô§Â§±Ë¥•ÔºåËØ∑ÈáçËØï');
            }
        }

        // Âä†ËΩΩÊâÄÊúâÂ∫óÈì∫ÁõëÊéß
        async function loadAllShopsMonitor() {
            try {
                const response = await fetch('/api/admin/shops', {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    renderShopsMonitor(data.shops);
                } else {
                    document.getElementById('shopsMonitor').innerHTML = '<div class="error">Âä†ËΩΩÂ∫óÈì∫Êï∞ÊçÆÂ§±Ë¥•</div>';
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∫óÈì∫ÁõëÊéßÈîôËØØ:', error);
                document.getElementById('shopsMonitor').innerHTML = '<div class="error">Âä†ËΩΩÂ∫óÈì∫Êï∞ÊçÆÈîôËØØ</div>';
            }
        }

        // Ê∏≤ÊüìÂ∫óÈì∫ÁõëÊéßÂàóË°®
        function renderShopsMonitor(shops) {
            const container = document.getElementById('shopsMonitor');
            
            if (shops.length === 0) {
                container.innerHTML = '<div class="empty-state">ÊöÇÊó†Â∫óÈì∫Êï∞ÊçÆ</div>';
                return;
            }
            
            container.innerHTML = shops.map(shop => `
                <div class="shop-monitor-item">
                    <div class="shop-monitor-info">
                        <h6>${shop.name}</h6>
                        <p>üåê ${shop.domain}</p>
                        <p>üë§ Â∫ó‰∏ªID: ${shop.ownerId}</p>
                        <p>üïí ÂàõÂª∫Êó∂Èó¥: ${new Date(shop.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="shop-monitor-actions">
                        <span class="shop-status status-${shop.status}">${shop.status}</span>
                    </div>
                </div>
            `).join('');
        }

        // Âà∑Êñ∞ÁÆ°ÁêÜÂëòÊï∞ÊçÆ
        function refreshAdminData() {
            if (currentUser.role !== 'super_admin') return;
            
            loadSystemStats();
            loadShopOwnersStats();
            loadAllShopsMonitor();
            
            // ÊòæÁ§∫Âà∑Êñ∞ÊàêÂäüÊèêÁ§∫
            const btn = event.target;
            const originalText = btn.textContent;
            btn.textContent = '‚úÖ Â∑≤Âà∑Êñ∞';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.textContent = originalText;
                btn.disabled = false;
            }, 1500);
        }
        
        // Êü•ÁúãÊé®ÂπøÊåáÂçó
        function openPromotionGuide() {
            alert('Êé®ÂπøÊåáÂçóÔºö\\n\\n1. Â§çÂà∂ÊÇ®ÁöÑ‰∏ìÂ±ûÊé®ÂπøÈìæÊé•\\n2. ÂàÜ‰∫´ÁªôÊúãÂèãÂíåÂêå‰∫ã\\n3. ÊúãÂèãÈÄöËøáÈìæÊé•Ê≥®ÂÜåÂêéÔºåÊÇ®Ëé∑Âæó10%‰Ω£Èáë\\n4. ‰Ω£ÈáëÂÆûÊó∂Âà∞Ë¥¶ÔºåÈïøÊúüÊúâÊïà\\n\\nÂø´ÂéªÂàÜ‰∫´ÂêßÔºÅ');
        }
        
        // Âä†ËΩΩÊé®ÂπøÊï∞ÊçÆ
        async function loadPromotionData() {
            try {
                // ËøôÈáåÂèØ‰ª•Ë∞ÉÁî®APIËé∑ÂèñÊé®ÂπøÊï∞ÊçÆ
                // const response = await fetch('/api/promotion/stats', {
                //     headers: { 'X-Session-Id': currentSession }
                // });
                // const data = await response.json();
                
                // ÊöÇÊó∂‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆ
                const stats = {
                    referralCount: 0,
                    totalCommission: 0,
                    monthlyCommission: 0
                };
                
                // Êõ¥Êñ∞ÁªüËÆ°Êï∞ÊçÆÊòæÁ§∫
                document.querySelector('.stats-grid .stat-item:nth-child(1) .stat-number').textContent = stats.referralCount;
                document.querySelector('.stats-grid .stat-item:nth-child(2) .stat-number').textContent = `Ôø•${stats.totalCommission}`;
                document.querySelector('.stats-grid .stat-item:nth-child(3) .stat-number').textContent = `Ôø•${stats.monthlyCommission}`;
                
                // ÂàùÂßãÂåñ‰ª∑Ê†ºË°®
                initializePriceTable();
                
            } catch (error) {
                console.error('Âä†ËΩΩÊé®ÂπøÊï∞ÊçÆÂ§±Ë¥•:', error);
            }
        }

        // ============ ‰ª∑Ê†ºËÆ°ÁÆóÂäüËÉΩ ============
        
        // ÂØπÊï∞ÂÆö‰ª∑Ê®°ÂûãÔºöy = 200x + 2600 * ln(x + 1)
        function calculateTotalPrice(quantity) {
            if (quantity <= 0) return 0;
            return Math.round(200 * quantity + 2600 * Math.log(quantity + 1));
        }
        
        // ÂàùÂßãÂåñ‰ª∑Ê†ºË°®Ôºà1-8Â•óÔºâ
        function initializePriceTable() {
            const tableBody = document.getElementById('priceTableBody');
            tableBody.innerHTML = '';
            
            for (let i = 1; i <= 8; i++) {
                const totalPrice = calculateTotalPrice(i);
                const unitPrice = Math.round(totalPrice / i);
                const originalPrice = 2000 * i;
                const savings = originalPrice - totalPrice;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${i}Â•ó</td>
                    <td class="total-price">¬•${totalPrice.toLocaleString()}</td>
                    <td>¬•${unitPrice.toLocaleString()}</td>
                    <td class="savings">${savings > 0 ? '¬•' + savings.toLocaleString() : '¬•0'}</td>
                `;
                tableBody.appendChild(row);
            }
        }
        
        // ËÆ°ÁÆóÂô®ËæìÂÖ•Êï∞Â≠ó
        function inputNumber(num) {
            const input = document.getElementById('quantityInput');
            const currentValue = input.value;
            
            if (currentValue === '0' || currentValue === '') {
                input.value = num;
            } else if (currentValue.length < 3) { // ÈôêÂà∂ÊúÄÂ§ö3‰ΩçÊï∞
                input.value = currentValue + num;
            }
            
            calculatePrice();
        }
        
        // Ê∏ÖÈô§ËæìÂÖ•
        function clearInput() {
            document.getElementById('quantityInput').value = '';
            resetCalculatorResult();
        }
        
        // ÈÄÄÊ†ºÂà†Èô§
        function backspace() {
            const input = document.getElementById('quantityInput');
            const currentValue = input.value;
            
            if (currentValue.length > 0) {
                input.value = currentValue.slice(0, -1);
                calculatePrice();
            }
        }
        
        // ËÆ°ÁÆó‰ª∑Ê†º
        function calculatePrice() {
            const input = document.getElementById('quantityInput');
            const quantity = parseInt(input.value) || 0;
            
            if (quantity <= 0 || quantity > 999) {
                resetCalculatorResult();
                return;
            }
            
            const totalPrice = calculateTotalPrice(quantity);
            const unitPrice = Math.round(totalPrice / quantity);
            const originalPrice = 2000 * quantity;
            const savings = originalPrice - totalPrice;
            
            // Êõ¥Êñ∞ÁªìÊûúÊòæÁ§∫
            document.getElementById('resultQuantity').textContent = `${quantity}Â•ó`;
            document.getElementById('resultPrice').textContent = `¬•${totalPrice.toLocaleString()}`;
            document.getElementById('resultUnitPrice').textContent = `¬•${unitPrice.toLocaleString()}`;
            document.getElementById('resultSavings').textContent = savings > 0 ? `¬•${savings.toLocaleString()}` : '¬•0';
        }
        
        // ÈáçÁΩÆËÆ°ÁÆóÁªìÊûú
        function resetCalculatorResult() {
            document.getElementById('resultQuantity').textContent = '-';
            document.getElementById('resultPrice').textContent = '¬•-';
            document.getElementById('resultUnitPrice').textContent = '¬•-';
            document.getElementById('resultSavings').textContent = '¬•-';
        }

        // ÁôªÂΩïË°®ÂçïÂ§ÑÁêÜ
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginBtn = document.getElementById('loginBtn');
            
            loginBtn.disabled = true;
            loginBtn.textContent = 'ÁôªÂΩï‰∏≠...';
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    currentUser = data.user;
                    currentSession = data.sessionId;
                    currentShops = data.shops;
                    
                    localStorage.setItem('sessionId', data.sessionId);
                    showMessage('ÁôªÂΩïÊàêÂäüÔºÅ', 'success');
                    
                    setTimeout(() => {
                        showMainInterface();
                    }, 1000);
                } else {
                    showMessage(data.error || 'ÁôªÂΩïÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showMessage('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                console.error('ÁôªÂΩïÈîôËØØ:', error);
            } finally {
                loginBtn.disabled = false;
                loginBtn.textContent = 'ÁôªÂΩï';
            }
        });

        // Ê≥®ÂÜåË°®ÂçïÂ§ÑÁêÜ
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('regUsername').value;
            const email = document.getElementById('regEmail').value;
            const password = document.getElementById('regPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const role = document.getElementById('role').value;
            const registerBtn = document.getElementById('registerBtn');
            
            // È™åËØÅÂØÜÁ†ÅÂåπÈÖç
            if (password !== confirmPassword) {
                showMessage('‰∏§Ê¨°ËæìÂÖ•ÁöÑÂØÜÁ†Å‰∏ç‰∏ÄËá¥', 'error');
                return;
            }
            
            registerBtn.disabled = true;
            registerBtn.textContent = 'Ê≥®ÂÜå‰∏≠...';
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ username, email, password, role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Ê≥®ÂÜåÊàêÂäüÔºÅËØ∑ÁôªÂΩï', 'success');
                    
                    // Ê∏ÖÁ©∫Ê≥®ÂÜåË°®Âçï
                    document.getElementById('registerForm').reset();
                    
                    // 3ÁßíÂêéÂàáÊç¢Âà∞ÁôªÂΩïÁïåÈù¢
                    setTimeout(() => {
                        toggleForms();
                    }, 3000);
                } else {
                    showMessage(data.error || 'Ê≥®ÂÜåÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showMessage('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï', 'error');
                console.error('Ê≥®ÂÜåÈîôËØØ:', error);
            } finally {
                registerBtn.disabled = false;
                registerBtn.textContent = 'Ê≥®ÂÜå';
            }
        });

        // ÂàáÊç¢ÁôªÂΩï/Ê≥®ÂÜåË°®Âçï
        function toggleForms() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            const toggleText = document.getElementById('toggleText');
            const toggleLink = document.getElementById('toggleLink');
            const testAccounts = document.getElementById('testAccounts');
            
            if (loginForm.style.display === 'none') {
                // ÂàáÊç¢Âà∞ÁôªÂΩï
                loginForm.style.display = 'block';
                registerForm.style.display = 'none';
                toggleText.textContent = 'ËøòÊ≤°ÊúâË¥¶Âè∑Ôºü';
                toggleLink.textContent = 'Á´ãÂç≥Ê≥®ÂÜå';
                testAccounts.style.display = 'block';
                document.querySelector('.login-header h1').textContent = 'üè™ ÂÆ¢ÊúçÁÆ°ÁêÜÁ≥ªÁªü';
                document.querySelector('.login-header p').textContent = 'Â§öÂ∫óÈì∫Áªü‰∏ÄÁÆ°ÁêÜÂπ≥Âè∞';
            } else {
                // ÂàáÊç¢Âà∞Ê≥®ÂÜå
                loginForm.style.display = 'none';
                registerForm.style.display = 'block';
                toggleText.textContent = 'Â∑≤ÊúâË¥¶Âè∑Ôºü';
                toggleLink.textContent = 'Á´ãÂç≥ÁôªÂΩï';
                testAccounts.style.display = 'none';
                document.querySelector('.login-header h1').textContent = 'üÜï Áî®Êà∑Ê≥®ÂÜå';
                document.querySelector('.login-header p').textContent = 'ÂàõÂª∫ÊÇ®ÁöÑÁÆ°ÁêÜË¥¶Êà∑';
            }
            
            // Ê∏ÖÁ©∫Ê∂àÊÅØ
            document.getElementById('loginMessage').textContent = '';
            document.getElementById('loginMessage').className = '';
        }

        // ÂàáÊç¢ÈìæÊé•‰∫ã‰ª∂
        document.getElementById('toggleLink').addEventListener('click', (e) => {
            e.preventDefault();
            toggleForms();
        });

        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(message, type) {
            const messageDiv = document.getElementById('loginMessage');
            messageDiv.className = type === 'error' ? 'error-message' : 'success-message';
            messageDiv.textContent = message;
            messageDiv.style.display = 'block';
            
            setTimeout(() => {
                messageDiv.style.display = 'none';
            }, 5000);
        }

        // Âä†ËΩΩÂ∫óÈì∫ÂàóË°®
        function loadShops() {
            const grid = document.getElementById('shopsGrid');
            
            if (currentShops.length === 0) {
                grid.innerHTML = '<div class="empty-state">ÊöÇÊó†Â∫óÈì∫ÔºåËØ∑ÂàõÂª∫Á¨¨‰∏Ä‰∏™Â∫óÈì∫</div>';
                return;
            }
            
            // Ë∞ÉËØïÔºöËæìÂá∫Â∫óÈì∫Êï∞ÊçÆ
            console.log('üîç Ë∞ÉËØïÂ∫óÈì∫Êï∞ÊçÆ:', currentShops.map(shop => ({
                name: shop.name,
                approvalStatus: shop.approvalStatus,
                type: typeof shop.approvalStatus,
                isPending: shop.approvalStatus === 'pending',
                isApproved: shop.approvalStatus === 'approved'
            })));
            
            grid.innerHTML = currentShops.map(shop => {
                const isPending = shop.approvalStatus === 'pending';
                console.log(`üè™ Ê∏≤ÊüìÂ∫óÈì∫ ${shop.name}: approvalStatus="${shop.approvalStatus}", isPending=${isPending}`);
                
                return `
                <div class="shop-card">
                    <div class="shop-header">
                        <h3 class="shop-name">${shop.name}</h3>
                        <span class="shop-role role-${shop.userRole}">${getRoleText(shop.userRole)}</span>
                        ${shop.approvalStatus ? `<span class="shop-status status-${shop.approvalStatus}">${getStatusText(shop.approvalStatus)}</span>` : ''}
                    </div>
                    <div class="shop-domain">${shop.domain}</div>
                    ${shop.description ? `<div class="shop-description">${shop.description}</div>` : ''}
                    <div class="shop-stats">
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">ÂæÖÂõûÂ§ç</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">‰ªäÊó•ÂØπËØù</div>
                        </div>
                        <div class="stat-item">
                            <div class="stat-number">0</div>
                            <div class="stat-label">Âú®Á∫øÂÆ¢Êúç</div>
                        </div>
                    </div>
                    <div class="shop-actions">
                        ${isPending ? `
                            ${shop.userRole === 'owner' ? `
                                <button class="action-btn btn-warning" onclick="editPendingShop('${shop.id}')">
                                    ÁºñËæëÂ∫óÈì∫
                                </button>
                                <button class="action-btn btn-info" onclick="resubmitShop('${shop.id}')">
                                    ÈáçÊñ∞Êèê‰∫§ÂÆ°Ê†∏
                                </button>
                                <button class="action-btn btn-primary" onclick="debugActivateShop('${shop.id}')">
                                    üíé ‰ªòË¥πÂºÄÈÄö (¬•2000)
                                </button>
                            ` : `
                                <button class="action-btn btn-secondary" disabled>
                                    ‚è≥ Á≠âÂæÖÂ∫ó‰∏ªÂÆ°Ê†∏
                                </button>
                            `}
                        ` : `
                            <button class="action-btn btn-primary" onclick="viewShopMessages('${shop.id}')">
                                Êü•ÁúãÊ∂àÊÅØ
                            </button>
                            ${shop.userRole === 'owner' ? `
                                <button class="action-btn btn-secondary" onclick="manageShop('${shop.id}')">
                                    ÁÆ°ÁêÜÂ∫óÈì∫
                                </button>
                                <button class="action-btn btn-info" onclick="generateIntegrationCode('${shop.id}')">
                                    üìã ÁîüÊàê‰ª£Á†Å
                                </button>
                                <button class="action-btn btn-success" onclick="renewShop('${shop.id}')">
                                    üí∞ Áª≠Ë¥π (¬•2000/Âπ¥)
                                </button>
                            ` : shop.userRole === 'manager' ? `
                                <button class="action-btn btn-secondary" onclick="manageShop('${shop.id}')">
                                    ÁÆ°ÁêÜÂ∫óÈì∫
                                </button>
                            ` : ''}
                        `}
                    </div>
                </div>`;
            }).join('');
        }

        // Âä†ËΩΩÊàëÁöÑÂ∫óÈì∫‰ø°ÊÅØ
        async function loadMyShops() {
            try {
                console.log('üîÑ ÂºÄÂßãÂä†ËΩΩÂ∫óÈì∫Êï∞ÊçÆ...');
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    console.log('üì¶ APIËøîÂõûÊï∞ÊçÆ:', data);
                    if (data.success) {
                        currentShops = data.shops || [];
                        console.log('‚úÖ Â∫óÈì∫Êï∞ÊçÆÂä†ËΩΩÂÆåÊàê:', currentShops.length, '‰∏™Â∫óÈì∫');
                        loadShops(); // ÈáçÊñ∞Ê∏≤ÊüìÂ∫óÈì∫ÂàóË°®
                    }
                } else {
                    console.error('‚ùå Âä†ËΩΩÂ∫óÈì∫‰ø°ÊÅØÂ§±Ë¥•:', response.status);
                }
            } catch (error) {
                console.error('‚ùå Âä†ËΩΩÂ∫óÈì∫‰ø°ÊÅØÈîôËØØ:', error);
            }
        }

        // Ëé∑ÂèñËßíËâ≤ÊòæÁ§∫ÊñáÊú¨
        function getRoleText(role) {
            const roleTexts = {
                'owner': 'Â∫ó‰∏ª',
                'manager': 'ÁªèÁêÜ',
                'employee': 'ÂëòÂ∑•'
            };
            return roleTexts[role] || role;
        }

        // Ëé∑ÂèñÁä∂ÊÄÅÊòæÁ§∫ÊñáÊú¨
        function getStatusText(status) {
            const statusTexts = {
                'pending': '‚è≥ ÂæÖÂÆ°Ê†∏',
                'approved': '‚úÖ Â∑≤ÈÄöËøá',
                'rejected': '‚ùå Â∑≤ÊãíÁªù'
            };
            return statusTexts[status] || status;
        }

        // ÁºñËæëÂæÖÂÆ°Ê†∏Â∫óÈì∫
        function editPendingShop(shopId) {
            const shop = currentShops.find(s => s.id === shopId);
            if (!shop) {
                alert('Â∫óÈì∫‰ø°ÊÅØ‰∏çÂ≠òÂú®');
                return;
            }

            // È¢ÑÂ°´ÂÖÖÁºñËæëË°®Âçï
            const form = document.getElementById('createShopForm');
            form.querySelector('[name="name"]').value = shop.name;
            form.querySelector('[name="domain"]').value = shop.domain;
            form.querySelector('[name="description"]').value = shop.description || '';
            
            // ‰øÆÊîπË°®ÂçïÊ†áÈ¢òÂíåÊåâÈíÆ
            document.querySelector('.form-section h4').textContent = '‚úèÔ∏è ÁºñËæëÂ∫óÈì∫‰ø°ÊÅØ';
            const submitBtn = form.querySelector('.submit-btn');
            submitBtn.textContent = 'Êõ¥Êñ∞Â∫óÈì∫';
            submitBtn.onclick = () => updatePendingShop(shopId);
            
            // ÊòæÁ§∫Ë°®Âçï
            document.querySelector('.form-section').style.display = 'block';
            document.querySelector('.form-section').scrollIntoView({ behavior: 'smooth' });
        }

        // Êõ¥Êñ∞ÂæÖÂÆ°Ê†∏Â∫óÈì∫
        async function updatePendingShop(shopId) {
            const form = document.getElementById('createShopForm');
            const formData = new FormData(form);
            
            try {
                const response = await fetch(`/api/shops/${shopId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({
                        name: formData.get('name'),
                        domain: formData.get('domain'),
                        description: formData.get('description')
                    })
                });

                if (response.ok) {
                    alert('‚úÖ Â∫óÈì∫‰ø°ÊÅØÊõ¥Êñ∞ÊàêÂäüÔºÅ\n\nÊÇ®ÁöÑÂ∫óÈì∫‰ø°ÊÅØÂ∑≤Êõ¥Êñ∞ÔºåËØ∑Á≠âÂæÖÁÆ°ÁêÜÂëòÈáçÊñ∞ÂÆ°Ê†∏„ÄÇ');
                    
                    // ÈáçÁΩÆË°®Âçï
                    form.reset();
                    document.querySelector('.form-section h4').textContent = 'üìù ÂàõÂª∫Êñ∞Â∫óÈì∫';
                    const submitBtn = form.querySelector('.submit-btn');
                    submitBtn.textContent = 'ÂàõÂª∫Â∫óÈì∫';
                    submitBtn.onclick = null;
                    document.querySelector('.form-section').style.display = 'none';
                    
                    // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂíåÂ∫óÈì∫ÂàóË°®
                    await loadMyShops();
                } else {
                    const error = await response.json();
                    alert('Êõ¥Êñ∞Â§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('Êõ¥Êñ∞Â∫óÈì∫ÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÈáçÊñ∞Êèê‰∫§ÂÆ°Ê†∏
        async function resubmitShop(shopId) {
            if (!confirm('Á°ÆÂÆöË¶ÅÈáçÊñ∞Êèê‰∫§Ëøô‰∏™Â∫óÈì∫ËøõË°åÂÆ°Ê†∏ÂêóÔºü\n\nÈáçÊñ∞Êèê‰∫§ÂêéÔºåÂÆ°Ê†∏Áä∂ÊÄÅÂ∞ÜÈáçÁΩÆ‰∏∫"ÂæÖÂÆ°Ê†∏"„ÄÇ')) {
                return;
            }

            try {
                const response = await fetch(`/api/shops/${shopId}/resubmit`, {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    alert('‚úÖ ÈáçÊñ∞Êèê‰∫§ÊàêÂäüÔºÅ\n\nÊÇ®ÁöÑÂ∫óÈì∫Â∑≤ÈáçÊñ∞Êèê‰∫§ÂÆ°Ê†∏ÔºåËØ∑Á≠âÂæÖÁÆ°ÁêÜÂëòÂ§ÑÁêÜ„ÄÇ');
                    await loadMyShops(); // ÈáçÊñ∞Âä†ËΩΩÂ∫óÈì∫ÂàóË°®
                } else {
                    const error = await response.json();
                    alert('ÈáçÊñ∞Êèê‰∫§Â§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('ÈáçÊñ∞Êèê‰∫§ÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ============ Â∫óÈì∫Áª≠Ë¥πÂäüËÉΩ ============

        // Â∫óÈì∫Áª≠Ë¥π
        async function renewShop(shopId) {
            const shop = currentShops.find(s => s.id === shopId);
            if (!shop) {
                alert('Â∫óÈì∫‰ø°ÊÅØ‰∏çÂ≠òÂú®');
                return;
            }

            const expiryDate = shop.expiryDate ? new Date(shop.expiryDate).toLocaleDateString() : 'Êú™ËÆæÁΩÆ';
            
            if (!confirm(`Á°ÆÂÆöË¶Å‰∏∫Â∫óÈì∫ "${shop.name}" Áª≠Ë¥πÂêóÔºü\n\nÁª≠Ë¥π‰ª∑Ê†ºÔºö¬•2000/Âπ¥\nÂΩìÂâçÂà∞ÊúüÊó∂Èó¥Ôºö${expiryDate}\nÁª≠Ë¥πÂêéÂ∞ÜÂª∂Èïø1Âπ¥ÊúâÊïàÊúü`)) {
                return;
            }

            try {
                // ÂàõÂª∫Áª≠Ë¥πËÆ¢Âçï
                const response = await fetch(`/api/shops/${shopId}/renew`, {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    showPaymentModal(data.order);
                } else {
                    const error = await response.json();
                    alert('ÂàõÂª∫Áª≠Ë¥πËÆ¢ÂçïÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('Áª≠Ë¥πÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊòæÁ§∫ÊîØ‰ªòÊ®°ÊÄÅÊ°Ü
        function showPaymentModal(order) {
            document.getElementById('renewalOrderId').textContent = order.orderId;
            document.getElementById('renewalShopName').textContent = order.shopName;
            document.getElementById('renewalAmount').textContent = `¬•${order.amount}`;
            
            const expiresAt = new Date(order.expiresAt).toLocaleString();
            document.getElementById('renewalExpiry').textContent = expiresAt;
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('renewalModal').style.display = 'block';
            
            // Â≠òÂÇ®ÂΩìÂâçËÆ¢ÂçïID
            window.currentRenewalOrder = order;
        }

        // ÈÄâÊã©ÊîØ‰ªòÊñπÂºèÂπ∂ÁîüÊàê‰∫åÁª¥Á†Å
        async function selectPaymentMethod(method) {
            if (!window.currentRenewalOrder) {
                alert('ËÆ¢Âçï‰ø°ÊÅØÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÂèëËµ∑Áª≠Ë¥π');
                return;
            }

            try {
                const response = await fetch(`/api/orders/${window.currentRenewalOrder.orderId}/qrcode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({
                        paymentMethod: method
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showQRCode(data.qrData, method);
                } else {
                    const error = await response.json();
                    alert('ÁîüÊàêÊîØ‰ªò‰∫åÁª¥Á†ÅÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('ÁîüÊàê‰∫åÁª¥Á†ÅÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊòæÁ§∫ÊîØ‰ªò‰∫åÁª¥Á†Å
        function showQRCode(qrData, method) {
            const methodName = method === 'alipay' ? 'ÊîØ‰ªòÂÆù' : 'ÂæÆ‰ø°';
            const appName = method === 'alipay' ? 'ÊîØ‰ªòÂÆù' : 'ÂæÆ‰ø°';
            
            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            document.getElementById('paymentMethodName').textContent = methodName;
            document.getElementById('paymentQRCode').src = qrData.qrCodeUrl;
            document.getElementById('paymentAppName').textContent = appName;
            
            // ËÆæÁΩÆÊîØ‰ªòÊñπÂºèÊ†∑Âºè
            const qrSection = document.getElementById('qrCodeSection');
            const qrContainer = qrSection.querySelector('.qr-code-container');
            
            // Ê∏ÖÈô§ÊóßÊ†∑Âºè
            qrContainer.classList.remove('alipay-style', 'wechat-style');
            qrSection.removeAttribute('data-method');
            
            // Â∫îÁî®Êñ∞Ê†∑Âºè
            qrContainer.classList.add(method === 'alipay' ? 'alipay-style' : 'wechat-style');
            qrSection.setAttribute('data-method', method);
            
            // Â≠òÂÇ®ÂΩìÂâçÊîØ‰ªòÊñπÂºèÔºåÁî®‰∫éÂà∑Êñ∞ÂäüËÉΩ
            window.currentPaymentMethod = method;
            
            // Ê∑ªÂä†‰∫åÁª¥Á†ÅÂä†ËΩΩÈîôËØØÂ§ÑÁêÜ
            const qrImg = document.getElementById('paymentQRCode');
            qrImg.onerror = function() {
                console.warn('‰∫åÁª¥Á†ÅÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                // Â§áÁî®ÊñπÊ°àÔºö‰ΩøÁî®ÁÆÄÂçïÁöÑÊñáÊú¨‰∫åÁª¥Á†Å
                this.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('Ê®°Êãü' + methodName + 'ÊîØ‰ªòËÆ¢Âçï:' + qrData.orderId + ' ÈáëÈ¢ù:¬•' + qrData.amount)}`;
            };
            
            // ÈöêËóèÊîØ‰ªòÊñπÂºèÈÄâÊã©ÔºåÊòæÁ§∫‰∫åÁª¥Á†Å
            document.getElementById('paymentMethods').style.display = 'none';
            document.getElementById('qrCodeSection').style.display = 'block';
            
            console.log(`üí≥ ÊòæÁ§∫${methodName}ÊîØ‰ªò‰∫åÁª¥Á†Å:`, qrData.qrCodeUrl);
            
            // ÂºÄÂßãËΩÆËØ¢ËÆ¢ÂçïÁä∂ÊÄÅ
            startPaymentPolling(qrData.orderId);
        }

        // ËΩÆËØ¢ÊîØ‰ªòÁä∂ÊÄÅ
        function startPaymentPolling(orderId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/orders/${orderId}/status`, {
                        headers: {
                            'X-Session-Id': currentSession
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        
                        if (data.order.status === 'paid') {
                            clearInterval(interval);
                            showPaymentSuccess();
                        } else if (data.order.status === 'expired') {
                            clearInterval(interval);
                            alert('ÊîØ‰ªòË∂ÖÊó∂ÔºåËØ∑ÈáçÊñ∞ÂèëËµ∑Áª≠Ë¥π');
                            closeRenewalModal();
                        }
                    }
                } catch (error) {
                    console.error('Êü•ËØ¢ÊîØ‰ªòÁä∂ÊÄÅÈîôËØØ:', error);
                }
            }, 3000); // ÊØè3ÁßíÊü•ËØ¢‰∏ÄÊ¨°

            // Â≠òÂÇ®ÂÆöÊó∂Âô®Ôºå‰ª•‰æøÊ∏ÖÁêÜ
            window.paymentPolling = interval;
        }

        // ÊòæÁ§∫ÊîØ‰ªòÊàêÂäü
        function showPaymentSuccess() {
            document.getElementById('qrCodeSection').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'block';
            
            setTimeout(async () => {
                closeRenewalModal();
                await loadMyShops(); // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂíåÂ∫óÈì∫ÂàóË°®
                alert('üéâ Áª≠Ë¥πÊàêÂäüÔºÅ\n\nÊÇ®ÁöÑÂ∫óÈì∫ÊúâÊïàÊúüÂ∑≤Âª∂Èïø1Âπ¥ÔºåÊÑüË∞¢ÊÇ®ÁöÑÊîØÊåÅÔºÅ');
            }, 2000);
        }

        // Âà∑Êñ∞‰∫åÁª¥Á†Å
        function refreshQRCode() {
            if (!window.currentRenewalOrder || !window.currentPaymentMethod) {
                alert('Êó†Ê≥ïÂà∑Êñ∞‰∫åÁª¥Á†ÅÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©ÊîØ‰ªòÊñπÂºè');
                return;
            }
            
            const refreshBtn = document.querySelector('.refresh-btn');
            const originalText = refreshBtn.textContent;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            refreshBtn.textContent = 'üîÑ Âà∑Êñ∞‰∏≠...';
            refreshBtn.disabled = true;
            
            // ÈáçÊñ∞ÁîüÊàê‰∫åÁª¥Á†Å
            selectPaymentMethod(window.currentPaymentMethod).finally(() => {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }, 500);
            });
        }

        // ÂÖ≥Èó≠Áª≠Ë¥πÊ®°ÊÄÅÊ°Ü
        function closeRenewalModal() {
            document.getElementById('renewalModal').style.display = 'none';
            
            // ÈáçÁΩÆÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
            document.getElementById('paymentMethods').style.display = 'block';
            document.getElementById('qrCodeSection').style.display = 'none';
            document.getElementById('paymentSuccess').style.display = 'none';
            
            // Ê∏ÖÁêÜËΩÆËØ¢
            if (window.paymentPolling) {
                clearInterval(window.paymentPolling);
                window.paymentPolling = null;
            }
            
            window.currentRenewalOrder = null;
        }

        // Ê®°ÊãüÊîØ‰ªòÊàêÂäüÔºàÊµãËØïÁî®Ôºâ
        async function mockPaymentSuccess() {
            if (!window.currentRenewalOrder) {
                alert('Ê≤°ÊúâÂæÖÊîØ‰ªòÁöÑËÆ¢Âçï');
                return;
            }

            try {
                const response = await fetch(`/api/orders/${window.currentRenewalOrder.orderId}/mock-payment`, {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    showPaymentSuccess();
                } else {
                    const error = await response.json();
                    alert('Ê®°ÊãüÊîØ‰ªòÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('Ê®°ÊãüÊîØ‰ªòÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ============ Â∫óÈì∫‰ªòË¥πÂºÄÈÄöÂäüËÉΩ ============

        // Ë∞ÉËØïÂáΩÊï∞ - ÊµãËØïÊåâÈíÆÁÇπÂáª
        function debugActivateShop(shopId) {
            console.log('üîç Ë∞ÉËØï: ‰ªòË¥πÂºÄÈÄöÊåâÈíÆË¢´ÁÇπÂáª', shopId);
            console.log('üîç ÂΩìÂâçÂ∫óÈì∫Êï∞ÊçÆ:', currentShops);
            activateShop(shopId);
        }

        // Â∫óÈì∫‰ªòË¥πÂºÄÈÄö
        async function activateShop(shopId) {
            console.log('üéØ ÂºÄÂßã‰ªòË¥πÂºÄÈÄöÊµÅÁ®ã:', shopId);
            
            // ‰ªéÂΩìÂâçÂä†ËΩΩÁöÑÂ∫óÈì∫Êï∞ÊçÆ‰∏≠Êü•ÊâæÂ∫óÈì∫
            let shop = null;
            if (currentShops && currentShops.length > 0) {
                shop = currentShops.find(s => s.id === shopId);
                console.log('üîç ÊâæÂà∞ÁöÑÂ∫óÈì∫:', shop);
            } else {
                console.error('‚ùå currentShops‰∏∫Á©∫ÊàñÊú™ÂÆö‰πâ:', currentShops);
            }

            if (!shop) {
                alert('Â∫óÈì∫‰∏çÂ≠òÂú®ÊàñÊï∞ÊçÆÊú™Âä†ËΩΩÔºåËØ∑Âà∑Êñ∞È°µÈù¢ÂêéÈáçËØï');
                console.error('‚ùå Shop not found:', shopId, 'Available shops:', currentShops);
                return;
            }

            console.log('‚úÖ Â∫óÈì∫È™åËØÅÈÄöËøáÔºåÊòæÁ§∫Á°ÆËÆ§ÂØπËØùÊ°Ü');
            if (!confirm(`Á°ÆÂÆöË¶Å‰ªòË¥πÂºÄÈÄöÂ∫óÈì∫ "${shop.name}" ÂêóÔºü\n\n‰ªòË¥πÂºÄÈÄö‰ª∑Ê†ºÔºö¬•2000\n‰ªòË¥πÊàêÂäüÂêéÔºåÂ∫óÈì∫Â∞ÜÁ´ãÂç≥ÂÆ°Ê†∏ÈÄöËøáÂπ∂Ëé∑Âæó1Âπ¥ÊúâÊïàÊúü`)) {
                console.log('‚ùå Áî®Êà∑ÂèñÊ∂à‰∫Ü‰ªòË¥πÂºÄÈÄö');
                return;
            }

            console.log('‚úÖ Áî®Êà∑Á°ÆËÆ§‰ªòË¥πÂºÄÈÄöÔºåÂàõÂª∫ËÆ¢Âçï...');
            try {
                // ÂàõÂª∫‰ªòË¥πÂºÄÈÄöËÆ¢Âçï
                const response = await fetch(`/api/shops/${shopId}/activate`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    }
                });

                console.log('üì° APIÂìçÂ∫îÁä∂ÊÄÅ:', response.status);
                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ ËÆ¢ÂçïÂàõÂª∫ÊàêÂäü:', data);
                    showActivationPaymentModal(data.order);
                } else {
                    const error = await response.json();
                    console.error('‚ùå APIÈîôËØØ:', error);
                    alert('ÂàõÂª∫‰ªòË¥πÂºÄÈÄöËÆ¢ÂçïÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('‚ùå ÁΩëÁªúÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊòæÁ§∫‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÊ®°ÊÄÅÊ°Ü
        function showActivationPaymentModal(order) {
            // Â°´ÂÖÖËÆ¢Âçï‰ø°ÊÅØ
            document.getElementById('activationOrderId').textContent = order.orderId;
            document.getElementById('activationShopName').textContent = order.shopName;
            document.getElementById('activationExpiry').textContent = order.expiresAt ? 
                new Date(order.expiresAt).toLocaleString() : 'Êó†';

            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('activationModal').style.display = 'block';
            
            // Â≠òÂÇ®ÂΩìÂâçËÆ¢ÂçïID
            window.currentActivationOrder = order;
        }

        // ÈÄâÊã©‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÊñπÂºèÂπ∂ÁîüÊàê‰∫åÁª¥Á†Å
        async function selectActivationPaymentMethod(method) {
            if (!window.currentActivationOrder) {
                alert('ËÆ¢Âçï‰ø°ÊÅØÂºÇÂ∏∏ÔºåËØ∑ÈáçÊñ∞ÂèëËµ∑‰ªòË¥πÂºÄÈÄö');
                return;
            }

            try {
                const response = await fetch(`/api/activation-orders/${window.currentActivationOrder.orderId}/qrcode`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({
                        paymentMethod: method
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    showActivationQRCode(data.qrData, method);
                } else {
                    const error = await response.json();
                    alert('ÁîüÊàêÊîØ‰ªò‰∫åÁª¥Á†ÅÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('ÁîüÊàê‰ªòË¥πÂºÄÈÄö‰∫åÁª¥Á†ÅÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊòæÁ§∫‰ªòË¥πÂºÄÈÄöÊîØ‰ªò‰∫åÁª¥Á†Å
        function showActivationQRCode(qrData, method) {
            const methodName = method === 'alipay' ? 'ÊîØ‰ªòÂÆù' : 'ÂæÆ‰ø°';
            const appName = method === 'alipay' ? 'ÊîØ‰ªòÂÆù' : 'ÂæÆ‰ø°';
            
            // Êõ¥Êñ∞ÁïåÈù¢ÊòæÁ§∫
            document.getElementById('activationPaymentMethodName').textContent = methodName;
            document.getElementById('activationPaymentQRCode').src = qrData.qrCodeUrl;
            document.getElementById('activationPaymentAppName').textContent = appName;
            
            // ËÆæÁΩÆÊîØ‰ªòÊñπÂºèÊ†∑Âºè
            const qrSection = document.getElementById('activationQrCodeSection');
            const qrContainer = qrSection.querySelector('.qr-code-container');
            
            // Ê∏ÖÈô§ÊóßÊ†∑Âºè
            qrContainer.classList.remove('alipay-style', 'wechat-style');
            qrSection.removeAttribute('data-method');
            
            // Â∫îÁî®Êñ∞Ê†∑Âºè
            qrContainer.classList.add(method === 'alipay' ? 'alipay-style' : 'wechat-style');
            qrSection.setAttribute('data-method', method);
            
            // Â≠òÂÇ®ÂΩìÂâçÊîØ‰ªòÊñπÂºèÔºåÁî®‰∫éÂà∑Êñ∞ÂäüËÉΩ
            window.currentActivationPaymentMethod = method;
            
            // Ê∑ªÂä†‰∫åÁª¥Á†ÅÂä†ËΩΩÈîôËØØÂ§ÑÁêÜ
            const qrImg = document.getElementById('activationPaymentQRCode');
            qrImg.onerror = function() {
                console.warn('‰ªòË¥πÂºÄÈÄö‰∫åÁª¥Á†ÅÂä†ËΩΩÂ§±Ë¥•Ôºå‰ΩøÁî®Â§áÁî®ÊñπÊ°à');
                this.src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent('Ê®°Êãü' + methodName + '‰ªòË¥πÂºÄÈÄöËÆ¢Âçï:' + qrData.orderId + ' ÈáëÈ¢ù:¬•' + qrData.amount)}`;
            };
            
            // ÈöêËóèÊîØ‰ªòÊñπÂºèÈÄâÊã©ÔºåÊòæÁ§∫‰∫åÁª¥Á†Å
            document.getElementById('activationPaymentMethods').style.display = 'none';
            document.getElementById('activationQrCodeSection').style.display = 'block';
            
            console.log(`üíé ÊòæÁ§∫${methodName}‰ªòË¥πÂºÄÈÄöÊîØ‰ªò‰∫åÁª¥Á†Å:`, qrData.qrCodeUrl);
            
            // ÂºÄÂßãËΩÆËØ¢ËÆ¢ÂçïÁä∂ÊÄÅ
            startActivationPaymentPolling(qrData.orderId);
        }

        // ÂºÄÂßã‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÁä∂ÊÄÅËΩÆËØ¢
        function startActivationPaymentPolling(orderId) {
            // Ê∏ÖÁêÜ‰πãÂâçÁöÑËΩÆËØ¢
            if (window.activationPaymentPolling) {
                clearInterval(window.activationPaymentPolling);
            }

            console.log('üîÑ ÂºÄÂßã‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÁä∂ÊÄÅËΩÆËØ¢...');
            
            window.activationPaymentPolling = setInterval(async () => {
                try {
                    const response = await fetch(`/api/activation-orders/${orderId}/status`, {
                        headers: {
                            'X-Session-Id': currentSession
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        const order = data.order;

                        if (order.status === 'paid') {
                            // ÊîØ‰ªòÊàêÂäü
                            clearInterval(window.activationPaymentPolling);
                            window.activationPaymentPolling = null;
                            showActivationPaymentSuccess();
                        } else if (order.status === 'expired') {
                            // ËÆ¢ÂçïËøáÊúü
                            clearInterval(window.activationPaymentPolling);
                            window.activationPaymentPolling = null;
                            alert('ÊîØ‰ªòË∂ÖÊó∂ÔºåËØ∑ÈáçÊñ∞ÂèëËµ∑‰ªòË¥πÂºÄÈÄö');
                            closeActivationModal();
                        }
                    }
                } catch (error) {
                    console.error('‰ªòË¥πÂºÄÈÄöËΩÆËØ¢ÈîôËØØ:', error);
                }
            }, 3000); // ÊØè3ÁßíÊ£ÄÊü•‰∏ÄÊ¨°

            // 30ÂàÜÈíüÂêéÂÅúÊ≠¢ËΩÆËØ¢
            setTimeout(() => {
                if (window.activationPaymentPolling) {
                    clearInterval(window.activationPaymentPolling);
                    window.activationPaymentPolling = null;
                }
            }, 30 * 60 * 1000);
        }

        // ÊòæÁ§∫‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÊàêÂäüÈ°µÈù¢
        function showActivationPaymentSuccess() {
            document.getElementById('activationQrCodeSection').style.display = 'none';
            document.getElementById('activationPaymentSuccess').style.display = 'block';
            
            console.log('üéâ ‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÊàêÂäü');
            
            // 3ÁßíÂêéËá™Âä®ÂÖ≥Èó≠Âπ∂Âà∑Êñ∞Â∫óÈì∫ÂàóË°®
            setTimeout(() => {
                alert('üéâ ‰ªòË¥πÂºÄÈÄöÊàêÂäüÔºÅ\n\nÊÇ®ÁöÑÂ∫óÈì∫Â∑≤Ëá™Âä®ÂÆ°Ê†∏ÈÄöËøáÂπ∂Ëé∑Âæó1Âπ¥ÊúâÊïàÊúüÔºåÊÑüË∞¢ÊÇ®ÁöÑÊîØÊåÅÔºÅ');
                closeActivationModal();
                loadMyShops(); // Âà∑Êñ∞Â∫óÈì∫ÂàóË°®
            }, 1000);
        }

        // Âà∑Êñ∞‰ªòË¥πÂºÄÈÄö‰∫åÁª¥Á†Å
        function refreshActivationQRCode() {
            if (!window.currentActivationOrder || !window.currentActivationPaymentMethod) {
                alert('Êó†Ê≥ïÂà∑Êñ∞‰∫åÁª¥Á†ÅÔºåËØ∑ÈáçÊñ∞ÈÄâÊã©ÊîØ‰ªòÊñπÂºè');
                return;
            }
            
            const refreshBtn = document.querySelector('#activationQrCodeSection .refresh-btn');
            const originalText = refreshBtn.textContent;
            
            // ÊòæÁ§∫Âä†ËΩΩÁä∂ÊÄÅ
            refreshBtn.textContent = 'üîÑ Âà∑Êñ∞‰∏≠...';
            refreshBtn.disabled = true;
            
            // ÈáçÊñ∞ÁîüÊàê‰∫åÁª¥Á†Å
            selectActivationPaymentMethod(window.currentActivationPaymentMethod).finally(() => {
                // ÊÅ¢Â§çÊåâÈíÆÁä∂ÊÄÅ
                setTimeout(() => {
                    refreshBtn.textContent = originalText;
                    refreshBtn.disabled = false;
                }, 500);
            });
        }

        // ÂÖ≥Èó≠‰ªòË¥πÂºÄÈÄöÊ®°ÊÄÅÊ°Ü
        function closeActivationModal() {
            document.getElementById('activationModal').style.display = 'none';
            
            // ÈáçÁΩÆÊ®°ÊÄÅÊ°ÜÁä∂ÊÄÅ
            document.getElementById('activationPaymentMethods').style.display = 'block';
            document.getElementById('activationQrCodeSection').style.display = 'none';
            document.getElementById('activationPaymentSuccess').style.display = 'none';
            
            // Ê∏ÖÁêÜËΩÆËØ¢
            if (window.activationPaymentPolling) {
                clearInterval(window.activationPaymentPolling);
                window.activationPaymentPolling = null;
            }
            
            window.currentActivationOrder = null;
        }

        // Ê®°Êãü‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÊàêÂäüÔºàÊµãËØïÁî®Ôºâ
        async function mockActivationPaymentSuccess() {
            if (!window.currentActivationOrder) {
                alert('Ê≤°ÊúâÂæÖÊîØ‰ªòÁöÑÂºÄÈÄöËÆ¢Âçï');
                return;
            }

            try {
                const response = await fetch(`/api/activation-orders/${window.currentActivationOrder.orderId}/mock-success`, {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('üß™ Ê®°Êãü‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÊàêÂäü:', data);
                    showActivationPaymentSuccess();
                } else {
                    const error = await response.json();
                    alert('Ê®°ÊãüÊîØ‰ªòÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('Ê®°Êãü‰ªòË¥πÂºÄÈÄöÊîØ‰ªòÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ============ ÈõÜÊàê‰ª£Á†ÅÁîüÊàêÂäüËÉΩ ============

        // ÁîüÊàêÂ∫óÈì∫ÁöÑÈõÜÊàê‰ª£Á†Å
        async function generateIntegrationCode(shopId) {
            // ‰ªéÂΩìÂâçÂ∫óÈì∫Êï∞ÊçÆ‰∏≠Êü•ÊâæÂ∫óÈì∫
            let shop = null;
            if (currentShops && currentShops.length > 0) {
                shop = currentShops.find(s => s.id === shopId);
            }

            if (!shop) {
                alert('Â∫óÈì∫‰∏çÂ≠òÂú®ÊàñÊï∞ÊçÆÊú™Âä†ËΩΩ');
                return;
            }

            if (shop.approvalStatus !== 'approved') {
                alert('Âè™ÊúâÂ∑≤ÂÆ°Ê†∏ÈÄöËøáÁöÑÂ∫óÈì∫ÊâçËÉΩÁîüÊàêÈõÜÊàê‰ª£Á†Å');
                return;
            }

            console.log('üîë ÂºÄÂßãÁîüÊàêÈõÜÊàê‰ª£Á†Å:', shop.name);

            try {
                // Ë∞ÉÁî®APIÁîüÊàêÈõÜÊàê‰ª£Á†Å
                const response = await fetch(`/api/shop/${shopId}/generate-code`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({
                        theme: 'default',
                        position: 'bottom-right',
                        welcomeMessage: `Ê¨¢ËøéËÆøÈóÆ${shop.name}ÔºÅÊúâ‰ªÄ‰πàÂèØ‰ª•Â∏ÆÊÇ®ÁöÑÂêóÔºü`
                    })
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('‚úÖ ÈõÜÊàê‰ª£Á†ÅÁîüÊàêÊàêÂäü:', data);
                    showIntegrationCodeModal(data);
                } else {
                    const error = await response.json();
                    alert('ÁîüÊàêÈõÜÊàê‰ª£Á†ÅÂ§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('‚ùå ÁîüÊàêÈõÜÊàê‰ª£Á†ÅÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÊòæÁ§∫ÈõÜÊàê‰ª£Á†ÅÊ®°ÊÄÅÊ°Ü
        function showIntegrationCodeModal(data) {
            // Â°´ÂÖÖÊ®°ÊÄÅÊ°ÜÂÜÖÂÆπ
            document.getElementById('integrationShopName').textContent = data.shop.name;
            document.getElementById('integrationShopId').textContent = data.shop.id;
            document.getElementById('integrationApiKey').textContent = data.shop.apiKey.substring(0, 8) + '...';
            document.getElementById('integrationGeneratedAt').textContent = new Date(data.generatedAt).toLocaleString('zh-CN');
            
            // ÊòæÁ§∫ÈõÜÊàê‰ª£Á†Å
            const codeArea = document.getElementById('integrationCode');
            codeArea.value = data.code;
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('integrationModal').style.display = 'block';
            
            console.log('üìã ÊòæÁ§∫ÈõÜÊàê‰ª£Á†ÅÊ®°ÊÄÅÊ°Ü');
        }

        // Â§çÂà∂ÈõÜÊàê‰ª£Á†ÅÂà∞Ââ™Ë¥¥Êùø
        function copyIntegrationCode() {
            const codeArea = document.getElementById('integrationCode');
            codeArea.select();
            codeArea.setSelectionRange(0, 99999); // ÈÄÇÈÖçÁßªÂä®ËÆæÂ§á

            try {
                document.execCommand('copy');
                
                // ÊòæÁ§∫Â§çÂà∂ÊàêÂäüÊèêÁ§∫
                const copyBtn = document.querySelector('.copy-btn');
                const originalText = copyBtn.textContent;
                copyBtn.textContent = '‚úÖ Â∑≤Â§çÂà∂';
                copyBtn.classList.add('copied');
                
                setTimeout(() => {
                    copyBtn.textContent = originalText;
                    copyBtn.classList.remove('copied');
                }, 2000);
                
                console.log('üìã ÈõÜÊàê‰ª£Á†ÅÂ∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø');
            } catch (err) {
                console.error('Â§çÂà∂Â§±Ë¥•:', err);
                alert('Â§çÂà∂Â§±Ë¥•ÔºåËØ∑ÊâãÂä®ÈÄâÊã©Â§çÂà∂');
            }
        }

        // ÂÖ≥Èó≠ÈõÜÊàê‰ª£Á†ÅÊ®°ÊÄÅÊ°Ü
        function closeIntegrationModal() {
            document.getElementById('integrationModal').style.display = 'none';
        }

        // ÈáçÊñ∞ÁîüÊàêAPIÂØÜÈí•
        async function regenerateApiKey() {
            const shopName = document.getElementById('integrationShopName').textContent;
            const shopId = document.getElementById('integrationShopId').textContent;
            
            if (!confirm(`Á°ÆÂÆöË¶ÅÈáçÊñ∞ÁîüÊàêÂ∫óÈì∫ "${shopName}" ÁöÑAPIÂØÜÈí•ÂêóÔºü\n\nÊ≥®ÊÑèÔºöÈáçÊñ∞ÁîüÊàêÂêéÔºå‰πãÂâçÁöÑÈõÜÊàê‰ª£Á†ÅÂ∞ÜÂ§±ÊïàÔºåÈúÄË¶ÅÊõ¥Êç¢‰∏∫Êñ∞ÁöÑ‰ª£Á†ÅÔºÅ`)) {
                return;
            }

            try {
                const response = await fetch(`/api/shop/${shopId}/regenerate-key`, {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    alert('üîë APIÂØÜÈí•Â∑≤ÈáçÊñ∞ÁîüÊàêÔºÅ\n\nËØ∑ÈáçÊñ∞ÁîüÊàêÈõÜÊàê‰ª£Á†Å‰ª•Ëé∑ÂèñÊúÄÊñ∞ÁöÑÂØÜÈí•„ÄÇ');
                    closeIntegrationModal();
                    console.log('üîë APIÂØÜÈí•ÈáçÊñ∞ÁîüÊàêÊàêÂäü');
                } else {
                    const error = await response.json();
                    alert('ÈáçÊñ∞ÁîüÊàêÂØÜÈí•Â§±Ë¥•: ' + error.error);
                }
            } catch (error) {
                console.error('‚ùå ÈáçÊñ∞ÁîüÊàêÂØÜÈí•ÈîôËØØ:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑ÈáçËØï');
            }
        }

        // ÂàõÂª∫Â∫óÈì∫Ë°®ÂçïÂ§ÑÁêÜ
        document.getElementById('createShopForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('shopName').value;
            const domain = document.getElementById('shopDomain').value;
            const description = document.getElementById('shopDescription').value;
            
            try {
                const response = await fetch('/api/shops', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ name, domain, description })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('üéâ Â∫óÈì∫Áî≥ËØ∑Â∑≤ÊàêÂäüÊèê‰∫§ÔºÅ\n\nÊÇ®ÁöÑÂ∫óÈì∫Áî≥ËØ∑Ê≠£Âú®Á≠âÂæÖÁÆ°ÁêÜÂëòÂÆ°Ê†∏ÔºåÂÆ°Ê†∏ÈÄöËøáÂêéÂç≥ÂèØÂºÄÂßã‰ΩøÁî®ÂÆ¢ÊúçÂäüËÉΩ„ÄÇ\n\nÂÆ°Ê†∏ÁªìÊûúÂ∞ÜÂú®Â∫óÈì∫ÂàóË°®‰∏≠ÂÆûÊó∂ÊòæÁ§∫ÔºåËØ∑ËÄêÂøÉÁ≠âÂæÖ„ÄÇ');
                    // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
                    hideCreateShopModal();
                    // ÈáçÊñ∞Âä†ËΩΩÁî®Êà∑‰ø°ÊÅØÂíåÂ∫óÈì∫ÂàóË°®
                    await validateSession(currentSession);
                    document.getElementById('createShopForm').reset();
                } else {
                    alert(data.error || 'ÂàõÂª∫Â§±Ë¥•');
                }
            } catch (error) {
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                console.error('ÂàõÂª∫Â∫óÈì∫ÈîôËØØ:', error);
            }
        });

        // Ê∑ªÂä†ÂëòÂ∑•Ë°®ÂçïÂ§ÑÁêÜ
        document.getElementById('addEmployeeFormData').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const username = document.getElementById('employeeUsername').value;
            const role = document.getElementById('employeeRole').value;
            
            try {
                const response = await fetch(`/api/shops/${currentManagedShop.id}/employees`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ username, role })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('‚úÖ ÂëòÂ∑•Ê∑ªÂä†ÊàêÂäüÔºÅ\n\nËØ•ÂëòÂ∑•Áé∞Âú®ÂèØ‰ª•ÁôªÂΩïÁ≥ªÁªüÂπ∂Â§ÑÁêÜÊú¨Â∫óÈì∫ÁöÑÂÆ¢ÊúçÂ∑•‰Ωú„ÄÇ\nÂëòÂ∑•ÂèØ‰ΩøÁî®ÂéüÊúâË¥¶Âè∑ÁôªÂΩïÁÆ°ÁêÜÂêéÂè∞Êü•ÁúãÂíåÂõûÂ§çÂÆ¢Êà∑Ê∂àÊÅØ„ÄÇ');
                    cancelAddEmployee();
                    loadEmployees(currentManagedShop.id);
                } else {
                    alert(data.error || 'Ê∑ªÂä†Â§±Ë¥•');
                }
            } catch (error) {
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                console.error('Ê∑ªÂä†ÂëòÂ∑•ÈîôËØØ:', error);
            }
        });

        // Â∫óÈì∫ËÆæÁΩÆË°®ÂçïÂ§ÑÁêÜ
        document.getElementById('shopSettingsForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const name = document.getElementById('editShopName').value;
            const domain = document.getElementById('editShopDomain').value;
            
            try {
                const response = await fetch(`/api/shops/${currentManagedShop.id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ name, domain })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('Â∫óÈì∫ËÆæÁΩÆÊõ¥Êñ∞ÊàêÂäüÔºÅ');
                    // ÈáçÊñ∞Âä†ËΩΩÂ∫óÈì∫ÂàóË°®
                    await validateSession(currentSession);
                    // Êõ¥Êñ∞ÂΩìÂâçÁÆ°ÁêÜÁöÑÂ∫óÈì∫‰ø°ÊÅØ
                    currentManagedShop.name = name;
                    currentManagedShop.domain = domain;
                    document.getElementById('manageShopTitle').textContent = `üè™ ÁÆ°ÁêÜÂ∫óÈì∫ - ${name}`;
                } else {
                    alert(data.error || 'Êõ¥Êñ∞Â§±Ë¥•');
                }
            } catch (error) {
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                console.error('Êõ¥Êñ∞Â∫óÈì∫ËÆæÁΩÆÈîôËØØ:', error);
            }
        });

        // Êü•ÁúãÂ∫óÈì∫Ê∂àÊÅØ
        function viewShopMessages(shopId) {
            const shop = currentShops.find(s => s.id === shopId);
            if (!shop) return;
            
            const messagesPanel = document.getElementById('messagesPanel');
            const messagesBody = messagesPanel.querySelector('.messages-body');
            
            messagesPanel.querySelector('.messages-header h3').textContent = `üì® ${shop.name} - ÂÆ¢ÊúçÊ∂àÊÅØ`;
            messagesBody.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÊ∂àÊÅØ...</div>';
            
            // ËøôÈáåÂèØ‰ª•Âä†ËΩΩÂÖ∑‰ΩìÁöÑÂ∫óÈì∫Ê∂àÊÅØ
            setTimeout(() => {
                messagesBody.innerHTML = `
                    <div class="empty-state">
                        ÊöÇÊó†Ê∂àÊÅØ<br>
                        <small>ËØ•Â∫óÈì∫ËøòÊ≤°ÊúâÊî∂Âà∞ÂÆ¢Êà∑Ê∂àÊÅØ</small>
                    </div>
                `;
            }, 1000);
        }

        // ÁÆ°ÁêÜÂ∫óÈì∫
        function manageShop(shopId) {
            const shop = currentShops.find(s => s.id === shopId);
            if (!shop) return;
            
            currentManagedShop = shop;
            document.getElementById('manageShopTitle').textContent = `üè™ ÁÆ°ÁêÜÂ∫óÈì∫ - ${shop.name}`;
            
            // Ê†πÊçÆÁî®Êà∑ËßíËâ≤ÊòæÁ§∫‰∏çÂêåÁöÑÊ†áÁ≠æ
            const tabNav = document.querySelector('#manageShopModal .tab-nav');
            const userRole = shop.userRole;
            
            if (userRole === 'owner') {
                // Â∫ó‰∏ªÔºöÊòæÁ§∫ÊâÄÊúâÊ†áÁ≠æ
                tabNav.innerHTML = `
                    <button class="tab-btn active" onclick="showTab('employees')">üë• ÂëòÂ∑•ÁÆ°ÁêÜ</button>
                    <button class="tab-btn" onclick="showTab('settings')">‚öôÔ∏è Â∫óÈì∫ËÆæÁΩÆ</button>
                `;
                // Â°´ÂÖÖÂ∫óÈì∫ËÆæÁΩÆË°®Âçï
                document.getElementById('editShopName').value = shop.name;
                document.getElementById('editShopDomain').value = shop.domain;
                // ÈªòËÆ§ÊòæÁ§∫ÂëòÂ∑•ÁÆ°ÁêÜÊ†áÁ≠æ
                showTab('employees');
            } else if (userRole === 'manager') {
                // ÁªèÁêÜÔºöÂè™ÊòæÁ§∫ÂëòÂ∑•ÁÆ°ÁêÜÊ†áÁ≠æ
                tabNav.innerHTML = `
                    <button class="tab-btn active" onclick="showTab('employees')">üë• ÂëòÂ∑•ÁÆ°ÁêÜ</button>
                `;
                // ÈªòËÆ§ÊòæÁ§∫ÂëòÂ∑•ÁÆ°ÁêÜÊ†áÁ≠æ
                showTab('employees');
            } else {
                // ÊôÆÈÄöÂëòÂ∑•ÔºöÂè™ÊòæÁ§∫ÂÆ¢ÊúçÊ∂àÊÅØÂäüËÉΩÔºå‰∏çÂ∫îËØ•ËøõÂÖ•ÁÆ°ÁêÜÁïåÈù¢
                alert('ÊÇ®Ê≤°ÊúâÁÆ°ÁêÜÊùÉÈôêÔºåÂè™ËÉΩÊü•ÁúãÂíåÂõûÂ§çÂÆ¢ÊúçÊ∂àÊÅØ');
                return;
            }
            
            // Âä†ËΩΩÂëòÂ∑•ÂàóË°®
            loadEmployees(shopId);
            
            // ÊòæÁ§∫Ê®°ÊÄÅÊ°Ü
            document.getElementById('manageShopModal').style.display = 'block';
        }

        // ÈöêËóèÂ∫óÈì∫ÁÆ°ÁêÜÊ®°ÊÄÅÊ°Ü
        function hideManageShopModal() {
            document.getElementById('manageShopModal').style.display = 'none';
            currentManagedShop = null;
        }

        // ÂàáÊç¢Ê†áÁ≠æÈ°µ
        function showTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÂÜÖÂÆπ
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // ÁßªÈô§ÊâÄÊúâÊ†áÁ≠æÊåâÈíÆÁöÑÊøÄÊ¥ªÁä∂ÊÄÅ
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // ÊòæÁ§∫ÊåáÂÆöÊ†áÁ≠æÂÜÖÂÆπ
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // ÊøÄÊ¥ªÂØπÂ∫îÁöÑÊ†áÁ≠æÊåâÈíÆ
            event.target.classList.add('active');
        }

        // ÊòæÁ§∫Ê∑ªÂä†ÂëòÂ∑•Ë°®Âçï
        function showAddEmployeeForm() {
            const shop = currentManagedShop;
            if (!shop || shop.userRole !== 'owner') {
                alert('Âè™ÊúâÂ∫ó‰∏ªÂèØ‰ª•Ê∑ªÂä†ÂëòÂ∑•');
                return;
            }
            document.getElementById('addEmployeeForm').style.display = 'block';
        }

        // ÂèñÊ∂àÊ∑ªÂä†ÂëòÂ∑•
        function cancelAddEmployee() {
            document.getElementById('addEmployeeForm').style.display = 'none';
            document.getElementById('addEmployeeFormData').reset();
        }

        // Âä†ËΩΩÂëòÂ∑•ÂàóË°®
        async function loadEmployees(shopId) {
            const employeesList = document.getElementById('employeesList');
            employeesList.innerHTML = '<div class="loading">Ê≠£Âú®Âä†ËΩΩÂëòÂ∑•‰ø°ÊÅØ...</div>';
            
            try {
                const response = await fetch(`/api/shops/${shopId}/employees`, {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    displayEmployees(data.employees);
                } else {
                    employeesList.innerHTML = `<div class="error">Âä†ËΩΩÂ§±Ë¥•: ${data.error}</div>`;
                }
            } catch (error) {
                employeesList.innerHTML = '<div class="error">ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï</div>';
                console.error('Âä†ËΩΩÂëòÂ∑•ÂàóË°®ÈîôËØØ:', error);
            }
        }

        // ÊòæÁ§∫ÂëòÂ∑•ÂàóË°®
        function displayEmployees(employees) {
            const employeesList = document.getElementById('employeesList');
            const shop = currentManagedShop;
            const isOwner = shop && shop.userRole === 'owner';
            
            if (employees.length === 0) {
                employeesList.innerHTML = '<div class="empty-state">ÊöÇÊó†ÂëòÂ∑•ÔºåÁÇπÂáª"‚ûï Ê∑ªÂä†ÂëòÂ∑•"ÂºÄÂßãÊãõÂãüÂÆ¢ÊúçÂõ¢Èòü</div>';
                return;
            }
            
            const html = employees.map(employee => `
                <div class="employee-item">
                    <div class="employee-info">
                        <h6>${employee.username}</h6>
                        <div class="employee-role">
                            <span class="role-badge role-${employee.role}">
                                ${getRoleText(employee.role)}
                            </span>
                            <span class="role-permissions">
                                ${employee.role === 'manager' ? 'üíº ÁÆ°ÁêÜÊùÉÈôê + ÂÆ¢ÊúçÊùÉÈôê' : 'üí¨ ÂÆ¢ÊúçÊùÉÈôê'}
                            </span>
                        </div>
                        <small>Âä†ÂÖ•Êó∂Èó¥: ${new Date(employee.joinedAt).toLocaleDateString()}</small>
                    </div>
                    ${isOwner ? `
                        <div class="employee-actions">
                            <button class="btn btn-small" onclick="editEmployee('${employee.id}')">ÁºñËæë</button>
                            <button class="btn btn-small btn-danger" onclick="removeEmployee('${employee.id}')">ÁßªÈô§</button>
                        </div>
                    ` : `
                        <div class="employee-actions">
                            <span class="role-badge">Âè™ËØª</span>
                        </div>
                    `}
                </div>
            `).join('');
            
            employeesList.innerHTML = html;
            
            // Êõ¥Êñ∞Ê∑ªÂä†ÂëòÂ∑•ÊåâÈíÆÁöÑÊòæÁ§∫
            const addEmployeeBtn = document.querySelector('.section-header .btn');
            if (addEmployeeBtn) {
                if (isOwner) {
                    addEmployeeBtn.style.display = 'inline-block';
                } else {
                    addEmployeeBtn.style.display = 'none';
                }
            }
        }

        // ÁºñËæëÂëòÂ∑•
        function editEmployee(employeeId) {
            alert('ÁºñËæëÂëòÂ∑•ÂäüËÉΩÂºÄÂèë‰∏≠...');
        }

        // ÁßªÈô§ÂëòÂ∑•
        async function removeEmployee(employeeId) {
            const shop = currentManagedShop;
            if (!shop || shop.userRole !== 'owner') {
                alert('Âè™ÊúâÂ∫ó‰∏ªÂèØ‰ª•ÁßªÈô§ÂëòÂ∑•');
                return;
            }
            
            if (!confirm('Á°ÆÂÆöË¶ÅÁßªÈô§Ëøô‰∏™ÂëòÂ∑•ÂêóÔºü')) return;
            
            try {
                const response = await fetch(`/api/shops/${currentManagedShop.id}/employees/${employeeId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    loadEmployees(currentManagedShop.id);
                } else {
                    alert('ÁßªÈô§Â§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
                console.error('ÁßªÈô§ÂëòÂ∑•ÈîôËØØ:', error);
            }
        }

        // ÂÖ®Â±ÄÂèòÈáè
        let currentManagedShop = null;

        // ÊòæÁ§∫ÂàõÂª∫Â∫óÈì∫Ê®°ÊÄÅÊ°Ü
        function showCreateShopModal() {
            document.getElementById('createShopModal').style.display = 'block';
        }

        // ÈöêËóèÂàõÂª∫Â∫óÈì∫Ê®°ÊÄÅÊ°Ü
        function hideCreateShopModal() {
            document.getElementById('createShopModal').style.display = 'none';
            document.getElementById('createShopForm').reset();
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const createModal = document.getElementById('createShopModal');
            const manageModal = document.getElementById('manageShopModal');
            
            if (event.target === createModal) {
                hideCreateShopModal();
            } else if (event.target === manageModal) {
                hideManageShopModal();
            }
        }

        // ÁôªÂá∫
        async function logout() {
            try {
                await fetch('/api/auth/logout', {
                    method: 'POST',
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
            } catch (error) {
                console.error('ÁôªÂá∫ÈîôËØØ:', error);
            } finally {
                localStorage.removeItem('sessionId');
                currentUser = null;
                currentSession = null;
                currentShops = [];
                showLoginInterface();
            }
        }

        // ============ Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢ÊùøÂäüËÉΩ ============

        let adminData = {
            systemStats: null,
            shopOwnersStats: [],
            allShops: []
        };

        // ÊòæÁ§∫Ë∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø
        function showAdminPanel() {
            if (currentUser.role !== 'super_admin') {
                alert('ÊùÉÈôê‰∏çË∂≥');
                return;
            }
            
            document.getElementById('adminPanelModal').style.display = 'block';
            loadAdminData();
        }

        // ÈöêËóèË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÈù¢Êùø
        function hideAdminPanel() {
            document.getElementById('adminPanelModal').style.display = 'none';
        }

        // ÊòæÁ§∫ÁÆ°ÁêÜÂëòÊ†áÁ≠æÈ°µ
        function showAdminTab(tabName) {
            // ÈöêËóèÊâÄÊúâÊ†áÁ≠æÈ°µ
            const tabs = document.querySelectorAll('#adminPanelModal .tab-content');
            tabs.forEach(tab => tab.classList.remove('active'));
            
            // ÁßªÈô§ÊâÄÊúâÊåâÈíÆÁöÑactiveÁä∂ÊÄÅ
            const buttons = document.querySelectorAll('#adminPanelModal .tab-btn');
            buttons.forEach(btn => btn.classList.remove('active'));
            
            // ÊòæÁ§∫ÈÄâ‰∏≠ÁöÑÊ†áÁ≠æÈ°µ
            document.getElementById(tabName + 'Tab').classList.add('active');
            
            // ÊøÄÊ¥ªÂØπÂ∫îÊåâÈíÆ
            event.target.classList.add('active');
            
            // Ê†πÊçÆÊ†áÁ≠æÈ°µÂä†ËΩΩÂØπÂ∫îÊï∞ÊçÆ
            if (tabName === 'overview') {
                loadSystemStats();
            } else if (tabName === 'owners') {
                loadShopOwnersStats();
            } else if (tabName === 'shops') {
                loadAllShops();
            }
        }

        // Âä†ËΩΩÁÆ°ÁêÜÂëòÊï∞ÊçÆ
        async function loadAdminData() {
            await loadSystemStats();
            await loadShopOwnersStats();
        }

        // Âä†ËΩΩÁ≥ªÁªüÁªüËÆ°
        async function loadSystemStats() {
            try {
                const response = await fetch('/api/admin/system-stats', {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    adminData.systemStats = data.stats;
                    updateSystemStatsUI();
                } else {
                    console.error('Âä†ËΩΩÁ≥ªÁªüÁªüËÆ°Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≥ªÁªüÁªüËÆ°ÈîôËØØ:', error);
            }
        }

        // Êõ¥Êñ∞Á≥ªÁªüÁªüËÆ°UI
        function updateSystemStatsUI() {
            const stats = adminData.systemStats;
            if (!stats) return;
            
            document.getElementById('totalUsers').textContent = stats.totalUsers;
            document.getElementById('totalShops').textContent = stats.totalShops;
            document.getElementById('shopOwners').textContent = stats.usersByRole.shop_owner || 0;
            document.getElementById('employees').textContent = stats.usersByRole.employee || 0;
        }

        // Âä†ËΩΩÂ∫ó‰∏ªÁªüËÆ°
        async function loadShopOwnersStats(keyword = '') {
            try {
                const url = keyword ? 
                    `/api/admin/shop-owners-stats?keyword=${encodeURIComponent(keyword)}` : 
                    '/api/admin/shop-owners-stats';
                
                const response = await fetch(url, {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    adminData.shopOwnersStats = data.stats;
                    updateShopOwnersUI();
                } else {
                    console.error('Âä†ËΩΩÂ∫ó‰∏ªÁªüËÆ°Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∫ó‰∏ªÁªüËÆ°ÈîôËØØ:', error);
            }
        }

        // Êõ¥Êñ∞Â∫ó‰∏ªÂàóË°®UI
        function updateShopOwnersUI() {
            const ownersList = document.getElementById('ownersList');
            const stats = adminData.shopOwnersStats;
            
            if (!stats || stats.length === 0) {
                ownersList.innerHTML = '<div class="empty-state">ÊöÇÊó†Â∫ó‰∏ªÊï∞ÊçÆ</div>';
                return;
            }
            
            const html = stats.map(stat => `
                <div class="owner-item">
                    <div class="owner-header">
                        <div class="owner-info">
                            <h5>${stat.user.username}</h5>
                            <p>üìß ${stat.user.email}</p>
                            <p>üìÖ Ê≥®ÂÜåÊó∂Èó¥: ${new Date(stat.user.createdAt).toLocaleDateString()}</p>
                            <p>üïê ÊúÄÂêéÁôªÂΩï: ${stat.user.lastLoginAt ? new Date(stat.user.lastLoginAt).toLocaleString() : '‰ªéÊú™ÁôªÂΩï'}</p>
                        </div>
                        <div class="owner-actions">
                            <button class="btn btn-small" onclick="viewOwnerDetails('${stat.user.id}')">
                                üëÅÔ∏è ËØ¶ÊÉÖ
                            </button>
                            <button class="btn btn-small btn-warning" onclick="toggleOwnerStatus('${stat.user.id}', 'suspended')">
                                üö´ Á¶ÅÁî®
                            </button>
                            <button class="btn btn-small btn-danger" onclick="deleteOwner('${stat.user.id}')">
                                üóëÔ∏è Âà†Èô§
                            </button>
                        </div>
                    </div>
                    <div class="owner-shops">
                        <h6>üìä Â∫óÈì∫ÁªüËÆ°: ${stat.shopsCount} ‰∏™Â∫óÈì∫, ${stat.totalMembers} ÂêçÊàêÂëò</h6>
                        <div class="shops-list">
                            ${stat.shops.map(shop => `
                                <div class="shop-tag">
                                    üè™ ${shop.name} (${shop.memberCount}‰∫∫)
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `).join('');
            
            ownersList.innerHTML = html;
        }

        // ÊêúÁ¥¢Â∫ó‰∏ª
        function searchShopOwners() {
            const keyword = document.getElementById('ownerSearch').value.trim();
            loadShopOwnersStats(keyword);
        }

        // Êü•ÁúãÂ∫ó‰∏ªËØ¶ÊÉÖ
        async function viewOwnerDetails(ownerId) {
            try {
                const response = await fetch(`/api/admin/shop-owner/${ownerId}`, {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    showOwnerDetailsModal(data);
                } else {
                    alert('Ëé∑ÂèñÂ∫ó‰∏ªËØ¶ÊÉÖÂ§±Ë¥•');
                }
            } catch (error) {
                console.error('Ëé∑ÂèñÂ∫ó‰∏ªËØ¶ÊÉÖÈîôËØØ:', error);
                alert('Ëé∑ÂèñÂ∫ó‰∏ªËØ¶ÊÉÖÂ§±Ë¥•');
            }
        }

        // ÊòæÁ§∫Â∫ó‰∏ªËØ¶ÊÉÖÊ®°ÊÄÅÊ°Ü
        function showOwnerDetailsModal(data) {
            const modal = document.createElement('div');
            modal.className = 'modal';
            modal.style.display = 'block';
            
            modal.innerHTML = `
                <div class="modal-content owner-details-modal">
                    <div class="modal-header">
                        <h3>üë§ Â∫ó‰∏ªËØ¶ÊÉÖ: ${data.owner.username}</h3>
                        <span class="close" onclick="this.closest('.modal').remove()">&times;</span>
                    </div>
                    <div class="modal-body">
                        <div class="detail-section">
                            <h5>Âü∫Êú¨‰ø°ÊÅØ</h5>
                            <p><strong>Áî®Êà∑Âêç:</strong> ${data.owner.username}</p>
                            <p><strong>ÈÇÆÁÆ±:</strong> ${data.owner.email}</p>
                            <p><strong>Ê≥®ÂÜåÊó∂Èó¥:</strong> ${new Date(data.owner.createdAt).toLocaleString()}</p>
                            <p><strong>ÊúÄÂêéÁôªÂΩï:</strong> ${data.owner.lastLoginAt ? new Date(data.owner.lastLoginAt).toLocaleString() : '‰ªéÊú™ÁôªÂΩï'}</p>
                        </div>
                        
                        <div class="detail-section">
                            <h5>Â∫óÈì∫ÁªüËÆ°</h5>
                            <p><strong>Êã•ÊúâÂ∫óÈì∫:</strong> ${data.shopsCount} ‰∏™</p>
                            <p><strong>ÊÄªÊàêÂëòÊï∞:</strong> ${data.totalMembers} ‰∫∫</p>
                        </div>
                        
                        <div class="detail-section">
                            <h5>Â∫óÈì∫ËØ¶ÊÉÖ</h5>
                            ${data.shops.map(shop => `
                                <div style="background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 10px;">
                                    <h6>${shop.name} (${shop.domain})</h6>
                                    <p><strong>Áä∂ÊÄÅ:</strong> <span class="shop-status status-${shop.status}">${shop.status === 'active' ? 'Ê≠£Â∏∏' : 'ÊöÇÂÅú'}</span></p>
                                    <p><strong>ÂàõÂª∫Êó∂Èó¥:</strong> ${new Date(shop.createdAt).toLocaleDateString()}</p>
                                    <p><strong>ÊàêÂëòÊï∞:</strong> ${shop.memberCount} ‰∫∫</p>
                                    ${shop.members.length > 0 ? `
                                        <p><strong>ÊàêÂëòÂàóË°®:</strong></p>
                                        <div class="member-list">
                                            ${shop.members.map(member => `
                                                <span class="member-tag">${member.username} (${member.shopRole})</span>
                                            `).join('')}
                                        </div>
                                    ` : '<p><strong>ÊàêÂëò:</strong> Êó†</p>'}
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    <div class="modal-buttons">
                        <button type="button" class="btn btn-secondary" onclick="this.closest('.modal').remove()">ÂÖ≥Èó≠</button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
        }

        // ÂàáÊç¢Â∫ó‰∏ªÁä∂ÊÄÅ
        async function toggleOwnerStatus(ownerId, status) {
            const action = status === 'suspended' ? 'Á¶ÅÁî®' : 'ÂêØÁî®';
            if (!confirm(`Á°ÆÂÆöË¶Å${action}ËØ•Â∫ó‰∏ªÂêóÔºü`)) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/shop-owner/${ownerId}/status`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ status })
                });
                
                if (response.ok) {
                    alert(`Â∫ó‰∏ª${action}ÊàêÂäü`);
                    loadShopOwnersStats();
                } else {
                    const error = await response.json();
                    alert(`${action}Â§±Ë¥•: ${error.error}`);
                }
            } catch (error) {
                console.error(`${action}Â∫ó‰∏ªÈîôËØØ:`, error);
                alert(`${action}Â§±Ë¥•`);
            }
        }

        // Âà†Èô§Â∫ó‰∏ª
        async function deleteOwner(ownerId) {
            if (!confirm('‚ö†Ô∏è Ë≠¶ÂëäÔºöÊ≠§Êìç‰ΩúÂ∞ÜÊ∞∏‰πÖÂà†Èô§Â∫ó‰∏ªÂèäÂÖ∂ÊâÄÊúâÂ∫óÈì∫Êï∞ÊçÆÔºåÊó†Ê≥ïÊÅ¢Â§çÔºÅ\n\nËØ∑ËæìÂÖ• "DELETE_ALL_DATA" Á°ÆËÆ§Âà†Èô§Ôºö')) {
                return;
            }
            
            const confirmation = prompt('ËØ∑ËæìÂÖ• "DELETE_ALL_DATA" Á°ÆËÆ§Âà†Èô§Ôºö');
            if (confirmation !== 'DELETE_ALL_DATA') {
                alert('Á°ÆËÆ§ÊñáÊú¨‰∏çÊ≠£Á°ÆÔºåÊìç‰ΩúÂ∑≤ÂèñÊ∂à');
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/shop-owner/${ownerId}`, {
                    method: 'DELETE',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ confirm: 'DELETE_ALL_DATA' })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    alert(data.message);
                    loadShopOwnersStats();
                    loadSystemStats(); // Âà∑Êñ∞Á≥ªÁªüÁªüËÆ°
                } else {
                    const error = await response.json();
                    alert(`Âà†Èô§Â§±Ë¥•: ${error.error}`);
                }
            } catch (error) {
                console.error('Âà†Èô§Â∫ó‰∏ªÈîôËØØ:', error);
                alert('Âà†Èô§Â§±Ë¥•');
            }
        }

        // Âä†ËΩΩÊâÄÊúâÂ∫óÈì∫
        async function loadAllShops() {
            try {
                const response = await fetch('/api/admin/shops', {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    adminData.allShops = data.shops;
                    updateAllShopsUI();
                } else {
                    console.error('Âä†ËΩΩÂ∫óÈì∫ÂàóË°®Â§±Ë¥•');
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂ∫óÈì∫ÂàóË°®ÈîôËØØ:', error);
            }
        }

        // Êõ¥Êñ∞ÊâÄÊúâÂ∫óÈì∫UI
        function updateAllShopsUI() {
            const shopsMonitor = document.getElementById('shopsMonitor');
            const shops = adminData.allShops;
            
            if (!shops || shops.length === 0) {
                shopsMonitor.innerHTML = '<div class="empty-state">ÊöÇÊó†Â∫óÈì∫Êï∞ÊçÆ</div>';
                return;
            }
            
            const html = shops.map(shop => `
                <div class="shop-monitor-item">
                    <div class="shop-monitor-info">
                        <h6>${shop.name}</h6>
                        <p>üåê ${shop.domain}</p>
                        <p>üìÖ ÂàõÂª∫Êó∂Èó¥: ${new Date(shop.createdAt).toLocaleDateString()}</p>
                    </div>
                    <div class="shop-monitor-status">
                        <span class="shop-status status-${shop.status}">
                            ${shop.status === 'active' ? 'Ê≠£Â∏∏ËøêË°å' : 'Â∑≤ÊöÇÂÅú'}
                        </span>
                    </div>
                </div>
            `).join('');
            
            shopsMonitor.innerHTML = html;
        }

        // Âà∑Êñ∞ÁÆ°ÁêÜÂëòÊï∞ÊçÆ
        function refreshAdminData() {
            loadAdminData();
        }

        // ============ ÂÆ°Ê†∏ÁÆ°ÁêÜÂäüËÉΩ ============

        // ÊòæÁ§∫ÂÆ°Ê†∏ÁÆ°ÁêÜÈù¢Êùø
        function showReviewPanel() {
            if (currentUser.role !== 'super_admin') {
                alert('Âè™ÊúâË∂ÖÁ∫ßÁÆ°ÁêÜÂëòÊâçËÉΩËÆøÈóÆÂÆ°Ê†∏ÂäüËÉΩ');
                return;
            }
            
            document.getElementById('reviewPanelModal').style.display = 'block';
            loadPendingShops();
        }

        // ÈöêËóèÂÆ°Ê†∏ÁÆ°ÁêÜÈù¢Êùø
        function hideReviewPanel() {
            document.getElementById('reviewPanelModal').style.display = 'none';
        }

        // Âä†ËΩΩÂæÖÂÆ°Ê†∏Â∫óÈì∫
        async function loadPendingShops() {
            try {
                const response = await fetch('/api/admin/pending-shops', {
                    headers: {
                        'X-Session-Id': currentSession
                    }
                });

                const data = await response.json();
                
                if (data.success) {
                    displayPendingShops(data.shops);
                } else {
                    alert('Âä†ËΩΩÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂæÖÂÆ°Ê†∏Â∫óÈì∫Â§±Ë¥•:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // ÊòæÁ§∫ÂæÖÂÆ°Ê†∏Â∫óÈì∫ÂàóË°®
        function displayPendingShops(shops) {
            const container = document.getElementById('pendingShopsContainer');
            
            if (shops.length === 0) {
                container.innerHTML = `
                    <div class="empty-pending">
                        <i>‚úÖ</i>
                        <h4>ÊöÇÊó†ÂæÖÂÆ°Ê†∏Â∫óÈì∫</h4>
                        <p>ÊâÄÊúâÂ∫óÈì∫ÈÉΩÂ∑≤ÂÆ°Ê†∏ÂÆåÊàê</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = shops.map(shop => `
                <div class="pending-shop-item">
                    <div class="pending-shop-header">
                        <div class="pending-shop-info">
                            <h5>${shop.name}</h5>
                            <div class="domain">üåê ${shop.domain}</div>
                            <div class="description">üìù ${shop.description}</div>
                            <div class="pending-shop-meta">
                                <span>üë§ Áî≥ËØ∑‰∫∫Ôºö${shop.ownerName}</span>
                                <span>üìß ÈÇÆÁÆ±Ôºö${shop.ownerEmail}</span>
                                <span>‚è∞ Êèê‰∫§Êó∂Èó¥Ôºö${new Date(shop.submittedAt).toLocaleString()}</span>
                            </div>
                        </div>
                        <div class="pending-shop-actions">
                            <button class="review-btn review-approve" onclick="reviewShop('${shop.id}', 'approve')">
                                ‚úÖ ÈÄöËøá
                            </button>
                            <button class="review-btn review-reject" onclick="reviewShop('${shop.id}', 'reject')">
                                ‚ùå ÊãíÁªù
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ÂÆ°Ê†∏Â∫óÈì∫
        async function reviewShop(shopId, action) {
            let note = '';
            
            if (action === 'reject') {
                note = prompt('ËØ∑ËæìÂÖ•ÊãíÁªùÂéüÂõ†Ôºö');
                if (!note) return; // Áî®Êà∑ÂèñÊ∂à
            } else {
                note = 'ÂÆ°Ê†∏ÈÄöËøáÔºåÊ¨¢Ëøé‰ΩøÁî®Êàë‰ª¨ÁöÑÂÆ¢ÊúçÁ≥ªÁªüÔºÅ';
            }

            try {
                const approved = action === 'approve';
                const response = await fetch(`/api/admin/review-shop/${shopId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': currentSession
                    },
                    body: JSON.stringify({ approved, note })
                });

                const data = await response.json();
                
                if (data.success) {
                    alert(action === 'approve' ? 'ÂÆ°Ê†∏ÈÄöËøáÔºÅ' : 'Â∑≤ÊãíÁªùÁî≥ËØ∑');
                    // ÈáçÊñ∞Âä†ËΩΩÂæÖÂÆ°Ê†∏ÂàóË°®
                    loadPendingShops();
                    // Âà∑Êñ∞Â∫óÈì∫ÂàóË°®ÔºàÂ¶ÇÊûúÁî®Êà∑‰πüÊòØÂ∫ó‰∏ªÔºâ
                    if (currentUser.role === 'shop_owner' || currentUser.role === 'super_admin') {
                        loadMyShops();
                    }
                } else {
                    alert('Êìç‰ΩúÂ§±Ë¥•: ' + data.error);
                }
            } catch (error) {
                console.error('ÂÆ°Ê†∏Êìç‰ΩúÂ§±Ë¥•:', error);
                alert('ÁΩëÁªúÈîôËØØÔºåËØ∑Á®çÂêéÈáçËØï');
            }
        }

        // Âà∑Êñ∞ÂæÖÂÆ°Ê†∏ÂàóË°®
        function refreshPendingShops() {
            loadPendingShops();
        }

        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠ÔºàÊâ©Â±ïÂéüÊúâÂáΩÊï∞Ôºâ
        const originalWindowClick = window.onclick;
        window.onclick = function(event) {
            const adminModal = document.getElementById('adminPanelModal');
            const reviewModal = document.getElementById('reviewPanelModal');
            
            if (event.target === adminModal) {
                hideAdminPanel();
            }
            
            if (event.target === reviewModal) {
                hideReviewPanel();
            }
            
            // Â§ÑÁêÜÂä®ÊÄÅÂàõÂª∫ÁöÑÊîØ‰ªòÊ®°ÊÄÅÊ°Ü
            if (event.target.classList && event.target.classList.contains('modal')) {
                const modal = event.target;
                if (modal.id.includes('payment') || modal.id.includes('qr') || modal.id.includes('activation') || modal.id.includes('pay')) {
                    modal.style.display = 'none';
                }
            }
            
            // Ë∞ÉÁî®ÂéüÊúâÁöÑÁÇπÂáªÂ§ÑÁêÜ
            if (originalWindowClick) {
                originalWindowClick(event);
            }
        }

        // Á°Æ‰øùÂä®ÊÄÅÊ®°ÊÄÅÊ°ÜÊúâÊ≠£Á°ÆÁöÑÊªöÂä®Ê†∑Âºè
        function ensureModalScrollable(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                const modalContent = modal.querySelector('.modal-content');
                const modalBody = modal.querySelector('.modal-body');
                
                if (modalContent) {
                    modalContent.style.maxHeight = '85vh';
                    modalContent.style.overflow = 'hidden';
                    modalContent.style.display = 'flex';
                    modalContent.style.flexDirection = 'column';
                }
                
                if (modalBody) {
                    modalBody.style.overflowY = 'auto';
                    modalBody.style.flex = '1';
                    modalBody.style.maxHeight = 'calc(85vh - 120px)';
                }
            }
        }

        // ÁõëÂê¨DOMÂèòÂåñÔºåËá™Âä®Â∫îÁî®ÊªöÂä®Ê†∑ÂºèÂà∞Êñ∞ÂàõÂª∫ÁöÑÊ®°ÊÄÅÊ°Ü
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                mutation.addedNodes.forEach(function(node) {
                    if (node.nodeType === 1 && node.classList && node.classList.contains('modal')) {
                        setTimeout(() => ensureModalScrollable(node.id), 100);
                    }
                });
            });
        });
        
        observer.observe(document.body, { childList: true, subtree: true });
    </script>
    
    <!-- Áª≠Ë¥πÊ®°ÊÄÅÊ°Ü -->
    <div id="renewalModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üí∞ Â∫óÈì∫Áª≠Ë¥π</h3>
                <button class="close-btn" onclick="closeRenewalModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- ËÆ¢Âçï‰ø°ÊÅØ -->
                <div class="renewal-info">
                    <div class="info-item">
                        <strong>ËÆ¢ÂçïÂè∑Ôºö</strong>
                        <span id="renewalOrderId"></span>
                    </div>
                    <div class="info-item">
                        <strong>Â∫óÈì∫ÂêçÁß∞Ôºö</strong>
                        <span id="renewalShopName"></span>
                    </div>
                    <div class="info-item">
                        <strong>Áª≠Ë¥πÈáëÈ¢ùÔºö</strong>
                        <span id="renewalAmount" class="amount">¬•2000</span>
                    </div>
                    <div class="info-item">
                        <strong>ËÆ¢ÂçïÊúâÊïàÊúüÔºö</strong>
                        <span id="renewalExpiry"></span>
                    </div>
                </div>

                <!-- ÊîØ‰ªòÊñπÂºèÈÄâÊã© -->
                <div id="paymentMethods" class="payment-methods">
                    <h4>ËØ∑ÈÄâÊã©ÊîØ‰ªòÊñπÂºèÔºö</h4>
                    <div class="payment-buttons">
                        <button class="payment-btn alipay-btn" onclick="selectPaymentMethod('alipay')">
                            <div class="payment-icon">üí∞</div>
                            <div class="payment-text">ÊîØ‰ªòÂÆùÊîØ‰ªò</div>
                        </button>
                        <button class="payment-btn wechat-btn" onclick="selectPaymentMethod('wechat')">
                            <div class="payment-icon">üíö</div>
                            <div class="payment-text">ÂæÆ‰ø°ÊîØ‰ªò</div>
                        </button>
                    </div>
                </div>

                <!-- ‰∫åÁª¥Á†ÅÊîØ‰ªòÂå∫Âüü -->
                <div id="qrCodeSection" class="qr-code-section" style="display: none;">
                    <h4 id="paymentMethodName">ÊîØ‰ªòÂÆù</h4>
                    <div class="qr-code-container">
                        <img id="paymentQRCode" src="" alt="ÊîØ‰ªò‰∫åÁª¥Á†Å" />
                        <div class="qr-tips">
                            <p>ËØ∑‰ΩøÁî®<span id="paymentAppName">ÊîØ‰ªòÂÆù</span>Êâ´Á†ÅÊîØ‰ªò <span class="amount">¬•2000</span></p>
                            <p class="tip-text">ÊîØ‰ªòÂÆåÊàêÂêéÈ°µÈù¢Â∞ÜËá™Âä®Ë∑≥ËΩ¨</p>
                        </div>
                        
                        <!-- Âà∑Êñ∞‰∫åÁª¥Á†ÅÊåâÈíÆ -->
                        <div class="qr-actions">
                            <button class="refresh-btn" onclick="refreshQRCode()" title="Âà∑Êñ∞‰∫åÁª¥Á†Å">
                                üîÑ Âà∑Êñ∞‰∫åÁª¥Á†Å
                            </button>
                        </div>
                    </div>
                    
                    <!-- Á°ÆËÆ§ÊåâÈíÆ -->
                    <div class="test-buttons">
                        <button class="test-btn" onclick="closeRenewalModal()">
                            Á°ÆÂÆö
                        </button>
                    </div>
                </div>

                <!-- ÊîØ‰ªòÊàêÂäü -->
                <div id="paymentSuccess" class="payment-success" style="display: none;">
                    <div class="success-icon">‚úÖ</div>
                    <h4>ÊîØ‰ªòÊàêÂäüÔºÅ</h4>
                    <p>ÊÇ®ÁöÑÂ∫óÈì∫ÊúâÊïàÊúüÂ∑≤Âª∂Èïø1Âπ¥</p>
                    <div class="success-actions">
                        <button class="btn btn-primary" onclick="closeRenewalModal(); loadMyShops();">ËøîÂõûÂ∫óÈì∫ÂàóË°®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* Áª≠Ë¥πÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .renewal-info {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .info-item {
            margin-bottom: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 14px;
        }

        .info-item strong {
            color: #333;
        }

        .amount {
            color: #e74c3c;
            font-size: 18px;
            font-weight: bold;
        }

        .payment-methods {
            text-align: center;
            margin-bottom: 20px;
        }

        .payment-methods h4 {
            margin-bottom: 20px;
            color: #333;
        }

        .payment-buttons {
            display: flex;
            gap: 20px;
            justify-content: center;
        }

        .payment-btn {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 24px 20px;
            border: 2px solid #ddd;
            border-radius: 16px;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
            position: relative;
            overflow: hidden;
        }

        .payment-btn::before {
            content: "";
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.4), transparent);
            transition: left 0.5s;
        }

        .payment-btn:hover::before {
            left: 100%;
        }

        .payment-btn:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 20px rgba(0,0,0,0.15);
        }

        .alipay-btn {
            background: linear-gradient(135deg, #fff 0%, #f0f8ff 100%);
        }

        .alipay-btn:hover {
            border-color: #1677ff;
            background: linear-gradient(135deg, #f0f8ff 0%, #e6f7ff 100%);
            box-shadow: 0 8px 20px rgba(22,119,255,0.25);
        }

        .wechat-btn {
            background: linear-gradient(135deg, #fff 0%, #f0fff4 100%);
        }

        .wechat-btn:hover {
            border-color: #07c160;
            background: linear-gradient(135deg, #f0fff4 0%, #e6f7ec 100%);
            box-shadow: 0 8px 20px rgba(7,193,96,0.25);
        }

        .payment-icon {
            font-size: 32px;
            margin-bottom: 12px;
            transition: transform 0.3s ease;
        }

        .payment-btn:hover .payment-icon {
            transform: scale(1.1) rotate(5deg);
        }

        .payment-text {
            font-size: 16px;
            font-weight: 600;
            color: #333;
            transition: color 0.3s ease;
        }

        .alipay-btn:hover .payment-text {
            color: #1677ff;
        }

        .wechat-btn:hover .payment-text {
            color: #07c160;
        }

        .qr-code-section {
            text-align: center;
        }

        .qr-code-section h4 {
            color: #333;
            margin-bottom: 20px;
            font-size: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .qr-code-section h4::before {
            content: "üí∞";
            font-size: 20px;
        }

        .qr-code-section[data-method="wechat"] h4::before {
            content: "üíö";
        }

        .qr-code-container {
            display: inline-block;
            padding: 25px;
            background: white;
            border: 3px solid #eee;
            border-radius: 16px;
            margin: 20px 0;
            box-shadow: 0 4px 16px rgba(0,0,0,0.1);
            position: relative;
            transition: all 0.3s ease;
        }

        .qr-code-container::before {
            content: "";
            position: absolute;
            top: -3px;
            left: -3px;
            right: -3px;
            bottom: -3px;
            border-radius: 16px;
            background: linear-gradient(45deg, #1677ff, #52c41a);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .qr-code-container:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(0,0,0,0.15);
        }

        .qr-code-container:hover::before {
            opacity: 1;
        }

        .qr-code-container.alipay-style {
            border-color: #1677ff;
        }

        .qr-code-container.alipay-style::before {
            background: linear-gradient(45deg, #1677ff, #40a9ff);
        }

        .qr-code-container.wechat-style {
            border-color: #07c160;
        }

        .qr-code-container.wechat-style::before {
            background: linear-gradient(45deg, #07c160, #52c41a);
        }

        .qr-code-container img {
            width: 200px;
            height: 200px;
            border: none;
            display: block;
            margin: 0 auto;
            border-radius: 8px;
            transition: transform 0.3s ease;
        }

        .qr-code-container:hover img {
            transform: scale(1.02);
        }

        .qr-tips {
            margin-top: 15px;
        }

        .qr-tips p {
            margin: 8px 0;
            color: #333;
        }

        .tip-text {
            color: #666 !important;
            font-size: 12px;
        }

        .test-buttons {
            margin-top: 20px;
        }

        .test-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
        }

        .test-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .payment-success {
            text-align: center;
            padding: 40px 20px;
        }

        .success-icon {
            font-size: 48px;
            margin-bottom: 20px;
        }

        .payment-success h4 {
            color: #28a745;
            margin-bottom: 10px;
            font-size: 18px;
        }

        .payment-success p {
            color: #666;
            margin-bottom: 20px;
        }

        .success-actions {
            margin-top: 20px;
        }

        .qr-actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }

        .refresh-btn {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            color: #495057;
            border: 1px solid #ced4da;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.3s ease;
        }

        .refresh-btn:hover {
            background: linear-gradient(135deg, #e9ecef 0%, #dee2e6 100%);
            color: #212529;
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .refresh-btn:active {
            transform: translateY(0);
        }
    </style>
    
    <!-- ‰ªòË¥πÂºÄÈÄöÊ®°ÊÄÅÊ°Ü -->
    <div id="activationModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üíé Â∫óÈì∫‰ªòË¥πÂºÄÈÄö</h3>
                <button class="close-btn" onclick="closeActivationModal()">√ó</button>
            </div>
            <div class="modal-body">
                <!-- ËÆ¢Âçï‰ø°ÊÅØ -->
                <div class="activation-info">
                    <div class="info-item">
                        <strong>ËÆ¢ÂçïÂè∑Ôºö</strong>
                        <span id="activationOrderId"></span>
                    </div>
                    <div class="info-item">
                        <strong>Â∫óÈì∫ÂêçÁß∞Ôºö</strong>
                        <span id="activationShopName"></span>
                    </div>
                    <div class="info-item">
                        <strong>ÂºÄÈÄöË¥πÁî®Ôºö</strong>
                        <span id="activationAmount" class="amount">¬•2000</span>
                    </div>
                    <div class="info-item">
                        <strong>ËÆ¢ÂçïÊúâÊïàÊúüÔºö</strong>
                        <span id="activationExpiry"></span>
                    </div>
                    <div class="info-item activation-benefit">
                        <strong>ÂºÄÈÄöÂêé‰∫´ÂèóÔºö</strong>
                        <span class="benefit-text">‚úÖ Á´ãÂç≥ÂÆ°Ê†∏ÈÄöËøá + 1Âπ¥ÊúçÂä°Êúü</span>
                    </div>
                </div>

                <!-- ÊîØ‰ªòÊñπÂºèÈÄâÊã© -->
                <div id="activationPaymentMethods" class="payment-methods">
                    <h4>ËØ∑ÈÄâÊã©ÊîØ‰ªòÊñπÂºèÔºö</h4>
                    <div class="payment-buttons">
                        <button class="payment-btn alipay-btn" onclick="selectActivationPaymentMethod('alipay')">
                            <div class="payment-icon">üí∞</div>
                            <div class="payment-text">ÊîØ‰ªòÂÆùÊîØ‰ªò</div>
                        </button>
                        <button class="payment-btn wechat-btn" onclick="selectActivationPaymentMethod('wechat')">
                            <div class="payment-icon">üíö</div>
                            <div class="payment-text">ÂæÆ‰ø°ÊîØ‰ªò</div>
                        </button>
                    </div>
                </div>

                <!-- ‰∫åÁª¥Á†ÅÊîØ‰ªòÂå∫Âüü -->
                <div id="activationQrCodeSection" class="qr-code-section" style="display: none;">
                    <h4 id="activationPaymentMethodName">ÊîØ‰ªòÂÆù</h4>
                    <div class="qr-code-container">
                        <img id="activationPaymentQRCode" src="" alt="‰ªòË¥πÂºÄÈÄöÊîØ‰ªò‰∫åÁª¥Á†Å" />
                        <div class="qr-tips">
                            <p>ËØ∑‰ΩøÁî®<span id="activationPaymentAppName">ÊîØ‰ªòÂÆù</span>Êâ´Á†ÅÊîØ‰ªò <span class="amount">¬•2000</span></p>
                            <p class="tip-text">‰ªòË¥πÊàêÂäüÂêéÔºåÂ∫óÈì∫Â∞ÜÁ´ãÂç≥ÂÆ°Ê†∏ÈÄöËøá</p>
                        </div>
                        
                        <!-- Âà∑Êñ∞‰∫åÁª¥Á†ÅÊåâÈíÆ -->
                        <div class="qr-actions">
                            <button class="refresh-btn" onclick="refreshActivationQRCode()" title="Âà∑Êñ∞‰∫åÁª¥Á†Å">
                                üîÑ Âà∑Êñ∞‰∫åÁª¥Á†Å
                            </button>
                        </div>
                    </div>
                    
                    <!-- Á°ÆËÆ§ÊåâÈíÆ -->
                    <div class="test-buttons">
                        <button class="test-btn" onclick="closeActivationModal()">
                            Á°ÆÂÆö
                        </button>
                    </div>
                </div>

                <!-- ÊîØ‰ªòÊàêÂäü -->
                <div id="activationPaymentSuccess" class="payment-success" style="display: none;">
                    <div class="success-icon">üéâ</div>
                    <h4>‰ªòË¥πÂºÄÈÄöÊàêÂäüÔºÅ</h4>
                    <p>ÊÇ®ÁöÑÂ∫óÈì∫Â∑≤Ëá™Âä®ÂÆ°Ê†∏ÈÄöËøáÂπ∂Ëé∑Âæó1Âπ¥ÊúâÊïàÊúü</p>
                    <div class="success-actions">
                        <button class="btn btn-primary" onclick="closeActivationModal(); loadMyShops();">ËøîÂõûÂ∫óÈì∫ÂàóË°®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ÈõÜÊàê‰ª£Á†ÅÊ®°ÊÄÅÊ°Ü -->
    <div id="integrationModal" class="integration-modal">
        <div class="integration-modal-content">
            <div class="integration-header">
                <h3>üõçÔ∏è Â∫óÈì∫ÈõÜÊàê‰ª£Á†Å</h3>
                <span class="integration-close" onclick="closeIntegrationModal()">&times;</span>
            </div>
            
            <div class="integration-body">
                <div class="integration-info">
                    <div class="info-row">
                        <span class="label">Â∫óÈì∫ÂêçÁß∞:</span>
                        <span class="value" id="integrationShopName"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">Â∫óÈì∫ID:</span>
                        <span class="value code-text" id="integrationShopId"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">APIÂØÜÈí•:</span>
                        <span class="value code-text" id="integrationApiKey"></span>
                    </div>
                    <div class="info-row">
                        <span class="label">ÁîüÊàêÊó∂Èó¥:</span>
                        <span class="value" id="integrationGeneratedAt"></span>
                    </div>
                </div>

                <div class="code-section">
                    <div class="code-header">
                        <h4>üîß ÈõÜÊàê‰ª£Á†Å</h4>
                        <div class="code-actions">
                            <button class="btn btn-sm btn-outline copy-btn" onclick="copyIntegrationCode()">
                                üìã Â§çÂà∂‰ª£Á†Å
                            </button>
                            <button class="btn btn-sm btn-warning" onclick="regenerateApiKey()">
                                üîë ÈáçÊñ∞ÁîüÊàêÂØÜÈí•
                            </button>
                        </div>
                    </div>
                    <textarea id="integrationCode" class="code-textarea" readonly placeholder="Ê≠£Âú®ÁîüÊàêÈõÜÊàê‰ª£Á†Å..."></textarea>
                </div>

                <div class="integration-note">
                    <h5>üìù ‰ΩøÁî®ËØ¥ÊòéÔºö</h5>
                    <ul>
                        <li>Â∞Ü‰∏äÊñπ‰ª£Á†ÅÂ§çÂà∂Âπ∂Á≤òË¥¥Âà∞ÊÇ®ÁΩëÁ´ôÁöÑ HTML È°µÈù¢‰∏≠</li>
                        <li>Âª∫ËÆÆÊîæÂú® <code>&lt;/body&gt;</code> Ê†áÁ≠æÂâç</li>
                        <li>‰ª£Á†ÅÂ∞ÜÂú®Âè≥‰∏ãËßíÊòæÁ§∫ÂÆ¢ÊúçËÅäÂ§©ÊåâÈíÆ</li>
                        <li>ËÆøÂÆ¢ÁÇπÂáªÂç≥ÂèØÂºÄÂßã‰∏éÊÇ®ÁöÑÂÆ¢ÊúçÂØπËØù</li>
                        <li>Â¶ÇÈúÄÊõ¥ÊîπÊ†∑ÂºèÊàñ‰ΩçÁΩÆÔºåËØ∑ËÅîÁ≥ªÊäÄÊúØÊîØÊåÅ</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <style>
        /* ÈõÜÊàê‰ª£Á†ÅÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .integration-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(3px);
        }

        .integration-modal-content {
            background-color: #ffffff;
            margin: 3% auto;
            border-radius: 16px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideInDown 0.3s ease-out;
        }

        @keyframes slideInDown {
            from {
                opacity: 0;
                transform: translateY(-50px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .integration-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 20px 25px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .integration-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .integration-close {
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .integration-close:hover {
            opacity: 1;
        }

        .integration-body {
            padding: 25px;
        }

        .integration-info {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .info-row:last-child {
            border-bottom: none;
        }

        .info-row .label {
            font-weight: 600;
            color: #374151;
            min-width: 100px;
        }

        .info-row .value {
            color: #6b7280;
            text-align: right;
        }

        .code-text {
            font-family: 'Courier New', monospace;
            background: #f3f4f6;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 13px;
        }

        .code-section {
            margin-bottom: 25px;
        }

        .code-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .code-header h4 {
            margin: 0;
            color: #374151;
            font-size: 16px;
        }

        .code-actions {
            display: flex;
            gap: 10px;
        }

        .code-textarea {
            width: 100%;
            height: 280px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            line-height: 1.5;
            padding: 15px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: #f9fafb;
            color: #374151;
            resize: vertical;
            transition: border-color 0.2s;
        }

        .code-textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }

        .copy-btn.copied {
            background: #059669 !important;
            color: white !important;
            border-color: #059669 !important;
        }

        .integration-note {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 20px;
        }

        .integration-note h5 {
            margin: 0 0 15px 0;
            color: #92400e;
            font-size: 14px;
        }

        .integration-note ul {
            margin: 0;
            padding-left: 20px;
            color: #92400e;
        }

        .integration-note li {
            margin-bottom: 8px;
            font-size: 13px;
            line-height: 1.4;
        }

        .integration-note code {
            background: #fbbf24;
            color: #92400e;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
        }

        /* ÂìçÂ∫îÂºèËÆæËÆ° */
        @media (max-width: 768px) {
            .integration-modal-content {
                width: 95%;
                margin: 1% auto;
            }

            .integration-body {
                padding: 15px;
            }

            .code-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }

            .code-actions {
                flex-wrap: wrap;
            }

            .info-row {
                flex-direction: column;
                align-items: flex-start;
                gap: 5px;
            }
        }

        /* ‰ªòË¥πÂºÄÈÄöÊ®°ÊÄÅÊ°ÜÊ†∑Âºè */
        .activation-info {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }

        .activation-benefit {
            background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
            padding: 12px;
            margin: 15px -5px 5px -5px;
            border-radius: 8px;
            border: 1px solid #c3e6cb;
        }

        .benefit-text {
            color: #155724;
            font-weight: 600;
            font-size: 14px;
        }
    </style>
</body>
</html>
