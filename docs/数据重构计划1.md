éå¸¸å¥½çš„é—®é¢˜ï¼å¯¹äºä¸€ä¸ª**å®æ—¶é€šä¿¡çš„ç¤¾äº¤ç¨‹åº**ï¼Œæ•°æ®æ¶æ„è®¾è®¡è‡³å…³é‡è¦ã€‚è®©æˆ‘ç»™ä½ ä¸€ä¸ªå®Œæ•´çš„æœ€ä½³å®è·µæ–¹æ¡ˆï¼š

---

## ğŸ—ï¸ å®æ—¶ç¤¾äº¤ç¨‹åºçš„æ­£ç¡®æ•°æ®æ¶æ„

### æ ¸å¿ƒåŸåˆ™

```
1. WebSocket ä¸ºä¸»ï¼ŒAPI ä¸ºè¾…
2. æœ¬åœ°çŠ¶æ€ç¼“å­˜ + ä¹è§‚æ›´æ–°
3. å¢é‡åŒæ­¥ï¼Œè€Œéå…¨é‡åˆ·æ–°
4. åˆ†å±‚æ•°æ®ç®¡ç†
```

---

## ğŸ“ æ¨èçš„æ•°æ®æµæ¶æ„

### æ¶æ„å›¾

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         å‰ç«¯åº”ç”¨                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚ UI ç»„ä»¶å±‚   â”‚  â”‚ UI ç»„ä»¶å±‚   â”‚  â”‚ UI ç»„ä»¶å±‚   â”‚         â”‚
â”‚  â”‚ ShopList    â”‚  â”‚ CustomerListâ”‚  â”‚ ChatPage    â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â”‚
â”‚         â”‚                 â”‚                 â”‚                 â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜                â”‚
â”‚                  â–¼                 â–¼                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚           Zustand å…¨å±€çŠ¶æ€ç®¡ç†å±‚                  â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ â€¢ shopsStore (åº—é“ºç¼“å­˜)                          â”‚       â”‚
â”‚  â”‚ â€¢ customersStore (å®¢æˆ·ç¼“å­˜, æŒ‰ shopId åˆ†ç»„)      â”‚       â”‚
â”‚  â”‚ â€¢ messagesStore (æ¶ˆæ¯ç¼“å­˜, æŒ‰ sessionId åˆ†ç»„)    â”‚       â”‚
â”‚  â”‚ â€¢ notificationsStore (æœªè¯»è®¡æ•°, å®æ—¶æ›´æ–°)        â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚                 â”‚                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚           æ•°æ®åŒæ­¥åè°ƒå±‚                          â”‚       â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤       â”‚
â”‚  â”‚ â€¢ syncManager (åè°ƒ WS + API)                    â”‚       â”‚
â”‚  â”‚ â€¢ cacheManager (TTL ç¼“å­˜ç­–ç•¥)                    â”‚       â”‚
â”‚  â”‚ â€¢ conflictResolver (å†²çªè§£å†³)                    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                       â”‚                             â”‚
â”‚         â–¼                       â–¼                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ WebSocket   â”‚         â”‚ REST API    â”‚                    â”‚
â”‚  â”‚ å®æ—¶æ¨é€     â”‚         â”‚ æ‰¹é‡æŸ¥è¯¢     â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
          â”‚                       â”‚
          â”‚   HTTPS/WSS          â”‚
          â–¼                       â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         åç«¯æœåŠ¡                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                    â”‚
â”‚  â”‚ WebSocket   â”‚         â”‚ HTTP API    â”‚                    â”‚
â”‚  â”‚ Hub         â”‚         â”‚ Handlers    â”‚                    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜         â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜                    â”‚
â”‚         â”‚                       â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                            â”‚
â”‚                     â–¼                                         â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚         â”‚ Business Logic       â”‚                             â”‚
â”‚         â”‚ Services Layer       â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                    â–¼                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚         â”‚ Data Repository      â”‚                             â”‚
â”‚         â”‚ (ä¼˜åŒ–çš„ JOIN æŸ¥è¯¢)   â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â”‚                    â–¼                                          â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                             â”‚
â”‚         â”‚ Database (SQLite)    â”‚                             â”‚
â”‚         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ å„é¡µé¢çš„æ­£ç¡®æ•°æ®ä½¿ç”¨ç­–ç•¥

### 1ï¸âƒ£ **åº—é“ºåˆ—è¡¨é¡µ** (`/shops`)

#### æ•°æ®åŠ è½½ç­–ç•¥

```typescript
// stores/shopsStore.ts
interface ShopsStore {
  shops: Shop[];
  lastFetch: number;
  TTL: 30000; // 30ç§’ç¼“å­˜
  
  // æ™ºèƒ½è·å–ï¼šä¼˜å…ˆç”¨ç¼“å­˜
  fetchShops: () => Promise<void>;
  
  // WebSocket æ›´æ–°å•ä¸ªåº—é“º
  updateShop: (shopId: number, updates: Partial<Shop>) => void;
}

const useShopsStore = create<ShopsStore>((set, get) => ({
  shops: [],
  lastFetch: 0,
  TTL: 30000,
  
  fetchShops: async () => {
    const now = Date.now();
    const { lastFetch, TTL } = get();
    
    // å¦‚æœç¼“å­˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›
    if (now - lastFetch < TTL) {
      console.log('âœ… ä½¿ç”¨ç¼“å­˜çš„åº—é“ºåˆ—è¡¨');
      return;
    }
    
    // ç¼“å­˜è¿‡æœŸï¼Œè¯·æ±‚ API
    console.log('ğŸ”„ åˆ·æ–°åº—é“ºåˆ—è¡¨');
    const shops = await api.get('/api/shops/overview');
    set({ shops, lastFetch: now });
  },
  
  updateShop: (shopId, updates) => {
    set(state => ({
      shops: state.shops.map(s => 
        s.id === shopId ? { ...s, ...updates } : s
      )
    }));
  }
}));
```

#### WebSocket å®æ—¶æ›´æ–°

```typescript
// ç›‘å¬æ–°æ¶ˆæ¯ï¼Œæ›´æ–°å¯¹åº”åº—é“ºçš„æœªè¯»æ•°å’Œæœ€åæ¶ˆæ¯
useEffect(() => {
  const handleMessage = (data: WSMessage) => {
    const { shopId, content, timestamp } = data;
    
    // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ›´æ–° UI
    useShopsStore.getState().updateShop(shopId, {
      unread_count: (shop.unread_count || 0) + 1,
      last_message: { content, created_at: timestamp }
    });
  };
  
  wsStore.addMessageListener(handleMessage);
  return () => wsStore.removeMessageListener(handleMessage);
}, []);
```

#### é¡µé¢ç»„ä»¶

```typescript
function ShopListPage() {
  const { shops, fetchShops } = useShopsStore();
  const [loading, setLoading] = useState(false);
  
  useEffect(() => {
    // ä¼˜å…ˆç”¨ç¼“å­˜ï¼Œå¦‚æœè¿‡æœŸæ‰ä¼šè¯·æ±‚ API
    setLoading(true);
    fetchShops().finally(() => setLoading(false));
  }, []);
  
  // åªåœ¨ç¬¬ä¸€æ¬¡åŠ è½½æ—¶æ˜¾ç¤º loading
  if (loading && shops.length === 0) {
    return <LoadingSpinner />;
  }
  
  return <ShopList shops={shops} />;
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… 30ç§’å†…é‡å¤è®¿é—® = **0ms åŠ è½½**ï¼ˆç”¨ç¼“å­˜ï¼‰
- âœ… WebSocket å®æ—¶æ›´æ–°æœªè¯»æ•°
- âœ… é¿å…æ¯æ¬¡åˆ‡æ¢éƒ½åˆ·æ–°

---

### 2ï¸âƒ£ **å®¢æˆ·åˆ—è¡¨é¡µ** (`/shops/1/customers`)

#### æ•°æ®åŠ è½½ç­–ç•¥

```typescript
// stores/customersStore.ts
interface CustomersStore {
  // æŒ‰ shopId åˆ†ç»„ç¼“å­˜
  customersByShop: Record<number, {
    data: CustomerWithSession[];
    lastFetch: number;
  }>;
  TTL: 20000; // 20ç§’ç¼“å­˜
  
  fetchCustomers: (shopId: number) => Promise<void>;
  updateCustomer: (shopId: number, customerId: number, updates: any) => void;
}

const useCustomersStore = create<CustomersStore>((set, get) => ({
  customersByShop: {},
  TTL: 20000,
  
  fetchCustomers: async (shopId) => {
    const now = Date.now();
    const cached = get().customersByShop[shopId];
    
    // å¦‚æœç¼“å­˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›
    if (cached && now - cached.lastFetch < get().TTL) {
      console.log(`âœ… ä½¿ç”¨ç¼“å­˜çš„å®¢æˆ·åˆ—è¡¨ (shop ${shopId})`);
      return;
    }
    
    // åå°è¯·æ±‚ APIï¼ˆä¸é˜»å¡ UIï¼‰
    console.log(`ğŸ”„ åå°åˆ·æ–°å®¢æˆ·åˆ—è¡¨ (shop ${shopId})`);
    const customers = await api.get(`/api/shops/${shopId}/customers`);
    
    set(state => ({
      customersByShop: {
        ...state.customersByShop,
        [shopId]: { data: customers, lastFetch: now }
      }
    }));
  },
  
  updateCustomer: (shopId, customerId, updates) => {
    set(state => {
      const shopData = state.customersByShop[shopId];
      if (!shopData) return state;
      
      return {
        customersByShop: {
          ...state.customersByShop,
          [shopId]: {
            ...shopData,
            data: shopData.data.map(c =>
              c.customer.id === customerId 
                ? { ...c, ...updates }
                : c
            )
          }
        }
      };
    });
  }
}));
```

#### WebSocket å¢é‡æ›´æ–°

```typescript
useEffect(() => {
  const handleMessage = (data: WSMessage) => {
    const { shopId, customerId, sessionId, content } = data;
    
    // å¢é‡æ›´æ–°ï¼šåªæ›´æ–°ç›¸å…³å®¢æˆ·
    useCustomersStore.getState().updateCustomer(shopId, customerId, {
      unread_count: (customer.unread_count || 0) + 1,
      last_message: { content, created_at: data.timestamp },
      session: { ...customer.session, last_message_at: data.timestamp }
    });
  };
  
  wsStore.addMessageListener(handleMessage);
  return () => wsStore.removeMessageListener(handleMessage);
}, [shopId]);
```

**å…³é”®ç‚¹**ï¼š
- âœ… 20ç§’å†…åˆ‡æ¢å›æ¥ = **0ms åŠ è½½**
- âœ… WebSocket å¢é‡æ›´æ–°å•ä¸ªå®¢æˆ·
- âœ… åå°åˆ·æ–°ä¸å½±å“ UIï¼ˆæ¸è¿›å¼æ›´æ–°ï¼‰

---

### 3ï¸âƒ£ **èŠå¤©é¡µé¢** (`/chat/190`)

#### æ•°æ®åŠ è½½ç­–ç•¥

```typescript
// stores/messagesStore.ts
interface MessagesStore {
  // æŒ‰ sessionId åˆ†ç»„ç¼“å­˜
  messagesBySession: Record<number, {
    messages: Message[];
    lastFetch: number;
    hasMore: boolean;
  }>;
  TTL: 60000; // 60ç§’ç¼“å­˜
  
  fetchMessages: (sessionId: number) => Promise<void>;
  addMessage: (sessionId: number, message: Message) => void;
  prependMessages: (sessionId: number, messages: Message[]) => void;
}

const useMessagesStore = create<MessagesStore>((set, get) => ({
  messagesBySession: {},
  TTL: 60000,
  
  fetchMessages: async (sessionId) => {
    const now = Date.now();
    const cached = get().messagesBySession[sessionId];
    
    // å¦‚æœç¼“å­˜æœªè¿‡æœŸï¼Œç›´æ¥è¿”å›
    if (cached && now - cached.lastFetch < get().TTL) {
      console.log(`âœ… ä½¿ç”¨ç¼“å­˜çš„æ¶ˆæ¯ (session ${sessionId})`);
      return;
    }
    
    console.log(`ğŸ”„ åŠ è½½æ¶ˆæ¯å†å² (session ${sessionId})`);
    const messages = await api.get(`/api/sessions/${sessionId}/messages`);
    
    set(state => ({
      messagesBySession: {
        ...state.messagesBySession,
        [sessionId]: {
          messages,
          lastFetch: now,
          hasMore: messages.length >= 50
        }
      }
    }));
  },
  
  // WebSocket å®æ—¶æ·»åŠ æ–°æ¶ˆæ¯
  addMessage: (sessionId, message) => {
    set(state => {
      const session = state.messagesBySession[sessionId];
      if (!session) return state;
      
      return {
        messagesBySession: {
          ...state.messagesBySession,
          [sessionId]: {
            ...session,
            messages: [...session.messages, message],
            lastFetch: Date.now() // åˆ·æ–°ç¼“å­˜æ—¶é—´
          }
        }
      };
    });
  },
  
  // åŠ è½½æ›´å¤šå†å²æ¶ˆæ¯
  prependMessages: (sessionId, messages) => {
    set(state => {
      const session = state.messagesBySession[sessionId];
      if (!session) return state;
      
      return {
        messagesBySession: {
          ...state.messagesBySession,
          [sessionId]: {
            ...session,
            messages: [...messages, ...session.messages],
            hasMore: messages.length >= 50
          }
        }
      };
    });
  }
}));
```

#### èŠå¤©é¡µé¢ç»„ä»¶

```typescript
function ChatPage() {
  const { sessionId } = useParams();
  const { fetchMessages, addMessage, messagesBySession } = useMessagesStore();
  const [sending, setSending] = useState(false);
  
  const sessionData = messagesBySession[Number(sessionId)];
  const messages = sessionData?.messages || [];
  
  useEffect(() => {
    if (sessionId) {
      // ä¼˜å…ˆç”¨ç¼“å­˜ï¼Œå¦‚æœè¿‡æœŸæ‰ä¼šè¯·æ±‚
      fetchMessages(Number(sessionId));
    }
  }, [sessionId]);
  
  // WebSocket å®æ—¶æ¥æ”¶æ–°æ¶ˆæ¯
  useEffect(() => {
    const handleMessage = (data: WSMessage) => {
      if (data.sessionId === Number(sessionId)) {
        // ä¹è§‚æ›´æ–°ï¼šç«‹å³æ˜¾ç¤ºæ–°æ¶ˆæ¯
        addMessage(Number(sessionId), {
          id: Date.now(),
          content: data.content,
          sender_type: data.sender_type,
          created_at: data.timestamp
        });
      }
    };
    
    wsStore.addMessageListener(handleMessage);
    return () => wsStore.removeMessageListener(handleMessage);
  }, [sessionId]);
  
  // å‘é€æ¶ˆæ¯ï¼ˆä¹è§‚æ›´æ–°ï¼‰
  const handleSend = async (content: string) => {
    const tempMessage: Message = {
      id: Date.now(),
      content,
      sender_type: 'staff',
      created_at: new Date().toISOString(),
      _optimistic: true // æ ‡è®°ä¸ºä¹è§‚æ›´æ–°
    };
    
    // ç«‹å³æ˜¾ç¤ºåœ¨ UI ä¸Š
    addMessage(Number(sessionId), tempMessage);
    
    try {
      // åå°å‘é€åˆ°æœåŠ¡å™¨
      await api.post(`/api/sessions/${sessionId}/messages`, { content });
    } catch (error) {
      // å‘é€å¤±è´¥ï¼Œæ ‡è®°æ¶ˆæ¯é”™è¯¯
      toast.error('å‘é€å¤±è´¥');
    }
  };
  
  return (
    <ChatContainer>
      <MessageList messages={messages} />
      <SendBox onSend={handleSend} disabled={sending} />
    </ChatContainer>
  );
}
```

**å…³é”®ç‚¹**ï¼š
- âœ… 60ç§’å†…åˆ‡æ¢å›æ¥ = **0ms åŠ è½½**
- âœ… WebSocket å®æ—¶æ¨é€æ–°æ¶ˆæ¯
- âœ… ä¹è§‚æ›´æ–°ï¼šå‘é€æ¶ˆæ¯ç«‹å³æ˜¾ç¤º
- âœ… æ»šåŠ¨åŠ è½½æ›´å¤šï¼ˆåˆ†é¡µæŸ¥è¯¢ï¼‰

---

## ğŸ”„ å®Œæ•´çš„æ•°æ®åŒæ­¥æµç¨‹

### åœºæ™¯ 1ï¼šç”¨æˆ·åœ¨åº—é“ºåˆ—è¡¨

```
1. é¡µé¢åŠ è½½
   â”œâ”€ æ£€æŸ¥ç¼“å­˜ (0-30ç§’å†…)
   â”œâ”€ æœ‰ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤º (0ms)
   â””â”€ æ— ç¼“å­˜ â†’ API è¯·æ±‚ (200ms)

2. WebSocket è¿æ¥å»ºç«‹
   â””â”€ ç›‘å¬æ‰€æœ‰åº—é“ºçš„æ¶ˆæ¯

3. æ–°æ¶ˆæ¯åˆ°è¾¾ (åº—é“º A)
   â”œâ”€ WebSocket æ¨é€
   â”œâ”€ æ›´æ–°åº—é“º A çš„æœªè¯»æ•° (+1)
   â”œâ”€ æ›´æ–°åº—é“º A çš„æœ€åæ¶ˆæ¯
   â””â”€ é‡æ–°æ’åºåº—é“ºåˆ—è¡¨
   
æ€»è€—æ—¶: 0-200ms
```

### åœºæ™¯ 2ï¼šç‚¹å‡»è¿›å…¥å®¢æˆ·åˆ—è¡¨

```
1. è·¯ç”±è·³è½¬ /shops/1/customers
   â”œâ”€ æ£€æŸ¥ç¼“å­˜ (0-20ç§’å†…)
   â”œâ”€ æœ‰ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤º (0ms)
   â””â”€ æ— ç¼“å­˜ â†’ API è¯·æ±‚ (300ms, ä½†åå°æ‰§è¡Œ)

2. WebSocket ç»§ç»­ç›‘å¬
   â””â”€ åªæ¥æ”¶è¯¥åº—é“ºçš„æ¶ˆæ¯

3. æ–°æ¶ˆæ¯åˆ°è¾¾ (å®¢æˆ· B)
   â”œâ”€ WebSocket æ¨é€
   â”œâ”€ æ›´æ–°å®¢æˆ· B çš„å¡ç‰‡
   â””â”€ é‡æ–°æ’åºå®¢æˆ·åˆ—è¡¨
   
æ€»è€—æ—¶: 0-300ms (æœ‰ç¼“å­˜æ—¶ 0ms)
```

### åœºæ™¯ 3ï¼šç‚¹å‡»è¿›å…¥èŠå¤©

```
1. è·¯ç”±è·³è½¬ /chat/190
   â”œâ”€ æ£€æŸ¥ç¼“å­˜ (0-60ç§’å†…)
   â”œâ”€ æœ‰ç¼“å­˜ â†’ ç«‹å³æ˜¾ç¤º (0ms)
   â””â”€ æ— ç¼“å­˜ â†’ API è¯·æ±‚ (400ms)

2. WebSocket åˆ‡æ¢ç›‘å¬èŒƒå›´
   â””â”€ åªæ¥æ”¶è¯¥ä¼šè¯çš„æ¶ˆæ¯

3. æ–°æ¶ˆæ¯åˆ°è¾¾
   â”œâ”€ WebSocket æ¨é€
   â”œâ”€ è¿½åŠ åˆ°æ¶ˆæ¯åˆ—è¡¨
   â””â”€ è‡ªåŠ¨æ»šåŠ¨åˆ°åº•éƒ¨

4. å‘é€æ¶ˆæ¯
   â”œâ”€ ç«‹å³æ˜¾ç¤ºåœ¨ UI (ä¹è§‚æ›´æ–°, 0ms)
   â”œâ”€ åå°å‘é€åˆ°æœåŠ¡å™¨ (100ms)
   â””â”€ WebSocket ç¡®è®¤é€è¾¾
   
æ€»è€—æ—¶: 0-400ms (æœ‰ç¼“å­˜æ—¶ 0ms)
```

---

## ğŸ“Š æ€§èƒ½å¯¹æ¯”

### å½“å‰æ–¹æ¡ˆï¼ˆæ— ç¼“å­˜ï¼‰

| åœºæ™¯ | åŠ è½½æ—¶é—´ |
|------|---------|
| æ‰“å¼€åº—é“ºåˆ—è¡¨ | 500-1000ms |
| åˆ‡æ¢åˆ°å®¢æˆ·åˆ—è¡¨ | 1500-3000ms |
| è¿›å…¥èŠå¤©é¡µé¢ | 300-800ms |
| è¿”å›å†è¿›å…¥ï¼ˆé‡å¤ï¼‰ | **å†ç­‰ 1500-3000ms** âŒ |

### ä¼˜åŒ–æ–¹æ¡ˆï¼ˆå¸¦ç¼“å­˜ï¼‰

| åœºæ™¯ | é¦–æ¬¡åŠ è½½ | äºŒæ¬¡è®¿é—®ï¼ˆç¼“å­˜ï¼‰ |
|------|---------|----------------|
| æ‰“å¼€åº—é“ºåˆ—è¡¨ | 200ms | **0ms** âš¡ |
| åˆ‡æ¢åˆ°å®¢æˆ·åˆ—è¡¨ | 150ms | **0ms** âš¡ |
| è¿›å…¥èŠå¤©é¡µé¢ | 100ms | **0ms** âš¡ |
| è¿”å›å†è¿›å…¥ | - | **0ms** âš¡ |

**æå‡**: é¦–æ¬¡å¿« 5-10å€ï¼ŒäºŒæ¬¡è®¿é—®**ç¬é—´åŠ è½½**

---

## ğŸ¯ æœ€ä½³å®è·µæ€»ç»“

### 1. **æ•°æ®è·å–ç­–ç•¥**

```typescript
// âœ… æ­£ç¡®ï¼šç¼“å­˜ä¼˜å…ˆ + åå°åˆ·æ–°
async function fetchData(key, fetcher, ttl) {
  const cached = cache.get(key);
  const now = Date.now();
  
  // å¦‚æœç¼“å­˜æ–°é²œï¼Œç«‹å³è¿”å›
  if (cached && now - cached.time < ttl) {
    return cached.data;
  }
  
  // å¦‚æœç¼“å­˜è¿‡æœŸä½†å­˜åœ¨ï¼Œå…ˆè¿”å›æ—§æ•°æ®ï¼Œåå°åˆ·æ–°
  if (cached) {
    fetcher().then(data => cache.set(key, data, now));
    return cached.data; // å…ˆç”¨æ—§çš„ï¼Œé¿å…ç™½å±
  }
  
  // å®Œå…¨æ²¡æœ‰ç¼“å­˜ï¼Œç­‰å¾…åŠ è½½
  const data = await fetcher();
  cache.set(key, data, now);
  return data;
}
```

### 2. **WebSocket ä½¿ç”¨åŸåˆ™**

```
âœ… ç”¨äºï¼šå®æ—¶æ¨é€ï¼ˆæ–°æ¶ˆæ¯ã€çŠ¶æ€å˜åŒ–ï¼‰
âŒ ä¸ç”¨äºï¼šæ‰¹é‡æ•°æ®åŠ è½½ï¼ˆç”¨ REST APIï¼‰

âœ… ç›‘å¬èŒƒå›´ï¼šå½“å‰é¡µé¢ç›¸å…³çš„æ•°æ®
âŒ ä¸ç›‘å¬ï¼šæ— å…³é¡µé¢çš„æ•°æ®
```

### 3. **ç¼“å­˜ç­–ç•¥**

| æ•°æ®ç±»å‹ | TTL | æ›´æ–°æ–¹å¼ |
|---------|-----|---------|
| åº—é“ºåˆ—è¡¨ | 30ç§’ | WebSocket å¢é‡æ›´æ–° |
| å®¢æˆ·åˆ—è¡¨ | 20ç§’ | WebSocket å¢é‡æ›´æ–° |
| æ¶ˆæ¯å†å² | 60ç§’ | WebSocket è¿½åŠ æ¶ˆæ¯ |
| ç”¨æˆ·ä¿¡æ¯ | 5åˆ†é’Ÿ | API å®šæœŸåˆ·æ–° |

### 4. **å¹¶å‘è¯·æ±‚**

```typescript
// âœ… å¹¶è¡Œè¯·æ±‚
const [shops, customers, messages] = await Promise.all([
  fetchShops(),
  fetchCustomers(shopId),
  fetchMessages(sessionId)
]);

// âŒ ä¸²è¡Œè¯·æ±‚
const shops = await fetchShops();
const customers = await fetchCustomers(shopId);
const messages = await fetchMessages(sessionId);
```

---

## ğŸš€ å®æ–½æ­¥éª¤

### ç¬¬ 1 æ­¥ï¼šåˆ›å»ºå…¨å±€çŠ¶æ€ç®¡ç†ï¼ˆ1å°æ—¶ï¼‰
```bash
frontend/src/stores/
  â”œâ”€ shopsStore.ts       # åº—é“ºç¼“å­˜
  â”œâ”€ customersStore.ts   # å®¢æˆ·ç¼“å­˜
  â”œâ”€ messagesStore.ts    # æ¶ˆæ¯ç¼“å­˜
  â””â”€ cacheManager.ts     # ç»Ÿä¸€ç¼“å­˜ç®¡ç†
```

### ç¬¬ 2 æ­¥ï¼šä¼˜åŒ–åç«¯ APIï¼ˆ2å°æ—¶ï¼‰
- ä¿®æ”¹ N+1 æŸ¥è¯¢ä¸º JOIN æŸ¥è¯¢
- æ·»åŠ æ•°æ®åº“ç´¢å¼•

### ç¬¬ 3 æ­¥ï¼šä¿®æ”¹å‰ç«¯é¡µé¢ï¼ˆ2å°æ—¶ï¼‰
- æ¥å…¥ç¼“å­˜ store
- å®ç°ä¹è§‚æ›´æ–°
- ä¼˜åŒ– WebSocket ç›‘å¬

### ç¬¬ 4 æ­¥ï¼šæµ‹è¯•éªŒè¯ï¼ˆ1å°æ—¶ï¼‰
- æµ‹è¯•ç¼“å­˜å‘½ä¸­ç‡
- æµ‹è¯•å®æ—¶æ›´æ–°
- æ€§èƒ½åŸºå‡†æµ‹è¯•

**æ€»è€—æ—¶**: çº¦ 6 å°æ—¶

---

**éœ€è¦æˆ‘å¸®ä½ å¼€å§‹å®æ–½è¿™ä¸ªä¼˜åŒ–æ–¹æ¡ˆå—ï¼Ÿæˆ‘ä»¬å¯ä»¥ä»æœ€å…³é”®çš„"åˆ›å»ºç¼“å­˜ store"å¼€å§‹ï¼**