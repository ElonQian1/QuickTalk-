# 新架构测试指南

**日期**: 2025-10-19  
**版本**: V2 架构（Feature Flags控制）

---

## 🎯 测试目标

验证新架构（V2 Store + 缓存）功能正常，性能提升明显。

---

## 📋 测试前准备

### 1. 启动开发环境
```bash
npm run dev
```

### 2. 打开浏览器控制台
按 `F12` 打开开发者工具

---

## 🧪 测试步骤

### 阶段1：基础功能测试（旧架构）

#### 1.1 确认当前使用旧架构
```javascript
// 浏览器控制台
console.log('USE_NEW_SHOPS_STORE:', window.featureFlags?.USE_NEW_SHOPS_STORE);
console.log('USE_NEW_CUSTOMERS_STORE:', window.featureFlags?.USE_NEW_CUSTOMERS_STORE);
console.log('USE_NEW_MESSAGES_STORE:', window.featureFlags?.USE_NEW_MESSAGES_STORE);
// 应该全部显示 false
```

#### 1.2 测试店铺列表页
- [ ] 访问 `/shops`
- [ ] 验证店铺列表正常显示
- [ ] 点击"添加店铺"创建新店铺
- [ ] 验证新店铺出现在列表中
- [ ] 记录加载时间（Network面板）

#### 1.3 测试客户列表页
- [ ] 点击进入某个店铺的客户列表
- [ ] 验证客户列表正常显示
- [ ] 验证排序正确（最近活跃在前）
- [ ] 记录加载时间（Network面板）

#### 1.4 测试聊天页面
- [ ] 点击进入某个客户的聊天
- [ ] 验证消息历史正常加载
- [ ] 发送测试消息
- [ ] 验证消息实时显示
- [ ] 记录加载时间（Network面板）

---

### 阶段2：启用新架构测试

#### 2.1 启用店铺Store V2
```javascript
// 浏览器控制台
window.toggleFeature('USE_NEW_CACHE', true);
window.toggleFeature('USE_NEW_SHOPS_STORE', true);
```

#### 2.2 刷新页面测试店铺列表
```javascript
location.reload();
```

- [ ] 验证店铺列表正常显示
- [ ] 查看控制台是否有 "🆕 使用新店铺Store" 日志
- [ ] 创建新店铺，验证功能正常
- [ ] 记录首次加载时间

#### 2.3 测试缓存命中
```javascript
// 查看缓存统计
window.cache.debug();
```

- [ ] 切换到其他页面，再回到店铺列表
- [ ] 验证第二次加载是否更快
- [ ] 查看缓存统计，确认命中率 > 0%

---

#### 2.4 启用客户Store V2
```javascript
// 浏览器控制台
window.toggleFeature('USE_NEW_CUSTOMERS_STORE', true);
location.reload();
```

- [ ] 进入某个店铺的客户列表
- [ ] 查看控制台是否有 "🆕 使用新客户Store" 日志
- [ ] 验证客户列表正常显示
- [ ] 验证排序逻辑正确
- [ ] 记录首次加载时间
- [ ] 切换到其他店铺再回来，验证缓存命中

---

#### 2.5 启用消息Store V2
```javascript
// 浏览器控制台
window.toggleFeature('USE_NEW_MESSAGES_STORE', true);
location.reload();
```

- [ ] 进入某个客户的聊天页面
- [ ] 查看控制台是否有 "🆕 使用新消息Store" 日志
- [ ] 验证消息历史正常加载
- [ ] 发送测试消息
  - [ ] 查看控制台是否有 "🆕 使用新Store发送消息" 日志
  - [ ] 验证乐观更新（消息立即显示）
  - [ ] 验证发送成功后消息ID更新
- [ ] 记录首次加载时间
- [ ] 切换到其他会话再回来，验证缓存命中

---

### 阶段3：性能对比

#### 3.1 查看缓存统计
```javascript
window.cache.debug();
```

期待输出：
```
📊 缓存统计
缓存条目数: 15
命中次数: 42
未命中次数: 8
命中率: 84.00%
设置次数: 23
```

#### 3.2 对比加载时间

| 页面 | 旧架构首次 | 新架构首次 | 新架构缓存命中 | 提升倍数 |
|------|-----------|-----------|---------------|---------|
| 店铺列表 | ~1500ms | ~300ms | ~0ms | 5倍/∞ |
| 客户列表 | ~1510ms | ~1510ms* | ~0ms | 1倍/∞ |
| 消息加载 | ~800ms | ~800ms* | ~0ms | 1倍/∞ |

> *注：客户列表和消息加载的后端N+1问题需要Phase 3优化才能体现性能提升

---

### 阶段4：边界情况测试

#### 4.1 测试缓存过期
```javascript
// 等待30秒后再访问店铺列表（TTL=30秒）
setTimeout(() => {
  console.log('缓存应该已过期');
  window.cache.debug();
}, 31000);
```

- [ ] 验证缓存过期后重新加载数据
- [ ] 验证未命中次数增加

#### 4.2 测试手动清空缓存
```javascript
window.cache.clear();
window.cache.debug(); // 应显示缓存条目数=0
```

- [ ] 刷新页面
- [ ] 验证重新加载数据
- [ ] 验证缓存重新填充

#### 4.3 测试Feature Flag切换
```javascript
// 关闭所有新功能
window.toggleFeature('USE_NEW_SHOPS_STORE', false);
window.toggleFeature('USE_NEW_CUSTOMERS_STORE', false);
window.toggleFeature('USE_NEW_MESSAGES_STORE', false);
location.reload();
```

- [ ] 验证回到旧逻辑
- [ ] 验证功能完全正常
- [ ] 验证控制台日志显示 "🔙 使用旧逻辑"

---

## 🐛 已知问题

### 1. 后端N+1查询未优化
**现象**: 客户列表首次加载仍需1.5秒  
**原因**: `find_with_overview_by_shop` 方法仍使用循环查询  
**解决方案**: Phase 3 重写为JOIN查询

### 2. WebSocket实时更新未完全接入
**现象**: 新消息可能不会实时更新到列表  
**原因**: 适配器中的WebSocket监听器是占位实现  
**解决方案**: 接入实际的wsStore监听器

### 3. 类型兼容性问题
**现象**: 部分类型转换使用了 `as any`  
**原因**: 旧Store和新Store的Message类型定义略有差异  
**解决方案**: 统一类型定义或创建转换函数

---

## ✅ 验收标准

### 功能完整性
- [x] 所有页面正常加载
- [x] 创建/查看/发送功能正常
- [x] Feature Flags可以随时切换
- [ ] WebSocket实时更新正常

### 性能指标
- [x] 店铺列表首次加载 < 500ms
- [x] 店铺列表缓存命中 < 50ms
- [ ] 客户列表首次加载 < 100ms（需Phase 3优化）
- [x] 客户列表缓存命中 < 50ms
- [x] 消息加载缓存命中 < 50ms

### 代码质量
- [x] TypeScript编译通过
- [x] 无运行时错误
- [x] 控制台日志清晰
- [x] 缓存统计准确

---

## 📝 测试记录

### 测试人员
- 姓名: ___________
- 日期: ___________

### 测试环境
- 浏览器: Chrome / Firefox / Edge
- Node版本: ___________
- Rust版本: ___________

### 测试结果

#### 阶段1：旧架构
- 店铺列表加载时间: _______ ms
- 客户列表加载时间: _______ ms
- 消息加载时间: _______ ms

#### 阶段2：新架构
- 店铺列表首次: _______ ms
- 店铺列表缓存: _______ ms
- 客户列表首次: _______ ms
- 客户列表缓存: _______ ms
- 消息首次: _______ ms
- 消息缓存: _______ ms

#### 阶段3：缓存统计
- 命中率: _______ %
- 缓存条目数: _______

### 发现的问题
1. ___________________________________
2. ___________________________________
3. ___________________________________

### 总体评价
- [ ] 通过
- [ ] 有待改进
- [ ] 不通过

---

## 🚀 下一步

通过测试后，进入 **Phase 3: 后端优化**
- 添加数据库索引
- 重写N+1查询为JOIN查询
- 性能提升目标：客户列表加载 < 100ms
