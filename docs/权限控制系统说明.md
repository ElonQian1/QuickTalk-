# 权限控制系统实现说明

## 概述

针对用户反馈"只有管理员才处理批准店铺、拒绝店铺、激活店铺"和"现在是店主登录，他没有这种权限"的问题，已实现完整的基于角色的权限控制系统。

## 用户角色定义

1. **super_admin** - 超级管理员：拥有所有权限
2. **admin** - 管理员：拥有店铺管理权限
3. **shop_owner** - 店主：只能管理自己的店铺基础功能
4. **agent** - 客服：基础客服功能

## 权限控制架构

### 前端权限控制

#### 权限检查函数
```javascript
// 检查是否为管理员
function isAdmin()

// 检查是否可以管理店铺
function canManageShops()

// 检查是否可以批准店铺
function canApproveShops()

// 检查特定操作权限
function hasActionPermission(action)

// 检查员工管理权限
function canManageEmployees()
```

#### 动态UI生成
- `generateManagementOptions(shop)` - 根据用户角色生成管理选项
- `getShopActions(shop)` - 根据角色生成操作按钮

### 权限控制规则

#### 管理员专有操作
- `approve` - 批准店铺
- `reject` - 拒绝店铺
- `activate` - 激活店铺
- `deactivate` - 停用店铺

#### 通用操作（所有用户）
- `edit` - 编辑店铺信息
- `integration` - 查看集成代码

#### 角色限制操作
- `employees` - 员工管理（管理员或店主）

## 店铺状态与权限对应

### 管理员视图
- **pending** → 可批准/拒绝
- **approved** → 可激活/撤销批准
- **active** → 可停用
- **inactive** → 可重新激活
- **rejected** → 可重新批准

### 店主视图
- **pending** → 只能编辑信息，显示"审核中"提示
- **approved** → 显示付费激活按钮
- **active** → 可员工管理、集成代码
- **inactive** → 显示续费激活按钮
- **rejected** → 可修改信息重新申请

## 实现特性

### 1. 多层权限验证
- UI层面：根据角色动态生成界面
- 操作层面：在`handleShopAction`中验证权限
- API层面：后端需要添加对应验证（待实现）

### 2. 智能状态管理
- 根据店铺状态显示合适的操作选项
- 管理员看到完整的状态管理功能
- 店主只看到适合的业务操作

### 3. 用户体验优化
- 清晰的权限提示信息
- 基于续费状态的激活逻辑
- 友好的错误提示

## 已实现功能

✅ 前端权限检查函数系统
✅ 动态UI权限控制
✅ 店铺操作按钮角色控制
✅ 店铺管理模态框权限分离
✅ 操作权限验证
✅ 状态显示与权限匹配
✅ 调试日志输出

## 待实现功能

~~⏳ 后端API权限验证~~ （已实现，见下“后端权限验证实现”）
⏳ 付费激活逻辑实现
⏳ 续费状态检查
⏳ 权限配置管理界面

## 测试建议

1. **管理员测试**：
   - 登录管理员账户
   - 验证可以看到所有店铺状态管理选项
   - 测试批准、拒绝、激活、停用功能

2. **店主测试**：
   - 登录店主账户
   - 验证只能看到基础管理功能
   - 确认无法访问审核和状态管理功能

3. **权限绕过测试**：
   - 尝试直接调用管理员操作
   - 验证权限验证是否生效

## 安全注意事项

1. **前端权限验证不是安全边界**
2. **必须在后端API层面实现权限验证**
3. **敏感操作需要额外的身份验证**
4. **建议添加操作日志记录**

## 续费激活逻辑设计

管理员根据店主续费情况激活店铺：
1. 店主提交续费证明
2. 管理员验证续费状态
3. 管理员执行激活操作
4. 系统更新店铺状态为active

这确保了"管理根据店主是否续费来启用这些功能，或者激活店铺"的需求。

---

## 后端权限验证实现（新增 2025-09-25）

### 已加入的服务端强制规则

| 操作 | 旧行为 | 新行为 | 许可主体 |
|------|--------|--------|----------|
| GET /api/shops | super_admin 查看全部 | 默认仅看到 pending/rejected/inactive；?all=1 才全量 | super_admin 全量; 其它仅 owner 自己 |
| DELETE /api/shops/:id | 无鉴权 | 校验 super_admin 或店铺 owner | super_admin 或 owner |
| POST /api/shops/:id/rotate-api-key | 无鉴权 | 校验 super_admin 或 owner | super_admin 或 owner |
| PATCH/POST /api/shops/:id (update_shop) | 无鉴权 | 校验 super_admin 或 owner | super_admin 或 owner |
| POST /api/shops/:id/approve | 无强制 | 仅 super_admin | super_admin |
| POST /api/shops/:id/reject | 无强制 | 仅 super_admin | super_admin |
| POST /api/shops/:id/activate | 无强制 | 仅 super_admin | super_admin |
| POST /api/shops/:id/deactivate | 无强制 | 仅 super_admin | super_admin |

### 关键实现要点

1. 统一通过 `SessionExtractor` 注入当前 `admin_id`。
2. 封装 `enforce_super_admin(state, admin_id)` 辅助函数，集中角色校验。
3. 所有敏感操作先查询 `shops.owner_id`，再比对 `session.admin_id` 与角色。
4. 未授权返回 HTTP 403；非 owner 访问不存在资源时使用 404 降低存在性泄漏风险（在 `get_shop_details` 已保留）。
5. 超级管理员列表接口默认聚焦待处理（审核/问题）店铺，减少噪音并突出运营工作流。

### 查询与过滤策略

超级管理员：
- 默认：`status IN ('pending','rejected','inactive')`
- ?all=1 或 ?all=true：取消状态过滤，按创建时间倒序。

普通用户（店主 / admin / agent）：
- 仅自身 `owner_id = session.admin_id` 的店铺。

### 安全收益

* 彻底消除仅靠前端隐藏按钮的风险。
* 降低越权 API 调用面。
* 将审核操作集中到 super_admin，符合“超级管理员只负责审核”业务规则。

### 后续建议

1. 添加操作审计日志表（shop_audit_logs）。
2. 给激活/停用等操作加入事务与事件发布（领域事件 -> 通知/WebSocket）。
3. 将角色查询缓存到会话结构减少重复 SQL（可在登录时注入 role）。
4. 引入专门的应用服务层封装授权判定（逐步向 DDD UseCase 迁移）。

### 验证步骤（手动）

1. 使用普通店主账号登录：
   - 调用 GET /api/shops 应只返回自己的店铺。
   - 尝试 POST /api/shops/{other_id}/rotate-api-key 应得 403。
2. 使用 super_admin 登录：
   - GET /api/shops 默认不含 active 店铺（除非其状态符合过滤）。
   - GET /api/shops?all=1 返回全部。
3. 使用 super_admin 尝试 approve/reject/activate/deactivate 任一待审核店铺，应 200。
4. 使用普通店主调用上述审核端点，应 403。

### 相关代码位置

文件：`src/api/shops.rs`

新增辅助函数：
```rust
async fn enforce_super_admin(state: &Arc<AppState>, admin_id: &str) -> Result<(), StatusCode> { /* ... */ }
```

受影响函数：`get_shops`, `delete_shop`, `rotate_api_key`, `update_shop`, `approve_shop`, `reject_shop`, `activate_shop`, `deactivate_shop`。

---

文档更新时间：2025-09-25