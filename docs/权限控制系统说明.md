# 权限控制系统实现说明

## 概述

针对用户反馈"只有管理员才处理批准店铺、拒绝店铺、激活店铺"和"现在是店主登录，他没有这种权限"的问题，已实现完整的基于角色的权限控制系统。

## 用户角色定义

1. **super_admin** - 超级管理员：拥有所有权限
2. **admin** - 管理员：拥有店铺管理权限
3. **shop_owner** - 店主：只能管理自己的店铺基础功能
4. **agent** - 客服：基础客服功能

## 权限控制架构

### 前端权限控制

#### 权限检查函数
```javascript
// 检查是否为管理员
function isAdmin()

// 检查是否可以管理店铺
function canManageShops()

// 检查是否可以批准店铺
function canApproveShops()

// 检查特定操作权限
function hasActionPermission(action)

// 检查员工管理权限
function canManageEmployees()
```

#### 动态UI生成
- `generateManagementOptions(shop)` - 根据用户角色生成管理选项
- `getShopActions(shop)` - 根据角色生成操作按钮

### 权限控制规则

#### 管理员专有操作
- `approve` - 批准店铺
- `reject` - 拒绝店铺
- `activate` - 激活店铺
- `deactivate` - 停用店铺

#### 通用操作（所有用户）
- `edit` - 编辑店铺信息
- `integration` - 查看集成代码

#### 角色限制操作
- `employees` - 员工管理（管理员或店主）

## 店铺状态与权限对应

### 管理员视图
- **pending** → 可批准/拒绝
- **approved** → 可激活/撤销批准
- **active** → 可停用
- **inactive** → 可重新激活
- **rejected** → 可重新批准

### 店主视图
- **pending** → 只能编辑信息，显示"审核中"提示
- **approved** → 显示付费激活按钮
- **active** → 可员工管理、集成代码
- **inactive** → 显示续费激活按钮
- **rejected** → 可修改信息重新申请

## 实现特性

### 1. 多层权限验证
- UI层面：根据角色动态生成界面
- 操作层面：在`handleShopAction`中验证权限
- API层面：后端需要添加对应验证（待实现）

### 2. 智能状态管理
- 根据店铺状态显示合适的操作选项
- 管理员看到完整的状态管理功能
- 店主只看到适合的业务操作

### 3. 用户体验优化
- 清晰的权限提示信息
- 基于续费状态的激活逻辑
- 友好的错误提示

## 已实现功能

✅ 前端权限检查函数系统
✅ 动态UI权限控制
✅ 店铺操作按钮角色控制
✅ 店铺管理模态框权限分离
✅ 操作权限验证
✅ 状态显示与权限匹配
✅ 调试日志输出

## 待实现功能

⏳ 后端API权限验证
⏳ 付费激活逻辑实现
⏳ 续费状态检查
⏳ 权限配置管理界面

## 测试建议

1. **管理员测试**：
   - 登录管理员账户
   - 验证可以看到所有店铺状态管理选项
   - 测试批准、拒绝、激活、停用功能

2. **店主测试**：
   - 登录店主账户
   - 验证只能看到基础管理功能
   - 确认无法访问审核和状态管理功能

3. **权限绕过测试**：
   - 尝试直接调用管理员操作
   - 验证权限验证是否生效

## 安全注意事项

1. **前端权限验证不是安全边界**
2. **必须在后端API层面实现权限验证**
3. **敏感操作需要额外的身份验证**
4. **建议添加操作日志记录**

## 续费激活逻辑设计

管理员根据店主续费情况激活店铺：
1. 店主提交续费证明
2. 管理员验证续费状态
3. 管理员执行激活操作
4. 系统更新店铺状态为active

这确保了"管理根据店主是否续费来启用这些功能，或者激活店铺"的需求。