# 架构与实现风险清单（QuickTalk 纯 Rust 客服系统）

> 更新日期：2025-09-25  
> 分类维度：架构一致性 / 分层与领域 / 事件模型 / 数据与性能 / 安全 / 可维护性 / 测试 / 前端 / 运维部署 / 技术债  
> 评级说明：
> - 严重度 (Severity): S1=高影响/S2=中等/S3=低  
> - 紧急度 (Urgency): U1=需一周内处理 / U2=可一月内 / U3=观察即可  

---
## 1. 架构一致性
| 编号 | 描述 | 现状 | 风险 | 严重度 | 紧急度 | 备注 |
|------|------|------|------|--------|--------|------|
| A-01 | 旧目录与新分层并存（`db/` 既含仓库又含读模型） | 结构混合 | 增加新人认知成本 | S2 | U2 | 需引入 `infrastructure/` 过渡别名 |
| A-02 | 领域事件有两套（`domain/shared/events.rs` 与 `domain/conversation/mod.rs` 内部自定义） | 重复 | 事件扩展时易分叉 | S2 | U1 | 统一 DomainEvent 定义源 |
| A-03 | Handler 仍手动拼装 DTO | 重复映射代码 | 产出不一致 / 漏字段 | S3 | U2 | 可生成转换辅助 |
| A-04 | 前端仍消费旧 WebSocket `new_message` 等类型 | 协议未统一 | 新 envelope 上线需要双写 | S2 | U1 | 需 envelope 适配层 |

## 2. 分层与领域模型
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| D-01 | UseCase 有旧文件残留（已部分清理） | 造成调用混乱 | S3 | U2 |
| D-02 | 聚合不变式较少（仅 append + 状态） | 业务规则外泄倾向 | S2 | U2 |
| D-03 | 缺少跨聚合领域服务（如未读统计） | 读模型逻辑散落 | S3 | U3 |
| D-04 | 没有“读模型投影”机制 | 查询性能未来可能劣化 | S2 | U2 |

## 3. 事件模型与实时分发
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| E-01 | DomainEvent -> WebSocket 广播缺少统一 envelope | 客户端协议碎片化 | S1 | U1 |
| E-02 | 没有事件幂等ID（内部正计划 event_id） | 客户端重连重复处理风险 | S2 | U1 |
| E-03 | 事件发布未区分“领域事件”与“集成事件” | 后续扩展统计/审计困难 | S3 | U2 |
| E-04 | 无事件处理回压/队列 | 大量消息时广播阻塞风险 | S2 | U2 |

## 4. 数据与性能
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| DB-01 | 消息查询按 offset/limit + ORDER DESC | 大 offset 时性能退化 | S2 | U2 |
| DB-02 | 缺少基于时间/ID 游标分页 | 无法高效向上翻页 | S2 | U2 |
| DB-03 | 未确认 WAL / busy_timeout 配置 | 并发写阻塞风险 | S2 | U2 |
| DB-04 | 未读计数实时依赖全量统计 | 增长后读放大 | S2 | U2 |
| DB-05 | 缺少消息索引 (conversation_id, timestamp) 文档佐证 | 查询退化潜在 | S1 | U1 |

## 5. 安全
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| SEC-01 | WebSocket 认证直接发送 sessionId | 劫持风险（如无过期） | S1 | U1 |
| SEC-02 | 上传前端未做大小/MIME 限制 | 存储与执行风险 | S1 | U1 |
| SEC-03 | 无速率限制（消息/上传） | 滥用 DOS 风险 | S2 | U2 |
| SEC-04 | 未列出权限矩阵 -> 代码授权分散 | 越权潜伏 | S2 | U2 |

## 6. 可维护性与技术债
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| M-01 | 超大前端脚本（>1k 行） | 重构成本高 | S2 | U1 |
| M-02 | 脚本/工具散落（PowerShell/Shell） | 环境不可预期 | S3 | U2 |
| M-03 | 无统一代码风格检查（Rust fmt 已有, JS 无） | 代码风格漂移 | S3 | U3 |

## 7. 测试
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| T-01 | 领域/用例尚无单元测试 | 回归风险高 | S1 | U1 |
| T-02 | WebSocket 行为无自动化验证 | 实时回归隐患 | S2 | U2 |
| T-03 | 前端协议适配无契约测试 | 协议演进破坏旧前端可能 | S2 | U2 |

## 8. 前端结构
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| FE-01 | View/State/Transport 未分离 | 难以增量功能 | S2 | U1 |
| FE-02 | 消息模型字段不统一 | Bug 调试困难 | S2 | U1 |
| FE-03 | 没有按需局部渲染（全量 innerHTML） | 大消息量性能下降 | S2 | U2 |
| FE-04 | 缺离线/缓存策略 | 网络闪断体验差 | S3 | U3 |

## 9. 运维与部署
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| OP-01 | 多套 Dockerfile / hybrid 残留 | 误用错误镜像 | S2 | U1 |
| OP-02 | 数据库备份策略未文档化 | 数据丢失恢复不确定 | S1 | U2 |
| OP-03 | 迁移脚本未建立执行顺序规范 | 环境重建易失败 | S2 | U2 |

## 10. 其他 / 潜在
| 编号 | 描述 | 风险 | 严重度 | 紧急度 |
|------|------|------|--------|--------|
| OT-01 | 国际化 (i18n) 不支持 | 海外拓展成本 | S3 | U3 |
| OT-02 | 统计埋点未结构化 | 无法量化使用情况 | S2 | U3 |

---
## 汇总优先关注 (Top 10)
1. E-01 统一事件 envelope
2. SEC-01 WebSocket 认证强化
3. T-01 核心领域/用例测试
4. DB-05 确认/添加必要索引
5. FE-02 消息字段统一（已开始）
6. M-01 前端脚本拆分（进行中）
7. SEC-02 上传大小/MIME 校验
8. DB-01 分页策略升级（游标）
9. OP-01 清理混合部署产物
10. A-02 事件定义统一

---
## 风险处理策略建议映射
| 策略 | 适用风险 | 说明 |
|------|----------|------|
| 接受 | 低影响 / 高成本 | 暂不处理（如 OT-01 短期） |
| 缓解 | 中风险 | 文档化 + 计划演进 |
| 消除 | 高风险 / 低成本 | 立即修复（E-01, SEC-01） |
| 转移 | 运维/合规类 | 通过流程/外部服务降低责任 |

---
（本文档为动态文档，建议每次结构性迭代后更新。）
