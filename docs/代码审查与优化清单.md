# QuickTalk 代码审查与优化清单

更新时间：2025-10-05

> 目标：保持“纯 Rust 后端 + 纯静态前端”前提下，使消息 / 店铺 / 移动端客服体验模块化、可观测、可渐进下线 legacy，并控制单文件规模 & 避免重复逻辑。

---

## 1. 最新架构概览（前端消息域）

```
usecases/
   message-module.js          # 协调器（已瘦身，聚合入口 + 兼容层）
   message-boot.js            # 启动与副作用装配 (滚动/渲染/发送器/增强特性)
   message-navigation.js      # 导航与视图显示控制
   ws-event-router.js         # 统一 WS 事件路由 (domain.event.* / 普通事件)
   message-ws-events-handler.js (deprecated shim)
mobile/
   shops-mobile-adapter.js    # 移动端店铺列表
   shops-mobile-crud.js       # 移动端店铺创建
   conversations-mobile-adapter.js # 移动端会话列表 (新增)
state/
   message-state-store.js*    # 会话与消息集中状态（引用）
render/
   message-renderer.js*       # 全量渲染
   message-render-adapter.js* # 增量渲染适配
sender/
   message-sender.js*         # ACK / temp 消息队列
media/
   media-handler.js*          # 媒体、录音、上传
integration/
   shop-stats-service.js*     # 店铺统计统一获取
   customer-numbering.js*     # 客户编号策略
```
(* 表示文件已存在但未在本次文档中展开)

核心特征：
- 单一路径处理 WebSocket 事件（WsEventRouter）
- 兼容层集中在 `message-module.js`，将逐步迁出
- Boot 拆分后，协调器构造函数副作用显著减少
- 观测点：`__MessageLegacyUsage` + `__MessageBootInfo`

---

## 2. 已完成增量（最近两轮）
| 增量 | 状态 | 说明 |
|------|------|------|
| 拆分 Boot | ✅ | 初始化副作用迁移至 `message-boot.js` |
| 移动端会话列表 | ✅ | 新增 `conversations-mobile-adapter.js`（刷新 / 未读自增） |
| WS 路由统一 | ✅ | 仅保留 WsEventRouter 主路径，旧 handler 转 shim |
| 导航抽离 | ✅ | `message-navigation.js` 管理标题/返回/视图显示 |
| 店铺统计统一入口 | ✅ | `_fetchShopStatsSafe` 集中三层来源与兜底 |
| 客户编号去重 | ✅ | 保留增强策略 + 兜底 fallback |
| Legacy 使用计数 | ✅ | `_legacyUsage.*` + 控制台 `__MessageLegacyUsage.print()` |

---

## 3. 冗余 & 下线候选清单

| 项目 | 现用途 | 风险 | 下线条件 (策略) | 预计动作 |
|------|--------|------|----------------|----------|
| `_legacyLoadMessages` | 老消息加载入口 | 低 | 7 日内计数=0 | 移至 legacy-compat 并 stub |
| `_legacySendMessage` | 旧发送链路 | 中 | 新发送器成功率≥99% 且计数=0 | 删除 + 记录变更日志 |
| `_legacyLoadConversationsForShop` | 老会话加载 | 低 | 计数=0 | 下线 |
| `_legacyShowShops` | 老店铺展示 | 低 | 计数=0 | 下线 |
| `handleWebSocketMessage` (inline) | WS fallback | 中 | 计数=0 且 Router 稳定 3 天 | 移除 & 提示 |
| Fallback setTimeout 初始化 | 避免未引入 boot 空白 | 低 | 确认 boot 覆盖率≥95% | 删除 fallback |
| `updateConversationPreview` 双层 | 与 conversationsManager 内重复 | 低 | Manager 100% 接管 | Stub -> console.warn |

清理优先级：Inline WS > legacy send/load > preview 重复。

---

## 4. 移动端功能缺口盘点

| 功能块 | 现状 | 缺口 | 优先级 |
|--------|------|------|--------|
| 消息视图 | 复用桌面布局，未针对小屏优化 | 输入条高度 / 按钮触达区域 / 富媒体入口 | 高 |
| 会话列表 | 首版完成 | 搜索 / 置顶 / 分页 / 最近活跃排序 | 中 |
| 店铺列表 | 列表 & 创建可用 | 编辑 / 删除 / 集成代码弹窗 | 中 |
| 未读逻辑 | 徽章更新 + 进入会话清零 | 动画 & “回到上次阅读位置” | 中 |
| 发送体验 | 文本 + 基础提示 | 发送中状态 / 失败重试按钮 / 上传进度 | 中 |
| 媒体支持 | MediaHandler 可复用 | 移动端 UI 排布优化 | 中 |
| 暗色模式 | 局部覆盖 | 气泡/输入框/工具条全面适配 | 中 |
| 性能 | 无长列表优化 | 虚拟滚动 / 分段渲染 | 低 |

下一最小步：实现“移动端消息视图适配器 (message-view-mobile-adapter)”

---

## 5. 下一阶段“小步快跑”路线图

### S1（当前迭代：可见体验）
1. 移动端消息视图适配器（布局 + 输入条 + 富媒体入口分组）
2. 会话列表搜索 + 最近活跃排序（纯前端）
3. Inline WS handler 使用计数观察 & 预下线告警

### S2（兼容削减 & 观测增强）
1. 抽离 `legacy-compat-layer.js` 汇总 *所有* legacy 方法
2. WebSocket 事件统计 `ws-events-metrics.js`（domain vs legacy vs 未识别）
3. 移除 `_legacySendMessage` / `_legacyLoadMessages` （若条件满足）

### S3（结构强化）
1. Orchestrator 再瘦身 < 400 行（拆出 usecases/send / usecases/conversation-select）
2. 移除 fallback setTimeout 初始化分支
3. 引入极轻量 `DiagnosticPanel`（只读：boot steps / legacy usage / ws metrics）

---

## 6. 当前代码质量基线（更新）

| 维度 | 评分 | 说明 |
|------|------|------|
| 模块边界 | B+ | 已拆 Boot / 导航 / 移动适配，但兼容逻辑仍集中 |
| 冗余控制 | B | 有明确计数支撑的清理计划 |
| 可观测性 | A- | Boot + Legacy + (待补 WS metrics) |
| 可扩展性 | B+ | 单一路径事件 + 发送器抽象完善 |
| 移动端体验 | C+ | 会话列表 OK，消息视图待适配 |

改进关键：抽离 legacy / 移动端 UX / 事件指标。

---

## 7. 待验证功能分组（更新）

### 消息域（完善度高）
- [x] 店铺列表（含创建）
- [x] 会话列表（基础）
- [x] WebSocket 实时追加
- [x] 文本消息发送 & ACK 替换
- [x] 未读徽章自增
- [ ] 移动端消息视图适配（进行中 - 待实现）
- [ ] 发送失败重试 UI

### 店铺管理
- [x] 加载
- [x] 创建
- [ ] 编辑
- [ ] 删除
- [ ] 集成代码弹窗

### 员工管理
- [ ] 列表
- [ ] 创建/编辑/删除
- [ ] 权限配置

### 统计 / 工作台
- [ ] 店铺汇总统计卡片增强（刷新动画）
- [ ] 消息趋势图
- [ ] 实时在线客户数

### 个人中心
- [ ] 用户信息读取
- [ ] 密码修改
- [ ] 通知开关

---

## 8. 清理/下线策略（执行逻辑）
1. 每日（或人工触发）调用：`__MessageLegacyUsage.print()` & 记录快照。
2. 连续 3 次（≥24h 间隔）某 legacy 项为 0 → 标记 pending-remove。
3. 打补丁：
    - 将对应方法迁入 `legacy-compat-layer.js` 并在原位置导出 `console.warn('[deprecated removed] ...')`。
4. 发布后观察错误日志（若无消费）→ 删除 shim。

---

## 9. 统一工具/模式基线
| 领域 | 约束 | 统一点 |
|------|------|--------|
| Toast / 通知 | 不再直接调用 `showToast` | 使用 `Feedback.show` |
| 状态/空态 | 不重复手写 DOM | 使用 `StatusView.[loading|empty|error]`，缺席时降级 |
| WS 事件 | 单入口 | `WsEventRouter.route(module, raw)` |
| 消息发送 | 不绕过发送器 | `MessageSender.enqueue*` |
| 店铺统计 | 不多处 API 直拉 | `_fetchShopStatsSafe` |
| 客户编号 | 不内嵌拼接 | `CustomerNumbering.generateCustomerNumber` |

---

## 10. 观测面板字段（建议）
```js
window.__QTDiag = {
   get(){
      return {
         boot: window.__MessageBootInfo?.get(),
         legacy: window.__MessageLegacyUsage?.get(),
         ws: window.__WsEventsMetrics?.get?.(),
         hasSender: !!(window.MessageModuleInstance && window.MessageModuleInstance._sender),
         hasRouter: !!window.WsEventRouter,
         mobileAdapters: {
            shops: !!window.ShopsMobileAdapter,
            convs: !!window.MobileConversationsAdapter,
            msgView: !!window.MobileMessageViewAdapter
         }
      };
   }
};
```

---

## 11. 风险 / 注意事项
| 风险 | 说明 | 缓解 |
|------|------|------|
| 过早删除 legacy | 某旧入口仍被外部植入代码调用 | 先改为 warn stub 再完全删除 |
| 移动端视图不统一 | 混用桌面样式导致拥挤 | 单独 adapter + 精简工具条 |
| WS 重连提示干扰 | 频繁 toast | 去重 + 限频（已在 fallback 内） |
| 发送器 ACK 误替换 | temp_id 规则冲突 | 加入 temp_id 前缀/长度校验（后续） |

---

## 12. 当前行动 & 后续
### 进行中
- 移动端消息视图适配器 (下一提交计划)

### 下一步候选
1. 添加 `ws-events-metrics.js` 统计 domain / legacy / 其它类型占比
2. 抽离 `legacy-compat-layer.js`（第一批仅复制不删）
3. 新增 `message-view-mobile-adapter.js` + 样式段落
4. 发送失败重试 UI（按钮：重新发送 / 删除草稿）

---

## 13. 进度快照（更新）
| 里程碑 | 状态 | 备注 |
|--------|------|------|
| 模块恢复 | ✅ | 核心交互可用 |
| Boot 拆分 | ✅ | 辅助初始化归位 |
| 会话移动适配 | ✅ | 列表 + 未读增量 |
| Inline WS 路由合并 | ✅ | 单一入口运作 |
| 移动端消息视图 | ⏳ | 待实现 |
| Legacy 下线第一批 | 计划 | 等待计数归零 |
| WS Metrics | 计划 | 未实现 |

---

## 14. 代码质量检查清单（执行版）
- [ ] Orchestrator 控制在 < 400 行（当前：待统计）
- [x] 发送路径统一（无直接 websocket.send 文本）
- [x] 统计入口统一 `_fetchShopStatsSafe`
- [x] 客户编号统一调用 `CustomerNumbering`
- [ ] 移动端消息视图单独适配文件
- [ ] Legacy 方法迁出（阶段 1）
- [ ] WS 事件指标面板
- [ ] 移除 fallback setTimeout 初始化

---

## 15. 总结
系统已进入“兼容层瘦身 + 移动端体验补齐 + 可观测补强”阶段。建议保持：
1. 每次提交 ≤ 1 个核心模块 + 1 个观测/清理动作。
2. 使用 `_legacyUsage` 数据做删除决策，不主观猜测。
3. 先补齐移动端消息视图，再做大规模 legacy 下线，以免同时面临多源问题。

---

*本文档将随每轮小步重构更新。*
