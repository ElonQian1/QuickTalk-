# 移动端功能恢复计划

生成时间：2025-10-04

## 🔍 已发现的问题

### 1. 首页统计数据未加载 ❌
**问题**: `dashboard.js` 中定义了 `loadDashboardData()` 函数，但从未被调用
**影响**: 店铺总数、今日消息数显示为 0
**位置**: `dashboard.js` line 9, `app-bootstrap.js`

### 2. 首页快捷操作按钮绑定 ⚠️
**问题**: `quick-actions.html` 中使用了内联事件处理器，但对应函数可能未定义
**影响**: 点击"新增店铺"、"工作台/报表"按钮无响应
**位置**: `quick-actions.html`, `page-navigation.js`

## 📋 修复任务清单

### 任务1: 恢复首页统计数据加载
- [x] 识别问题：`loadDashboardData()` 未被调用
- [ ] 修改 `app-bootstrap.js`：在初始化完成后调用
- [ ] 修改 `dashboard-bootstrap.js`：添加数据加载触发
- [ ] 测试验证

### 任务2: 修复首页快捷操作
- [ ] 检查 `createNewShop()` 函数是否存在
- [ ] 检查 `viewAnalytics()` 函数是否存在
- [ ] 修改 `quick-actions.html`：使用 data 属性替代内联事件
- [ ] 修改 `dashboard-bootstrap.js`：添加事件委托
- [ ] 测试验证

### 任务3: 恢复页面切换功能
- [ ] 检查 `data-switch-page` 属性的处理器
- [ ] 验证 `page-navigation.js` 是否正确加载
- [ ] 测试验证

### 任务4: 验证底部导航
- [ ] 测试底部导航切换
- [ ] 验证未读徽章显示
- [ ] 测试验证

### 任务5: 验证消息页
- [ ] 测试店铺列表加载
- [ ] 测试对话列表加载
- [ ] 测试消息发送/接收
- [ ] 测试文件上传
- [ ] 测试 WebSocket 连接

### 任务6: 验证店铺页
- [ ] 测试店铺列表加载
- [ ] 测试创建店铺
- [ ] 测试编辑店铺
- [ ] 测试删除店铺
- [ ] 测试激活/停用

### 任务7: 验证工作台
- [ ] 测试统计数据显示
- [ ] 测试图表渲染

### 任务8: 验证个人中心
- [ ] 测试信息显示
- [ ] 测试密码修改
- [ ] 测试退出登录

## 🔧 修复代码

### 修复1: app-bootstrap.js - 添加首页数据加载

```javascript
// 在 _initializeUIComponents() 方法的最后添加
async _initializeUIComponents() {
    window.log.info('AppBootstrap', '初始化UI组件...');

    if (document.readyState === 'loading') {
        await new Promise(resolve => {
            document.addEventListener('DOMContentLoaded', resolve);
        });
    }

    this._initializeLegacyComponents();
    
    // 🔥 新增：加载首页数据
    await this._loadInitialData();

    window.log.info('AppBootstrap', '✅ UI组件初始化完成');
}

/**
 * 加载初始数据
 * @private
 */
async _loadInitialData() {
    try {
        // 等待部分组件加载
        await new Promise(r => setTimeout(r, 300));
        
        // 加载首页统计数据
        if (typeof window.loadDashboardData === 'function') {
            await window.loadDashboardData();
            window.log.info('AppBootstrap', '✅ 首页数据已加载');
        }
        
        // 触发其他初始化
        if (window.DashboardBootstrap && typeof window.DashboardBootstrap.init === 'function') {
            window.DashboardBootstrap.init();
        }
    } catch (error) {
        window.log.error('AppBootstrap', '初始数据加载失败', error);
    }
}
```

### 修复2: dashboard-bootstrap.js - 添加快捷操作绑定

```javascript
function bind(){
    const root = document.getElementById('homePage') || document;

    // 现有绑定...

    // 🔥 新增：快捷操作按钮绑定（使用事件委托）
    const actionButtons = root.querySelector('.action-buttons');
    if (actionButtons) {
        actionButtons.addEventListener('click', function(e) {
            const btn = e.target.closest('.action-btn');
            if (!btn) return;
            
            // data-switch-page 属性
            const switchPage = btn.getAttribute('data-switch-page');
            if (switchPage && typeof window.switchPage === 'function') {
                window.switchPage(switchPage);
                return;
            }
            
            // 其他操作
            const text = btn.textContent.trim();
            if (text.includes('新增店铺')) {
                if (typeof window.createNewShop === 'function') {
                    window.createNewShop();
                } else if (window.CreateShopModal && typeof window.CreateShopModal.open === 'function') {
                    window.CreateShopModal.open();
                }
            } else if (text.includes('工作台') || text.includes('报表')) {
                if (typeof window.viewAnalytics === 'function') {
                    window.viewAnalytics();
                } else if (typeof window.switchPage === 'function') {
                    window.switchPage('workbench');
                }
            }
        });
    }

    console.log('✅ dashboard-bootstrap.js 事件绑定完成（含快捷操作）');
}

// 初始化时也加载数据
let __wired = false;
function init(){ 
    if (__wired) return; 
    __wired = true; 
    setTimeout(() => {
        bind();
        // 🔥 新增：加载数据
        if (typeof window.loadDashboardData === 'function') {
            window.loadDashboardData().catch(e => console.error('加载首页数据失败:', e));
        }
    }, 200); 
}
```

### 修复3: quick-actions.html - 优化属性使用

```html
<!-- component: home/quick-actions -->
<div class="quick-actions">
  <h3 class="actions-title">快速操作</h3>
  <div class="action-buttons">
    <button class="action-btn tap-feedback" data-switch-page="messages">💬 查看消息</button>
    <button class="action-btn tap-feedback" data-switch-page="shops">🏪 管理店铺</button>
    <button class="action-btn tap-feedback" data-action="create-shop">➕ 新增店铺</button>
    <button class="action-btn tap-feedback" data-switch-page="workbench">📊 工作台/报表</button>
  </div>
</div>
```

## 📊 预期效果

修复完成后：
- ✅ 首页显示正确的店铺总数和今日消息数
- ✅ 所有快捷操作按钮都能正常工作
- ✅ 页面切换流畅
- ✅ 底部导航与顶部栏正常
- ✅ 所有模块功能完整

---

*开始执行修复...*
