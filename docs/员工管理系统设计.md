# 员工管理系统设计

## 数据库设计

### 1. 用户表 (users)
存储所有系统用户的基本信息
```sql
CREATE TABLE users (
    id TEXT PRIMARY KEY,
    username TEXT NOT NULL UNIQUE,
    email TEXT NOT NULL UNIQUE,
    password_hash TEXT NOT NULL,
    name TEXT NOT NULL,
    phone TEXT,
    avatar TEXT,
    role TEXT DEFAULT 'user' CHECK (role IN ('super_admin', 'admin', 'shop_owner', 'user')),
    status TEXT DEFAULT 'active' CHECK (status IN ('active', 'inactive', 'banned')),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

### 2. 员工表 (employees)
存储店铺员工关系和权限
```sql
CREATE TABLE employees (
    id TEXT PRIMARY KEY,
    shop_id TEXT NOT NULL,
    user_id TEXT NOT NULL,  -- 关联到users表
    invited_by TEXT NOT NULL, -- 邀请人(店主)ID
    role TEXT DEFAULT 'agent' CHECK (role IN ('manager', 'agent', 'viewer')),
    permissions TEXT, -- JSON格式的权限配置
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'active', 'inactive', 'rejected')),
    hired_at DATETIME,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (shop_id) REFERENCES shops(id),
    FOREIGN KEY (user_id) REFERENCES users(id),
    FOREIGN KEY (invited_by) REFERENCES users(id),
    UNIQUE(shop_id, user_id) -- 防止重复邀请
);
```

### 3. 员工邀请表 (employee_invitations)
管理邀请流程
```sql
CREATE TABLE employee_invitations (
    id TEXT PRIMARY KEY,
    shop_id TEXT NOT NULL,
    inviter_id TEXT NOT NULL, -- 邀请人ID
    invitee_email TEXT NOT NULL, -- 被邀请人邮箱
    invitee_id TEXT, -- 如果用户已注册
    role TEXT DEFAULT 'agent',
    message TEXT, -- 邀请消息
    token TEXT NOT NULL UNIQUE, -- 邀请令牌
    status TEXT DEFAULT 'pending' CHECK (status IN ('pending', 'accepted', 'rejected', 'expired')),
    expires_at DATETIME NOT NULL,
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    responded_at DATETIME,
    FOREIGN KEY (shop_id) REFERENCES shops(id),
    FOREIGN KEY (inviter_id) REFERENCES users(id),
    FOREIGN KEY (invitee_id) REFERENCES users(id)
);
```

### 4. 员工权限配置表 (employee_permissions)
详细的权限管理
```sql
CREATE TABLE employee_permissions (
    id TEXT PRIMARY KEY,
    employee_id TEXT NOT NULL,
    permission_type TEXT NOT NULL, -- 'conversation', 'customer', 'report', 'setting'
    permission_action TEXT NOT NULL, -- 'read', 'write', 'delete', 'manage'
    resource_id TEXT, -- 特定资源ID（如特定对话）
    granted_by TEXT NOT NULL, -- 授权人ID
    granted_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    expires_at DATETIME, -- 权限过期时间
    FOREIGN KEY (employee_id) REFERENCES employees(id),
    FOREIGN KEY (granted_by) REFERENCES users(id)
);
```

## 功能设计

### 1. 员工邀请流程
```
店主搜索用户 → 发送邀请 → 用户收到通知 → 接受/拒绝 → 成为员工
```

### 2. 权限分级
- **manager**: 管理级员工，可以邀请其他员工
- **agent**: 客服人员，处理客户咨询
- **viewer**: 只读权限，查看数据

### 3. 权限控制
- 员工只能访问所属店铺的数据
- 根据角色限制功能访问
- 支持细粒度权限控制

## API 设计

### 员工邀请
- `POST /api/shops/{shop_id}/invitations` - 发送邀请
- `GET /api/shops/{shop_id}/invitations` - 查看邀请列表
- `POST /api/invitations/{token}/accept` - 接受邀请
- `POST /api/invitations/{token}/reject` - 拒绝邀请

### 员工管理
- `GET /api/shops/{shop_id}/employees` - 获取员工列表
- `PUT /api/shops/{shop_id}/employees/{employee_id}` - 更新员工信息
- `DELETE /api/shops/{shop_id}/employees/{employee_id}` - 移除员工
- `POST /api/shops/{shop_id}/employees/{employee_id}/permissions` - 设置权限

### 用户搜索
- `GET /api/users/search?q={keyword}` - 搜索用户（用于邀请）

## 前端界面设计

### 1. 员工管理页面
- 员工列表（姓名、角色、状态、加入时间）
- 邀请新员工按钮
- 员工权限管理
- 员工状态管理（激活/停用）

### 2. 邀请流程界面
- 用户搜索框
- 角色选择器
- 邀请消息编辑
- 邀请历史记录

### 3. 员工权限设置
- 权限矩阵界面
- 角色模板快速设置
- 自定义权限配置

## 安全考虑

1. **权限验证**：每个API调用都验证用户权限
2. **数据隔离**：员工只能访问所属店铺数据
3. **邀请安全**：使用令牌和过期时间防止滥用
4. **审计日志**：记录所有员工操作

## 实现优先级

1. **第一阶段**：基础用户系统和员工表
2. **第二阶段**：邀请机制和基础权限
3. **第三阶段**：细粒度权限和高级功能
4. **第四阶段**：审计和安全优化