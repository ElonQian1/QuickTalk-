# 改进与演进计划（QuickTalk）

> 更新日期：2025-09-25  
> 目标：在不破坏线上稳定性的前提下，完成从“迁移完成”到“结构稳健、可演进”的过渡。

---
## 1. 优先级与度量标准
| 指标 | 说明 |
|------|------|
| ROI | 影响面 / 开发成本 比值（高优先） |
| Stabilization | 降低回归/事故风险 |
| Evolvability | 后续功能扩展加速度 |
| Observability | 可观测度提升 |

---
## 2. 行动清单（按阶段）

### 2.1 短期（1 周内）
| 编号 | 行动 | 价值 | 成本 | 负责人 | 说明 |
|------|------|------|------|--------|------|
| S-01 | 统一 DomainEvent 定义来源 | 高 | 低 | TBD | 去除双定义，集中在 `domain/shared/events.rs` |
| S-02 | 实现 OutboundEventEnvelope + WebSocket 适配 | 高 | 中 | TBD | 新协议 v1 稳定，兼容旧类型映射 |
| S-03 | WebSocket 认证协议文档化 & 校验添加过期/签名 | 高 | 中 | TBD | sessionId -> token（含过期时间） |
| S-04 | 消息仓库新增按 ID 查询（已完成） | 中 | 低 | DONE | 简化 handler 读取路径 |
| S-05 | 增加 upload 后端大小/MIME 校验 | 高 | 低 | TBD | 防滥用与恶意内容 |
| S-06 | 前端模块继续拆分：state-store + templates | 中 | 中 | TBD | 为增量渲染做准备 |
| S-07 | 添加 `tests/domain_send_message.rs` | 高 | 低 | TBD | 核心不变式保障 |
| S-08 | 添加索引检查（migration 或文档） | 高 | 低 | TBD | messages(conversation_id,timestamp) |

### 2.2 中期（1 月内）
| 编号 | 行动 | 价值 | 成本 | 说明 |
|------|------|------|------|------|
| M-01 | 引入读模型投影：conversation_summary 表 | 中 | 中 | 未读数/最后消息快速计算 |
| M-02 | 分页从 offset 改游标（before_id / after_id） | 高 | 中 | 无限滚动时性能更平稳 |
| M-03 | 事件分发抽象：EventDispatcher + Handler trait | 中 | 中 | 支持审计/统计模块挂载 |
| M-04 | 上传异步处理（大文件排队） | 中 | 中 | 防止阻塞主线程 |
| M-05 | 前端虚拟消息列表（窗口化渲染） | 中 | 中 | 大量历史消息性能保障 |
| M-06 | 增加前端协议契约测试（基于 JSON sample） | 高 | 中 | 避免协议漂移 |
| M-07 | Rust tracing + 统一 request span | 中 | 低 | 可观测 & 性能诊断 |
| M-08 | 简单权限策略（角色 -> 权限映射） | 高 | 中 | 强化多角色安全 |

### 2.3 长期（>1 月）
| 编号 | 行动 | 价值 | 成本 | 说明 |
|------|------|------|------|------|
| L-01 | 内部事件总线支持内存订阅聚合统计 | 中 | 中 | 增强实时监控/统计 |
| L-02 | 会话归档/分片策略（历史消息冷存） | 中 | 高 | 数据量增长后控制体积 |
| L-03 | 前端离线模式（IndexedDB + 重放队列） | 中 | 高 | 移动弱网体验 |
| L-04 | WebSocket 压缩 / 批量发送 | 中 | 中 | 高并发下带宽优化 |
| L-05 | 多区域部署（读本地 + 写主节点） | 中 | 高 | 地理加速 |
| L-06 | 合规模块（日志留存 / 审计导出） | 高 | 高 | 商业化合规需求 |

---
## 3. 事件协议演进计划
| 阶段 | 目标 | 内容 |
|------|------|------|
| v1 | 统一封装 | `{version:"v1", type, event_id, emitted_at, data}` |
| v1.1 | 扩展元数据 | 加入 `trace_id` / `source` 字段 |
| v2 | 批量事件 | 支持 data 数组压缩传输 |

兼容策略：新事件优先保持旧字段稳定；仅在结构不可兼容时提升 version。

## 4. 指标与验收
| 目标 | 指标 | 验收标准 |
|------|------|----------|
| 协议统一 | 旧 -> 新映射 | 所有 WebSocket 下发统一 envelope |
| 稳定性 | 回归测试 | 关键用例测试 >= 6 条稳定通过 |
| 性能 | 消息分页 | 单会话 10k 消息翻页 < 200ms (本地基准) |
| 安全 | 上传限制 | 大文件 (>20MB) 拒绝；非法 MIME 拒绝 |
| 可维护性 | 前端拆分 | 最大脚本文件 < 600 行 |

## 5. 风险与回滚策略
| 变更 | 风险 | 回滚方式 |
|------|------|----------|
| Envelope 上线 | 旧前端不兼容 | 保留旧类型并行广播一周 |
| 游标分页 | 客户端逻辑错误 | 开关 flag: `USE_CURSOR_PAGINATION=false` |
| 模块化前端 | 事件桥接缺失 | 保留 compat 层直到验收 |

## 6. 路线图（里程碑）
| 里程碑 | 目标 | 预计时间 |
|--------|------|----------|
| M1 | Envelope + 测试 + 上传校验 | +7 天 |
| M2 | 分页游标 + 读模型投影 | +30 天 |
| M3 | 权限策略 + 事件调度抽象 | +45 天 |
| M4 | 前端离线与虚拟列表 | +75 天 |

## 7. 工具与支持建议
| 方向 | 建议 |
|------|------|
| 测试 | 使用 `cargo nextest`（可选）加速本地回归 |
| 可观测 | 引入 `tracing-subscriber` + 结构化 JSON 输出（可选） |
| 静态分析 | 启用 `clippy` 严格级别：`warn` -> `deny` 渐进 |
| JS 质量 | 仅使用 `eslint --config .eslintrc.simple.json`（不引入打包） |

---
## 8. 已完成（Rolling）
| 编号 | 项目 | 完成日期 |
|------|------|----------|
| DONE-01 | 领域事件扩展（close/reopen） | 2025-09-25 |
| DONE-02 | 前端初步模块骨架 | 2025-09-25 |
| DONE-03 | 消息读取仓库 find_by_id | 2025-09-25 |

---
（该文档与 `ARCH_RISKS.md` 配套维护，改动后同步更新时间。）
