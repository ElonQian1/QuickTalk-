# 申请正式 HTTPS 证书指南

## 🎯 问题现状

当前使用的是**自签名证书**（localhost），导致浏览器显示"不安全"警告。

需要申请**由受信任 CA 签发的正式证书**才能解决。

---

## ✅ 解决方案 A：使用免费域名 + Let's Encrypt（推荐）

### 📋 准备工作

你已经有：
- **域名**: `elontalk.duckdns.org`
- **服务器IP**: `43.139.82.12`
- **DuckDNS Token**: `400bfeb6-b2fe-40e8-8cb6-7d38a2b943ca`

### 🚀 步骤 1：在 Ubuntu 服务器上安装 Certbot

SSH 登录到你的 Ubuntu 服务器：

```bash
# 更新软件包
sudo apt update

# 安装 Certbot 和插件
sudo apt install certbot python3-certbot-nginx -y

# 或者如果没有 nginx，安装 standalone 模式
sudo apt install certbot -y
```

### 🚀 步骤 2：停止当前服务（让 Certbot 使用 80 端口）

```bash
# 停止你的客服系统
sudo systemctl stop customer-service

# 或者如果没有 systemd 服务
pkill customer-service-backend
```

### 🚀 步骤 3：申请证书

```bash
# 使用 standalone 模式申请证书
sudo certbot certonly --standalone \
  --preferred-challenges http \
  --email siwmm@163.com \
  --agree-tos \
  --no-eff-email \
  -d elontalk.duckdns.org

# 等待完成，证书会保存到：
# /etc/letsencrypt/live/elontalk.duckdns.org/
```

### 🚀 步骤 4：复制证书到部署目录

```bash
# 复制证书文件
sudo cp /etc/letsencrypt/live/elontalk.duckdns.org/fullchain.pem \
        /root/ubuntu-deploy-ready/certs/server.crt

sudo cp /etc/letsencrypt/live/elontalk.duckdns.org/privkey.pem \
        /root/ubuntu-deploy-ready/certs/server.key

# 设置权限
sudo chmod 644 /root/ubuntu-deploy-ready/certs/server.crt
sudo chmod 600 /root/ubuntu-deploy-ready/certs/server.key
```

### 🚀 步骤 5：重启服务

```bash
cd /root/ubuntu-deploy-ready
sudo systemctl start customer-service

# 或者
./customer-service-backend
```

### 🚀 步骤 6：验证证书

在浏览器中访问：`https://elontalk.duckdns.org:8443`

应该看到：
- ✅ 锁图标变绿色
- ✅ 显示"连接是安全的"
- ✅ 证书颁发者：Let's Encrypt

---

## ✅ 解决方案 B：使用 DNS 验证（如果 80 端口被封）

如果你的服务器 80 端口被防火墙封锁，使用 DNS 验证：

### 方法 1：手动 DNS 验证

```bash
# 申请证书（DNS 验证）
sudo certbot certonly --manual \
  --preferred-challenges dns \
  --email siwmm@163.com \
  --agree-tos \
  --no-eff-email \
  -d elontalk.duckdns.org
```

Certbot 会提示你添加 DNS TXT 记录：

```
Please deploy a DNS TXT record under the name:
_acme-challenge.elontalk.duckdns.org

with the following value:
xxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

### 添加 DNS 记录到 DuckDNS

在浏览器中访问：
```
https://www.duckdns.org/update?domains=elontalk&token=400bfeb6-b2fe-40e8-8cb6-7d38a2b943ca&txt=xxxxxxxxxxxxxxxxxxxxxxxxxxxx
```

（替换 `xxxxxxxxxxxxxxxxxxxxxxxxxxxx` 为 Certbot 提供的值）

等待 1-2 分钟后，按回车继续验证。

---

## ✅ 解决方案 C：在 Windows 上申请证书（备用方案）

如果无法在服务器上申请，可以在 Windows 本地申请后上传。

### 🔧 使用 win-acme

1. **下载 win-acme**：
   ```powershell
   # 下载最新版本
   # https://github.com/win-acme/win-acme/releases/latest
   ```

2. **运行申请**（需要手动 DNS 验证）：
   ```powershell
   .\wacs.exe
   # 选择 M - Manual input
   # 输入域名: elontalk.duckdns.org
   # 选择验证方式: DNS-01
   ```

3. **复制证书**：
   ```powershell
   # 证书保存在 C:\ProgramData\win-acme\certificates\
   copy "C:\ProgramData\win-acme\certificates\elontalk.duckdns.org\*.crt" `
        "E:\duihua\customer-service-system\ubuntu-deploy-ready\certs\server.crt"
   
   copy "C:\ProgramData\win-acme\certificates\elontalk.duckdns.org\*.key" `
        "E:\duihua\customer-service-system\ubuntu-deploy-ready\certs\server.key"
   ```

---

## 🔄 证书自动续期

Let's Encrypt 证书有效期只有 **90 天**，需要定期续期。

### 在 Ubuntu 上设置自动续期

```bash
# Certbot 会自动创建定时任务
# 查看定时任务
sudo systemctl list-timers | grep certbot

# 手动测试续期
sudo certbot renew --dry-run

# 续期成功后，需要复制新证书并重启服务
# 创建续期后钩子脚本
sudo nano /etc/letsencrypt/renewal-hooks/post/copy-cert.sh
```

**脚本内容**：
```bash
#!/bin/bash
cp /etc/letsencrypt/live/elontalk.duckdns.org/fullchain.pem \
   /root/ubuntu-deploy-ready/certs/server.crt

cp /etc/letsencrypt/live/elontalk.duckdns.org/privkey.pem \
   /root/ubuntu-deploy-ready/certs/server.key

chmod 644 /root/ubuntu-deploy-ready/certs/server.crt
chmod 600 /root/ubuntu-deploy-ready/certs/server.key

systemctl restart customer-service
```

```bash
# 设置脚本可执行
sudo chmod +x /etc/letsencrypt/renewal-hooks/post/copy-cert.sh
```

---

## 🔍 验证证书信息

### 在 Ubuntu 上验证

```bash
openssl x509 -in /root/ubuntu-deploy-ready/certs/server.crt -text -noout | grep -E "Subject:|Issuer:|Not After"
```

应该显示：
```
Subject: CN=elontalk.duckdns.org
Issuer: C=US, O=Let's Encrypt, CN=R3
Not After : 2026-XX-XX XX:XX:XX GMT
```

### 在浏览器中验证

访问：`https://elontalk.duckdns.org:8443`

点击地址栏的锁图标 → 查看证书：
- ✅ 颁发给：elontalk.duckdns.org
- ✅ 颁发者：Let's Encrypt Authority X3
- ✅ 有效期：90 天

---

## ⚠️ 常见问题

### Q1: 80 端口被占用或被封锁

**解决**：使用 DNS-01 验证（方案 B）

### Q2: 申请失败 - rate limit

**原因**：Let's Encrypt 每周对同一域名限制 5 次申请

**解决**：等待 1 周后重试，或使用测试环境：
```bash
sudo certbot certonly --standalone --staging -d elontalk.duckdns.org
```

### Q3: 证书过期

**解决**：
```bash
# 手动续期
sudo certbot renew

# 强制续期
sudo certbot renew --force-renewal
```

### Q4: 浏览器仍然显示不安全

**检查**：
1. 是否使用了正确的域名（不是 IP 地址）
2. 是否清除了浏览器缓存
3. 证书是否已过期
4. 服务器是否加载了新证书（重启服务）

---

## 📚 相关文档

- Let's Encrypt 官方文档：https://letsencrypt.org/docs/
- Certbot 用户指南：https://certbot.eff.org/instructions
- DuckDNS 文档：https://www.duckdns.org/spec.jsp

---

## 🎯 推荐方案

**最简单最快的方案**：方案 A（在 Ubuntu 服务器上直接申请）

只需要 5 个命令：
```bash
sudo apt install certbot -y
sudo systemctl stop customer-service
sudo certbot certonly --standalone -d elontalk.duckdns.org --email siwmm@163.com --agree-tos
sudo cp /etc/letsencrypt/live/elontalk.duckdns.org/*.pem /root/ubuntu-deploy-ready/certs/
sudo systemctl start customer-service
```

完成后，你的网站就会显示 ✅ 安全锁了！
