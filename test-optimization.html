<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>代码优化验证测试页面</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .header {
            text-align: center;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        
        .test-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .test-section h3 {
            color: #333;
            border-bottom: 2px solid #667eea;
            padding-bottom: 10px;
        }
        
        .test-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background-color: #667eea;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #5a6fd8;
        }
        
        .btn-success {
            background-color: #28a745;
            color: white;
        }
        
        .btn-info {
            background-color: #17a2b8;
            color: white;
        }
        
        .btn-warning {
            background-color: #ffc107;
            color: #212529;
        }
        
        .test-output {
            background-color: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 14px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        
        .status {
            padding: 10px;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: 500;
        }
        
        .status.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background-color: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .demo-area {
            border: 2px dashed #dee2e6;
            padding: 20px;
            border-radius: 5px;
            min-height: 200px;
        }
        
        #test-messages {
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 10px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            background-color: #fafafa;
        }
        
        .message {
            margin: 5px 0;
            padding: 8px 12px;
            border-radius: 18px;
            max-width: 80%;
            word-wrap: break-word;
        }
        
        .message.customer {
            background-color: #e3f2fd;
            align-self: flex-start;
        }
        
        .message.staff {
            background-color: #667eea;
            color: white;
            align-self: flex-end;
            margin-left: auto;
        }
        
        .component-status {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .component-card {
            background: white;
            border: 1px solid #dee2e6;
            border-radius: 5px;
            padding: 15px;
            text-align: center;
        }
        
        .component-card.loaded {
            border-color: #28a745;
            background-color: #f8fff9;
        }
        
        .component-card.error {
            border-color: #dc3545;
            background-color: #fff5f5;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>🧪 QuickTalk 代码优化验证测试</h1>
        <p>验证统一组件的功能完整性和性能表现</p>
    </div>

    <!-- 组件状态检查 -->
    <div class="test-section">
        <h3>📦 组件加载状态</h3>
        <div class="component-status">
            <div class="component-card" id="utils-status">
                <h4>UnifiedUtils</h4>
                <div class="loading"></div>
                <p>检查中...</p>
            </div>
            <div class="component-card" id="websocket-status">
                <h4>UnifiedWebSocketClient</h4>
                <div class="loading"></div>
                <p>检查中...</p>
            </div>
            <div class="component-card" id="message-status">
                <h4>UnifiedMessageManager</h4>
                <div class="loading"></div>
                <p>检查中...</p>
            </div>
        </div>
    </div>

    <!-- 工具函数测试 -->
    <div class="test-section">
        <h3>🔧 UnifiedUtils 工具函数测试</h3>
        <div class="test-controls">
            <button class="btn btn-primary" onclick="testDeepClone()">测试深拷贝</button>
            <button class="btn btn-primary" onclick="testDebounce()">测试防抖</button>
            <button class="btn btn-primary" onclick="testFormatTime()">测试时间格式化</button>
            <button class="btn btn-primary" onclick="testFileSize()">测试文件大小格式化</button>
            <button class="btn btn-primary" onclick="testValidation()">测试验证函数</button>
        </div>
        <div id="utils-output" class="test-output"></div>
    </div>

    <!-- WebSocket连接测试 -->
    <div class="test-section">
        <h3>🔌 UnifiedWebSocketClient 连接测试</h3>
        <div class="test-controls">
            <button class="btn btn-success" onclick="testWebSocketConnection()">测试连接</button>
            <button class="btn btn-info" onclick="testWebSocketSend()">测试发送消息</button>
            <button class="btn btn-warning" onclick="testWebSocketDisconnect()">断开连接</button>
        </div>
        <div id="websocket-status-display" class="status info">
            连接状态: 未连接
        </div>
        <div id="websocket-output" class="test-output"></div>
    </div>

    <!-- 消息管理器测试 -->
    <div class="test-section">
        <h3>💬 UnifiedMessageManager 消息测试</h3>
        <div class="test-controls">
            <button class="btn btn-primary" onclick="testAddMessage()">添加文本消息</button>
            <button class="btn btn-primary" onclick="testAddImageMessage()">添加图片消息</button>
            <button class="btn btn-primary" onclick="testMarkAsRead()">标记已读</button>
            <button class="btn btn-warning" onclick="clearMessages()">清空消息</button>
        </div>
        <div class="demo-area">
            <h4>消息演示区域:</h4>
            <div id="test-messages"></div>
        </div>
        <div id="message-output" class="test-output"></div>
    </div>

    <!-- 性能测试 -->
    <div class="test-section">
        <h3>⚡ 性能测试</h3>
        <div class="test-controls">
            <button class="btn btn-info" onclick="testPerformance()">运行性能测试</button>
            <button class="btn btn-primary" onclick="runFullTestSuite()">运行完整测试套件</button>
        </div>
        <div id="performance-output" class="test-output"></div>
    </div>

    <!-- 引入统一组件库 -->
    <script src="/static/js/core/UnifiedUtils.js"></script>
    <script src="/static/js/core/UnifiedWebSocketClient.js"></script>
    <script src="/static/js/core/UnifiedMessageManager.js"></script>
    
    <!-- 测试脚本 -->
    <script src="/test-optimization-validation.js"></script>
    
    <script>
        // 全局变量
        let testWebSocketClient = null;
        let testMessageManager = null;
        let messageCounter = 0;

        // 页面加载完成后检查组件状态
        document.addEventListener('DOMContentLoaded', function() {
            checkComponentStatus();
            initializeTestComponents();
        });

        // 检查组件加载状态
        function checkComponentStatus() {
            const components = [
                { id: 'utils-status', name: 'UnifiedUtils', check: () => typeof UnifiedUtils !== 'undefined' },
                { id: 'websocket-status', name: 'UnifiedWebSocketClient', check: () => typeof UnifiedWebSocketClient !== 'undefined' },
                { id: 'message-status', name: 'UnifiedMessageManager', check: () => typeof UnifiedMessageManager !== 'undefined' }
            ];

            components.forEach(component => {
                const element = document.getElementById(component.id);
                const isLoaded = component.check();
                
                if (isLoaded) {
                    element.className = 'component-card loaded';
                    element.innerHTML = `<h4>${component.name}</h4><p>✅ 已加载</p>`;
                } else {
                    element.className = 'component-card error';
                    element.innerHTML = `<h4>${component.name}</h4><p>❌ 加载失败</p>`;
                }
            });
        }

        // 初始化测试组件
        function initializeTestComponents() {
            try {
                testMessageManager = new UnifiedMessageManager({
                    containerId: 'test-messages',
                    onNewMessage: (message) => {
                        logToOutput('message-output', `新消息回调: ${JSON.stringify(message)}`);
                    }
                });
                logToOutput('message-output', '✅ UnifiedMessageManager 初始化成功');
            } catch (error) {
                logToOutput('message-output', `❌ UnifiedMessageManager 初始化失败: ${error.message}`);
            }
        }

        // 输出日志到指定区域
        function logToOutput(outputId, message) {
            const output = document.getElementById(outputId);
            const timestamp = new Date().toLocaleTimeString();
            output.textContent += `[${timestamp}] ${message}\n`;
            output.scrollTop = output.scrollHeight;
        }

        // 工具函数测试
        function testDeepClone() {
            try {
                const original = { a: 1, b: { c: 2 }, d: [1, 2, 3] };
                const cloned = UnifiedUtils.deepClone(original);
                
                const success = JSON.stringify(cloned) === JSON.stringify(original) && cloned !== original;
                logToOutput('utils-output', `深拷贝测试: ${success ? '✅ 通过' : '❌ 失败'}`);
                logToOutput('utils-output', `原对象: ${JSON.stringify(original)}`);
                logToOutput('utils-output', `拷贝对象: ${JSON.stringify(cloned)}`);
            } catch (error) {
                logToOutput('utils-output', `❌ 深拷贝测试异常: ${error.message}`);
            }
        }

        function testDebounce() {
            try {
                let counter = 0;
                const debouncedFn = UnifiedUtils.debounce(() => counter++, 500);
                
                logToOutput('utils-output', '开始防抖测试，快速调用5次...');
                for (let i = 0; i < 5; i++) {
                    debouncedFn();
                }
                
                setTimeout(() => {
                    logToOutput('utils-output', `防抖测试结果: 计数器值 = ${counter} ${counter === 1 ? '✅ 通过' : '❌ 失败'}`);
                }, 1000);
            } catch (error) {
                logToOutput('utils-output', `❌ 防抖测试异常: ${error.message}`);
            }
        }

        function testFormatTime() {
            try {
                const testDate = new Date('2024-12-01T12:30:45');
                const formatted = UnifiedUtils.formatTime(testDate, 'YYYY-MM-DD HH:mm:ss');
                const expected = '2024-12-01 12:30:45';
                
                logToOutput('utils-output', `时间格式化测试: ${formatted === expected ? '✅ 通过' : '❌ 失败'}`);
                logToOutput('utils-output', `预期: ${expected}, 实际: ${formatted}`);
            } catch (error) {
                logToOutput('utils-output', `❌ 时间格式化测试异常: ${error.message}`);
            }
        }

        function testFileSize() {
            try {
                const tests = [
                    { input: 1024, expected: '1 KB' },
                    { input: 1048576, expected: '1 MB' },
                    { input: 1073741824, expected: '1 GB' }
                ];
                
                tests.forEach(test => {
                    const result = UnifiedUtils.formatFileSize(test.input);
                    const success = result === test.expected;
                    logToOutput('utils-output', `文件大小格式化 ${test.input}: ${result} ${success ? '✅' : '❌'}`);
                });
            } catch (error) {
                logToOutput('utils-output', `❌ 文件大小格式化测试异常: ${error.message}`);
            }
        }

        function testValidation() {
            try {
                const emailTests = [
                    { input: 'test@example.com', expected: true },
                    { input: 'invalid-email', expected: false }
                ];
                
                const urlTests = [
                    { input: 'https://example.com', expected: true },
                    { input: 'invalid-url', expected: false }
                ];
                
                emailTests.forEach(test => {
                    const result = UnifiedUtils.isValidEmail(test.input);
                    logToOutput('utils-output', `邮箱验证 "${test.input}": ${result} ${result === test.expected ? '✅' : '❌'}`);
                });
                
                urlTests.forEach(test => {
                    const result = UnifiedUtils.isValidUrl(test.input);
                    logToOutput('utils-output', `URL验证 "${test.input}": ${result} ${result === test.expected ? '✅' : '❌'}`);
                });
            } catch (error) {
                logToOutput('utils-output', `❌ 验证函数测试异常: ${error.message}`);
            }
        }

        // WebSocket测试
        function testWebSocketConnection() {
            try {
                if (testWebSocketClient && testWebSocketClient.isConnected()) {
                    logToOutput('websocket-output', '连接已存在，先断开...');
                    testWebSocketClient.disconnect();
                }

                testWebSocketClient = new UnifiedWebSocketClient({
                    url: `${window.location.protocol === 'https:' ? 'wss:' : 'ws:'}//${window.location.host}/ws`,
                    onConnect: () => {
                        logToOutput('websocket-output', '✅ WebSocket连接已建立');
                        updateWebSocketStatus('已连接', 'success');
                    },
                    onMessage: (data) => {
                        logToOutput('websocket-output', `📨 收到消息: ${JSON.stringify(data)}`);
                    },
                    onDisconnect: () => {
                        logToOutput('websocket-output', '🔌 WebSocket连接已断开');
                        updateWebSocketStatus('已断开', 'error');
                    },
                    onError: (error) => {
                        logToOutput('websocket-output', `❌ WebSocket错误: ${error}`);
                        updateWebSocketStatus('连接错误', 'error');
                    },
                    autoReconnect: false
                });

                testWebSocketClient.connect();
                updateWebSocketStatus('连接中...', 'info');
                logToOutput('websocket-output', '开始WebSocket连接测试...');
            } catch (error) {
                logToOutput('websocket-output', `❌ WebSocket连接测试异常: ${error.message}`);
                updateWebSocketStatus('连接失败', 'error');
            }
        }

        function testWebSocketSend() {
            if (!testWebSocketClient || !testWebSocketClient.isConnected()) {
                logToOutput('websocket-output', '❌ WebSocket未连接，请先建立连接');
                return;
            }

            try {
                const testMessage = {
                    type: 'test',
                    content: `测试消息 #${++messageCounter}`,
                    timestamp: Date.now()
                };

                testWebSocketClient.send(testMessage);
                logToOutput('websocket-output', `📤 发送测试消息: ${JSON.stringify(testMessage)}`);
            } catch (error) {
                logToOutput('websocket-output', `❌ 发送消息失败: ${error.message}`);
            }
        }

        function testWebSocketDisconnect() {
            if (testWebSocketClient) {
                testWebSocketClient.disconnect();
                logToOutput('websocket-output', '断开WebSocket连接');
            } else {
                logToOutput('websocket-output', '没有活动的WebSocket连接');
            }
        }

        function updateWebSocketStatus(status, type) {
            const statusElement = document.getElementById('websocket-status-display');
            statusElement.textContent = `连接状态: ${status}`;
            statusElement.className = `status ${type}`;
        }

        // 消息管理器测试
        function testAddMessage() {
            if (!testMessageManager) {
                logToOutput('message-output', '❌ UnifiedMessageManager 未初始化');
                return;
            }

            const message = {
                id: `test-msg-${++messageCounter}`,
                content: `这是测试消息 #${messageCounter}`,
                sender_type: messageCounter % 2 === 0 ? 'customer' : 'staff',
                created_at: new Date().toISOString()
            };

            testMessageManager.addMessage(message);
            logToOutput('message-output', `✅ 添加消息: ${JSON.stringify(message)}`);
        }

        function testAddImageMessage() {
            if (!testMessageManager) {
                logToOutput('message-output', '❌ UnifiedMessageManager 未初始化');
                return;
            }

            const imageMessage = {
                id: `test-img-${++messageCounter}`,
                content: '图片消息',
                sender_type: 'staff',
                file_url: 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KICA8cmVjdCB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgZmlsbD0iIzY2N2VlYSIvPgogIDx0ZXh0IHg9IjUwIiB5PSI1NSIgZm9udC1mYW1pbHk9IkFyaWFsIiBmb250LXNpemU9IjE0IiBmaWxsPSJ3aGl0ZSIgdGV4dC1hbmNob3I9Im1pZGRsZSI+VEVTVDwvdGV4dD4KPC9zdmc+',
                file_name: 'test-image.svg',
                created_at: new Date().toISOString()
            };

            testMessageManager.addImageMessage(imageMessage);
            logToOutput('message-output', `✅ 添加图片消息: ${imageMessage.file_name}`);
        }

        function testMarkAsRead() {
            if (!testMessageManager) {
                logToOutput('message-output', '❌ UnifiedMessageManager 未初始化');
                return;
            }

            const messageElements = document.querySelectorAll('#test-messages .message');
            const messageIds = Array.from(messageElements).map(el => el.dataset.messageId).filter(id => id);

            if (messageIds.length > 0) {
                testMessageManager.markMessagesAsRead(messageIds);
                logToOutput('message-output', `✅ 标记 ${messageIds.length} 条消息为已读`);
            } else {
                logToOutput('message-output', '❌ 没有消息可标记为已读');
            }
        }

        function clearMessages() {
            const container = document.getElementById('test-messages');
            container.innerHTML = '';
            logToOutput('message-output', '🗑️ 清空所有测试消息');
        }

        // 性能测试
        function testPerformance() {
            logToOutput('performance-output', '🚀 开始性能测试...');

            // 深拷贝性能测试
            const largeObject = {
                data: new Array(1000).fill(0).map((_, i) => ({ id: i, value: `item_${i}`, nested: { prop: i * 2 } }))
            };

            const startTime = performance.now();
            const cloned = UnifiedUtils.deepClone(largeObject);
            const endTime = performance.now();
            const cloneTime = endTime - startTime;

            logToOutput('performance-output', `深拷贝性能: ${cloneTime.toFixed(2)}ms (1000个对象)`);
            logToOutput('performance-output', `拷贝正确性: ${cloned.data.length === 1000 ? '✅ 通过' : '❌ 失败'}`);

            // 防抖性能测试
            let counter = 0;
            const perfStartTime = performance.now();
            const debouncedFn = UnifiedUtils.debounce(() => counter++, 10);

            for (let i = 0; i < 100; i++) {
                debouncedFn();
            }

            const perfEndTime = performance.now();
            const debounceTime = perfEndTime - perfStartTime;

            logToOutput('performance-output', `防抖创建性能: ${debounceTime.toFixed(2)}ms (100次调用)`);

            // 消息渲染性能测试
            if (testMessageManager) {
                const renderStartTime = performance.now();
                
                for (let i = 0; i < 50; i++) {
                    testMessageManager.addMessage({
                        id: `perf-test-${i}`,
                        content: `性能测试消息 ${i}`,
                        sender_type: i % 2 === 0 ? 'customer' : 'staff',
                        created_at: new Date().toISOString()
                    });
                }
                
                const renderEndTime = performance.now();
                const renderTime = renderEndTime - renderStartTime;
                
                logToOutput('performance-output', `消息渲染性能: ${renderTime.toFixed(2)}ms (50条消息)`);
                
                // 清理性能测试消息
                setTimeout(() => {
                    clearMessages();
                    logToOutput('performance-output', '🧹 清理性能测试消息');
                }, 2000);
            }
        }

        // 运行完整测试套件
        function runFullTestSuite() {
            if (typeof runAllTests === 'function') {
                logToOutput('performance-output', '🧪 启动完整测试套件...');
                runAllTests().then(report => {
                    logToOutput('performance-output', `📊 测试完成: 通过 ${report.passed}, 失败 ${report.failed}`);
                    logToOutput('performance-output', `📈 成功率: ${report.successRate}%`);
                });
            } else {
                logToOutput('performance-output', '❌ 完整测试套件未加载');
            }
        }
    </script>
</body>
</html>