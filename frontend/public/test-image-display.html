<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>图片显示测试</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        .test-section {
            margin: 20px 0;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        .upload-area {
            border: 2px dashed #ccc;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 10px 0;
        }
        .chat-container {
            height: 300px;
            border: 1px solid #ddd;
            overflow-y: auto;
            padding: 10px;
        }
        .message {
            margin: 10px 0;
            padding: 10px;
            border-radius: 8px;
        }
        .user-message {
            background: #007bff;
            color: white;
            text-align: right;
        }
        .staff-message {
            background: #f8f9fa;
            color: #333;
        }
        .message-image {
            max-width: 200px;
            max-height: 200px;
            border-radius: 8px;
            cursor: pointer;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <h1>图片上传和显示测试</h1>
    
    <!-- 图片上传测试 -->
    <div class="test-section">
        <h2>1. 图片上传测试</h2>
        <div class="upload-area">
            <input type="file" id="imageInput" accept="image/*">
            <button onclick="uploadImage()">上传图片</button>
        </div>
        <div id="uploadStatus"></div>
    </div>
    
    <!-- API测试 -->
    <div class="test-section">
        <h2>2. API 测试</h2>
        <button onclick="testFileAPI()">测试文件信息API</button>
        <button onclick="testChatAPI()">测试聊天API</button>
        <div id="apiResults" class="log"></div>
    </div>
    
    <!-- 聊天显示测试 -->
    <div class="test-section">
        <h2>3. 聊天界面测试</h2>
        <div id="chatContainer" class="chat-container"></div>
        <button onclick="testImageMessage()">测试图片消息显示</button>
        <button onclick="clearChat()">清空聊天</button>
    </div>
    
    <!-- 调试日志 -->
    <div class="test-section">
        <h2>4. 调试日志</h2>
        <div id="debugLog" class="log"></div>
        <button onclick="clearLog()">清空日志</button>
    </div>

    <script>
        const log = (message) => {
            const logDiv = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logDiv.innerHTML += `[${timestamp}] ${message}<br>`;
            logDiv.scrollTop = logDiv.scrollHeight;
            console.log(message);
        };
        
        let lastUploadedFileId = null;
        
        async function uploadImage() {
            const input = document.getElementById('imageInput');
            const statusDiv = document.getElementById('uploadStatus');
            
            if (!input.files[0]) {
                statusDiv.innerHTML = '<span style="color: red;">请选择一张图片</span>';
                return;
            }
            
            const file = input.files[0];
            log(`开始上传图片: ${file.name}, 大小: ${file.size} bytes`);
            
            const formData = new FormData();
            formData.append('files', file);
            
            try {
                statusDiv.innerHTML = '<span style="color: blue;">上传中...</span>';
                
                const response = await fetch('/api/files/upload', {
                    method: 'POST',
                    body: formData
                });
                
                const result = await response.json();
                log(`上传响应: ${JSON.stringify(result, null, 2)}`);
                
                if (result.success && result.files && result.files.length > 0) {
                    lastUploadedFileId = result.files[0].id;
                    statusDiv.innerHTML = `<span style="color: green;">上传成功！文件ID: ${lastUploadedFileId}</span>`;
                    log(`上传成功，文件ID: ${lastUploadedFileId}`);
                } else {
                    statusDiv.innerHTML = `<span style="color: red;">上传失败: ${result.error}</span>`;
                    log(`上传失败: ${result.error}`);
                }
            } catch (error) {
                statusDiv.innerHTML = `<span style="color: red;">上传错误: ${error.message}</span>`;
                log(`上传错误: ${error.message}`);
            }
        }
        
        async function testFileAPI() {
            const resultsDiv = document.getElementById('apiResults');
            resultsDiv.innerHTML = '';
            
            if (!lastUploadedFileId) {
                resultsDiv.innerHTML = '请先上传一张图片';
                return;
            }
            
            try {
                // 测试文件信息API
                log(`测试文件信息API: /api/files/${lastUploadedFileId}?info=true`);
                const infoResponse = await fetch(`/api/files/${lastUploadedFileId}?info=true`);
                const infoResult = await infoResponse.json();
                log(`文件信息响应: ${JSON.stringify(infoResult, null, 2)}`);
                
                resultsDiv.innerHTML += `<strong>文件信息API结果:</strong><br><pre>${JSON.stringify(infoResult, null, 2)}</pre><br>`;
                
                // 测试直接文件访问
                log(`测试直接文件访问: /api/files/${lastUploadedFileId}`);
                const fileResponse = await fetch(`/api/files/${lastUploadedFileId}`);
                log(`直接文件访问状态: ${fileResponse.status} ${fileResponse.statusText}`);
                
                if (fileResponse.ok) {
                    const contentType = fileResponse.headers.get('content-type');
                    resultsDiv.innerHTML += `<strong>直接文件访问:</strong><br>状态: ${fileResponse.status}<br>Content-Type: ${contentType}<br>`;
                    
                    if (contentType && contentType.startsWith('image/')) {
                        const imageUrl = `/api/files/${lastUploadedFileId}`;
                        resultsDiv.innerHTML += `<img src="${imageUrl}" style="max-width: 200px; max-height: 200px; border: 1px solid #ddd;"><br>`;
                    }
                } else {
                    resultsDiv.innerHTML += `<strong>直接文件访问失败:</strong> ${fileResponse.status}<br>`;
                }
                
            } catch (error) {
                resultsDiv.innerHTML += `<strong>API测试错误:</strong> ${error.message}<br>`;
                log(`API测试错误: ${error.message}`);
            }
        }
        
        async function testChatAPI() {
            const resultsDiv = document.getElementById('apiResults');
            
            if (!lastUploadedFileId) {
                resultsDiv.innerHTML += '<br><strong>聊天API测试:</strong> 请先上传一张图片<br>';
                return;
            }
            
            try {
                // 测试发送图片消息API
                log(`测试发送图片消息API`);
                const messageData = {
                    content: '这是一张测试图片',
                    fileId: lastUploadedFileId,
                    messageType: 'image'
                };
                
                const response = await fetch('/api/conversations/test-conversation/messages/media', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(messageData)
                });
                
                const result = await response.json();
                log(`聊天API响应: ${JSON.stringify(result, null, 2)}`);
                
                resultsDiv.innerHTML += `<br><strong>聊天API结果:</strong><br><pre>${JSON.stringify(result, null, 2)}</pre><br>`;
                
            } catch (error) {
                resultsDiv.innerHTML += `<br><strong>聊天API错误:</strong> ${error.message}<br>`;
                log(`聊天API错误: ${error.message}`);
            }
        }
        
        // 模拟 chat.js 的 getFileUrl 方法
        async function getFileUrl(fileId) {
            try {
                log(`获取文件URL: ${fileId}`);
                const response = await fetch(`/api/files/${fileId}?info=true`);
                if (response.ok) {
                    const result = await response.json();
                    log(`getFileUrl响应: ${JSON.stringify(result, null, 2)}`);
                    if (result.success && result.file) {
                        return result.file.url;
                    }
                }
            } catch (error) {
                log(`获取文件URL失败: ${error.message}`);
            }
            return null;
        }
        
        // 模拟 chat.js 的 addImageMessage 方法
        async function addImageMessage(type, messageData, staffName = null) {
            const chatContainer = document.getElementById('chatContainer');
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}-message`;
            
            // 创建图片元素
            const imageContainer = document.createElement('div');
            imageContainer.className = 'message-image-container';
            
            const image = document.createElement('img');
            image.className = 'message-image';
            image.style.maxWidth = '200px';
            image.style.maxHeight = '200px';
            image.style.borderRadius = '8px';
            image.style.cursor = 'pointer';
            
            log(`处理图片消息，fileId: ${messageData.fileId}`);
            
            // 构建图片URL
            if (messageData.fileId) {
                try {
                    const url = await getFileUrl(messageData.fileId);
                    if (url) {
                        log(`成功获取图片URL: ${url}`);
                        image.src = url;
                        image.alt = '图片消息';
                    } else {
                        log(`无法获取图片URL，使用占位符`);
                        image.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23ddd"/><text x="50" y="50" text-anchor="middle" dy=".3em">图片</text></svg>';
                        image.alt = '图片加载失败';
                    }
                } catch (error) {
                    log(`图片URL获取异常: ${error.message}`);
                    image.src = 'data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="100" height="100"><rect width="100" height="100" fill="%23ddd"/><text x="50" y="50" text-anchor="middle" dy=".3em">错误</text></svg>';
                    image.alt = '图片加载异常';
                }
            }
            
            // 点击放大图片
            image.onclick = () => {
                if (image.src && !image.src.startsWith('data:')) {
                    window.open(image.src, '_blank');
                }
            };
            
            imageContainer.appendChild(image);
            messageDiv.appendChild(imageContainer);
            
            // 添加文本描述
            if (messageData.content) {
                const textDiv = document.createElement('div');
                textDiv.textContent = messageData.content;
                messageDiv.appendChild(textDiv);
            }
            
            chatContainer.appendChild(messageDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        async function testImageMessage() {
            if (!lastUploadedFileId) {
                alert('请先上传一张图片');
                return;
            }
            
            const messageData = {
                content: '这是一条测试图片消息',
                fileId: lastUploadedFileId,
                messageType: 'image'
            };
            
            log(`测试图片消息显示`);
            await addImageMessage('staff', messageData, '测试客服');
        }
        
        function clearChat() {
            document.getElementById('chatContainer').innerHTML = '';
        }
        
        function clearLog() {
            document.getElementById('debugLog').innerHTML = '';
        }
        
        // 页面加载时的初始化
        window.onload = function() {
            log('图片显示测试页面已加载');
        };
    </script>
</body>
</html>