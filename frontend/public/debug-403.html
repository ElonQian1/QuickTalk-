<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>403错误诊断</title>
    <style>
        body { font-family: monospace; padding: 20px; background: #f5f5f5; }
        .test-box { background: white; padding: 20px; margin: 10px 0; border-radius: 8px; }
        .error { background: #ffebee; border-left: 4px solid #f44336; }
        .success { background: #e8f5e9; border-left: 4px solid #4caf50; }
        .warning { background: #fff3e0; border-left: 4px solid #ff9800; }
        button { padding: 10px 20px; margin: 5px; border: none; border-radius: 4px; background: #2196F3; color: white; cursor: pointer; }
        pre { background: #f1f1f1; padding: 10px; border-radius: 4px; overflow-x: auto; }
        .log { max-height: 400px; overflow-y: auto; }
    </style>
</head>
<body>
    <h1>🔍 403错误专项诊断</h1>
    
    <div class="test-box">
        <h3>🎯 快速诊断</h3>
        <button onclick="quickDiagnose()">🚀 一键诊断</button>
        <button onclick="testLogin()">🔐 测试登录</button>
        <button onclick="testShopsAPI()">🏪 测试店铺API</button>
        <button onclick="clearLog()">🗑️ 清除日志</button>
    </div>

    <div class="test-box">
        <h3>📋 当前状态</h3>
        <div id="currentStatus">检查中...</div>
    </div>

    <div class="test-box">
        <h3>📝 诊断日志</h3>
        <div id="diagnosticLog" class="log">等待诊断...</div>
    </div>

    <script>
        let logEntries = [];

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            logEntries.push(`[${timestamp}] ${message}`);
            updateLogDisplay();
            console.log(message);
        }

        function updateLogDisplay() {
            const logDiv = document.getElementById('diagnosticLog');
            logDiv.innerHTML = `<pre>${logEntries.join('\n')}</pre>`;
            logDiv.scrollTop = logDiv.scrollHeight;
        }

        function clearLog() {
            logEntries = [];
            updateLogDisplay();
        }

        function updateStatus(html, className = '') {
            const statusDiv = document.getElementById('currentStatus');
            statusDiv.innerHTML = html;
            statusDiv.className = className;
        }

        async function quickDiagnose() {
            clearLog();
            log('🚀 开始快速诊断...');
            
            await checkSessionIds();
            await testLogin();
            await testShopsAPI();
            
            log('✅ 诊断完成');
        }

        function checkSessionIds() {
            log('🔍 检查SessionId...');
            
            const localStorageId = localStorage.getItem('sessionId');
            const sessionStorageId = sessionStorage.getItem('currentSessionId');
            const globalSessionId = window.sessionId;
            
            log(`localStorage.sessionId: ${localStorageId || '无'}`);
            log(`sessionStorage.currentSessionId: ${sessionStorageId || '无'}`);
            log(`window.sessionId: ${globalSessionId || '无'}`);
            
            const sessionId = localStorageId || sessionStorageId || globalSessionId;
            if (sessionId) {
                log(`✅ 找到可用的sessionId: ${sessionId}`);
                updateStatus(`✅ SessionId: ${sessionId}`, 'success');
                return sessionId;
            } else {
                log('❌ 没有找到任何sessionId');
                updateStatus('❌ 没有SessionId', 'error');
                return null;
            }
        }

        async function testLogin() {
            log('🔐 测试登录状态...');
            
            const sessionId = localStorage.getItem('sessionId') || 
                              sessionStorage.getItem('currentSessionId') || 
                              'test_session';
            
            try {
                const response = await fetch('/api/auth/me', {
                    headers: {
                        'X-Session-Id': sessionId
                    }
                });
                
                log(`登录API响应: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const user = await response.json();
                    log(`✅ 登录成功: ${user.username} (${user.role})`);
                    updateStatus(`✅ 已登录: ${user.username} (${user.role})`, 'success');
                    return user;
                } else {
                    const error = await response.text();
                    log(`❌ 登录失败: ${error}`);
                    updateStatus(`❌ 登录失败: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`❌ 登录请求异常: ${error.message}`);
                updateStatus(`❌ 请求异常: ${error.message}`, 'error');
                return null;
            }
        }

        async function testShopsAPI() {
            log('🏪 测试店铺API...');
            
            const sessionId = localStorage.getItem('sessionId') || 
                              sessionStorage.getItem('currentSessionId') || 
                              'test_session';
            
            try {
                log(`发送请求到 /api/admin/shops，sessionId: ${sessionId}`);
                
                const response = await fetch('/api/admin/shops', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Session-Id': sessionId
                    }
                });
                
                log(`店铺API响应: ${response.status} ${response.statusText}`);
                
                if (response.ok) {
                    const shops = await response.json();
                    log(`✅ 店铺API成功: 获取到 ${shops.length} 个店铺`);
                    if (shops.length > 0) {
                        log(`前3个店铺: ${shops.slice(0, 3).map(s => s.name).join(', ')}`);
                    }
                    updateStatus(`✅ 店铺数据: ${shops.length} 个`, 'success');
                    return shops;
                } else {
                    const errorText = await response.text();
                    log(`❌ 店铺API失败 (${response.status}): ${errorText}`);
                    
                    if (response.status === 403) {
                        log('🔍 403错误可能原因:');
                        log('  1. SessionId无效或过期');
                        log('  2. 用户权限不足');
                        log('  3. 认证中间件问题');
                    }
                    
                    updateStatus(`❌ API错误: ${response.status}`, 'error');
                    return null;
                }
            } catch (error) {
                log(`❌ 店铺API请求异常: ${error.message}`);
                updateStatus(`❌ 请求异常: ${error.message}`, 'error');
                return null;
            }
        }

        // 页面加载时自动检查状态
        window.addEventListener('DOMContentLoaded', () => {
            checkSessionIds();
        });
    </script>
</body>
</html>
