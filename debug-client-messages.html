<!DOCTYPE html>
<html>
<head>
    <title>客服系统测试 - 消息接收调试</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #messages { border: 1px solid #ddd; height: 200px; overflow-y: auto; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>QuickTalk客服系统 - 消息接收测试</h1>
    
    <div>
        <button onclick="testConnect()">测试连接</button>
        <button onclick="sendTestMessage()">发送测试消息</button>
        <button onclick="checkMessages()">手动检查消息</button>
        <button onclick="startAutoCheck()">开始自动检查</button>
        <button onclick="stopAutoCheck()">停止自动检查</button>
        <button onclick="clearLogs()">清空日志</button>
    </div>
    
    <div>
        <p>当前 lastSequenceId: <span id="lastSeqId">0</span></p>
        <p>连接状态: <span id="status">未连接</span></p>
    </div>
    
    <h3>消息列表</h3>
    <div id="messages"></div>
    
    <h3>调试日志</h3>
    <div id="logs"></div>
    
    <script>
        // 配置
        const CONFIG = {
            shopKey: 'sk_ji85ucic9p00m12as1ygf34o8humuxfl',
            shopId: 'shop_1757591780450_1',
            serverUrl: 'http://localhost:3030',
            userId: 'user_test_debug_' + Date.now()
        };
        
        let lastSequenceId = 0;
        let checkInterval = null;
        let isConnected = false;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.innerHTML = new Date().toLocaleTimeString() + ' - ' + message;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
            isConnected = status === '已连接';
        }
        
        function updateLastSeqId(seqId) {
            lastSequenceId = seqId;
            document.getElementById('lastSeqId').textContent = seqId;
        }
        
        async function testConnect() {
            try {
                log('🔗 尝试连接到服务器...', 'info');
                
                const response = await fetch(CONFIG.serverUrl + '/api/secure-connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': CONFIG.shopKey,
                        'X-Shop-Id': CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: CONFIG.userId,
                        timestamp: Date.now(),
                        shopKey: CONFIG.shopKey,
                        shopId: CONFIG.shopId,
                        domain: window.location.hostname,
                        version: '1.0.3'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('✅ 连接成功: ' + (data.shop?.name || '基础连接'), 'success');
                    updateStatus('已连接');
                } else {
                    const errorText = await response.text();
                    log('❌ 连接失败: ' + errorText, 'error');
                    updateStatus('连接失败');
                }
            } catch (error) {
                log('❌ 连接错误: ' + error.message, 'error');
                updateStatus('连接错误');
            }
        }
        
        async function sendTestMessage() {
            try {
                const message = '测试消息 - ' + new Date().toLocaleTimeString();
                log('📤 发送消息: ' + message, 'info');
                
                const response = await fetch(CONFIG.serverUrl + '/api/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': CONFIG.shopKey,
                        'X-Shop-Id': CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: CONFIG.userId,
                        message: message,
                        shopKey: CONFIG.shopKey,
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    log('✅ 消息发送成功', 'success');
                    // 发送成功后立即检查消息
                    setTimeout(checkMessages, 500);
                } else {
                    const errorText = await response.text();
                    log('❌ 消息发送失败: ' + errorText, 'error');
                }
            } catch (error) {
                log('❌ 发送错误: ' + error.message, 'error');
            }
        }
        
        async function checkMessages() {
            try {
                log('📥 检查消息 (lastId=' + lastSequenceId + ')...', 'info');
                
                const response = await fetch(CONFIG.serverUrl + '/api/client/messages?userId=' + CONFIG.userId + '&lastId=' + lastSequenceId + '&shopId=' + CONFIG.shopId, {
                    headers: {
                        'X-Shop-Key': CONFIG.shopKey,
                        'X-Shop-Id': CONFIG.shopId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('📥 获取结果: ' + data.data.messages.length + ' 条消息, maxSequenceId: ' + data.data.maxSequenceId, 'info');
                    
                    if (data.data.messages.length > 0) {
                        // 显示新消息
                        data.data.messages.forEach(msg => {
                            displayMessage(msg);
                            log('📨 收到新消息 (seq:' + msg.sequenceId + '): ' + msg.message, 'success');
                        });
                        
                        // 更新lastSequenceId
                        if (data.data.maxSequenceId && data.data.maxSequenceId > lastSequenceId) {
                            updateLastSeqId(data.data.maxSequenceId);
                            log('🔄 更新lastSequenceId: ' + data.data.maxSequenceId, 'success');
                        }
                    } else {
                        log('📭 没有新消息', 'info');
                    }
                } else {
                    const errorText = await response.text();
                    log('❌ 获取消息失败: ' + errorText, 'error');
                }
            } catch (error) {
                log('❌ 检查消息错误: ' + error.message, 'error');
            }
        }
        
        function displayMessage(msg) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.style.margin = '5px 0';
            div.style.padding = '5px';
            div.style.backgroundColor = msg.type === 'staff_message' ? '#e8f5e8' : '#f5f5f5';
            div.innerHTML = '<strong>' + (msg.type === 'staff_message' ? '客服' : '用户') + '</strong> (seq:' + msg.sequenceId + '): ' + msg.message;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function startAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            checkInterval = setInterval(checkMessages, 2000);
            log('🔄 开始自动检查消息 (每2秒)', 'info');
        }
        
        function stopAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
            }
            log('⏹️ 停止自动检查消息', 'info');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('messages').innerHTML = '';
        }
        
        // 页面加载完成后自动连接
        window.onload = function() {
            log('🚀 页面加载完成，用户ID: ' + CONFIG.userId, 'info');
            testConnect();
        };
    </script>
</body>
</html>
