<!DOCTYPE html>
<html>
<head>
    <title>å®¢æœç³»ç»Ÿæµ‹è¯• - æ¶ˆæ¯æ¥æ”¶è°ƒè¯•</title>
    <meta charset="utf-8">
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .log { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .error { background: #ffebee; color: #c62828; }
        .success { background: #e8f5e8; color: #2e7d32; }
        .info { background: #e3f2fd; color: #1565c0; }
        button { padding: 10px 20px; margin: 5px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer; }
        #messages { border: 1px solid #ddd; height: 200px; overflow-y: auto; padding: 10px; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>QuickTalkå®¢æœç³»ç»Ÿ - æ¶ˆæ¯æ¥æ”¶æµ‹è¯•</h1>
    
    <div>
        <button onclick="testConnect()">æµ‹è¯•è¿æ¥</button>
        <button onclick="sendTestMessage()">å‘é€æµ‹è¯•æ¶ˆæ¯</button>
        <button onclick="checkMessages()">æ‰‹åŠ¨æ£€æŸ¥æ¶ˆæ¯</button>
        <button onclick="startAutoCheck()">å¼€å§‹è‡ªåŠ¨æ£€æŸ¥</button>
        <button onclick="stopAutoCheck()">åœæ­¢è‡ªåŠ¨æ£€æŸ¥</button>
        <button onclick="clearLogs()">æ¸…ç©ºæ—¥å¿—</button>
    </div>
    
    <div>
        <p>å½“å‰ lastSequenceId: <span id="lastSeqId">0</span></p>
        <p>è¿æ¥çŠ¶æ€: <span id="status">æœªè¿æ¥</span></p>
    </div>
    
    <h3>æ¶ˆæ¯åˆ—è¡¨</h3>
    <div id="messages"></div>
    
    <h3>è°ƒè¯•æ—¥å¿—</h3>
    <div id="logs"></div>
    
    <script>
        // é…ç½®
        const CONFIG = {
            shopKey: 'sk_ji85ucic9p00m12as1ygf34o8humuxfl',
            shopId: 'shop_1757591780450_1',
            serverUrl: 'http://localhost:3030',
            userId: 'user_test_debug_' + Date.now()
        };
        
        let lastSequenceId = 0;
        let checkInterval = null;
        let isConnected = false;
        
        function log(message, type = 'info') {
            const logs = document.getElementById('logs');
            const div = document.createElement('div');
            div.className = 'log ' + type;
            div.innerHTML = new Date().toLocaleTimeString() + ' - ' + message;
            logs.appendChild(div);
            logs.scrollTop = logs.scrollHeight;
            console.log(message);
        }
        
        function updateStatus(status) {
            document.getElementById('status').textContent = status;
            isConnected = status === 'å·²è¿æ¥';
        }
        
        function updateLastSeqId(seqId) {
            lastSequenceId = seqId;
            document.getElementById('lastSeqId').textContent = seqId;
        }
        
        async function testConnect() {
            try {
                log('ğŸ”— å°è¯•è¿æ¥åˆ°æœåŠ¡å™¨...', 'info');
                
                const response = await fetch(CONFIG.serverUrl + '/api/secure-connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': CONFIG.shopKey,
                        'X-Shop-Id': CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: CONFIG.userId,
                        timestamp: Date.now(),
                        shopKey: CONFIG.shopKey,
                        shopId: CONFIG.shopId,
                        domain: window.location.hostname,
                        version: '1.0.3'
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('âœ… è¿æ¥æˆåŠŸ: ' + (data.shop?.name || 'åŸºç¡€è¿æ¥'), 'success');
                    updateStatus('å·²è¿æ¥');
                } else {
                    const errorText = await response.text();
                    log('âŒ è¿æ¥å¤±è´¥: ' + errorText, 'error');
                    updateStatus('è¿æ¥å¤±è´¥');
                }
            } catch (error) {
                log('âŒ è¿æ¥é”™è¯¯: ' + error.message, 'error');
                updateStatus('è¿æ¥é”™è¯¯');
            }
        }
        
        async function sendTestMessage() {
            try {
                const message = 'æµ‹è¯•æ¶ˆæ¯ - ' + new Date().toLocaleTimeString();
                log('ğŸ“¤ å‘é€æ¶ˆæ¯: ' + message, 'info');
                
                const response = await fetch(CONFIG.serverUrl + '/api/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': CONFIG.shopKey,
                        'X-Shop-Id': CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: CONFIG.userId,
                        message: message,
                        shopKey: CONFIG.shopKey,
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ', 'success');
                    // å‘é€æˆåŠŸåç«‹å³æ£€æŸ¥æ¶ˆæ¯
                    setTimeout(checkMessages, 500);
                } else {
                    const errorText = await response.text();
                    log('âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ' + errorText, 'error');
                }
            } catch (error) {
                log('âŒ å‘é€é”™è¯¯: ' + error.message, 'error');
            }
        }
        
        async function checkMessages() {
            try {
                log('ğŸ“¥ æ£€æŸ¥æ¶ˆæ¯ (lastId=' + lastSequenceId + ')...', 'info');
                
                const response = await fetch(CONFIG.serverUrl + '/api/client/messages?userId=' + CONFIG.userId + '&lastId=' + lastSequenceId + '&shopId=' + CONFIG.shopId, {
                    headers: {
                        'X-Shop-Key': CONFIG.shopKey,
                        'X-Shop-Id': CONFIG.shopId
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    log('ğŸ“¥ è·å–ç»“æœ: ' + data.data.messages.length + ' æ¡æ¶ˆæ¯, maxSequenceId: ' + data.data.maxSequenceId, 'info');
                    
                    if (data.data.messages.length > 0) {
                        // æ˜¾ç¤ºæ–°æ¶ˆæ¯
                        data.data.messages.forEach(msg => {
                            displayMessage(msg);
                            log('ğŸ“¨ æ”¶åˆ°æ–°æ¶ˆæ¯ (seq:' + msg.sequenceId + '): ' + msg.message, 'success');
                        });
                        
                        // æ›´æ–°lastSequenceId
                        if (data.data.maxSequenceId && data.data.maxSequenceId > lastSequenceId) {
                            updateLastSeqId(data.data.maxSequenceId);
                            log('ğŸ”„ æ›´æ–°lastSequenceId: ' + data.data.maxSequenceId, 'success');
                        }
                    } else {
                        log('ğŸ“­ æ²¡æœ‰æ–°æ¶ˆæ¯', 'info');
                    }
                } else {
                    const errorText = await response.text();
                    log('âŒ è·å–æ¶ˆæ¯å¤±è´¥: ' + errorText, 'error');
                }
            } catch (error) {
                log('âŒ æ£€æŸ¥æ¶ˆæ¯é”™è¯¯: ' + error.message, 'error');
            }
        }
        
        function displayMessage(msg) {
            const messages = document.getElementById('messages');
            const div = document.createElement('div');
            div.style.margin = '5px 0';
            div.style.padding = '5px';
            div.style.backgroundColor = msg.type === 'staff_message' ? '#e8f5e8' : '#f5f5f5';
            div.innerHTML = '<strong>' + (msg.type === 'staff_message' ? 'å®¢æœ' : 'ç”¨æˆ·') + '</strong> (seq:' + msg.sequenceId + '): ' + msg.message;
            messages.appendChild(div);
            messages.scrollTop = messages.scrollHeight;
        }
        
        function startAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
            }
            checkInterval = setInterval(checkMessages, 2000);
            log('ğŸ”„ å¼€å§‹è‡ªåŠ¨æ£€æŸ¥æ¶ˆæ¯ (æ¯2ç§’)', 'info');
        }
        
        function stopAutoCheck() {
            if (checkInterval) {
                clearInterval(checkInterval);
                checkInterval = null;
            }
            log('â¹ï¸ åœæ­¢è‡ªåŠ¨æ£€æŸ¥æ¶ˆæ¯', 'info');
        }
        
        function clearLogs() {
            document.getElementById('logs').innerHTML = '';
            document.getElementById('messages').innerHTML = '';
        }
        
        // é¡µé¢åŠ è½½å®Œæˆåè‡ªåŠ¨è¿æ¥
        window.onload = function() {
            log('ğŸš€ é¡µé¢åŠ è½½å®Œæˆï¼Œç”¨æˆ·ID: ' + CONFIG.userId, 'info');
            testConnect();
        };
    </script>
</body>
</html>
