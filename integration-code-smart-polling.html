<!-- QuickTalkå®¢æœç³»ç»Ÿé›†æˆä»£ç  - ä¼˜åŒ–è½®è¯¢ç‰ˆæœ¬ -->
<!-- ä¼˜åŒ–å†…å®¹: å‡å°‘æ—¥å¿—è¾“å‡ºï¼Œæ™ºèƒ½è½®è¯¢é¢‘ç‡ -->

<script>
// å®¢æœç³»ç»Ÿå®ç° - ä¼˜åŒ–è½®è¯¢ç‰ˆæœ¬
(function(){
    let cs = {
        isOpen: false,
        isMini: false,
        isConnected: false,
        userId: 'user_' + Math.random().toString(36).substr(2,9) + '_' + Date.now(),
        interval: null,
        lastSequenceId: 0,
        pollInterval: 2000,  // åŸºç¡€è½®è¯¢é—´éš”
        maxPollInterval: 10000,  // æœ€å¤§è½®è¯¢é—´éš”
        emptyResponseCount: 0,  // è¿ç»­ç©ºå“åº”è®¡æ•°
        
        init() {
            // éªŒè¯åŸŸå
            const currentDomain = window.location.hostname;
            const authorizedDomain = window.QUICKTALK_CONFIG.authorizedDomain;
            
            if (currentDomain !== authorizedDomain && 
                !currentDomain.endsWith('.' + authorizedDomain) && 
                currentDomain !== 'localhost') {
                console.error('âŒ QuickTalkå®¢æœç³»ç»Ÿï¼šåŸŸåæœªæˆæƒ');
                return;
            }
            
            console.log('âœ… åŸŸåéªŒè¯é€šè¿‡ï¼Œæ­£åœ¨è¿æ¥å®¢æœç³»ç»Ÿ...');
            this.updateTime();
            setTimeout(() => this.connect(), 1000);
        },
        
        async connect() {
            try {
                console.log('ğŸ”— å°è¯•è¿æ¥åˆ°æœåŠ¡å™¨...');
                
                let res = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/secure-connect', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': window.QUICKTALK_CONFIG.shopKey,
                        'X-Shop-Id': window.QUICKTALK_CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: this.userId,
                        timestamp: Date.now(),
                        shopKey: window.QUICKTALK_CONFIG.shopKey,
                        shopId: window.QUICKTALK_CONFIG.shopId,
                        domain: window.location.hostname,
                        version: window.QUICKTALK_CONFIG.version
                    })
                });
                
                if (!res.ok) {
                    res = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/connect', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            userId: this.userId,
                            timestamp: Date.now()
                        })
                    });
                }
                
                if (res.ok) {
                    const data = await res.json();
                    this.isConnected = true;
                    this.updateStatus('connected', 'å·²è¿æ¥');
                    this.startSmartPoll();  // ä½¿ç”¨æ™ºèƒ½è½®è¯¢
                    console.log('âœ… å®¢æœè¿æ¥æˆåŠŸ:', data.shop?.name || 'åŸºç¡€è¿æ¥');
                } else {
                    throw new Error('è¿æ¥å¤±è´¥');
                }
            } catch (e) {
                console.error('âŒ å®¢æœè¿æ¥å¤±è´¥:', e);
                this.updateStatus('disconnected', 'è¿æ¥å¤±è´¥');
                setTimeout(() => this.connect(), 5000);
            }
        },
        
        // ğŸš€ æ™ºèƒ½è½®è¯¢ï¼šæ ¹æ®æ¶ˆæ¯æ´»è·ƒåº¦è°ƒæ•´é¢‘ç‡
        startSmartPoll() {
            if (this.interval) clearInterval(this.interval);
            this.interval = setInterval(() => this.checkMsg(), this.pollInterval);
            console.log('ğŸ”„ å¼€å§‹æ™ºèƒ½è½®è¯¢ (é—´éš”: ' + this.pollInterval + 'ms)...');
        },
        
        // ğŸ“ˆ åŠ¨æ€è°ƒæ•´è½®è¯¢é¢‘ç‡
        adjustPollInterval(hasNewMessages) {
            if (hasNewMessages) {
                // æœ‰æ–°æ¶ˆæ¯æ—¶æ¢å¤å¿«é€Ÿè½®è¯¢
                this.pollInterval = 2000;
                this.emptyResponseCount = 0;
            } else {
                // è¿ç»­æ— æ¶ˆæ¯æ—¶é€æ¸å‡æ…¢è½®è¯¢
                this.emptyResponseCount++;
                if (this.emptyResponseCount > 5) {
                    this.pollInterval = Math.min(this.maxPollInterval, this.pollInterval * 1.5);
                }
            }
            
            // é‡å¯è½®è¯¢ä»¥åº”ç”¨æ–°é—´éš”
            if (this.interval) {
                clearInterval(this.interval);
                this.interval = setInterval(() => this.checkMsg(), this.pollInterval);
            }
        },
        
        async checkMsg() {
            if (!this.isConnected) return;
            try {
                const res = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/client/messages?userId=' + this.userId + '&lastId=' + this.lastSequenceId + '&shopId=' + window.QUICKTALK_CONFIG.shopId, {
                    headers: {
                        'X-Shop-Key': window.QUICKTALK_CONFIG.shopKey,
                        'X-Shop-Id': window.QUICKTALK_CONFIG.shopId
                    }
                });
                
                if (res.ok) {
                    const data = await res.json();
                    const hasNewMessages = data.data?.messages?.length > 0;
                    
                    if (hasNewMessages) {
                        console.log('ğŸ“¨ æ”¶åˆ°æ–°æ¶ˆæ¯:', data.data.messages.length + 'æ¡');
                        data.data.messages.forEach(msg => {
                            this.handleMsg(msg);
                        });
                        
                        if (data.data.maxSequenceId) {
                            this.lastSequenceId = data.data.maxSequenceId;
                            console.log('ğŸ”„ æ›´æ–°lastSequenceId:', this.lastSequenceId);
                        }
                    }
                    
                    // æ ¹æ®æ˜¯å¦æœ‰æ–°æ¶ˆæ¯è°ƒæ•´è½®è¯¢é¢‘ç‡
                    this.adjustPollInterval(hasNewMessages);
                    
                } else if (res.status === 401) {
                    console.error('âŒ è®¤è¯å¤±è´¥ï¼Œå°è¯•é‡æ–°è¿æ¥...');
                    this.isConnected = false;
                    this.updateStatus('disconnected', 'è®¤è¯å¤±è´¥');
                    setTimeout(() => this.connect(), 3000);
                }
            } catch (e) {
                console.error('âŒ è·å–æ¶ˆæ¯å¤±è´¥:', e);
                this.isConnected = false;
                this.updateStatus('disconnected', 'è¿æ¥æ–­å¼€');
                setTimeout(() => this.connect(), 3000);
            }
        },
        
        handleMsg(msg) {
            if (msg.type === 'staff_message') {
                this.addMsg('staff', msg.message);
                console.log('ğŸ“¨ æ”¶åˆ°å®¢æœæ¶ˆæ¯:', msg.message);
                
                // æ”¶åˆ°æ¶ˆæ¯æ—¶ç«‹å³æ¢å¤å¿«é€Ÿè½®è¯¢
                this.pollInterval = 2000;
                this.emptyResponseCount = 0;
            } else if (msg.type === 'system_notification') {
                this.addMsg('system', msg.message);
                console.log('ğŸ“¨ æ”¶åˆ°ç³»ç»Ÿæ¶ˆæ¯:', msg.message);
            }
        },
        
        // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
        addMsg(type, text) {
            const body = document.getElementById('cs-body');
            const div = document.createElement('div');
            div.className = 'cs-msg cs-' + type;
            div.innerHTML = '<span class="cs-msg-text">' + text + '</span><span class="cs-msg-time">' + new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'}) + '</span>';
            body.appendChild(div);
            body.scrollTop = body.scrollHeight;
        },
        
        async send() {
            const input = document.getElementById('cs-input');
            const msg = input.value.trim();
            if (!msg) return;
            
            if (!this.isConnected) {
                this.addMsg('system', 'è¿æ¥æ–­å¼€ï¼Œæ— æ³•å‘é€æ¶ˆæ¯');
                return;
            }
            
            this.addMsg('user', msg);
            input.value = '';
            
            try {
                const response = await fetch(window.QUICKTALK_CONFIG.apiUrl + '/send', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Shop-Key': window.QUICKTALK_CONFIG.shopKey,
                        'X-Shop-Id': window.QUICKTALK_CONFIG.shopId
                    },
                    body: JSON.stringify({
                        userId: this.userId,
                        message: msg,
                        shopKey: window.QUICKTALK_CONFIG.shopKey,
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    console.log('âœ… æ¶ˆæ¯å‘é€æˆåŠŸ');
                    // å‘é€æ¶ˆæ¯åæ¢å¤å¿«é€Ÿè½®è¯¢ç­‰å¾…å›å¤
                    this.pollInterval = 1000;  // ä¸´æ—¶æé«˜é¢‘ç‡
                    this.emptyResponseCount = 0;
                    setTimeout(() => this.checkMsg(), 500);
                } else {
                    console.error('âŒ æ¶ˆæ¯å‘é€å¤±è´¥');
                    this.addMsg('system', 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
                }
            } catch (e) {
                console.error('âŒ å‘é€é”™è¯¯:', e);
                this.addMsg('system', 'å‘é€å¤±è´¥ï¼Œè¯·é‡è¯•');
            }
        },
        
        updateStatus(status, text) {
            const dot = document.getElementById('cs-dot');
            const statusText = document.getElementById('cs-status');
            if (dot) dot.className = 'cs-dot cs-' + status;
            if (statusText) statusText.textContent = text;
        },
        
        updateTime() {
            const time = document.getElementById('welcome-time');
            if (time) time.textContent = new Date().toLocaleTimeString('zh-CN', {hour: '2-digit', minute: '2-digit'});
        }
        
        // ... å…¶ä»–æ–¹æ³•ä¿æŒä¸å˜
    };
    
    // å…¨å±€å‡½æ•°
    window.toggleCS = () => cs.toggle();
    window.closeCS = () => cs.close();
    window.miniCS = () => cs.minimize();
    window.sendCS = () => cs.send();
    
    // åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', function() {
        const cbBtn = document.querySelector('#cb');
        if (cbBtn) {
            cbBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                cs.toggle();
            });
        }
        setTimeout(() => cs.init(), 1000);
    });
    
    if (document.readyState !== 'loading') {
        setTimeout(() => cs.init(), 1000);
    }
    
    window.addEventListener('beforeunload', () => {
        if (cs.interval) clearInterval(cs.interval);
    });
})();
</script>
